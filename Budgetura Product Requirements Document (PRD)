# **Budgetura Product Requirements Document (PRD)** {#budgetura-product-requirements-document-(prd)}

# **Budgetura \- Debt Management React Application** {#budgetura---debt-management-react-application}

**Version:** 3.0  
 **Date:** November 30, 2025  
 **Project Type:** React Web Application (Full-Featured Fintech MVP)  
 **Developer Level:** Junior Developer Friendly

**Developer Name:** Oxford Pierpont  
 **GitHub:** oxfordpierpont  
 **Website:** budgetura.com

---

## 

## **Table of Contents** {#table-of-contents}

[Budgetura Product Requirements Document (PRD)	1](#budgetura-product-requirements-document-\(prd\))

[Budgetura \- Debt Management React Application	1](#budgetura---debt-management-react-application)

[Table of Contents	2](#table-of-contents)

[1\. Project Overview	5](#1.-project-overview)

[1.1 Purpose	5](#1.1-purpose)

[1.2 Target Users	5](#1.2-target-users)

[1.3 Business Model	6](#1.3-business-model)

[1.4 Success Criteria	7](#1.4-success-criteria)

[2\. Technical Stack	8](#2.-technical-stack)

[2.1 Frontend Technologies	8](#2.1-frontend-technologies)

[2.2 Backend Technologies	10](#2.2-backend-technologies)

[2.3 Development Tools	11](#2.3-development-tools)

[2.4 Infrastructure & DevOps	12](#2.4-infrastructure-&-devops)

[2.5 Security Stack	14](#2.5-security-stack)

[2.6 Browser & Device Support	15](#2.6-browser-&-device-support)

[2.7 Third-Party Integrations (Phase 1 & 2\)	16](#2.7-third-party-integrations-\(phase-1-&-2\))

[3\. Application Architecture	18](#3.-application-architecture)

[3.1 High-Level System Architecture	18](#3.1-high-level-system-architecture)

[3.2 Detailed Project Structure	23](#3.2-detailed-project-structure)

[3.3 Component Architecture & Design Patterns	37](#3.3-component-architecture-&-design-patterns)

[3.4 State Management Architecture	40](#3.4-state-management-architecture)

[3.5 Data Flow Architecture	42](#3.5-data-flow-architecture)

[4\. Database Schema	47](#4.-database-schema)

[4.1 Complete Database Design (PostgreSQL via Supabase)	47](#4.1-complete-database-design-\(postgresql-via-supabase\))

[4.1.1 Users Table	47](#4.1.1-users-table)

[4.1.2 Credit Cards Table	57](#4.1.2-credit-cards-table)

[4.1.3 Loans Table	66](#4.1.3-loans-table)

[4.1.4 Mortgages Table	77](#4.1.4-mortgages-table)

[4.1.5 Bills Table	90](#4.1.5-bills-table)

[4.1.6 Goals Table	103](#4.1.6-goals-table)

[4.1.7 Snapshots Table	114](#4.1.7-snapshots-table)

[4.2 Additional Database Tables	125](#4.2-additional-database-tables)

[4.2.1 Payment History Table (Optional \- Future Enhancement)	125](#4.2.1-payment-history-table-\(optional---future-enhancement\))

[4.2.2 Notifications Table	127](#4.2.2-notifications-table)

[4.3 Database Functions & Stored Procedures	129](#4.3-database-functions-&-stored-procedures)

[4.4 TypeScript Type Definitions (Complete)	132](#4.4-typescript-type-definitions-\(complete\))

[5\. Feature Specifications (Complete)	143](#5.-feature-specifications-\(complete\))

[5.1 Authentication System	143](#5.1-authentication-system)

[5.1.1 Sign Up Flow	143](#5.1.1-sign-up-flow)

[5.1.2 Sign In Flow	158](#5.1.2-sign-in-flow)

[5.1.3 Password Reset Flow	163](#5.1.3-password-reset-flow)

[5.2 Dashboard Overview	168](#5.2-dashboard-overview)

[5.2.1 Dashboard Layout	168](#5.2.1-dashboard-layout)

[5.3 Credit Card Manager	211](#5.3-credit-card-manager)

[5.3.1 Credit Card List View	211](#5.3.1-credit-card-list-view)

[5.3.2 Credit Card Detail View	241](#5.3.2-credit-card-detail-view)

[5.3.3 Credit Card Form (Add/Edit)	258](#5.3.3-credit-card-form-\(add/edit\))

[5.3.4 Payoff Calculator Component	296](#5.3.4-payoff-calculator-component)

[5.3.5 Payment History Component	316](#5.3.5-payment-history-component)

[5.4 Loans Manager	330](#5.4-loans-manager)

[5.4.1 Loans List View	330](#5.4.1-loans-list-view)

[5.4.2 Loan Detail View	363](#5.4.2-loan-detail-view)

[5.4.3 Loan Form (Add/Edit)	414](#5.4.3-loan-form-\(add/edit\))

[5.5 Mortgage Manager	445](#5.5-mortgage-manager)

[5.5.1 Mortgage List View	445](#5.5.1-mortgage-list-view)

[5.5.2 Mortgage Detail View	477](#5.5.2-mortgage-detail-view)

[5.5.3 Mortgage Form (Add/Edit)	528](#5.5.3-mortgage-form-\(add/edit\))

[5.6 Bills Tracker	564](#5.6-bills-tracker)

[5.6.1 Bills List View	564](#5.6.1-bills-list-view)

[5.6.2 Bill Detail View	620](#5.6.2-bill-detail-view)

[5.6.3 Bill Form (Add/Edit)	647](#5.6.3-bill-form-\(add/edit\))

[5.7 Goals Tracker	669](#5.7-goals-tracker)

[5.7.1 Goals List View	669](#5.7.1-goals-list-view)

[5.7.2 Goal Detail View	706](#5.7.2-goal-detail-view)

[5.7.3 Goal Form (Add/Edit)	764](#5.7.3-goal-form-\(add/edit\))

[5.8 Snapshots	780](#5.8-snapshots)

[5.8.1 Snapshots List View	780](#5.8.1-snapshots-list-view)

[5.8.2 Snapshot Detail View	824](#5.8.2-snapshot-detail-view)

[5.8.3 Snapshot Form (Add/Edit)	864](#5.8.3-snapshot-form-\(add/edit\))

[5.9 Debt Action Plan	892](#5.9-debt-action-plan)

[5.9.1 Debt Action Plan Overview Page	892](#5.9.1-debt-action-plan-overview-page)

[6\. Settings	927](#6.-settings)

[6.1 Settings Layout & Navigation	927](#6.1-settings-layout-&-navigation)

[6.2 Account Settings	933](#6.2-account-settings)

[6.3 Security Settings	942](#6.3-security-settings)

[6.4 Notification Settings	957](#6.4-notification-settings)

[6.5 Preferences Settings	971](#6.5-preferences-settings)

[6.6 Data & Privacy Settings	981](#6.6-data-&-privacy-settings)

[7\. Reports & Analytics	996](#7.-reports-&-analytics)

[7.1 Reports Overview Page	996](#7.1-reports-overview-page)

[7.2 Income vs Expenses Report	1006](#7.2-income-vs-expenses-report)

[7.3 Net Worth Trend Report	1038](#7.3-net-worth-trend-report)

---

## **1\. Project Overview** {#1.-project-overview}

### **1.1 Purpose** {#1.1-purpose}

Budgetura is a comprehensive React-based web application that transforms traditional debt management from static spreadsheets into an interactive, real-time financial tracking system. It is a **full-featured fintech application** with advanced calculations, data visualization, predictive analytics, and secure user data management.

**Key Features:**

* **Real-time Calculations:** Instant feedback as users input data  
* **Advanced Visualizations:** Interactive charts with Recharts library  
* **Progressive Web App:** Works offline, installable on mobile devices  
* **Type Safety:** Full TypeScript implementation for reliability  
* **Modern Architecture:** Component-based with proper state management  
* **Superior Performance:** Optimized React rendering and code splitting  
* **Enhanced Security:** JWT authentication, encrypted data storage  
* **Scalable Infrastructure:** Microservices-ready architecture  
* **API-First Design:** RESTful API for future mobile apps

### **1.2 Target Users** {#1.2-target-users}

**Primary Personas:**

**Persona 1: The Debt-Overwhelmed Millennial**

* Age: 28-38  
* Income: $45,000-$75,000/year  
* Debt: $30,000-$80,000 (student loans, credit cards, auto loan)  
* Tech Savvy: High (uses smartphone apps daily)  
* Pain Points:  
  * Juggling multiple credit cards and loans  
  * Confused about optimal payoff strategy  
  * Feels overwhelmed by debt  
  * Wants clear, actionable plan  
* Goals:  
  * Become debt-free in 3-5 years  
  * Improve credit score  
  * Save for major purchase (house, wedding)

**Persona 2: The Budget-Conscious Family**

* Age: 32-45  
* Household Income: $80,000-$120,000/year  
* Debt: $150,000-$300,000 (mortgage, cars, credit cards)  
* Tech Savvy: Medium (uses apps but prefers desktop)  
* Pain Points:  
  * Managing household expenses with multiple incomes  
  * Tracking bills with different due dates  
  * Balancing debt payoff with family savings goals  
  * Need visibility into long-term financial trajectory  
* Goals:  
  * Pay off mortgage early  
  * Save for children's college  
  * Build emergency fund  
  * Retire comfortably

**Persona 3: The Financial Fresh-Start**

* Age: 25-50  
* Income: Varies widely  
* Debt: $10,000-$50,000 (rebuilding after life event)  
* Tech Savvy: Medium to High  
* Pain Points:  
  * Recovering from divorce, job loss, or medical debt  
  * Rebuilding credit  
  * Need motivation and accountability  
  * Overwhelmed by financial complexity  
* Goals:  
  * Create sustainable budget  
  * Establish emergency fund  
  * Build positive financial habits  
  * Track progress and celebrate wins

### **1.3 Business Model** {#1.3-business-model}

**Revenue Streams:**

1. **Freemium Model**

   * **Free Tier:**  
     * Up to 3 credit cards  
     * Up to 2 loans  
     * 1 mortgage  
     * Up to 10 bills  
     * 3 goals  
     * 12 monthly snapshots  
     * Basic action plan  
   * **Premium Tier ($9.99/month or $99/year):**  
     * Unlimited credit cards, loans, bills, goals  
     * Unlimited snapshots  
     * Advanced action plans with scenarios  
     * Export to PDF/CSV  
     * Priority support  
     * Bank account integration (future)  
     * Custom debt payoff strategies  
     * Financial health score  
     * Comparison with peers (anonymous)  
2. **Enterprise/Family Plans ($19.99/month)**

   * Up to 5 family members  
   * Shared household view  
   * Multiple user permissions  
   * Family financial meetings feature  
   * Aggregate reporting  
3. **Affiliate Revenue**

   * Credit card recommendations (affiliate links)  
   * Refinancing partners  
   * Financial advisor referrals  
   * Debt consolidation services  
4. **White Label Licensing**

   * License to credit unions  
   * License to financial advisors  
   * Custom branding options

### **1.4 Success Criteria** {#1.4-success-criteria}

**User Engagement Metrics:**

* Users log in at least 2x per month (target: 70% of active users)  
* Average session duration \> 5 minutes  
* Monthly snapshot creation rate \> 80%  
* Mobile usage \> 40% of total traffic  
* PWA installation rate \> 15%

**Business Metrics:**

* Free-to-paid conversion: 5% within 3 months  
* Monthly churn rate \< 5%  
* Customer lifetime value (LTV) \> $200  
* Average customer acquisition cost (CAC) \< $40  
* LTV:CAC ratio \> 5:1

**Technical Metrics:**

* Page load time \< 1.5 seconds (95th percentile)  
* Time to Interactive (TTI) \< 2.5 seconds  
* Lighthouse Performance score \> 95  
* Zero critical security vulnerabilities  
* API uptime \> 99.9%  
* Error rate \< 0.1%

**User Satisfaction:**

* Net Promoter Score (NPS) \> 50  
* App Store rating \> 4.5 stars (future mobile app)  
* Customer support satisfaction \> 90%  
* Feature request implementation within 3 months

---

## **2\. Technical Stack** {#2.-technical-stack}

### **2.1 Frontend Technologies** {#2.1-frontend-technologies}

```ts
// Core Framework
React: 19.x                    // Latest React with concurrent features
TypeScript: 5.6+               // Full type safety
Vite: 6.x                      // Ultra-fast build tool with HMR

// Routing & Navigation
React Router: 6.22+            // Client-side routing
                               // - Lazy loading
                               // - Nested routes
                               // - Protected routes

// State Management
Zustand: 4.5+                  // Lightweight global state
                               // - User authentication
                               // - UI state (modals, toasts)
                               // - User preferences
@tanstack/react-query: 5.28+   // Server state management
                               // - Caching
                               // - Background refetching
                               // - Optimistic updates
                               // - Pagination

// Styling
Tailwind CSS: 3.4+             // Utility-first CSS
                               // - Custom design system
                               // - Dark mode support
                               // - Responsive design
@tailwindcss/forms             // Form styling plugin
@tailwindcss/typography        // Typography plugin
clsx                           // Conditional classNames
tailwind-merge                 // Merge Tailwind classes

// Data Visualization
Recharts: 2.12+                // Composable charting library
                               // - Line charts (debt over time)
                               // - Pie charts (debt breakdown)
                               // - Bar charts (monthly comparisons)
                               // - Area charts (projections)
                               // - Responsive charts

// Form Management
React Hook Form: 7.51+         // Performant form library
                               // - Minimal re-renders
                               // - Easy validation
@hookform/resolvers            // Validation resolvers
Zod: 3.22+                     // TypeScript-first schema validation
                               // - Runtime type checking
                               // - Reusable schemas
                               // - Error messages

// Date Handling
date-fns: 3.3+                 // Modern date utility library
                               // - Immutable
                               // - Tree-shakeable
                               // - TypeScript support

// Icons
lucide-react: 0.344+           // Beautiful icon set
                               // - 1000+ icons
                               // - Customizable
                               // - Tree-shakeable

// Utilities
react-hot-toast                // Toast notifications
react-error-boundary           // Error boundaries
@headlessui/react              // Unstyled accessible components
                               // - Modals
                               // - Dropdowns
                               // - Transitions
framer-motion                  // Animation library
                               // - Page transitions
                               // - Micro-interactions
```

### **2.2 Backend Technologies** {#2.2-backend-technologies}

**Option A: Supabase (Recommended for MVP)**

```ts
Supabase: Latest
├── PostgreSQL Database        // Robust relational database
│   ├── Row Level Security    // User data isolation
│   ├── Triggers & Functions  // Business logic
│   └── Real-time subscriptions
│
├── Authentication
│   ├── JWT tokens
│   ├── Email/password
│   ├── OAuth providers (Google, Apple)
│   └── Magic links
│
├── Storage
│   ├── User avatars
│   ├── Exported files (PDF, CSV)
│   └── Document uploads
│
└── Edge Functions
    ├── Complex calculations
    ├── Report generation
    └── Scheduled tasks
```

**Option B: Custom Node.js Backend**

```ts
Node.js: 20+ LTS
Express.js: 4.18+              // Web framework
PostgreSQL: 16+                // Database
Prisma: 5.11+                  // ORM with type safety
JWT: 9.0+                      // Authentication
bcrypt: 5.1+                   // Password hashing
node-cron: 3.0+                // Scheduled tasks
Bull: 4.12+                    // Job queues
```

### **2.3 Development Tools** {#2.3-development-tools}

```shell
# Package Manager
pnpm: 8.15+                    # Fast, disk-efficient

# Code Quality
ESLint: 8.57+                  # Linting
  ├── @typescript-eslint/*     # TypeScript rules
  ├── eslint-plugin-react      # React rules
  └── eslint-plugin-jsx-a11y   # Accessibility rules

Prettier: 3.2+                 # Code formatting
  └── prettier-plugin-tailwindcss

# Testing
Vitest: 1.3+                   # Unit testing (Vite-native)
React Testing Library: 14.2+   # Component testing
Playwright: 1.42+              # E2E testing
@testing-library/jest-dom      # Custom matchers

# Git Hooks
Husky: 9.0+                    # Git hooks
lint-staged: 15.2+             # Run on staged files
commitlint: 19.0+              # Enforce commit conventions

# Type Checking
tsc: 5.6+                      # TypeScript compiler
  └── --noEmit for CI/CD       # Type checking only
```

### **2.4 Infrastructure & DevOps** {#2.4-infrastructure-&-devops}

```
# Hosting & Deployment
Frontend:
  - Vercel (Recommended)
    ├── Automatic deployments from Git
    ├── Preview deployments for PRs
    ├── Edge caching
    ├── Analytics
    └── Web Vitals monitoring
  
  - Alternatives: Netlify, Cloudflare Pages

Backend (if custom):
  - Railway (Recommended for Node.js)
  - Render
  - AWS Elastic Beanstalk
  - DigitalOcean App Platform

Database:
  - Supabase (managed PostgreSQL)
  - Railway (managed PostgreSQL)
  - AWS RDS
  - Neon (serverless PostgreSQL)

# CDN & Static Assets
Cloudflare:
  - Global CDN
  - DDoS protection
  - Image optimization
  - DNS management

# Monitoring & Analytics
Sentry: Error tracking
  ├── Frontend errors
  ├── Backend errors
  ├── Performance monitoring
  └── Release tracking

Plausible/PostHog: Privacy-friendly analytics
  ├── Page views
  ├── User flows
  ├── Feature usage
  └── Conversion funnels

LogRocket/Fullstory: Session replay
  ├── User session recording
  ├── Debugging production issues
  └── UX insights

# Email Services
Resend/SendGrid:
  ├── Transactional emails
  ├── Password resets
  ├── Notifications
  └── Monthly reports
```

### **2.5 Security Stack** {#2.5-security-stack}

```ts
// Authentication & Authorization
JWT (JSON Web Tokens)
  ├── Access tokens (short-lived: 15 minutes)
  ├── Refresh tokens (long-lived: 7 days)
  └── HttpOnly cookies for refresh tokens

// Encryption
bcrypt                         // Password hashing (10 rounds)
crypto-js                      // Client-side encryption for sensitive data

// API Security
helmet                         // Security headers
cors                           // CORS configuration
rate-limit-redis               // Rate limiting
express-validator              // Input validation
xss-clean                      // XSS protection
hpp                            // HTTP Parameter Pollution protection

// Environment Variables
dotenv                         // Development
Vercel Environment Variables   // Production
  ├── VITE_SUPABASE_URL       // Public
  ├── VITE_SUPABASE_ANON_KEY  // Public
  ├── SUPABASE_SERVICE_KEY     // Secret
  ├── JWT_SECRET               // Secret
  └── DATABASE_URL             // Secret
```

### **2.6 Browser & Device Support** {#2.6-browser-&-device-support}

**Desktop Browsers:**

```
Chrome: Latest 2 versions (95%+ features)
Firefox: Latest 2 versions (95%+ features)
Safari: Latest 2 versions (95%+ features)
Edge: Latest 2 versions (95%+ features)

Graceful degradation for:
- IE11: Not supported (show upgrade message)
- Older versions: Basic functionality only
```

**Mobile Browsers:**

```
iOS Safari: 14+ (95%+ features)
Chrome Mobile: Latest 2 versions
Samsung Internet: Latest 2 versions
Firefox Mobile: Latest 2 versions
```

**Screen Sizes:**

```
Mobile:  320px - 767px
  ├── iPhone SE: 375px
  ├── iPhone 12/13/14: 390px
  └── iPhone Pro Max: 428px

Tablet:  768px - 1023px
  ├── iPad: 768px
  └── iPad Pro: 1024px

Desktop: 1024px+
  ├── Laptop: 1280px, 1440px
  └── Desktop: 1920px, 2560px
```

**Progressive Web App (PWA):**

```
Service Worker: Offline support
Web Manifest: Install to home screen
Push Notifications: Bill reminders, milestones
Background Sync: Offline data sync
```

### **2.7 Third-Party Integrations (Phase 1 & 2\)** {#2.7-third-party-integrations-(phase-1-&-2)}

```ts
// Phase 1 (MVP)
Supabase Auth                  // User authentication
Recharts                       // Data visualization
React Hook Form + Zod          // Form handling

// Phase 2 (Post-MVP)
Plaid                          // Bank account integration
  ├── Link accounts
  ├── Transaction syncing
  └── Balance updates

Stripe                         // Payment processing
  ├── Subscription management
  ├── Invoice generation
  └── Webhook handling

OneSignal/Firebase             // Push notifications
  ├── Web push
  ├── In-app notifications
  └── Email notifications

n8n/Zapier                     // Automation
  ├── Monthly snapshot creation
  ├── Bill reminders
  ├── Data exports
  └── Email reports

SendGrid/Resend                // Email service
  ├── Welcome emails
  ├── Password resets
  ├── Monthly summaries
  └── Marketing campaigns

// Phase 3 (Advanced)
OpenAI API                     // AI-powered insights
  ├── Personalized recommendations
  ├── Spending pattern analysis
  └── Financial chatbot

Twilio                         // SMS notifications
  ├── Bill reminders
  ├── Payment confirmations
  └── 2FA authentication

Google Analytics/Mixpanel      // Advanced analytics
  ├── User behavior tracking
  ├── Funnel analysis
  └── A/B testing
```

---

## **3\. Application Architecture** {#3.-application-architecture}

### **3.1 High-Level System Architecture** {#3.1-high-level-system-architecture}

```
┌─────────────────────────────────────────────────────────────┐
│                      CLIENT (Browser)                        │
│  ┌────────────────────────────────────────────────────────┐ │
│  │              React Application (SPA)                    │ │
│  │  ┌──────────────────────────────────────────────────┐  │ │
│  │  │  Presentation Layer (React Components)           │  │ │
│  │  │  - Pages (Dashboard, CreditCards, Loans, etc.)   │  │ │
│  │  │  - Components (Cards, Forms, Charts, etc.)       │  │ │
│  │  └──────────────────────────────────────────────────┘  │ │
│  │  ┌──────────────────────────────────────────────────┐  │ │
│  │  │  Business Logic Layer                            │  │ │
│  │  │  - Custom Hooks (useAuth, useCreditCards, etc.)  │  │ │
│  │  │  - Calculation Engine (lib/calculations/)        │  │ │
│  │  │  - Utilities (formatters, validators)            │  │ │
│  │  └──────────────────────────────────────────────────┘  │ │
│  │  ┌──────────────────────────────────────────────────┐  │ │
│  │  │  State Management Layer                          │  │ │
│  │  │  - Zustand Store (auth, UI state, preferences)   │  │ │
│  │  │  - React Query Cache (server state, API data)    │  │ │
│  │  └──────────────────────────────────────────────────┘  │ │
│  │  ┌──────────────────────────────────────────────────┐  │ │
│  │  │  API Client Layer                                │  │ │
│  │  │  - Supabase Client                               │  │ │
│  │  │  - HTTP Client (fetch/axios)                     │  │ │
│  │  │  - WebSocket Client (real-time)                  │  │ │
│  │  └──────────────────────────────────────────────────┘  │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ HTTPS/WSS
                            │
┌─────────────────────────────────────────────────────────────┐
│                    API LAYER (Supabase)                      │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  Authentication Service                                 │ │
│  │  - JWT token generation/validation                     │ │
│  │  - OAuth providers                                     │ │
│  │  - Session management                                  │ │
│  └────────────────────────────────────────────────────────┘ │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  REST API Endpoints                                    │ │
│  │  - Auto-generated from PostgREST                       │ │
│  │  - Row Level Security (RLS) policies                   │ │
│  └────────────────────────────────────────────────────────┘ │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  Real-time Subscriptions                               │ │
│  │  - WebSocket connections                               │ │
│  │  - Database change notifications                       │ │
│  └────────────────────────────────────────────────────────┘ │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  Edge Functions (Serverless)                           │ │
│  │  - Complex calculations                                │ │
│  │  - Report generation                                   │ │
│  │  - Scheduled tasks (cron jobs)                         │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                            │
                            │
┌─────────────────────────────────────────────────────────────┐
│                   DATABASE LAYER (PostgreSQL)                │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  Tables                                                │ │
│  │  - users, credit_cards, loans, mortgages              │ │
│  │  - bills, goals, snapshots                            │ │
│  │  - user_preferences, notification_settings            │ │
│  └────────────────────────────────────────────────────────┘ │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  Row Level Security Policies                          │ │
│  │  - User can only access own data                      │ │
│  │  - Soft deletes for audit trail                       │ │
│  └────────────────────────────────────────────────────────┘ │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  Database Functions & Triggers                        │ │
│  │  - Auto-update timestamps                             │ │
│  │  - Cascade deletes                                    │ │
│  │  - Data validation                                    │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                            │
                            │
┌─────────────────────────────────────────────────────────────┐
│                  EXTERNAL SERVICES                           │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────────┐│
│  │  Email   │  │ Push     │  │ Payment  │  │ Bank        ││
│  │  Service │  │ Notif.   │  │ (Stripe) │  │ (Plaid)     ││
│  └──────────┘  └──────────┘  └──────────┘  └─────────────┘│
└─────────────────────────────────────────────────────────────┘
```

### **3.2 Detailed Project Structure** {#3.2-detailed-project-structure}

```
budgetura/
│
├── .github/
│   ├── workflows/
│   │   ├── ci.yml                    # CI/CD pipeline
│   │   ├── deploy-preview.yml        # Preview deployments
│   │   └── deploy-production.yml     # Production deployments
│   └── ISSUE_TEMPLATE/
│       ├── bug_report.md
│       └── feature_request.md
│
├── public/
│   ├── icons/
│   │   ├── icon-72x72.png
│   │   ├── icon-96x96.png
│   │   ├── icon-128x128.png
│   │   ├── icon-144x144.png
│   │   ├── icon-152x152.png
│   │   ├── icon-192x192.png
│   │   ├── icon-384x384.png
│   │   └── icon-512x512.png
│   ├── screenshots/                  # For PWA
│   │   ├── desktop-1.png
│   │   ├── desktop-2.png
│   │   ├── mobile-1.png
│   │   └── mobile-2.png
│   ├── favicon.ico
│   ├── manifest.json                 # PWA manifest
│   ├── robots.txt
│   └── sitemap.xml
│
├── src/
│   ├── assets/
│   │   ├── images/
│   │   │   ├── logo.svg
│   │   │   ├── empty-states/
│   │   │   │   ├── no-credit-cards.svg
│   │   │   │   ├── no-loans.svg
│   │   │   │   ├── no-bills.svg
│   │   │   │   └── no-goals.svg
│   │   │   └── illustrations/
│   │   │       ├── debt-free.svg
│   │   │       └── celebrating.svg
│   │   └── styles/
│   │       ├── global.css            # Global styles, Tailwind imports
│   │       ├── animations.css        # Custom animations
│   │       └── print.css             # Print-specific styles
│   │
│   ├── components/
│   │   ├── common/                   # Shared/reusable components
│   │   │   ├── Avatar.tsx
│   │   │   ├── Badge.tsx
│   │   │   ├── Button.tsx
│   │   │   ├── Card.tsx
│   │   │   ├── Checkbox.tsx
│   │   │   ├── DatePicker.tsx
│   │   │   ├── Dropdown.tsx
│   │   │   ├── EmptyState.tsx
│   │   │   ├── ErrorBoundary.tsx
│   │   │   ├── ErrorMessage.tsx
│   │   │   ├── Input.tsx
│   │   │   ├── Label.tsx
│   │   │   ├── LoadingSpinner.tsx
│   │   │   ├── Modal.tsx
│   │   │   ├── Pagination.tsx
│   │   │   ├── Progress.tsx
│   │   │   ├── Select.tsx
│   │   │   ├── Skeleton.tsx
│   │   │   ├── Switch.tsx
│   │   │   ├── Table.tsx
│   │   │   ├── Tabs.tsx
│   │   │   ├── Textarea.tsx
│   │   │   ├── Toast.tsx
│   │   │   ├── Tooltip.tsx
│   │   │   └── index.ts              # Barrel export
│   │   │
│   │   ├── layout/
│   │   │   ├── Header.tsx
│   │   │   ├── Sidebar.tsx
│   │   │   ├── MobileNav.tsx
│   │   │   ├── Footer.tsx
│   │   │   ├── MainLayout.tsx
│   │   │   └── AuthLayout.tsx
│   │   │
│   │   ├── auth/
│   │   │   ├── LoginForm.tsx
│   │   │   ├── RegisterForm.tsx
│   │   │   ├── ForgotPasswordForm.tsx
│   │   │   ├── ResetPasswordForm.tsx
│   │   │   ├── ProtectedRoute.tsx
│   │   │   └── SocialLoginButtons.tsx
│   │   │
│   │   ├── dashboard/
│   │   │   ├── DashboardMetrics.tsx
│   │   │   ├── MetricCard.tsx
│   │   │   ├── DebtBreakdownChart.tsx
│   │   │   ├── ProgressOverTimeChart.tsx
│   │   │   ├── QuickActions.tsx
│   │   │   ├── RecentActivity.tsx
│   │   │   ├── UpcomingBills.tsx
│   │   │   └── GoalProgress.tsx
│   │   │
│   │   ├── credit-cards/
│   │   │   ├── CreditCardList.tsx
│   │   │   ├── CreditCardItem.tsx
│   │   │   ├── CreditCardForm.tsx
│   │   │   ├── CreditCardFormFields.tsx
│   │   │   ├── PayoffCalculator.tsx
│   │   │   ├── PayoffScenarioCard.tsx
│   │   │   ├── UtilizationGauge.tsx
│   │   │   ├── CreditCardFilters.tsx
│   │   │   ├── CreditCardSort.tsx
│   │   │   ├── BulkActions.tsx
│   │   │   ├── DeleteConfirmModal.tsx
│   │   │   └── ExportCreditCards.tsx
│   │   │
│   │   ├── loans/
│   │   │   ├── LoanList.tsx
│   │   │   ├── LoanItem.tsx
│   │   │   ├── LoanForm.tsx
│   │   │   ├── LoanFormFields.tsx
│   │   │   ├── LoanPaymentCalculator.tsx
│   │   │   ├── AmortizationSchedule.tsx
│   │   │   ├── AmortizationChart.tsx
│   │   │   ├── PayoffProjection.tsx
│   │   │   └── LoanTypeIcon.tsx
│   │   │
│   │   ├── mortgage/
│   │   │   ├── MortgageOverview.tsx
│   │   │   ├── MortgageForm.tsx
│   │   │   ├── MortgageFormFields.tsx
│   │   │   ├── MortgageDetails.tsx
│   │   │   ├── TotalHousingCost.tsx
│   │   │   ├── EquityTracker.tsx
│   │   │   ├── RefinanceCalculator.tsx
│   │   │   ├── RefinanceComparison.tsx
│   │   │   └── MortgagePayoffChart.tsx
│   │   │
│   │   ├── bills/
│   │   │   ├── BillList.tsx
│   │   │   ├── BillItem.tsx
│   │   │   ├── BillForm.tsx
│   │   │   ├── BillFormFields.tsx
│   │   │   ├── BillCalendar.tsx
│   │   │   ├── BillCalendarDay.tsx
│   │   │   ├── BillSummary.tsx
│   │   │   ├── BillCategoryChart.tsx
│   │   │   ├── EssentialVsDiscretionary.tsx
│   │   │   ├── FrequencyConverter.tsx
│   │   │   ├── UpcomingBillsWidget.tsx
│   │   │   └── BillReminders.tsx
│   │   │
│   │   ├── goals/
│   │   │   ├── GoalList.tsx
│   │   │   ├── GoalCard.tsx
│   │   │   ├── GoalForm.tsx
│   │   │   ├── GoalFormFields.tsx
│   │   │   ├── GoalProgress.tsx
│   │   │   ├── GoalProgressBar.tsx
│   │   │   ├── GoalUpdateModal.tsx
│   │   │   ├── GoalTimeline.tsx
│   │   │   ├── GoalMilestones.tsx
│   │   │   ├── GoalCelebration.tsx
│   │   │   └── GoalPriorityBadge.tsx
│   │   │
│   │   ├── snapshots/
│   │   │   ├── SnapshotHistory.tsx
│   │   │   ├── SnapshotCard.tsx
│   │   │   ├── SnapshotDetails.tsx
│   │   │   ├── CreateSnapshotButton.tsx
│   │   │   ├── SnapshotComparison.tsx
│   │   │   ├── ComparisonMetric.tsx
│   │   │   ├── SnapshotChart.tsx
│   │   │   ├── ProgressTrendChart.tsx
│   │   │   ├── AutoSnapshotSettings.tsx
│   │   │   └── SnapshotExport.tsx
│   │   │
│   │   ├── action-plan/
│   │   │   ├── ActionPlanGenerator.tsx
│   │   │   ├── MethodSelector.tsx
│   │   │   ├── CurrentSituation.tsx
│   │   │   ├── StrategyExplanation.tsx
│   │   │   ├── PayoffOrder.tsx
│   │   │   ├── PayoffOrderItem.tsx
│   │   │   ├── ActionSteps.tsx
│   │   │   ├── Milestones.tsx
│   │   │   ├── MilestoneItem.tsx
│   │   │   ├── MotivationSection.tsx
│   │   │   ├── PrintableActionPlan.tsx
│   │   │   ├── PayoffTimeline.tsx
│   │   │   ├── DebtWaterfallChart.tsx
│   │   │   └── InterestSavingsCalculator.tsx
│   │   │
│   │   ├── settings/
│   │   │   ├── ProfileSettings.tsx
│   │   │   ├── PreferencesSettings.tsx
│   │   │   ├── NotificationSettings.tsx
│   │   │   ├── SecuritySettings.tsx
│   │   │   ├── BillingSettings.tsx
│   │   │   ├── DataExport.tsx
│   │   │   ├── DeleteAccount.tsx
│   │   │   └── ThemeToggle.tsx
│   │   │
│   │   └── charts/                   # Reusable chart components
│   │       ├── LineChart.tsx
│   │       ├── BarChart.tsx
│   │       ├── PieChart.tsx
│   │       ├── AreaChart.tsx
│   │       ├── DonutChart.tsx
│   │       └── ChartTooltip.tsx
│   │
│   ├── hooks/
│   │   ├── api/                      # Data fetching hooks
│   │   │   ├── useAuth.ts
│   │   │   ├── useCreditCards.ts
│   │   │   ├── useLoans.ts
│   │   │   ├── useMortgages.ts
│   │   │   ├── useBills.ts
│   │   │   ├── useGoals.ts
│   │   │   ├── useSnapshots.ts
│   │   │   ├── useDashboard.ts
│   │   │   ├── useActionPlan.ts
│   │   │   └── useUserProfile.ts
│   │   │
│   │   ├── calculations/             # Calculation hooks
│   │   │   ├── useCreditCardCalculations.ts
│   │   │   ├── useLoanCalculations.ts
│   │   │   ├── useMortgageCalculations.ts
│   │   │   ├── useDTICalculation.ts
│   │   │   ├── useUtilizationCalculation.ts
│   │   │   └── usePayoffProjections.ts
│   │   │
│   │   └── utilities/                # Utility hooks
│   │       ├── useDebounce.ts
│   │       ├── useLocalStorage.ts
│   │       ├── useMediaQuery.ts
│   │       ├── useOnClickOutside.ts
│   │       ├── usePagination.ts
│   │       ├── usePrevious.ts
│   │       ├── useToggle.ts
│   │       └── useWindowSize.ts
│   │
│   ├── lib/
│   │   ├── api/
│   │   │   ├── client.ts             # Base API client
│   │   │   ├── auth.ts               # Auth API
│   │   │   ├── creditCards.ts        # Credit cards API
│   │   │   ├── loans.ts              # Loans API
│   │   │   ├── mortgages.ts          # Mortgages API
│   │   │   ├── bills.ts              # Bills API
│   │   │   ├── goals.ts              # Goals API
│   │   │   ├── snapshots.ts          # Snapshots API
│   │   │   ├── dashboard.ts          # Dashboard API
│   │   │   └── users.ts              # User management API
│   │   │
│   │   ├── calculations/
│   │   │   ├── creditCard.ts
│   │   │   │   ├── calculateMonthsToPayoff()
│   │   │   │   ├── calculateTotalInterest()
│   │   │   │   ├── calculateUtilization()
│   │   │   │   ├── calculatePayoffDate()
│   │   │   │   └── calculatePayoffScenarios()
│   │   │   │
│   │   │   ├── loan.ts
│   │   │   │   ├── calculateLoanPayment()
│   │   │   │   ├── calculateRemainingBalance()
│   │   │   │   ├── generateAmortizationSchedule()
│   │   │   │   └── calculateEarlyPayoffSavings()
│   │   │   │
│   │   │   ├── mortgage.ts
│   │   │   │   ├── calculateMortgagePayment()
│   │   │   │   ├── calculateTotalHousingCost()
│   │   │   │   ├── calculateEquity()
│   │   │   │   ├── calculateLTV()
│   │   │   │   └── compareRefinanceScenarios()
│   │   │   │
│   │   │   ├── dti.ts
│   │   │   │   ├── calculateDTI()
│   │   │   │   ├── calculateTotalMonthlyDebtPayments()
│   │   │   │   └── getDTIRating()
│   │   │   │
│   │   │   ├── utilization.ts
│   │   │   │   ├── calculateOverallUtilization()
│   │   │   │   ├── calculatePerCardUtilization()
│   │   │   │   └── getUtilizationRating()
│   │   │   │
│   │   │   ├── debtPayoff.ts
│   │   │   │   ├── generateAvalancheOrder()
│   │   │   │   ├── generateSnowballOrder()
│   │   │   │   ├── calculateDebtFreeDate()
│   │   │   │   ├── calculateTotalInterestSavings()
│   │   │   │   └── generatePayoffTimeline()
│   │   │   │
│   │   │   └── goals.ts
│   │   │       ├── calculateRemainingAmount()
│   │   │       ├── calculateMonthsToGoal()
│   │   │       ├── calculateProgressPercentage()
│   │   │       └── estimateCompletionDate()
│   │   │
│   │   ├── utils/
│   │   │   ├── constants.ts
│   │   │   │   ├── LOAN_TYPES
│   │   │   │   ├── BILL_CATEGORIES
│   │   │   │   ├── BILL_FREQUENCIES
│   │   │   │   ├── GOAL_TYPES
│   │   │   │   ├── PRIORITY_LEVELS
│   │   │   │   └── STATUS_OPTIONS
│   │   │   │
│   │   │   ├── formatters.ts
│   │   │   │   ├── formatCurrency()
│   │   │   │   ├── formatPercentage()
│   │   │   │   ├── formatDate()
│   │   │   │   ├── formatShortDate()
│   │   │   │   ├── formatNumber()
│   │   │   │   └── formatPhoneNumber()
│   │   │   │
│   │   │   ├── validators.ts
│   │   │   │   ├── isValidEmail()
│   │   │   │   ├── isValidPassword()
│   │   │   │   ├── isValidCurrency()
│   │   │   │   ├── isValidPercentage()
│   │   │   │   └── isValidDate()
│   │   │   │
│   │   │   ├── helpers.ts
│   │   │   │   ├── cn() (className merger)
│   │   │   │   ├── generateId()
│   │   │   │   ├── groupBy()
│   │   │   │   ├── sortBy()
│   │   │   │   └── debounce()
│   │   │   │
│   │   │   └── errors.ts
│   │   │       ├── ApiError class
│   │   │       ├── ValidationError class
│   │   │       ├── AuthError class
│   │   │       └── NetworkError class
│   │   │
│   │   ├── supabase.ts               # Supabase client setup
│   │   ├── queryClient.ts            # React Query setup
│   │   └── schemas/                  # Zod schemas
│   │       ├── auth.schema.ts
│   │       ├── creditCard.schema.ts
│   │       ├── loan.schema.ts
│   │       ├── mortgage.schema.ts
│   │       ├── bill.schema.ts
│   │       ├── goal.schema.ts
│   │       └── user.schema.ts
│   │
│   ├── pages/
│   │   ├── Dashboard.tsx
│   │   ├── CreditCards.tsx
│   │   ├── CreditCardNew.tsx
│   │   ├── CreditCardEdit.tsx
│   │   ├── Loans.tsx
│   │   ├── LoanNew.tsx
│   │   ├── LoanEdit.tsx
│   │   ├── Mortgage.tsx
│   │   ├── MortgageNew.tsx
│   │   ├── MortgageEdit.tsx
│   │   ├── Bills.tsx
│   │   ├── BillNew.tsx
│   │   ├── BillEdit.tsx
│   │   ├── Goals.tsx
│   │   ├── GoalNew.tsx
│   │   ├── GoalEdit.tsx
│   │   ├── Snapshots.tsx
│   │   ├── SnapshotDetail.tsx
│   │   ├── ActionPlan.tsx
│   │   ├── Settings.tsx
│   │   ├── Profile.tsx
│   │   ├── Preferences.tsx
│   │   ├── Notifications.tsx
│   │   ├── Billing.tsx
│   │   ├── Login.tsx
│   │   ├── Register.tsx
│   │   ├── ForgotPassword.tsx
│   │   ├── ResetPassword.tsx
│   │   ├── EmailVerification.tsx
│   │   ├── NotFound.tsx
│   │   └── ServerError.tsx
│   │
│   ├── store/                        # Zustand stores
│   │   ├── index.ts
│   │   ├── authStore.ts
│   │   ├── uiStore.ts
│   │   ├── preferenceStore.ts
│   │   └── notificationStore.ts
│   │
│   ├── types/
│   │   ├── index.ts                  # Main exports
│   │   ├── auth.ts
│   │   ├── user.ts
│   │   ├── creditCard.ts
│   │   ├── loan.ts
│   │   ├── mortgage.ts
│   │   ├── bill.ts
│   │   ├── goal.ts
│   │   ├── snapshot.ts
│   │   ├── dashboard.ts
│   │   ├── actionPlan.ts
│   │   └── api.ts
│   │
│   ├── App.tsx
│   ├── main.tsx
│   ├── router.tsx                    # Route configuration
│   └── vite-env.d.ts
│
├── tests/
│   ├── unit/
│   │   ├── calculations/
│   │   │   ├── creditCard.test.ts
│   │   │   ├── loan.test.ts
│   │   │   ├── mortgage.test.ts
│   │   │   ├── dti.test.ts
│   │   │   └── utilization.test.ts
│   │   │
│   │   ├── utils/
│   │   │   ├── formatters.test.ts
│   │   │   ├── validators.test.ts
│   │   │   └── helpers.test.ts
│   │   │
│   │   └── hooks/
│   │       └── useCreditCardCalculations.test.ts
│   │
│   ├── integration/
│   │   ├── components/
│   │   │   ├── CreditCardForm.test.tsx
│   │   │   ├── LoanForm.test.tsx
│   │   │   └── Dashboard.test.tsx
│   │   │
│   │   └── api/
│   │       ├── creditCards.test.ts
│   │       └── auth.test.ts
│   │
│   ├── e2e/
│   │   ├── auth.spec.ts
│   │   ├── credit-cards.spec.ts
│   │   ├── loans.spec.ts
│   │   ├── dashboard.spec.ts
│   │   └── action-plan.spec.ts
│   │
│   └── setup.ts
│
├── supabase/                         # Supabase migrations & functions
│   ├── migrations/
│   │   ├── 20250101000000_initial_schema.sql
│   │   ├── 20250101000001_create_users_table.sql
│   │   ├── 20250101000002_create_credit_cards_table.sql
│   │   ├── 20250101000003_create_loans_table.sql
│   │   ├── 20250101000004_create_mortgages_table.sql
│   │   ├── 20250101000005_create_bills_table.sql
│   │   ├── 20250101000006_create_goals_table.sql
│   │   ├── 20250101000007_create_snapshots_table.sql
│   │   ├── 20250101000008_enable_rls.sql
│   │   └── 20250101000009_create_indexes.sql
│   │
│   ├── functions/
│   │   ├── create-snapshot/
│   │   │   ├── index.ts
│   │   │   └── package.json
│   │   │
│   │   ├── generate-report/
│   │   │   ├── index.ts
│   │   │   └── package.json
│   │   │
│   │   └── scheduled-snapshots/
│   │       ├── index.ts
│   │       └── package.json
│   │
│   └── seed.sql                      # Sample data for development
│
├── .env.example
├── .env.local
├── .eslintrc.json
├── .prettierrc
├── .gitignore
├── .husky/
│   ├── pre-commit
│   └── commit-msg
├── commitlint.config.js
├── index.html
├── package.json
├── pnpm-lock.yaml
├── playwright.config.ts
├── postcss.config.js
├── README.md
├── tailwind.config.js
├── tsconfig.json
├── tsconfig.node.json
├── vercel.json
├── vite.config.ts
└── vitest.config.ts
```

### **3.3 Component Architecture & Design Patterns** {#3.3-component-architecture-&-design-patterns}

**Atomic Design Principles:**

```
Atoms (Smallest building blocks)
├── Button
├── Input
├── Label
├── Badge
├── Avatar
├── Icon
└── Spinner

Molecules (Combinations of atoms)
├── FormField (Label + Input + ErrorMessage)
├── SearchBar (Input + Icon + Button)
├── MetricCard (Card + Icon + Text + Number)
└── ProgressBar (Container + Fill + Label)

Organisms (Complex components)
├── CreditCardForm (Multiple FormFields + Buttons)
├── PayoffCalculator (Multiple MetricCards + Chart)
├── DataTable (Table + Pagination + Filters)
└── NavigationBar (Logo + Links + UserMenu)

Templates (Page-level layouts)
├── MainLayout (Header + Sidebar + Content + Footer)
├── AuthLayout (Centered content with background)
└── SettingsLayout (Tabs + Content area)

Pages (Specific instances)
├── Dashboard (Template + specific organisms)
├── CreditCards (Template + CreditCardList + CreditCardForm)
└── Settings (SettingsLayout + specific forms)
```

**Component Composition Pattern:**

```ts
// Example: Composable Card Component

// Base Card
export const Card = ({ children, className }) => (
  <div className={cn("bg-white rounded-lg shadow-md p-6", className)}>
    {children}
  </div>
);

// Card Header
Card.Header = ({ children, className }) => (
  <div className={cn("mb-4", className)}>{children}</div>
);

// Card Title
Card.Title = ({ children, className }) => (
  <h3 className={cn("text-xl font-bold text-gray-900", className)}>
    {children}
  </h3>
);

// Card Description
Card.Description = ({ children, className }) => (
  <p className={cn("text-sm text-gray-600", className)}>{children}</p>
);

// Card Content
Card.Content = ({ children, className }) => (
  <div className={cn("", className)}>{children}</div>
);

// Card Footer
Card.Footer = ({ children, className }) => (
  <div className={cn("mt-6 pt-4 border-t border-gray-200", className)}>
    {children}
  </div>
);

// Usage:
<Card>
  <Card.Header>
    <Card.Title>Total Debt</Card.Title>
    <Card.Description>All your outstanding debts</Card.Description>
  </Card.Header>
  <Card.Content>
    <p className="text-3xl font-bold">{formatCurrency(totalDebt)}</p>
  </Card.Content>
  <Card.Footer>
    <Button size="sm">View Details</Button>
  </Card.Footer>
</Card>
```

### **3.4 State Management Architecture** {#3.4-state-management-architecture}

```ts
// Global State (Zustand) - UI & Auth State
├── authStore
│   ├── user: User | null
│   ├── isAuthenticated: boolean
│   ├── isLoading: boolean
│   ├── signIn()
│   ├── signOut()
│   └── updateUser()
│
├── uiStore
│   ├── sidebarOpen: boolean
│   ├── currentModal: string | null
│   ├── toasts: Toast[]
│   ├── toggleSidebar()
│   ├── openModal()
│   ├── closeModal()
│   └── addToast()
│
└── preferenceStore
    ├── theme: 'light' | 'dark'
    ├── currency: string
    ├── dateFormat: string
    ├── payoffMethod: 'avalanche' | 'snowball'
    ├── setTheme()
    └── updatePreferences()

// Server State (React Query) - API Data
├── queries
│   ├── ['user'] → User profile data
│   ├── ['dashboard'] → Dashboard metrics
│   ├── ['creditCards'] → All credit cards
│   ├── ['creditCard', id] → Single credit card
│   ├── ['loans'] → All loans
│   ├── ['loan', id] → Single loan
│   ├── ['mortgages'] → All mortgages
│   ├── ['bills'] → All bills
│   ├── ['goals'] → All goals
│   └── ['snapshots'] → Snapshot history
│
└── mutations
    ├── createCreditCard
    ├── updateCreditCard
    ├── deleteCreditCard
    ├── createLoan
    ├── updateLoan
    ├── deleteLoan
    └── createSnapshot

// Local Component State (useState)
└── Component-specific UI state
    ├── Form inputs
    ├── Expanded/collapsed states
    ├── Temporary selections
    └── Local filters
```

**Example State Usage:**

```ts
// Dashboard.tsx
const Dashboard = () => {
  // Global auth state (Zustand)
  const { user } = useAuthStore();
  
  // Server state (React Query)
  const { data: dashboardData, isLoading } = useQuery({
    queryKey: ['dashboard'],
    queryFn: () => dashboardAPI.getData(user.id),
    staleTime: 1000 * 60 * 5, // 5 minutes
  });
  
  // Local UI state (useState)
  const [selectedTimeRange, setSelectedTimeRange] = useState('30d');
  
  // Derived state (useMemo)
  const filteredData = useMemo(() => {
    return filterByTimeRange(dashboardData, selectedTimeRange);
  }, [dashboardData, selectedTimeRange]);
  
  return (
    // JSX
  );
};
```

### **3.5 Data Flow Architecture** {#3.5-data-flow-architecture}

```
┌─────────────────────────────────────────────────────────────┐
│                     USER INTERACTION                         │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  User clicks "Add Credit Card" button                   │ │
│  └────────────────┬────────────────────────────────────────┘ │
└───────────────────┼──────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│                  COMPONENT EVENT HANDLER                     │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  const handleSubmit = async (data) => {                │ │
│  │    await createCreditCard(data);                       │ │
│  │  }                                                      │ │
│  └────────────────┬────────────────────────────────────────┘ │
└───────────────────┼──────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│                     CUSTOM HOOK                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  export const useCreditCards = () => {                 │ │
│  │    const mutation = useMutation({                      │ │
│  │      mutationFn: creditCardsAPI.create,               │ │
│  │      onSuccess: () => {                               │ │
│  │        queryClient.invalidateQueries(['creditCards']) │ │
│  │        toast.success('Card added!')                   │ │
│  │      }                                                 │ │
│  │    });                                                 │ │
│  │    return { createCreditCard: mutation.mutate };      │ │
│  │  }                                                     │ │
│  └────────────────┬────────────────────────────────────────┘ │
└───────────────────┼──────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│                      API CLIENT                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  export const creditCardsAPI = {                       │ │
│  │    create: async (data) => {                          │ │
│  │      const { data: result } = await supabase          │ │
│  │        .from('credit_cards')                          │ │
│  │        .insert(data)                                  │ │
│  │        .select()                                      │ │
│  │        .single();                                     │ │
│  │      return result;                                   │ │
│  │    }                                                   │ │
│  │  }                                                     │ │
│  └────────────────┬────────────────────────────────────────┘ │
└───────────────────┼──────────────────────────────────────────┘
                    │
                    ▼ HTTP POST
┌─────────────────────────────────────────────────────────────┐
│                    SUPABASE API                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  POST /rest/v1/credit_cards                           │ │
│  │  Authorization: Bearer <JWT>                          │ │
│  │  Body: { cardName, balance, ... }                    │ │
│  └────────────────┬────────────────────────────────────────┘ │
└───────────────────┼──────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│                  ROW LEVEL SECURITY                          │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  Policy: Users can only INSERT their own records      │ │
│  │  CREATE POLICY insert_own_cards                       │ │
│  │  ON credit_cards FOR INSERT                           │ │
│  │  WITH CHECK (auth.uid() = user_id);                  │ │
│  └────────────────┬────────────────────────────────────────┘ │
└───────────────────┼──────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│                  POSTGRESQL DATABASE                         │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  INSERT INTO credit_cards (                           │ │
│  │    user_id, card_name, balance, ...                   │ │
│  │  ) VALUES (                                            │ │
│  │    'uuid', 'Chase Freedom', 3500, ...                 │ │
│  │  ) RETURNING *;                                        │ │
│  └────────────────┬────────────────────────────────────────┘ │
└───────────────────┼──────────────────────────────────────────┘
                    │
                    ▼ Return new record
┌─────────────────────────────────────────────────────────────┐
│                  REACT QUERY CACHE                           │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  1. Invalidate ['creditCards'] query                   │ │
│  │  2. Refetch data automatically                         │ │
│  │  3. Update UI with new data                            │ │
│  └────────────────┬────────────────────────────────────────┘ │
└───────────────────┼──────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│                      UI UPDATE                               │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  - Toast notification appears                          │ │
│  │  - New card appears in list                            │ │
│  │  - Dashboard metrics update                            │ │
│  │  - Form resets                                         │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

---

## **4\. Database Schema** {#4.-database-schema}

### **4.1 Complete Database Design (PostgreSQL via Supabase)** {#4.1-complete-database-design-(postgresql-via-supabase)}

#### **4.1.1 Users Table** {#4.1.1-users-table}

**Purpose:** Store core user account information and global preferences

```sql
CREATE TABLE users (
    -- Primary Key
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Authentication
    email VARCHAR(255) UNIQUE NOT NULL,
    email_verified BOOLEAN DEFAULT FALSE,
    email_verified_at TIMESTAMP,
    password_hash VARCHAR(255) NOT NULL,
    
    -- Profile Information
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    avatar_url TEXT,
    phone_number VARCHAR(20),
    date_of_birth DATE,
    
    -- Financial Settings
    monthly_income DECIMAL(10, 2) DEFAULT 0.00,
    target_debt_free_date DATE,
    preferred_payoff_method VARCHAR(20) DEFAULT 'avalanche',
    currency VARCHAR(3) DEFAULT 'USD',
    locale VARCHAR(10) DEFAULT 'en-US',
    
    -- Subscription & Billing
    subscription_tier VARCHAR(20) DEFAULT 'free',
    subscription_status VARCHAR(20) DEFAULT 'active',
    stripe_customer_id VARCHAR(255),
    trial_ends_at TIMESTAMP,
    subscribed_at TIMESTAMP,
    
    -- Preferences
    theme VARCHAR(10) DEFAULT 'light',
    timezone VARCHAR(50) DEFAULT 'America/New_York',
    date_format VARCHAR(20) DEFAULT 'MM/DD/YYYY',
    
    -- Notifications
    email_notifications BOOLEAN DEFAULT TRUE,
    push_notifications BOOLEAN DEFAULT TRUE,
    sms_notifications BOOLEAN DEFAULT FALSE,
    
    -- Timestamps
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    last_login_at TIMESTAMP,
    deleted_at TIMESTAMP,
    
    -- Constraints
    CONSTRAINT subscription_tier_check CHECK (
        subscription_tier IN ('free', 'premium', 'family')
    ),
    CONSTRAINT subscription_status_check CHECK (
        subscription_status IN ('active', 'canceled', 'past_due', 'trialing')
    ),
    CONSTRAINT payoff_method_check CHECK (
        preferred_payoff_method IN ('avalanche', 'snowball', 'custom')
    ),
    CONSTRAINT theme_check CHECK (theme IN ('light', 'dark', 'auto'))
);

-- Indexes for performance
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_stripe_customer_id ON users(stripe_customer_id);
CREATE INDEX idx_users_subscription_tier ON users(subscription_tier);
CREATE INDEX idx_users_deleted_at ON users(deleted_at) WHERE deleted_at IS NULL;

-- Auto-update timestamp trigger
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_users_updated_at
    BEFORE UPDATE ON users
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- Row Level Security
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- Policy: Users can only read/update their own record
CREATE POLICY users_select_own
    ON users FOR SELECT
    USING (auth.uid() = id);

CREATE POLICY users_update_own
    ON users FOR UPDATE
    USING (auth.uid() = id);

-- Policy: No direct inserts (handled by Supabase Auth)
CREATE POLICY users_no_insert
    ON users FOR INSERT
    WITH CHECK (false);

-- Policy: Soft delete only
CREATE POLICY users_soft_delete
    ON users FOR UPDATE
    USING (auth.uid() = id)
    WITH CHECK (deleted_at IS NOT NULL);
```

**Field Descriptions:**

| Field Name | Type | Nullable | Description | Example |
| ----- | ----- | ----- | ----- | ----- |
| id | UUID | No | Primary key, auto-generated | `a1b2c3d4-e5f6-7890-abcd-ef1234567890` |
| email | VARCHAR(255) | No | User's email (unique) | `john.doe@example.com` |
| email\_verified | BOOLEAN | No | Email verification status | `true` |
| email\_verified\_at | TIMESTAMP | Yes | When email was verified | `2025-01-15 10:30:00` |
| password\_hash | VARCHAR(255) | No | Bcrypt hashed password | `$2b$10$...` |
| first\_name | VARCHAR(100) | Yes | User's first name | `John` |
| last\_name | VARCHAR(100) | Yes | User's last name | `Doe` |
| avatar\_url | TEXT | Yes | Profile picture URL | `https://storage.../avatar.jpg` |
| phone\_number | VARCHAR(20) | Yes | Phone number (E.164 format) | `+14155552671` |
| date\_of\_birth | DATE | Yes | Birth date (for age verification) | `1990-05-15` |
| monthly\_income | DECIMAL(10,2) | No | Gross monthly income | `4500.00` |
| target\_debt\_free\_date | DATE | Yes | Goal date to be debt-free | `2028-12-31` |
| preferred\_payoff\_method | VARCHAR(20) | No | Default payoff strategy | `avalanche` |
| currency | VARCHAR(3) | No | ISO 4217 currency code | `USD` |
| locale | VARCHAR(10) | No | Locale for formatting | `en-US` |
| subscription\_tier | VARCHAR(20) | No | Current plan | `premium` |
| subscription\_status | VARCHAR(20) | No | Subscription state | `active` |
| stripe\_customer\_id | VARCHAR(255) | Yes | Stripe customer ID | `cus_123456789` |
| trial\_ends\_at | TIMESTAMP | Yes | Trial expiration | `2025-02-14 23:59:59` |
| subscribed\_at | TIMESTAMP | Yes | When user subscribed | `2025-01-15 14:20:00` |
| theme | VARCHAR(10) | No | UI theme preference | `dark` |
| timezone | VARCHAR(50) | No | User's timezone | `America/Los_Angeles` |
| date\_format | VARCHAR(20) | No | Preferred date format | `MM/DD/YYYY` |
| email\_notifications | BOOLEAN | No | Email notifications enabled | `true` |
| push\_notifications | BOOLEAN | No | Push notifications enabled | `true` |
| sms\_notifications | BOOLEAN | No | SMS notifications enabled | `false` |
| created\_at | TIMESTAMP | No | Account creation time | `2025-01-15 09:00:00` |
| updated\_at | TIMESTAMP | No | Last update time | `2025-01-20 15:30:00` |
| last\_login\_at | TIMESTAMP | Yes | Last successful login | `2025-01-20 08:15:00` |
| deleted\_at | TIMESTAMP | Yes | Soft delete timestamp | `null` (not deleted) |

#### **4.1.2 Credit Cards Table** {#4.1.2-credit-cards-table}

**Purpose:** Store individual credit card information with complete financial details

```sql
CREATE TABLE credit_cards (
    -- Primary Key
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Foreign Key
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- Card Information
    card_name VARCHAR(255) NOT NULL,
    issuer VARCHAR(100),
    last_four_digits VARCHAR(4),
    card_type VARCHAR(20),
    network VARCHAR(20),
    
    -- Financial Details
    balance DECIMAL(10, 2) NOT NULL,
    credit_limit DECIMAL(10, 2) NOT NULL,
    interest_rate DECIMAL(5, 2) NOT NULL,
    annual_fee DECIMAL(10, 2) DEFAULT 0.00,
    
    -- Payment Information
    minimum_payment DECIMAL(10, 2) NOT NULL,
    minimum_payment_percentage DECIMAL(5, 2),
    extra_payment DECIMAL(10, 2) DEFAULT 0.00,
    due_date INTEGER,
    statement_date INTEGER,
    auto_pay BOOLEAN DEFAULT FALSE,
    
    -- Rewards & Benefits
    rewards_program VARCHAR(100),
    cashback_rate DECIMAL(5, 2),
    points_balance INTEGER DEFAULT 0,
    
    -- Status & Notes
    status VARCHAR(20) DEFAULT 'active',
    notes TEXT,
    
    -- Calculated Fields (can be generated columns or computed)
    utilization_percentage DECIMAL(5, 2) GENERATED ALWAYS AS (
        CASE 
            WHEN credit_limit > 0 THEN (balance / credit_limit * 100)
            ELSE 0 
        END
    ) STORED,
    
    available_credit DECIMAL(10, 2) GENERATED ALWAYS AS (
        GREATEST(credit_limit - balance, 0)
    ) STORED,
    
    -- Timestamps
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    opened_date DATE,
    closed_date DATE,
    
    -- Constraints
    CONSTRAINT balance_positive CHECK (balance >= 0),
    CONSTRAINT credit_limit_positive CHECK (credit_limit > 0),
    CONSTRAINT balance_lte_credit_limit CHECK (balance <= credit_limit * 1.1),
    CONSTRAINT interest_rate_range CHECK (interest_rate >= 0 AND interest_rate <= 100),
    CONSTRAINT minimum_payment_positive CHECK (minimum_payment >= 0),
    CONSTRAINT extra_payment_positive CHECK (extra_payment >= 0),
    CONSTRAINT due_date_range CHECK (due_date IS NULL OR (due_date >= 1 AND due_date <= 31)),
    CONSTRAINT statement_date_range CHECK (statement_date IS NULL OR (statement_date >= 1 AND statement_date <= 31)),
    CONSTRAINT status_check CHECK (status IN ('active', 'paid_off', 'closed', 'frozen')),
    CONSTRAINT card_type_check CHECK (card_type IS NULL OR card_type IN ('credit', 'charge', 'secured')),
    CONSTRAINT network_check CHECK (network IS NULL OR network IN ('Visa', 'Mastercard', 'Amex', 'Discover', 'Other'))
);

-- Indexes
CREATE INDEX idx_credit_cards_user_id ON credit_cards(user_id);
CREATE INDEX idx_credit_cards_status ON credit_cards(status);
CREATE INDEX idx_credit_cards_user_status ON credit_cards(user_id, status);
CREATE INDEX idx_credit_cards_due_date ON credit_cards(due_date) WHERE status = 'active';
CREATE INDEX idx_credit_cards_utilization ON credit_cards(utilization_percentage) WHERE status = 'active';

-- Auto-update timestamp trigger
CREATE TRIGGER update_credit_cards_updated_at
    BEFORE UPDATE ON credit_cards
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- Trigger to update status when balance reaches zero
CREATE OR REPLACE FUNCTION check_credit_card_paid_off()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.balance = 0 AND OLD.balance > 0 AND NEW.status = 'active' THEN
        NEW.status = 'paid_off';
        NEW.closed_date = CURRENT_DATE;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER credit_card_paid_off_check
    BEFORE UPDATE ON credit_cards
    FOR EACH ROW
    EXECUTE FUNCTION check_credit_card_paid_off();

-- Row Level Security
ALTER TABLE credit_cards ENABLE ROW LEVEL SECURITY;

-- Policy: Users can only access their own credit cards
CREATE POLICY credit_cards_select_own
    ON credit_cards FOR SELECT
    USING (auth.uid() = user_id);

CREATE POLICY credit_cards_insert_own
    ON credit_cards FOR INSERT
    WITH CHECK (auth.uid() = user_id);

CREATE POLICY credit_cards_update_own
    ON credit_cards FOR UPDATE
    USING (auth.uid() = user_id);

CREATE POLICY credit_cards_delete_own
    ON credit_cards FOR DELETE
    USING (auth.uid() = user_id);
```

**Field Descriptions:**

| Field Name | Type | Required | Description | Example Value |
| ----- | ----- | ----- | ----- | ----- |
| id | UUID | Yes | Primary key | `a1b2c3d4-...` |
| user\_id | UUID | Yes | Owner of this card | `user-uuid-123` |
| card\_name | VARCHAR(255) | Yes | User-friendly name/identifier | `Chase Freedom Unlimited` |
| issuer | VARCHAR(100) | No | Bank/issuer name | `JPMorgan Chase Bank` |
| last\_four\_digits | VARCHAR(4) | No | Last 4 digits for identification | `1234` |
| card\_type | VARCHAR(20) | No | Type of credit card | `credit` |
| network | VARCHAR(20) | No | Payment network | `Visa` |
| balance | DECIMAL(10,2) | Yes | Current balance owed | `3500.00` |
| credit\_limit | DECIMAL(10,2) | Yes | Maximum credit limit | `5000.00` |
| interest\_rate | DECIMAL(5,2) | Yes | Annual percentage rate | `18.99` |
| annual\_fee | DECIMAL(10,2) | No | Yearly fee | `95.00` |
| minimum\_payment | DECIMAL(10,2) | Yes | Required minimum payment | `75.00` |
| minimum\_payment\_percentage | DECIMAL(5,2) | No | Min payment as % of balance | `2.00` |
| extra\_payment | DECIMAL(10,2) | No | Additional payment amount | `200.00` |
| due\_date | INTEGER | No | Day of month payment due (1-31) | `15` |
| statement\_date | INTEGER | No | Day statement generates | `20` |
| auto\_pay | BOOLEAN | No | Auto-payment enabled | `true` |
| rewards\_program | VARCHAR(100) | No | Rewards program name | `Chase Ultimate Rewards` |
| cashback\_rate | DECIMAL(5,2) | No | Cashback percentage | `1.50` |
| points\_balance | INTEGER | No | Current points/miles | `25000` |
| status | VARCHAR(20) | Yes | Card status | `active` |
| notes | TEXT | No | User notes | `Use for groceries only` |
| utilization\_percentage | DECIMAL(5,2) | Computed | (balance/limit)\*100 | `70.00` |
| available\_credit | DECIMAL(10,2) | Computed | credit\_limit \- balance | `1500.00` |
| created\_at | TIMESTAMP | Yes | Record creation time | `2025-01-15 10:00:00` |
| updated\_at | TIMESTAMP | Yes | Last modification time | `2025-01-20 14:30:00` |
| opened\_date | DATE | No | When card was opened | `2020-03-15` |
| closed\_date | DATE | No | When card was closed | `null` |

**Status Values:**

* `active`: Card is currently being used  
* `paid_off`: Balance is $0 but card is still open  
* `closed`: Card account is closed  
* `frozen`: Temporarily frozen (fraud, etc.)

#### **4.1.3 Loans Table** {#4.1.3-loans-table}

**Purpose:** Track personal loans, auto loans, student loans, and other installment debt

```sql
CREATE TABLE loans (
    -- Primary Key
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Foreign Key
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- Loan Information
    loan_name VARCHAR(255) NOT NULL,
    loan_type VARCHAR(50) NOT NULL,
    lender VARCHAR(100),
    account_number VARCHAR(50),
    
    -- Financial Details
    principal DECIMAL(12, 2) NOT NULL,
    current_balance DECIMAL(12, 2) NOT NULL,
    interest_rate DECIMAL(5, 2) NOT NULL,
    term_months INTEGER NOT NULL,
    monthly_payment DECIMAL(10, 2) NOT NULL,
    extra_payment DECIMAL(10, 2) DEFAULT 0.00,
    
    -- Dates
    start_date DATE NOT NULL,
    maturity_date DATE,
    first_payment_date DATE,
    
    -- Payment Details
    payment_day INTEGER,
    auto_pay BOOLEAN DEFAULT FALSE,
    prepayment_penalty BOOLEAN DEFAULT FALSE,
    prepayment_penalty_amount DECIMAL(10, 2),
    
    -- Collateral (for secured loans)
    is_secured BOOLEAN DEFAULT FALSE,
    collateral_type VARCHAR(50),
    collateral_value DECIMAL(12, 2),
    
    -- Status & Notes
    status VARCHAR(20) DEFAULT 'active',
    notes TEXT,
    
    -- Calculated Fields
    remaining_months INTEGER GENERATED ALWAYS AS (
        CASE 
            WHEN current_balance > 0 AND monthly_payment > 0 
            THEN CEIL(current_balance::NUMERIC / monthly_payment::NUMERIC)
            ELSE 0
        END
    ) STORED,
    
    principal_paid DECIMAL(12, 2) GENERATED ALWAYS AS (
        principal - current_balance
    ) STORED,
    
    payoff_percentage DECIMAL(5, 2) GENERATED ALWAYS AS (
        CASE 
            WHEN principal > 0 
            THEN ((principal - current_balance) / principal * 100)
            ELSE 0
        END
    ) STORED,
    
    -- Timestamps
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    paid_off_date DATE,
    
    -- Constraints
    CONSTRAINT principal_positive CHECK (principal > 0),
    CONSTRAINT balance_positive CHECK (current_balance >= 0),
    CONSTRAINT balance_lte_principal CHECK (current_balance <= principal),
    CONSTRAINT interest_rate_range CHECK (interest_rate >= 0 AND interest_rate <= 100),
    CONSTRAINT term_positive CHECK (term_months > 0),
    CONSTRAINT monthly_payment_positive CHECK (monthly_payment > 0),
    CONSTRAINT extra_payment_positive CHECK (extra_payment >= 0),
    CONSTRAINT payment_day_range CHECK (payment_day IS NULL OR (payment_day >= 1 AND payment_day <= 31)),
    CONSTRAINT loan_type_check CHECK (loan_type IN ('personal', 'auto', 'student', 'home_equity', 'business', 'other')),
    CONSTRAINT status_check CHECK (status IN ('active', 'deferred', 'paid_off', 'defaulted', 'in_forbearance')),
    CONSTRAINT collateral_type_check CHECK (
        collateral_type IS NULL OR 
        collateral_type IN ('vehicle', 'real_estate', 'securities', 'equipment', 'other')
    )
);

-- Indexes
CREATE INDEX idx_loans_user_id ON loans(user_id);
CREATE INDEX idx_loans_status ON loans(status);
CREATE INDEX idx_loans_loan_type ON loans(loan_type);
CREATE INDEX idx_loans_user_status ON loans(user_id, status);
CREATE INDEX idx_loans_maturity_date ON loans(maturity_date) WHERE status = 'active';

-- Auto-update timestamp trigger
CREATE TRIGGER update_loans_updated_at
    BEFORE UPDATE ON loans
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- Trigger to mark as paid off when balance reaches zero
CREATE OR REPLACE FUNCTION check_loan_paid_off()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.current_balance = 0 AND OLD.current_balance > 0 AND NEW.status = 'active' THEN
        NEW.status = 'paid_off';
        NEW.paid_off_date = CURRENT_DATE;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER loan_paid_off_check
    BEFORE UPDATE ON loans
    FOR EACH ROW
    EXECUTE FUNCTION check_loan_paid_off();

-- Row Level Security
ALTER TABLE loans ENABLE ROW LEVEL SECURITY;

CREATE POLICY loans_select_own ON loans FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY loans_insert_own ON loans FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY loans_update_own ON loans FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY loans_delete_own ON loans FOR DELETE USING (auth.uid() = user_id);
```

**Field Descriptions:**

| Field Name | Type | Required | Description | Example Value |
| ----- | ----- | ----- | ----- | ----- |
| id | UUID | Yes | Primary key | `a1b2c3d4-...` |
| user\_id | UUID | Yes | Owner of this loan | `user-uuid-123` |
| loan\_name | VARCHAR(255) | Yes | User-friendly identifier | `Auto Loan - Honda Civic` |
| loan\_type | VARCHAR(50) | Yes | Category of loan | `auto` |
| lender | VARCHAR(100) | No | Financial institution | `Wells Fargo Bank` |
| account\_number | VARCHAR(50) | No | Account/loan number | `12345678` |
| principal | DECIMAL(12,2) | Yes | Original loan amount | `25000.00` |
| current\_balance | DECIMAL(12,2) | Yes | Remaining balance | `18500.00` |
| interest\_rate | DECIMAL(5,2) | Yes | Annual interest rate | `5.75` |
| term\_months | INTEGER | Yes | Original term in months | `60` |
| monthly\_payment | DECIMAL(10,2) | Yes | Required monthly payment | `480.00` |
| extra\_payment | DECIMAL(10,2) | No | Additional principal payment | `100.00` |
| start\_date | DATE | Yes | Loan origination date | `2023-06-15` |
| maturity\_date | DATE | No | Expected payoff date | `2028-06-15` |
| first\_payment\_date | DATE | No | Date of first payment | `2023-07-15` |
| payment\_day | INTEGER | No | Day of month payment due | `15` |
| auto\_pay | BOOLEAN | No | Auto-payment enabled | `true` |
| prepayment\_penalty | BOOLEAN | No | Penalty for early payoff | `false` |
| prepayment\_penalty\_amount | DECIMAL(10,2) | No | Penalty amount if applicable | `0.00` |
| is\_secured | BOOLEAN | No | Loan is secured by collateral | `true` |
| collateral\_type | VARCHAR(50) | No | Type of collateral | `vehicle` |
| collateral\_value | DECIMAL(12,2) | No | Value of collateral | `22000.00` |
| status | VARCHAR(20) | Yes | Current loan status | `active` |
| notes | TEXT | No | User notes | `Refinanced in 2023` |
| remaining\_months | INTEGER | Computed | Estimated months to payoff | `39` |
| principal\_paid | DECIMAL(12,2) | Computed | Amount paid toward principal | `6500.00` |
| payoff\_percentage | DECIMAL(5,2) | Computed | Percentage paid off | `26.00` |
| created\_at | TIMESTAMP | Yes | Record creation | `2023-06-15 10:00:00` |
| updated\_at | TIMESTAMP | Yes | Last update | `2025-01-20 15:00:00` |
| paid\_off\_date | DATE | No | Date loan was paid off | `null` |

**Loan Types:**

* `personal`: Unsecured personal loan  
* `auto`: Auto/vehicle loan  
* `student`: Student loan (federal or private)  
* `home_equity`: Home equity loan or HELOC  
* `business`: Business loan  
* `other`: Other loan types

**Status Values:**

* `active`: Loan is current and being paid  
* `deferred`: Payments are deferred (e.g., student loan deferment)  
* `paid_off`: Loan is fully paid  
* `defaulted`: Loan is in default  
* `in_forbearance`: Temporary payment pause

#### **4.1.4 Mortgages Table** {#4.1.4-mortgages-table}

**Purpose:** Track mortgage loans with comprehensive property and payment details

```sql
CREATE TABLE mortgages (
    -- Primary Key
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Foreign Key
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- Property Information
    property_address TEXT,
    property_city VARCHAR(100),
    property_state VARCHAR(50),
    property_zip VARCHAR(10),
    property_type VARCHAR(50),
    property_value DECIMAL(12, 2),
    
    -- Mortgage Details
    lender VARCHAR(100),
    loan_number VARCHAR(50),
    loan_type VARCHAR(50),
    
    -- Financial Details
    loan_amount DECIMAL(12, 2) NOT NULL,
    current_balance DECIMAL(12, 2) NOT NULL,
    interest_rate DECIMAL(5, 2) NOT NULL,
    term_years INTEGER NOT NULL,
    
    -- Monthly Payments
    monthly_payment DECIMAL(10, 2) NOT NULL,
    extra_payment DECIMAL(10, 2) DEFAULT 0.00,
    
    -- Property Costs (Annual)
    property_tax DECIMAL(10, 2) DEFAULT 0.00,
    homeowners_insurance DECIMAL(10, 2) DEFAULT 0.00,
    hoa_fees DECIMAL(10, 2) DEFAULT 0.00,
    
    -- PMI/MIP
    pmi DECIMAL(10, 2) DEFAULT 0.00,
    pmi_removal_ltv DECIMAL(5, 2) DEFAULT 80.00,
    
    -- Dates
    start_date DATE NOT NULL,
    maturity_date DATE,
    first_payment_date DATE,
    
    -- Refinance Information
    is_refinanced BOOLEAN DEFAULT FALSE,
    original_loan_date DATE,
    refinance_date DATE,
    refinance_reason TEXT,
    
    -- Escrow
    has_escrow BOOLEAN DEFAULT TRUE,
    escrow_balance DECIMAL(10, 2),
    
    -- Status & Notes
    status VARCHAR(20) DEFAULT 'active',
    notes TEXT,
    
    -- Calculated Fields
    loan_to_value DECIMAL(5, 2) GENERATED ALWAYS AS (
        CASE 
            WHEN property_value > 0 
            THEN (current_balance / property_value * 100)
            ELSE 0
        END
    ) STORED,
    
    equity DECIMAL(12, 2) GENERATED ALWAYS AS (
        CASE 
            WHEN property_value > 0 
            THEN GREATEST(property_value - current_balance, 0)
            ELSE 0
        END
    ) STORED,
    
    equity_percentage DECIMAL(5, 2) GENERATED ALWAYS AS (
        CASE 
            WHEN property_value > 0 
            THEN ((property_value - current_balance) / property_value * 100)
            ELSE 0
        END
    ) STORED,
    
    total_monthly_housing_cost DECIMAL(10, 2) GENERATED ALWAYS AS (
        monthly_payment + 
        (property_tax / 12) + 
        (homeowners_insurance / 12) + 
        (hoa_fees / 12) + 
        pmi
    ) STORED,
    
    principal_paid DECIMAL(12, 2) GENERATED ALWAYS AS (
        loan_amount - current_balance
    ) STORED,
    
    -- Timestamps
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    paid_off_date DATE,
    
    -- Constraints
    CONSTRAINT loan_amount_positive CHECK (loan_amount > 0),
    CONSTRAINT balance_positive CHECK (current_balance >= 0),
    CONSTRAINT balance_lte_loan_amount CHECK (current_balance <= loan_amount),
    CONSTRAINT interest_rate_range CHECK (interest_rate >= 0 AND interest_rate <= 100),
    CONSTRAINT term_years_positive CHECK (term_years > 0),
    CONSTRAINT monthly_payment_positive CHECK (monthly_payment > 0),
    CONSTRAINT extra_payment_positive CHECK (extra_payment >= 0),
    CONSTRAINT property_value_positive CHECK (property_value IS NULL OR property_value > 0),
    CONSTRAINT property_type_check CHECK (
        property_type IS NULL OR 
        property_type IN ('single_family', 'condo', 'townhouse', 'multi_family', 'mobile_home', 'other')
    ),
    CONSTRAINT loan_type_check CHECK (
        loan_type IS NULL OR 
        loan_type IN ('conventional', 'fha', 'va', 'usda', 'jumbo', 'other')
    ),
    CONSTRAINT status_check CHECK (status IN ('active', 'paid_off', 'foreclosed', 'in_forbearance'))
);

-- Indexes
CREATE INDEX idx_mortgages_user_id ON mortgages(user_id);
CREATE INDEX idx_mortgages_status ON mortgages(status);
CREATE INDEX idx_mortgages_property_state ON mortgages(property_state);
CREATE INDEX idx_mortgages_ltv ON mortgages(loan_to_value) WHERE status = 'active';

-- Auto-update timestamp trigger
CREATE TRIGGER update_mortgages_updated_at
    BEFORE UPDATE ON mortgages
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- Trigger to remove PMI when LTV drops below threshold
CREATE OR REPLACE FUNCTION check_pmi_removal()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.loan_to_value < NEW.pmi_removal_ltv AND NEW.pmi > 0 THEN
        NEW.pmi = 0;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER mortgage_pmi_removal_check
    BEFORE UPDATE ON mortgages
    FOR EACH ROW
    EXECUTE FUNCTION check_pmi_removal();

-- Trigger to mark as paid off
CREATE OR REPLACE FUNCTION check_mortgage_paid_off()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.current_balance = 0 AND OLD.current_balance > 0 AND NEW.status = 'active' THEN
        NEW.status = 'paid_off';
        NEW.paid_off_date = CURRENT_DATE;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER mortgage_paid_off_check
    BEFORE UPDATE ON mortgages
    FOR EACH ROW
    EXECUTE FUNCTION check_mortgage_paid_off();

-- Row Level Security
ALTER TABLE mortgages ENABLE ROW LEVEL SECURITY;

CREATE POLICY mortgages_select_own ON mortgages FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY mortgages_insert_own ON mortgages FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY mortgages_update_own ON mortgages FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY mortgages_delete_own ON mortgages FOR DELETE USING (auth.uid() = user_id);
```

**Field Descriptions:**

| Field Name | Type | Required | Description | Example Value |
| ----- | ----- | ----- | ----- | ----- |
| id | UUID | Yes | Primary key | `a1b2c3d4-...` |
| user\_id | UUID | Yes | Owner | `user-uuid-123` |
| property\_address | TEXT | No | Full street address | `123 Main Street` |
| property\_city | VARCHAR(100) | No | City | `San Francisco` |
| property\_state | VARCHAR(50) | No | State/Province | `CA` |
| property\_zip | VARCHAR(10) | No | Postal code | `94102` |
| property\_type | VARCHAR(50) | No | Type of property | `single_family` |
| property\_value | DECIMAL(12,2) | No | Current market value | `450000.00` |
| lender | VARCHAR(100) | No | Mortgage lender | `Wells Fargo Home Mortgage` |
| loan\_number | VARCHAR(50) | No | Loan account number | `987654321` |
| loan\_type | VARCHAR(50) | No | Type of mortgage | `conventional` |
| loan\_amount | DECIMAL(12,2) | Yes | Original mortgage amount | `360000.00` |
| current\_balance | DECIMAL(12,2) | Yes | Remaining balance | `335000.00` |
| interest\_rate | DECIMAL(5,2) | Yes | Annual interest rate | `4.25` |
| term\_years | INTEGER | Yes | Loan term in years | `30` |
| monthly\_payment | DECIMAL(10,2) | Yes | Principal & interest payment | `1770.00` |
| extra\_payment | DECIMAL(10,2) | No | Additional principal payment | `500.00` |
| property\_tax | DECIMAL(10,2) | No | Annual property tax | `5400.00` |
| homeowners\_insurance | DECIMAL(10,2) | No | Annual insurance premium | `1200.00` |
| hoa\_fees | DECIMAL(10,2) | No | Annual HOA fees | `600.00` |
| pmi | DECIMAL(10,2) | No | Monthly PMI/MIP | `150.00` |
| pmi\_removal\_ltv | DECIMAL(5,2) | No | LTV% for PMI removal | `80.00` |
| start\_date | DATE | Yes | Mortgage start date | `2020-03-01` |
| maturity\_date | DATE | No | Expected payoff date | `2050-03-01` |
| first\_payment\_date | DATE | No | First payment due date | `2020-04-01` |
| is\_refinanced | BOOLEAN | No | Is this a refinance | `true` |
| original\_loan\_date | DATE | No | Original purchase date | `2015-06-15` |
| refinance\_date | DATE | No | Date of refinance | `2020-03-01` |
| refinance\_reason | TEXT | No | Why refinanced | `Lower rate from 5.5% to 4.25%` |
| has\_escrow | BOOLEAN | No | Escrow account exists | `true` |
| escrow\_balance | DECIMAL(10,2) | No | Current escrow balance | `2500.00` |
| status | VARCHAR(20) | Yes | Mortgage status | `active` |
| notes | TEXT | No | User notes | `Planning to pay off in 15 years` |
| loan\_to\_value | DECIMAL(5,2) | Computed | LTV ratio | `74.44` |
| equity | DECIMAL(12,2) | Computed | Home equity | `115000.00` |
| equity\_percentage | DECIMAL(5,2) | Computed | Equity as % of value | `25.56` |
| total\_monthly\_housing\_cost | DECIMAL(10,2) | Computed | Total monthly cost | `2520.00` |
| principal\_paid | DECIMAL(12,2) | Computed | Principal paid to date | `25000.00` |
| created\_at | TIMESTAMP | Yes | Record created | `2020-03-01 10:00:00` |
| updated\_at | TIMESTAMP | Yes | Last updated | `2025-01-20 16:00:00` |
| paid\_off\_date | DATE | No | Payoff date | `null` |

**Property Types:**

* `single_family`: Single-family detached home  
* `condo`: Condominium  
* `townhouse`: Townhome  
* `multi_family`: 2-4 unit property  
* `mobile_home`: Manufactured home  
* `other`: Other property type

**Loan Types:**

* `conventional`: Conventional mortgage  
* `fha`: FHA loan  
* `va`: VA loan  
* `usda`: USDA loan  
* `jumbo`: Jumbo loan  
* `other`: Other loan type

#### **4.1.5 Bills Table** {#4.1.5-bills-table}

**Purpose:** Track all recurring expenses and bills

```sql
CREATE TABLE bills (
    -- Primary Key
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Foreign Key
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- Bill Information
    bill_name VARCHAR(255) NOT NULL,
    category VARCHAR(50) NOT NULL,
    vendor VARCHAR(100),
    account_number VARCHAR(50),
    
    -- Payment Details
    amount DECIMAL(10, 2) NOT NULL,
    frequency VARCHAR(20) NOT NULL,
    due_date INTEGER,
    auto_pay BOOLEAN DEFAULT FALSE,
    payment_method VARCHAR(50),
    
    -- Classification
    is_essential BOOLEAN DEFAULT TRUE,
    is_recurring BOOLEAN DEFAULT TRUE,
    can_cancel BOOLEAN DEFAULT TRUE,
    
    -- Reminders
    reminder_days_before INTEGER DEFAULT 3,
    email_reminder BOOLEAN DEFAULT TRUE,
    push_reminder BOOLEAN DEFAULT TRUE,
    
    -- Status & Notes
    status VARCHAR(20) DEFAULT 'active',
    notes TEXT,
    
    -- Tracking
    last_paid_date DATE,
    last_paid_amount DECIMAL(10, 2),
    next_due_date DATE,
    
    -- Calculated Fields
    monthly_equivalent DECIMAL(10, 2) GENERATED ALWAYS AS (
        CASE frequency
            WHEN 'weekly' THEN amount * 52 / 12
            WHEN 'bi-weekly' THEN amount * 26 / 12
            WHEN 'semi-monthly' THEN amount * 2
            WHEN 'monthly' THEN amount
            WHEN 'quarterly' THEN amount / 3
            WHEN 'semi-annually' THEN amount / 6
            WHEN 'annually' THEN amount / 12
            ELSE amount
        END
    ) STORED,
    
    annual_cost DECIMAL(10, 2) GENERATED ALWAYS AS (
        CASE frequency
            WHEN 'weekly' THEN amount * 52
            WHEN 'bi-weekly' THEN amount * 26
            WHEN 'semi-monthly' THEN amount * 24
            WHEN 'monthly' THEN amount * 12
            WHEN 'quarterly' THEN amount * 4
            WHEN 'semi-annually' THEN amount * 2
            WHEN 'annually' THEN amount
            ELSE amount * 12
        END
    ) STORED,
    
    -- Timestamps
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    canceled_date DATE,
    
    -- Constraints
    CONSTRAINT amount_positive CHECK (amount > 0),
    CONSTRAINT due_date_range CHECK (due_date IS NULL OR (due_date >= 1 AND due_date <= 31)),
    CONSTRAINT reminder_days_positive CHECK (reminder_days_before >= 0),
    CONSTRAINT category_check CHECK (category IN (
        'housing', 'utilities', 'transportation', 'food', 'healthcare',
        'insurance', 'debt', 'entertainment', 'subscriptions', 
        'education', 'personal_care', 'savings', 'investments', 'other'
    )),
    CONSTRAINT frequency_check CHECK (frequency IN (
        'weekly', 'bi-weekly', 'semi-monthly', 'monthly', 
        'quarterly', 'semi-annually', 'annually', 'one-time'
    )),
    CONSTRAINT status_check CHECK (status IN ('active', 'paused', 'canceled')),
    CONSTRAINT payment_method_check CHECK (
        payment_method IS NULL OR payment_method IN (
            'auto-pay', 'manual', 'credit_card', 'debit_card', 
            'bank_transfer', 'check', 'cash', 'other'
        )
    )
);

-- Indexes
CREATE INDEX idx_bills_user_id ON bills(user_id);
CREATE INDEX idx_bills_category ON bills(category);
CREATE INDEX idx_bills_status ON bills(status);
CREATE INDEX idx_bills_user_status ON bills(user_id, status);
CREATE INDEX idx_bills_due_date ON bills(due_date) WHERE status = 'active';
CREATE INDEX idx_bills_next_due_date ON bills(next_due_date) WHERE status = 'active';
CREATE INDEX idx_bills_frequency ON bills(frequency);

-- Auto-update timestamp trigger
CREATE TRIGGER update_bills_updated_at
    BEFORE UPDATE ON bills
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- Function to calculate next due date
CREATE OR REPLACE FUNCTION calculate_next_bill_due_date(
    p_due_date INTEGER,
    p_frequency VARCHAR,
    p_last_paid_date DATE
) RETURNS DATE AS $$
DECLARE
    v_base_date DATE;
    v_next_date DATE;
BEGIN
    -- Use last paid date as base, or current date if never paid
    v_base_date := COALESCE(p_last_paid_date, CURRENT_DATE);
    
    -- Calculate next due date based on frequency
    CASE p_frequency
        WHEN 'weekly' THEN
            v_next_date := v_base_date + INTERVAL '7 days';
        WHEN 'bi-weekly' THEN
            v_next_date := v_base_date + INTERVAL '14 days';
        WHEN 'semi-monthly' THEN
            v_next_date := v_base_date + INTERVAL '15 days';
        WHEN 'monthly' THEN
            v_next_date := (DATE_TRUNC('month', v_base_date) + INTERVAL '1 month')::DATE + (p_due_date - 1);
        WHEN 'quarterly' THEN
            v_next_date := v_base_date + INTERVAL '3 months';
        WHEN 'semi-annually' THEN
            v_next_date := v_base_date + INTERVAL '6 months';
        WHEN 'annually' THEN
            v_next_date := v_base_date + INTERVAL '1 year';
        ELSE
            v_next_date := v_base_date + INTERVAL '1 month';
    END CASE;
    
    RETURN v_next_date;
END;
$$ LANGUAGE plpgsql;

-- Trigger to update next due date when payment is recorded
CREATE OR REPLACE FUNCTION update_bill_next_due_date()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.last_paid_date IS DISTINCT FROM OLD.last_paid_date THEN
        NEW.next_due_date := calculate_next_bill_due_date(
            NEW.due_date,
            NEW.frequency,
            NEW.last_paid_date
        );
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER bill_update_next_due_date
    BEFORE UPDATE ON bills
    FOR EACH ROW
    EXECUTE FUNCTION update_bill_next_due_date();

-- Row Level Security
ALTER TABLE bills ENABLE ROW LEVEL SECURITY;

CREATE POLICY bills_select_own ON bills FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY bills_insert_own ON bills FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY bills_update_own ON bills FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY bills_delete_own ON bills FOR DELETE USING (auth.uid() = user_id);
```

**Field Descriptions:**

| Field Name | Type | Required | Description | Example Value |
| ----- | ----- | ----- | ----- | ----- |
| id | UUID | Yes | Primary key | `a1b2c3d4-...` |
| user\_id | UUID | Yes | Owner | `user-uuid-123` |
| bill\_name | VARCHAR(255) | Yes | Bill identifier | `Netflix Premium` |
| category | VARCHAR(50) | Yes | Expense category | `subscriptions` |
| vendor | VARCHAR(100) | No | Service provider | `Netflix, Inc.` |
| account\_number | VARCHAR(50) | No | Account/customer number | `ACC-123456` |
| amount | DECIMAL(10,2) | Yes | Bill amount | `15.99` |
| frequency | VARCHAR(20) | Yes | How often billed | `monthly` |
| due\_date | INTEGER | No | Day of month due (1-31) | `5` |
| auto\_pay | BOOLEAN | No | Auto-payment enabled | `true` |
| payment\_method | VARCHAR(50) | No | How bill is paid | `credit_card` |
| is\_essential | BOOLEAN | No | Essential expense | `false` |
| is\_recurring | BOOLEAN | No | Recurring bill | `true` |
| can\_cancel | BOOLEAN | No | Can be canceled | `true` |
| reminder\_days\_before | INTEGER | No | Days before due for reminder | `3` |
| email\_reminder | BOOLEAN | No | Send email reminder | `true` |
| push\_reminder | BOOLEAN | No | Send push reminder | `true` |
| status | VARCHAR(20) | Yes | Bill status | `active` |
| notes | TEXT | No | User notes | `Family plan, shared with spouse` |
| last\_paid\_date | DATE | No | Last payment date | `2025-01-05` |
| last\_paid\_amount | DECIMAL(10,2) | No | Last payment amount | `15.99` |
| next\_due\_date | DATE | No | Next payment due | `2025-02-05` |
| monthly\_equivalent | DECIMAL(10,2) | Computed | Monthly cost equivalent | `15.99` |
| annual\_cost | DECIMAL(10,2) | Computed | Annual cost | `191.88` |
| created\_at | TIMESTAMP | Yes | Record created | `2024-01-05 10:00:00` |
| updated\_at | TIMESTAMP | Yes | Last updated | `2025-01-20 17:00:00` |
| canceled\_date | DATE | No | Cancellation date | `null` |

**Categories:**

* `housing`: Rent, mortgage (from mortgages table)  
* `utilities`: Electric, gas, water, internet, phone  
* `transportation`: Car payment, gas, insurance, public transit  
* `food`: Groceries, dining out, meal delivery  
* `healthcare`: Insurance, medications, copays  
* `insurance`: Life, disability, pet, other insurance  
* `debt`: Credit cards, loans (tracked separately)  
* `entertainment`: Streaming, hobbies, events  
* `subscriptions`: Software, memberships, boxes  
* `education`: Tuition, courses, books  
* `personal_care`: Gym, salon, spa  
* `savings`: Automatic transfers to savings  
* `investments`: Automatic investment contributions  
* `other`: Miscellaneous expenses

**Frequencies:**

* `weekly`: Every 7 days  
* `bi-weekly`: Every 14 days (26 times/year)  
* `semi-monthly`: Twice per month (24 times/year)  
* `monthly`: Once per month (12 times/year)  
* `quarterly`: Every 3 months (4 times/year)  
* `semi-annually`: Every 6 months (2 times/year)  
* `annually`: Once per year  
* `one-time`: One-time expense

#### **4.1.6 Goals Table** {#4.1.6-goals-table}

**Purpose:** Track savings goals and financial milestones

```sql
CREATE TABLE goals (
    -- Primary Key
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Foreign Key
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- Goal Information
    goal_name VARCHAR(255) NOT NULL,
    goal_type VARCHAR(50) NOT NULL,
    description TEXT,
    
    -- Financial Targets
    target_amount DECIMAL(10, 2) NOT NULL,
    current_amount DECIMAL(10, 2) DEFAULT 0.00,
    monthly_contribution DECIMAL(10, 2) DEFAULT 0.00,
    
    -- Timeline
    target_date DATE,
    started_date DATE DEFAULT CURRENT_DATE,
    
    -- Priority & Motivation
    priority VARCHAR(20) DEFAULT 'medium',
    motivation TEXT,
    image_url TEXT,
    
    -- Tracking
    is_recurring BOOLEAN DEFAULT FALSE,
    auto_contribute BOOLEAN DEFAULT FALSE,
    contribution_day INTEGER,
    
    -- Milestones
    milestone_25_reached BOOLEAN DEFAULT FALSE,
    milestone_50_reached BOOLEAN DEFAULT FALSE,
    milestone_75_reached BOOLEAN DEFAULT FALSE,
    milestone_100_reached BOOLEAN DEFAULT FALSE,
    
    -- Status & Notes
    status VARCHAR(20) DEFAULT 'active',
    notes TEXT,
    
    -- Calculated Fields
    remaining_amount DECIMAL(10, 2) GENERATED ALWAYS AS (
        GREATEST(target_amount - current_amount, 0)
    ) STORED,
    
    progress_percentage DECIMAL(5, 2) GENERATED ALWAYS AS (
        CASE 
            WHEN target_amount > 0 
            THEN LEAST((current_amount / target_amount * 100), 100)
            ELSE 0
        END
    ) STORED,
    
    months_to_goal INTEGER GENERATED ALWAYS AS (
        CASE 
            WHEN monthly_contribution > 0 AND target_amount > current_amount
            THEN CEIL((target_amount - current_amount) / monthly_contribution)
            ELSE NULL
        END
    ) STORED,
    
    is_on_track BOOLEAN GENERATED ALWAYS AS (
        CASE 
            WHEN target_date IS NULL THEN TRUE
            WHEN monthly_contribution = 0 THEN FALSE
            WHEN target_date < CURRENT_DATE THEN FALSE
            ELSE (
                current_amount + 
                (monthly_contribution * 
                 EXTRACT(EPOCH FROM (target_date - CURRENT_DATE)) / 2592000)
            ) >= target_amount
        END
    ) STORED,
    
    -- Timestamps
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    completed_date DATE,
    
    -- Constraints
    CONSTRAINT target_amount_positive CHECK (target_amount > 0),
    CONSTRAINT current_amount_positive CHECK (current_amount >= 0),
    CONSTRAINT current_lte_target CHECK (current_amount <= target_amount * 1.5),
    CONSTRAINT monthly_contribution_positive CHECK (monthly_contribution >= 0),
    CONSTRAINT contribution_day_range CHECK (
        contribution_day IS NULL OR (contribution_day >= 1 AND contribution_day <= 31)
    ),
    CONSTRAINT goal_type_check CHECK (goal_type IN (
        'emergency_fund', 'vacation', 'down_payment', 'car_purchase',
        'debt_payoff', 'retirement', 'education', 'wedding',
        'home_improvement', 'investment', 'general_savings', 'other'
    )),
    CONSTRAINT priority_check CHECK (priority IN ('low', 'medium', 'high')),
    CONSTRAINT status_check CHECK (status IN ('active', 'completed', 'paused', 'abandoned'))
);

-- Indexes
CREATE INDEX idx_goals_user_id ON goals(user_id);
CREATE INDEX idx_goals_status ON goals(status);
CREATE INDEX idx_goals_priority ON goals(priority);
CREATE INDEX idx_goals_user_status ON goals(user_id, status);
CREATE INDEX idx_goals_target_date ON goals(target_date) WHERE status = 'active';
CREATE INDEX idx_goals_progress ON goals(progress_percentage) WHERE status = 'active';

-- Auto-update timestamp trigger
CREATE TRIGGER update_goals_updated_at
    BEFORE UPDATE ON goals
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- Trigger to mark as completed when target reached
CREATE OR REPLACE FUNCTION check_goal_completed()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.current_amount >= NEW.target_amount AND NEW.status = 'active' THEN
        NEW.status = 'completed';
        NEW.completed_date = CURRENT_DATE;
        NEW.milestone_100_reached = TRUE;
    END IF;
    
    -- Update milestone flags
    IF NEW.progress_percentage >= 25 AND NOT NEW.milestone_25_reached THEN
        NEW.milestone_25_reached = TRUE;
    END IF;
    
    IF NEW.progress_percentage >= 50 AND NOT NEW.milestone_50_reached THEN
        NEW.milestone_50_reached = TRUE;
    END IF;
    
    IF NEW.progress_percentage >= 75 AND NOT NEW.milestone_75_reached THEN
        NEW.milestone_75_reached = TRUE;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER goal_completion_check
    BEFORE UPDATE ON goals
    FOR EACH ROW
    EXECUTE FUNCTION check_goal_completed();

-- Row Level Security
ALTER TABLE goals ENABLE ROW LEVEL SECURITY;

CREATE POLICY goals_select_own ON goals FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY goals_insert_own ON goals FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY goals_update_own ON goals FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY goals_delete_own ON goals FOR DELETE USING (auth.uid() = user_id);
```

**Field Descriptions:**

| Field Name | Type | Required | Description | Example Value |
| ----- | ----- | ----- | ----- | ----- |
| id | UUID | Yes | Primary key | `a1b2c3d4-...` |
| user\_id | UUID | Yes | Owner | `user-uuid-123` |
| goal\_name | VARCHAR(255) | Yes | Goal name | `Emergency Fund - 6 Months` |
| goal\_type | VARCHAR(50) | Yes | Category | `emergency_fund` |
| description | TEXT | No | Detailed description | `Save 6 months of expenses` |
| target\_amount | DECIMAL(10,2) | Yes | Goal target | `15000.00` |
| current\_amount | DECIMAL(10,2) | No | Current progress | `6750.00` |
| monthly\_contribution | DECIMAL(10,2) | No | Monthly addition | `500.00` |
| target\_date | DATE | No | Target completion | `2026-12-31` |
| started\_date | DATE | No | When goal started | `2024-01-01` |
| priority | VARCHAR(20) | No | Importance level | `high` |
| motivation | TEXT | No | Why this matters | `Financial security` |
| image\_url | TEXT | No | Motivational image | `https://...` |
| is\_recurring | BOOLEAN | No | Recurring goal | `false` |
| auto\_contribute | BOOLEAN | No | Automatic contributions | `true` |
| contribution\_day | INTEGER | No | Day of month to contribute | `1` |
| milestone\_25\_reached | BOOLEAN | No | 25% milestone | `true` |
| milestone\_50\_reached | BOOLEAN | No | 50% milestone | `true` |
| milestone\_75\_reached | BOOLEAN | No | 75% milestone | `false` |
| milestone\_100\_reached | BOOLEAN | No | Completed | `false` |
| status | VARCHAR(20) | Yes | Goal status | `active` |
| notes | TEXT | No | User notes | `Prioritize over vacation fund` |
| remaining\_amount | DECIMAL(10,2) | Computed | Amount left to save | `8250.00` |
| progress\_percentage | DECIMAL(5,2) | Computed | Completion percentage | `45.00` |
| months\_to\_goal | INTEGER | Computed | Est. months to complete | `17` |
| is\_on\_track | BOOLEAN | Computed | On pace to meet target | `true` |
| created\_at | TIMESTAMP | Yes | Record created | `2024-01-01 10:00:00` |
| updated\_at | TIMESTAMP | Yes | Last updated | `2025-01-20 18:00:00` |
| completed\_date | DATE | No | Completion date | `null` |

**Goal Types:**

* `emergency_fund`: Emergency savings  
* `vacation`: Vacation fund  
* `down_payment`: Home down payment  
* `car_purchase`: Vehicle purchase  
* `debt_payoff`: Debt elimination goal  
* `retirement`: Retirement savings  
* `education`: Education fund  
* `wedding`: Wedding savings  
* `home_improvement`: Home renovation  
* `investment`: Investment capital  
* `general_savings`: General savings  
* `other`: Other goal type

#### **4.1.7 Snapshots Table** {#4.1.7-snapshots-table}

**Purpose:** Store monthly snapshots of complete financial picture for historical tracking

```sql
CREATE TABLE snapshots (
    -- Primary Key
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Foreign Key
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- Snapshot Metadata
    snapshot_date DATE NOT NULL,
    snapshot_type VARCHAR(20) DEFAULT 'monthly',
    name VARCHAR(255),
    description TEXT,
    
    -- Income
    monthly_income DECIMAL(10, 2) NOT NULL,
    
    -- Debt Totals
    total_debt DECIMAL(12, 2) NOT NULL,
    total_credit_card_debt DECIMAL(10, 2) DEFAULT 0.00,
    total_loan_debt DECIMAL(10, 2) DEFAULT 0.00,
    total_mortgage_debt DECIMAL(12, 2) DEFAULT 0.00,
    
    -- Payment Totals
    total_monthly_payments DECIMAL(10, 2) NOT NULL,
    total_credit_card_payments DECIMAL(10, 2) DEFAULT 0.00,
    total_loan_payments DECIMAL(10, 2) DEFAULT 0.00,
    total_mortgage_payments DECIMAL(10, 2) DEFAULT 0.00,
    
    -- Bills & Expenses
    total_monthly_bills DECIMAL(10, 2) NOT NULL,
    essential_bills DECIMAL(10, 2) DEFAULT 0.00,
    discretionary_bills DECIMAL(10, 2) DEFAULT 0.00,
    
    -- Ratios & Metrics
    debt_to_income_ratio DECIMAL(5, 2) NOT NULL,
    credit_utilization DECIMAL(5, 2) NOT NULL,
    payment_to_income_ratio DECIMAL(5, 2),
    
    -- Assets & Net Worth
    total_assets DECIMAL(12, 2) DEFAULT 0.00,
    liquid_assets DECIMAL(10, 2) DEFAULT 0.00,
    retirement_assets DECIMAL(12, 2) DEFAULT 0.00,
    real_estate_equity DECIMAL(12, 2) DEFAULT 0.00,
    net_worth DECIMAL(12, 2) DEFAULT 0.00,
    
    -- Goals Progress
    total_goal_progress DECIMAL(10, 2) DEFAULT 0.00,
    total_goal_targets DECIMAL(10, 2) DEFAULT 0.00,
    goals_on_track INTEGER DEFAULT 0,
    goals_completed INTEGER DEFAULT 0,
    
    -- Counts
    active_credit_cards INTEGER DEFAULT 0,
    active_loans INTEGER DEFAULT 0,
    active_mortgages INTEGER DEFAULT 0,
    active_bills INTEGER DEFAULT 0,
    active_goals INTEGER DEFAULT 0,
    
    -- Projections (from calculations at time of snapshot)
    projected_debt_free_date DATE,
    projected_months_to_debt_free INTEGER,
    projected_total_interest DECIMAL(12, 2),
    
    -- Comparison to Previous Snapshot
    debt_change DECIMAL(12, 2),
    debt_change_percentage DECIMAL(5, 2),
    net_worth_change DECIMAL(12, 2),
    net_worth_change_percentage DECIMAL(5, 2),
    
    -- Status & Notes
    is_manual BOOLEAN DEFAULT FALSE,
    notes TEXT,
    
    -- Timestamps
    created_at TIMESTAMP DEFAULT NOW(),
    
    -- Constraints
    CONSTRAINT snapshot_date_unique_per_user UNIQUE (user_id, snapshot_date, snapshot_type),
    CONSTRAINT total_debt_positive CHECK (total_debt >= 0),
    CONSTRAINT total_payments_positive CHECK (total_monthly_payments >= 0),
    CONSTRAINT total_bills_positive CHECK (total_monthly_bills >= 0),
    CONSTRAINT total_assets_positive CHECK (total_assets >= 0),
    CONSTRAINT snapshot_type_check CHECK (snapshot_type IN ('daily', 'weekly', 'monthly', 'quarterly', 'annual', 'manual'))
);

-- Indexes
CREATE INDEX idx_snapshots_user_id ON snapshots(user_id);
CREATE INDEX idx_snapshots_date ON snapshots(snapshot_date DESC);
CREATE INDEX idx_snapshots_user_date ON snapshots(user_id, snapshot_date DESC);
CREATE INDEX idx_snapshots_type ON snapshots(snapshot_type);
CREATE UNIQUE INDEX idx_snapshots_user_date_type ON snapshots(user_id, snapshot_date, snapshot_type);

-- Function to calculate change from previous snapshot
CREATE OR REPLACE FUNCTION calculate_snapshot_changes()
RETURNS TRIGGER AS $$
DECLARE
    v_previous_snapshot RECORD;
BEGIN
    -- Get previous snapshot for this user
    SELECT * INTO v_previous_snapshot
    FROM snapshots
    WHERE user_id = NEW.user_id
      AND snapshot_date < NEW.snapshot_date
    ORDER BY snapshot_date DESC
    LIMIT 1;
    
    IF FOUND THEN
        -- Calculate debt change
        NEW.debt_change := NEW.total_debt - v_previous_snapshot.total_debt;
        
        IF v_previous_snapshot.total_debt > 0 THEN
            NEW.debt_change_percentage := 
                (NEW.debt_change / v_previous_snapshot.total_debt * 100);
        END IF;
        
        -- Calculate net worth change
        NEW.net_worth_change := NEW.net_worth - v_previous_snapshot.net_worth;
        
        IF v_previous_snapshot.net_worth != 0 THEN
            NEW.net_worth_change_percentage := 
                (NEW.net_worth_change / ABS(v_previous_snapshot.net_worth) * 100);
        END IF;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER snapshot_calculate_changes
    BEFORE INSERT ON snapshots
    FOR EACH ROW
    EXECUTE FUNCTION calculate_snapshot_changes();

-- Row Level Security
ALTER TABLE snapshots ENABLE ROW LEVEL SECURITY;

CREATE POLICY snapshots_select_own ON snapshots FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY snapshots_insert_own ON snapshots FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY snapshots_update_own ON snapshots FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY snapshots_delete_own ON snapshots FOR DELETE USING (auth.uid() = user_id);
```

**Field Descriptions:**

| Field Name | Type | Required | Description | Example Value |
| ----- | ----- | ----- | ----- | ----- |
| id | UUID | Yes | Primary key | `a1b2c3d4-...` |
| user\_id | UUID | Yes | Owner | `user-uuid-123` |
| snapshot\_date | DATE | Yes | Date of snapshot | `2025-01-01` |
| snapshot\_type | VARCHAR(20) | No | Frequency type | `monthly` |
| name | VARCHAR(255) | No | Custom name | `January 2025 Review` |
| description | TEXT | No | Notes about snapshot | `Started new job` |
| monthly\_income | DECIMAL(10,2) | Yes | Monthly income | `4500.00` |
| total\_debt | DECIMAL(12,2) | Yes | All debt combined | `45200.00` |
| total\_credit\_card\_debt | DECIMAL(10,2) | No | Credit card total | `10700.00` |
| total\_loan\_debt | DECIMAL(10,2) | No | Loans total | `18500.00` |
| total\_mortgage\_debt | DECIMAL(12,2) | No | Mortgage balance | `235000.00` |
| total\_monthly\_payments | DECIMAL(10,2) | Yes | All monthly payments | `2850.00` |
| total\_credit\_card\_payments | DECIMAL(10,2) | No | CC payments | `850.00` |
| total\_loan\_payments | DECIMAL(10,2) | No | Loan payments | `580.00` |
| total\_mortgage\_payments | DECIMAL(10,2) | No | Mortgage payment | `1420.00` |
| total\_monthly\_bills | DECIMAL(10,2) | Yes | All bills | `1850.00` |
| essential\_bills | DECIMAL(10,2) | No | Essential bills | `1450.00` |
| discretionary\_bills | DECIMAL(10,2) | No | Discretionary bills | `400.00` |
| debt\_to\_income\_ratio | DECIMAL(5,2) | Yes | DTI% | `63.33` |
| credit\_utilization | DECIMAL(5,2) | Yes | Utilization% | `45.50` |
| payment\_to\_income\_ratio | DECIMAL(5,2) | No | Payment/income% | `63.33` |
| total\_assets | DECIMAL(12,2) | No | All assets | `50000.00` |
| liquid\_assets | DECIMAL(10,2) | No | Cash/savings | `12000.00` |
| retirement\_assets | DECIMAL(12,2) | No | 401k/IRA | `35000.00` |
| real\_estate\_equity | DECIMAL(12,2) | No | Home equity | `115000.00` |
| net\_worth | DECIMAL(12,2) | No | Assets \- debts | `4800.00` |
| total\_goal\_progress | DECIMAL(10,2) | No | Current goal amounts | `8500.00` |
| total\_goal\_targets | DECIMAL(10,2) | No | Total goal targets | `30000.00` |
| goals\_on\_track | INTEGER | No | Goals on pace | `3` |
| goals\_completed | INTEGER | No | Completed goals | `1` |
| active\_credit\_cards | INTEGER | No | Active card count | `4` |
| active\_loans | INTEGER | No | Active loan count | `2` |
| active\_mortgages | INTEGER | No | Active mortgage count | `1` |
| active\_bills | INTEGER | No | Active bill count | `15` |
| active\_goals | INTEGER | No | Active goal count | `5` |
| projected\_debt\_free\_date | DATE | No | Projected payoff | `2028-06-15` |
| projected\_months\_to\_debt\_free | INTEGER | No | Months to debt-free | `42` |
| projected\_total\_interest | DECIMAL(12,2) | No | Est. total interest | `15200.00` |
| debt\_change | DECIMAL(12,2) | No | Change from previous | `-1350.00` |
| debt\_change\_percentage | DECIMAL(5,2) | No | % change | `-2.90` |
| net\_worth\_change | DECIMAL(12,2) | No | Net worth change | `2500.00` |
| net\_worth\_change\_percentage | DECIMAL(5,2) | No | % change | `108.70` |
| is\_manual | BOOLEAN | No | Manually created | `false` |
| notes | TEXT | No | User notes | `Great progress this month!` |
| created\_at | TIMESTAMP | Yes | Created timestamp | `2025-01-01 00:00:00` |

### **4.2 Additional Database Tables** {#4.2-additional-database-tables}

#### **4.2.1 Payment History Table (Optional \- Future Enhancement)** {#4.2.1-payment-history-table-(optional---future-enhancement)}

```sql
CREATE TABLE payment_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- Payment Details
    payment_type VARCHAR(20) NOT NULL, -- 'credit_card', 'loan', 'mortgage', 'bill'
    reference_id UUID NOT NULL, -- ID of related record
    reference_name VARCHAR(255),
    
    amount DECIMAL(10, 2) NOT NULL,
    payment_date DATE NOT NULL,
    payment_method VARCHAR(50),
    confirmation_number VARCHAR(100),
    
    -- Timestamps
    created_at TIMESTAMP DEFAULT NOW(),
    
    CONSTRAINT payment_type_check CHECK (
        payment_type IN ('credit_card', 'loan', 'mortgage', 'bill')
    )
);

CREATE INDEX idx_payment_history_user_id ON payment_history(user_id);
CREATE INDEX idx_payment_history_reference ON payment_history(reference_id);
CREATE INDEX idx_payment_history_date ON payment_history(payment_date DESC);
```

#### **4.2.2 Notifications Table** {#4.2.2-notifications-table}

```sql
CREATE TABLE notifications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- Notification Details
    type VARCHAR(50) NOT NULL,
    title VARCHAR(255) NOT NULL,
    message TEXT NOT NULL,
    
    -- Delivery
    channels VARCHAR[] DEFAULT ARRAY['in_app'], -- 'in_app', 'email', 'push', 'sms'
    scheduled_for TIMESTAMP,
    sent_at TIMESTAMP,
    
    -- Status
    is_read BOOLEAN DEFAULT FALSE,
    read_at TIMESTAMP,
    is_archived BOOLEAN DEFAULT FALSE,
    
    -- Action
    action_url TEXT,
    action_label VARCHAR(100),
    
    -- Related Entity
    entity_type VARCHAR(50),
    entity_id UUID,
    
    -- Timestamps
    created_at TIMESTAMP DEFAULT NOW(),
    expires_at TIMESTAMP,
    
    CONSTRAINT notification_type_check CHECK (type IN (
        'bill_reminder', 'payment_confirmation', 'milestone_reached',
        'goal_completed', 'snapshot_reminder', 'debt_progress',
        'account_alert', 'system_message'
    ))
);

CREATE INDEX idx_notifications_user_id ON notifications(user_id);
CREATE INDEX idx_notifications_user_unread ON notifications(user_id, is_read) WHERE is_read = FALSE;
CREATE INDEX idx_notifications_scheduled ON notifications(scheduled_for) WHERE sent_at IS NULL;
```

### **4.3 Database Functions & Stored Procedures** {#4.3-database-functions-&-stored-procedures}

```sql
-- Function to create a complete financial snapshot
CREATE OR REPLACE FUNCTION create_financial_snapshot(
    p_user_id UUID,
    p_snapshot_date DATE DEFAULT CURRENT_DATE
) RETURNS UUID AS $$
DECLARE
    v_snapshot_id UUID;
    v_monthly_income DECIMAL(10,2);
    v_total_cc_debt DECIMAL(10,2);
    v_total_loan_debt DECIMAL(10,2);
    v_total_mortgage_debt DECIMAL(12,2);
    -- ... more variables
BEGIN
    -- Get user's monthly income
    SELECT monthly_income INTO v_monthly_income
    FROM users WHERE id = p_user_id;
    
    -- Calculate total credit card debt
    SELECT COALESCE(SUM(balance), 0) INTO v_total_cc_debt
    FROM credit_cards
    WHERE user_id = p_user_id AND status = 'active';
    
    -- Calculate total loan debt
    SELECT COALESCE(SUM(current_balance), 0) INTO v_total_loan_debt
    FROM loans
    WHERE user_id = p_user_id AND status = 'active';
    
    -- Calculate total mortgage debt
    SELECT COALESCE(SUM(current_balance), 0) INTO v_total_mortgage_debt
    FROM mortgages
    WHERE user_id = p_user_id AND status = 'active';
    
    -- Insert snapshot
    INSERT INTO snapshots (
        user_id,
        snapshot_date,
        monthly_income,
        total_debt,
        total_credit_card_debt,
        total_loan_debt,
        total_mortgage_debt,
        -- ... more fields
        total_monthly_payments,
        debt_to_income_ratio,
        credit_utilization
    ) VALUES (
        p_user_id,
        p_snapshot_date,
        v_monthly_income,
        v_total_cc_debt + v_total_loan_debt + v_total_mortgage_debt,
        v_total_cc_debt,
        v_total_loan_debt,
        v_total_mortgage_debt,
        -- ... calculated values
    ) RETURNING id INTO v_snapshot_id;
    
    RETURN v_snapshot_id;
END;
$$ LANGUAGE plpgsql;
```

### **4.4 TypeScript Type Definitions (Complete)** {#4.4-typescript-type-definitions-(complete)}

```ts
// src/types/index.ts - Main type exports

// ============================================================================
// USER TYPES
// ============================================================================

export interface User {
  id: string;
  email: string;
  emailVerified: boolean;
  emailVerifiedAt?: string;
  firstName?: string;
  lastName?: string;
  avatarUrl?: string;
  phoneNumber?: string;
  dateOfBirth?: string;
  
  // Financial Settings
  monthlyIncome: number;
  targetDebtFreeDate?: string;
  preferredPayoffMethod: 'avalanche' | 'snowball' | 'custom';
  currency: string;
  locale: string;
  
  // Subscription
  subscriptionTier: 'free' | 'premium' | 'family';
  subscriptionStatus: 'active' | 'canceled' | 'past_due' | 'trialing';
  stripeCustomerId?: string;
  trialEndsAt?: string;
  subscribedAt?: string;
  
  // Preferences
  theme: 'light' | 'dark' | 'auto';
  timezone: string;
  dateFormat: string;
  
  // Notifications
  emailNotifications: boolean;
  pushNotifications: boolean;
  smsNotifications: boolean;
  
  // Timestamps
  createdAt: string;
  updatedAt: string;
  lastLoginAt?: string;
  deletedAt?: string;
}

export interface UserFormData {
  firstName?: string;
  lastName?: string;
  phoneNumber?: string;
  dateOfBirth?: string;
  monthlyIncome: number;
  targetDebtFreeDate?: string;
  preferredPayoffMethod: 'avalanche' | 'snowball' | 'custom';
  currency?: string;
  locale?: string;
  theme?: 'light' | 'dark' | 'auto';
  timezone?: string;
  dateFormat?: string;
}

// ============================================================================
// CREDIT CARD TYPES
// ============================================================================

export interface CreditCard {
  id: string;
  userId: string;
  
  // Card Information
  cardName: string;
  issuer?: string;
  lastFourDigits?: string;
  cardType?: 'credit' | 'charge' | 'secured';
  network?: 'Visa' | 'Mastercard' | 'Amex' | 'Discover' | 'Other';
  
  // Financial Details
  balance: number;
  creditLimit: number;
  interestRate: number;
  annualFee: number;
  
  // Payment Information
  minimumPayment: number;
  minimumPaymentPercentage?: number;
  extraPayment: number;
  dueDate?: number;
  statementDate?: number;
  autoPay: boolean;
  
  // Rewards & Benefits
  rewardsProgram?: string;
  cashbackRate?: number;
  pointsBalance?: number;
  
  // Status & Notes
  status: 'active' | 'paid_off' | 'closed' | 'frozen';
  notes?: string;
  
  // Calculated Fields
  utilizationPercentage: number;
  availableCredit: number;
  
  // Timestamps
  createdAt: string;
  updatedAt: string;
  openedDate?: string;
  closedDate?: string;
}

export interface CreditCardFormData {
  cardName: string;
  issuer?: string;
  lastFourDigits?: string;
  cardType?: 'credit' | 'charge' | 'secured';
  network?: 'Visa' | 'Mastercard' | 'Amex' | 'Discover' | 'Other';
  balance: number;
  creditLimit: number;
  interestRate: number;
  annualFee?: number;
  minimumPayment: number;
  minimumPaymentPercentage?: number;
  extraPayment?: number;
  dueDate?: number;
  statementDate?: number;
  autoPay?: boolean;
  rewardsProgram?: string;
  cashbackRate?: number;
  pointsBalance?: number;
  status: 'active' | 'paid_off' | 'closed' | 'frozen';
  notes?: string;
  openedDate?: string;
}

export interface CreditCardCalculations {
  utilizationPercentage: number;
  availableCredit: number;
  monthsToPayoffMinimum: number | 'Never';
  monthsToPayoffWithExtra: number | 'Never';
  totalInterestMinimum: number;
  totalInterestWithExtra: number;
  payoffDateMinimum: string;
  payoffDateWithExtra: string;
  interestSaved: number;
  monthsSaved: number;
}

// ============================================================================
// LOAN TYPES
// ============================================================================

export interface Loan {
  id: string;
  userId: string;
  
  // Loan Information
  loanName: string;
  loanType: 'personal' | 'auto' | 'student' | 'home_equity' | 'business' | 'other';
  lender?: string;
  accountNumber?: string;
  
  // Financial Details
  principal: number;
  currentBalance: number;
  interestRate: number;
  termMonths: number;
  monthlyPayment: number;
  extraPayment: number;
  
  // Dates
  startDate: string;
  maturityDate?: string;
  firstPaymentDate?: string;
  
  // Payment Details
  paymentDay?: number;
  autoPay: boolean;
  prepaymentPenalty: boolean;
  prepaymentPenaltyAmount?: number;
  
  // Collateral
  isSecured: boolean;
  collateralType?: 'vehicle' | 'real_estate' | 'securities' | 'equipment' | 'other';
  collateralValue?: number;
  
  // Status & Notes
  status: 'active' | 'deferred' | 'paid_off' | 'defaulted' | 'in_forbearance';
  notes?: string;
  
  // Calculated Fields
  remainingMonths: number;
  principalPaid: number;
  payoffPercentage: number;
  
  // Timestamps
  createdAt: string;
  updatedAt: string;
  paidOffDate?: string;
}

export interface LoanFormData {
  loanName: string;
  loanType: 'personal' | 'auto' | 'student' | 'home_equity' | 'business' | 'other';
  lender?: string;
  accountNumber?: string;
  principal: number;
  currentBalance: number;
  interestRate: number;
  termMonths: number;
  monthlyPayment: number;
  extraPayment?: number;
  startDate: string;
  maturityDate?: string;
  firstPaymentDate?: string;
  paymentDay?: number;
  autoPay?: boolean;
  prepaymentPenalty?: boolean;
  prepaymentPenaltyAmount?: number;
  isSecured?: boolean;
  collateralType?: 'vehicle' | 'real_estate' | 'securities' | 'equipment' | 'other';
  collateralValue?: number;
  status: 'active' | 'deferred' | 'paid_off' | 'defaulted' | 'in_forbearance';
  notes?: string;
}
```

---

## **5\. Feature Specifications (Complete)** {#5.-feature-specifications-(complete)}

### **5.1 Authentication System** {#5.1-authentication-system}

#### **5.1.1 Sign Up Flow** {#5.1.1-sign-up-flow}

**Purpose:** Allow new users to create an account with email/password

**User Story:** As a new user, I want to create an account so that I can start tracking my debt

**Components:**

* `SignUpPage.tsx` \- Main signup page  
* `SignUpForm.tsx` \- Form component with validation  
* `SocialAuthButtons.tsx` \- OAuth signup buttons (Google, Apple)  
* `PasswordStrengthIndicator.tsx` \- Visual password strength meter

**Form Fields:**

| Field | Type | Required | Validation | Example |
| ----- | ----- | ----- | ----- | ----- |
| firstName | text | No | 1-100 chars | John |
| lastName | text | No | 1-100 chars | Doe |
| email | email | Yes | Valid email format | john.doe@example.com |
| password | password | Yes | Min 8 chars, 1 upper, 1 lower, 1 number | MyPass123\! |
| confirmPassword | password | Yes | Must match password | MyPass123\! |
| acceptTerms | checkbox | Yes | Must be true | checked |

**Validation Rules:**

```ts
// src/lib/schemas/auth.schema.ts
import { z } from 'zod';

export const signUpSchema = z.object({
  firstName: z.string().min(1, 'First name is required').max(100).optional(),
  lastName: z.string().min(1, 'Last name is required').max(100).optional(),
  email: z
    .string()
    .min(1, 'Email is required')
    .email('Invalid email address')
    .toLowerCase()
    .trim(),
  password: z
    .string()
    .min(8, 'Password must be at least 8 characters')
    .regex(/[A-Z]/, 'Password must contain at least one uppercase letter')
    .regex(/[a-z]/, 'Password must contain at least one lowercase letter')
    .regex(/[0-9]/, 'Password must contain at least one number')
    .regex(/[^A-Za-z0-9]/, 'Password must contain at least one special character'),
  confirmPassword: z.string().min(1, 'Please confirm your password'),
  acceptTerms: z.boolean().refine(val => val === true, {
    message: 'You must accept the terms and conditions',
  }),
}).refine((data) => data.password === data.confirmPassword, {
  message: "Passwords don't match",
  path: ['confirmPassword'],
});

export type SignUpFormData = z.infer<typeof signUpSchema>;
```

**Component Implementation:**

```
// src/pages/auth/SignUpPage.tsx
import React, { useState } from 'react';
import { useNavigate, Link } from 'react-router-dom';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { Loader2, Mail, Lock, User, CheckCircle2 } from 'lucide-react';
import { signUpSchema, type SignUpFormData } from '@/lib/schemas/auth.schema';
import { useAuth } from '@/hooks/useAuth';
import { Button } from '@/components/common/Button';
import { Input } from '@/components/common/Input';
import { Checkbox } from '@/components/common/Checkbox';
import { PasswordStrengthIndicator } from '@/components/auth/PasswordStrengthIndicator';
import { SocialAuthButtons } from '@/components/auth/SocialAuthButtons';

export function SignUpPage() {
  const navigate = useNavigate();
  const { signUp, isLoading } = useAuth();
  const [showPassword, setShowPassword] = useState(false);

  const {
    register,
    handleSubmit,
    watch,
    formState: { errors, isSubmitting },
  } = useForm<SignUpFormData>({
    resolver: zodResolver(signUpSchema),
    mode: 'onBlur',
  });

  const password = watch('password');

  const onSubmit = async (data: SignUpFormData) => {
    try {
      await signUp({
        email: data.email,
        password: data.password,
        firstName: data.firstName,
        lastName: data.lastName,
      });
      
      // Redirect to email verification page
      navigate('/auth/verify-email', { 
        state: { email: data.email } 
      });
    } catch (error) {
      // Error handling is done in the useAuth hook
      console.error('Signup failed:', error);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 px-4 py-12">
      <div className="w-full max-w-md">
        {/* Logo */}
        <div className="text-center mb-8">
          <h1 className="text-4xl font-bold text-gray-900 mb-2">
            Budgetura
          </h1>
          <p className="text-gray-600">
            Your path to financial freedom starts here
          </p>
        </div>

        {/* Sign Up Card */}
        <div className="bg-white rounded-2xl shadow-xl p-8">
          <h2 className="text-2xl font-bold text-gray-900 mb-6">
            Create your account
          </h2>

          {/* Social Auth Buttons */}
          <SocialAuthButtons mode="signup" />

          {/* Divider */}
          <div className="relative my-6">
            <div className="absolute inset-0 flex items-center">
              <div className="w-full border-t border-gray-300" />
            </div>
            <div className="relative flex justify-center text-sm">
              <span className="px-4 bg-white text-gray-500">
                Or sign up with email
              </span>
            </div>
          </div>

          {/* Sign Up Form */}
          <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
            {/* Name Fields */}
            <div className="grid grid-cols-2 gap-4">
              <Input
                {...register('firstName')}
                label="First Name"
                placeholder="John"
                icon={User}
                error={errors.firstName?.message}
              />
              <Input
                {...register('lastName')}
                label="Last Name"
                placeholder="Doe"
                icon={User}
                error={errors.lastName?.message}
              />
            </div>

            {/* Email Field */}
            <Input
              {...register('email')}
              type="email"
              label="Email"
              placeholder="john.doe@example.com"
              icon={Mail}
              error={errors.email?.message}
              required
            />

            {/* Password Field */}
            <div>
              <Input
                {...register('password')}
                type={showPassword ? 'text' : 'password'}
                label="Password"
                placeholder="••••••••"
                icon={Lock}
                error={errors.password?.message}
                required
                showPasswordToggle
                onTogglePassword={() => setShowPassword(!showPassword)}
              />
              {password && (
                <PasswordStrengthIndicator password={password} className="mt-2" />
              )}
            </div>

            {/* Confirm Password Field */}
            <Input
              {...register('confirmPassword')}
              type={showPassword ? 'text' : 'password'}
              label="Confirm Password"
              placeholder="••••••••"
              icon={Lock}
              error={errors.confirmPassword?.message}
              required
            />

            {/* Terms Checkbox */}
            <Checkbox
              {...register('acceptTerms')}
              label={
                <span className="text-sm text-gray-600">
                  I agree to the{' '}
                  <Link
                    to="/terms"
                    className="text-blue-600 hover:text-blue-700 font-medium"
                  >
                    Terms of Service
                  </Link>{' '}
                  and{' '}
                  <Link
                    to="/privacy"
                    className="text-blue-600 hover:text-blue-700 font-medium"
                  >
                    Privacy Policy
                  </Link>
                </span>
              }
              error={errors.acceptTerms?.message}
            />

            {/* Submit Button */}
            <Button
              type="submit"
              variant="primary"
              size="lg"
              fullWidth
              disabled={isSubmitting || isLoading}
              icon={isSubmitting || isLoading ? Loader2 : CheckCircle2}
              iconAnimation={isSubmitting || isLoading ? 'spin' : undefined}
            >
              {isSubmitting || isLoading ? 'Creating account...' : 'Create account'}
            </Button>
          </form>

          {/* Sign In Link */}
          <p className="text-center text-sm text-gray-600 mt-6">
            Already have an account?{' '}
            <Link
              to="/auth/signin"
              className="text-blue-600 hover:text-blue-700 font-medium"
            >
              Sign in
            </Link>
          </p>
        </div>

        {/* Security Badge */}
        <div className="mt-6 text-center">
          <p className="text-xs text-gray-500 flex items-center justify-center gap-1">
            <Lock className="h-3 w-3" />
            Your data is encrypted and secure
          </p>
        </div>
      </div>
    </div>
  );
}
```

**Password Strength Indicator Component:**

```
// src/components/auth/PasswordStrengthIndicator.tsx
import React from 'react';
import { cn } from '@/lib/utils';

interface PasswordStrengthIndicatorProps {
  password: string;
  className?: string;
}

type Strength = 'weak' | 'fair' | 'good' | 'strong';

export function PasswordStrengthIndicator({ 
  password, 
  className 
}: PasswordStrengthIndicatorProps) {
  const calculateStrength = (pwd: string): Strength => {
    let score = 0;
    
    if (pwd.length >= 8) score++;
    if (pwd.length >= 12) score++;
    if (/[a-z]/.test(pwd)) score++;
    if (/[A-Z]/.test(pwd)) score++;
    if (/[0-9]/.test(pwd)) score++;
    if (/[^A-Za-z0-9]/.test(pwd)) score++;
    
    if (score <= 2) return 'weak';
    if (score <= 4) return 'fair';
    if (score <= 5) return 'good';
    return 'strong';
  };

  const strength = calculateStrength(password);

  const strengthConfig = {
    weak: { 
      label: 'Weak', 
      color: 'bg-red-500', 
      width: 'w-1/4',
      textColor: 'text-red-700'
    },
    fair: { 
      label: 'Fair', 
      color: 'bg-orange-500', 
      width: 'w-2/4',
      textColor: 'text-orange-700'
    },
    good: { 
      label: 'Good', 
      color: 'bg-yellow-500', 
      width: 'w-3/4',
      textColor: 'text-yellow-700'
    },
    strong: { 
      label: 'Strong', 
      color: 'bg-green-500', 
      width: 'w-full',
      textColor: 'text-green-700'
    },
  };

  const config = strengthConfig[strength];

  return (
    <div className={cn('space-y-1', className)}>
      {/* Progress Bar */}
      <div className="h-1.5 bg-gray-200 rounded-full overflow-hidden">
        <div
          className={cn('h-full transition-all duration-300', config.color, config.width)}
        />
      </div>
      
      {/* Label */}
      <p className={cn('text-xs font-medium', config.textColor)}>
        Password strength: {config.label}
      </p>

      {/* Requirements Checklist */}
      <ul className="text-xs text-gray-600 space-y-1 mt-2">
        <Requirement met={password.length >= 8}>
          At least 8 characters
        </Requirement>
        <Requirement met={/[A-Z]/.test(password)}>
          One uppercase letter
        </Requirement>
        <Requirement met={/[a-z]/.test(password)}>
          One lowercase letter
        </Requirement>
        <Requirement met={/[0-9]/.test(password)}>
          One number
        </Requirement>
        <Requirement met={/[^A-Za-z0-9]/.test(password)}>
          One special character
        </Requirement>
      </ul>
    </div>
  );
}

function Requirement({ 
  met, 
  children 
}: { 
  met: boolean; 
  children: React.ReactNode;
}) {
  return (
    <li className="flex items-center gap-1.5">
      <span className={cn(
        'flex-shrink-0 w-3.5 h-3.5 rounded-full flex items-center justify-center',
        met ? 'bg-green-100' : 'bg-gray-100'
      )}>
        {met && (
          <svg className="w-2.5 h-2.5 text-green-600" fill="currentColor" viewBox="0 0 12 12">
            <path d="M10 3L4.5 8.5L2 6" stroke="currentColor" strokeWidth="2" fill="none" strokeLinecap="round" strokeLinejoin="round"/>
          </svg>
        )}
      </span>
      <span className={met ? 'text-green-700' : 'text-gray-500'}>
        {children}
      </span>
    </li>
  );
}
```

**Social Auth Buttons:**

```
// src/components/auth/SocialAuthButtons.tsx
import React from 'react';
import { Button } from '@/components/common/Button';
import { useAuth } from '@/hooks/useAuth';

interface SocialAuthButtonsProps {
  mode: 'signup' | 'signin';
}

export function SocialAuthButtons({ mode }: SocialAuthButtonsProps) {
  const { signInWithGoogle, signInWithApple } = useAuth();

  const actionText = mode === 'signup' ? 'Sign up' : 'Sign in';

  return (
    <div className="grid grid-cols-2 gap-4">
      <Button
        type="button"
        variant="outline"
        onClick={signInWithGoogle}
        icon={() => (
          <svg className="w-5 h-5" viewBox="0 0 24 24">
            <path
              fill="currentColor"
              d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
            />
            <path
              fill="currentColor"
              d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
            />
            <path
              fill="currentColor"
              d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
            />
            <path
              fill="currentColor"
              d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
            />
          </svg>
        )}
      >
        Google
      </Button>

      <Button
        type="button"
        variant="outline"
        onClick={signInWithApple}
        icon={() => (
          <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
            <path d="M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.35C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/>
          </svg>
        )}
      >
        Apple
      </Button>
    </div>
  );
}
```

#### **5.1.2 Sign In Flow** {#5.1.2-sign-in-flow}

**Component Implementation:**

```
// src/pages/auth/SignInPage.tsx
import React, { useState } from 'react';
import { useNavigate, Link, useSearchParams } from 'react-router-dom';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { Loader2, Mail, Lock, LogIn, AlertCircle } from 'lucide-react';
import { useAuth } from '@/hooks/useAuth';
import { Button } from '@/components/common/Button';
import { Input } from '@/components/common/Input';
import { Checkbox } from '@/components/common/Checkbox';
import { Alert } from '@/components/common/Alert';
import { SocialAuthButtons } from '@/components/auth/SocialAuthButtons';

const signInSchema = z.object({
  email: z.string().email('Invalid email address').toLowerCase().trim(),
  password: z.string().min(1, 'Password is required'),
  rememberMe: z.boolean().optional(),
});

type SignInFormData = z.infer<typeof signInSchema>;

export function SignInPage() {
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();
  const { signIn, isLoading } = useAuth();
  const [showPassword, setShowPassword] = useState(false);

  const redirectTo = searchParams.get('redirectTo') || '/dashboard';
  const message = searchParams.get('message');

  const {
    register,
    handleSubmit,
    formState: { errors, isSubmitting },
  } = useForm<SignInFormData>({
    resolver: zodResolver(signInSchema),
    defaultValues: {
      rememberMe: true,
    },
  });

  const onSubmit = async (data: SignInFormData) => {
    try {
      await signIn({
        email: data.email,
        password: data.password,
        rememberMe: data.rememberMe,
      });
      
      navigate(redirectTo);
    } catch (error) {
      // Error is handled by useAuth hook
      console.error('Sign in failed:', error);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 px-4 py-12">
      <div className="w-full max-w-md">
        {/* Logo */}
        <div className="text-center mb-8">
          <h1 className="text-4xl font-bold text-gray-900 mb-2">
            Budgetura
          </h1>
          <p className="text-gray-600">
            Welcome back! Sign in to continue
          </p>
        </div>

        {/* Sign In Card */}
        <div className="bg-white rounded-2xl shadow-xl p-8">
          {/* Message Alert (if redirected) */}
          {message && (
            <Alert variant="info" className="mb-6">
              <AlertCircle className="h-4 w-4" />
              <span>{message}</span>
            </Alert>
          )}

          <h2 className="text-2xl font-bold text-gray-900 mb-6">
            Sign in to your account
          </h2>

          {/* Social Auth Buttons */}
          <SocialAuthButtons mode="signin" />

          {/* Divider */}
          <div className="relative my-6">
            <div className="absolute inset-0 flex items-center">
              <div className="w-full border-t border-gray-300" />
            </div>
            <div className="relative flex justify-center text-sm">
              <span className="px-4 bg-white text-gray-500">
                Or continue with email
              </span>
            </div>
          </div>

          {/* Sign In Form */}
          <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
            {/* Email Field */}
            <Input
              {...register('email')}
              type="email"
              label="Email"
              placeholder="john.doe@example.com"
              icon={Mail}
              error={errors.email?.message}
              autoComplete="email"
              required
            />

            {/* Password Field */}
            <Input
              {...register('password')}
              type={showPassword ? 'text' : 'password'}
              label="Password"
              placeholder="••••••••"
              icon={Lock}
              error={errors.password?.message}
              autoComplete="current-password"
              required
              showPasswordToggle
              onTogglePassword={() => setShowPassword(!showPassword)}
            />

            {/* Remember Me & Forgot Password */}
            <div className="flex items-center justify-between">
              <Checkbox
                {...register('rememberMe')}
                label="Remember me"
              />
              <Link
                to="/auth/forgot-password"
                className="text-sm text-blue-600 hover:text-blue-700 font-medium"
              >
                Forgot password?
              </Link>
            </div>

            {/* Submit Button */}
            <Button
              type="submit"
              variant="primary"
              size="lg"
              fullWidth
              disabled={isSubmitting || isLoading}
              icon={isSubmitting || isLoading ? Loader2 : LogIn}
              iconAnimation={isSubmitting || isLoading ? 'spin' : undefined}
            >
              {isSubmitting || isLoading ? 'Signing in...' : 'Sign in'}
            </Button>
          </form>

          {/* Sign Up Link */}
          <p className="text-center text-sm text-gray-600 mt-6">
            Don't have an account?{' '}
            <Link
              to="/auth/signup"
              className="text-blue-600 hover:text-blue-700 font-medium"
            >
              Sign up for free
            </Link>
          </p>
        </div>

        {/* Security Badge */}
        <div className="mt-6 text-center">
          <p className="text-xs text-gray-500 flex items-center justify-center gap-1">
            <Lock className="h-3 w-3" />
            Secured with 256-bit encryption
          </p>
        </div>
      </div>
    </div>
  );
}
```

#### **5.1.3 Password Reset Flow** {#5.1.3-password-reset-flow}

```
// src/pages/auth/ForgotPasswordPage.tsx
import React, { useState } from 'react';
import { Link } from 'react-router-dom';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { Mail, ArrowLeft, Send, CheckCircle2 } from 'lucide-react';
import { useAuth } from '@/hooks/useAuth';
import { Button } from '@/components/common/Button';
import { Input } from '@/components/common/Input';
import { Alert } from '@/components/common/Alert';

const forgotPasswordSchema = z.object({
  email: z.string().email('Invalid email address').toLowerCase().trim(),
});

type ForgotPasswordFormData = z.infer<typeof forgotPasswordSchema>;

export function ForgotPasswordPage() {
  const { resetPassword } = useAuth();
  const [isSuccess, setIsSuccess] = useState(false);

  const {
    register,
    handleSubmit,
    formState: { errors, isSubmitting },
    getValues,
  } = useForm<ForgotPasswordFormData>({
    resolver: zodResolver(forgotPasswordSchema),
  });

  const onSubmit = async (data: ForgotPasswordFormData) => {
    try {
      await resetPassword(data.email);
      setIsSuccess(true);
    } catch (error) {
      console.error('Password reset failed:', error);
    }
  };

  if (isSuccess) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 px-4 py-12">
        <div className="w-full max-w-md">
          <div className="bg-white rounded-2xl shadow-xl p-8 text-center">
            <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <CheckCircle2 className="h-8 w-8 text-green-600" />
            </div>
            
            <h2 className="text-2xl font-bold text-gray-900 mb-2">
              Check your email
            </h2>
            
            <p className="text-gray-600 mb-6">
              We've sent a password reset link to{' '}
              <span className="font-medium text-gray-900">
                {getValues('email')}
              </span>
            </p>

            <Alert variant="info" className="mb-6 text-left">
              <p className="text-sm">
                Didn't receive the email? Check your spam folder or{' '}
                <button
                  onClick={() => setIsSuccess(false)}
                  className="font-medium text-blue-600 hover:text-blue-700"
                >
                  try again
                </button>
              </p>
            </Alert>

            <Link to="/auth/signin">
              <Button variant="outline" fullWidth icon={ArrowLeft}>
                Back to sign in
              </Button>
            </Link>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 px-4 py-12">
      <div className="w-full max-w-md">
        <div className="text-center mb-8">
          <h1 className="text-4xl font-bold text-gray-900 mb-2">
            Budgetura
          </h1>
          <p className="text-gray-600">
            Reset your password
          </p>
        </div>

        <div className="bg-white rounded-2xl shadow-xl p-8">
          <h2 className="text-2xl font-bold text-gray-900 mb-2">
            Forgot your password?
          </h2>
          
          <p className="text-gray-600 mb-6">
            Enter your email address and we'll send you a link to reset your password.
          </p>

          <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
            <Input
              {...register('email')}
              type="email"
              label="Email"
              placeholder="john.doe@example.com"
              icon={Mail}
              error={errors.email?.message}
              autoComplete="email"
              required
            />

            <Button
              type="submit"
              variant="primary"
              size="lg"
              fullWidth
              disabled={isSubmitting}
              icon={Send}
            >
              {isSubmitting ? 'Sending...' : 'Send reset link'}
            </Button>
          </form>

          <div className="mt-6 text-center">
            <Link
              to="/auth/signin"
              className="text-sm text-gray-600 hover:text-gray-900 inline-flex items-center gap-1"
            >
              <ArrowLeft className="h-4 w-4" />
              Back to sign in
            </Link>
          </div>
        </div>
      </div>
    </div>
  );
}
```

### **5.2 Dashboard Overview** {#5.2-dashboard-overview}

#### **5.2.1 Dashboard Layout** {#5.2.1-dashboard-layout}

**Purpose:** Provide a comprehensive at-a-glance view of the user's entire financial picture

**User Story:** As a user, I want to see my complete financial snapshot when I log in so that I can quickly understand my current debt situation and progress

**Components:**

* `DashboardPage.tsx` \- Main dashboard container  
* `DashboardHeader.tsx` \- Welcome message and quick actions  
* `MetricCards.tsx` \- Key financial metrics  
* `DebtBreakdownChart.tsx` \- Pie chart of debt by category  
* `ProgressOverTimeChart.tsx` \- Line chart showing debt reduction  
* `UpcomingPayments.tsx` \- Next 7 days of due payments  
* `QuickActions.tsx` \- Common action buttons  
* `RecentActivity.tsx` \- Recent transactions/updates

**Layout Structure:**

```
┌─────────────────────────────────────────────────────────┐
│  Dashboard Header (Welcome + Date + Quick Add Button)  │
├─────────────────────────────────────────────────────────┤
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐│
│  │Total │ │Monthly│ │Monthly│ │ DTI  │ │Credit│ │Debt │ │
│  │Debt  │ │Debt  │ │Bills │ │Ratio │ │ Use  │ │Free │ │
│  └──────┘ └──────┘ └──────┘ └──────┘ └──────┘ └──────┘│
├───────────────────────────┬─────────────────────────────┤
│   Debt Breakdown Chart    │  Progress Over Time Chart   │
│   (Pie Chart)             │  (Line Chart)               │
│                           │                             │
├───────────────────────────┴─────────────────────────────┤
│  Upcoming Payments (Next 7 Days)                        │
├───────────────────────────┬─────────────────────────────┤
│   Quick Actions           │   Recent Activity           │
│   - Add Credit Card       │   - Updated: Chase Card     │
│   - Add Loan              │   - Payment: Auto Loan      │
│   - Add Bill              │   - New Goal: Vacation      │
│   - Create Snapshot       │                             │
└───────────────────────────┴─────────────────────────────┘
```

**Full Implementation:**

```
// src/pages/DashboardPage.tsx
import React from 'react';
import { Plus, TrendingDown, Target, Calendar } from 'lucide-react';
import { DashboardHeader } from '@/components/dashboard/DashboardHeader';
import { MetricCards } from '@/components/dashboard/MetricCards';
import { DebtBreakdownChart } from '@/components/dashboard/DebtBreakdownChart';
import { ProgressOverTimeChart } from '@/components/dashboard/ProgressOverTimeChart';
import { UpcomingPayments } from '@/components/dashboard/UpcomingPayments';
import { QuickActions } from '@/components/dashboard/QuickActions';
import { RecentActivity } from '@/components/dashboard/RecentActivity';
import { useDashboardData } from '@/hooks/useDashboardData';
import { Button } from '@/components/common/Button';
import { Skeleton } from '@/components/common/Skeleton';

export function DashboardPage() {
  const { data, isLoading, error } = useDashboardData();

  if (isLoading) {
    return <DashboardSkeleton />;
  }

  if (error) {
    return (
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div className="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
          <p className="text-red-800">
            Failed to load dashboard data. Please try again.
          </p>
          <Button 
            variant="outline" 
            className="mt-4"
            onClick={() => window.location.reload()}
          >
            Reload
          </Button>
        </div>
      </div>
    );
  }

  return (
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {/* Dashboard Header */}
      <DashboardHeader user={data.user} />

      {/* Metric Cards */}
      <MetricCards metrics={data.metrics} className="mt-8" />

      {/* Charts Grid */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
        {/* Debt Breakdown */}
        <DebtBreakdownChart data={data.debtBreakdown} />

        {/* Progress Over Time */}
        <ProgressOverTimeChart data={data.progressHistory} />
      </div>

      {/* Upcoming Payments */}
      <UpcomingPayments payments={data.upcomingPayments} className="mt-8" />

      {/* Quick Actions & Recent Activity */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
        <QuickActions />
        <RecentActivity activities={data.recentActivities} />
      </div>
    </div>
  );
}

function DashboardSkeleton() {
  return (
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <Skeleton className="h-12 w-64 mb-8" />
      
      {/* Metric Cards Skeleton */}
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
        {[...Array(6)].map((_, i) => (
          <Skeleton key={i} className="h-32 rounded-lg" />
        ))}
      </div>

      {/* Charts Skeleton */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
        <Skeleton className="h-80 rounded-lg" />
        <Skeleton className="h-80 rounded-lg" />
      </div>

      {/* Upcoming Payments Skeleton */}
      <Skeleton className="h-64 rounded-lg mt-8" />

      {/* Bottom Grid Skeleton */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
        <Skeleton className="h-64 rounded-lg" />
        <Skeleton className="h-64 rounded-lg" />
      </div>
    </div>
  );
}
```

**Dashboard Header Component:**

```
// src/components/dashboard/DashboardHeader.tsx
import React, { useState } from 'react';
import { Plus, Calendar } from 'lucide-react';
import { Button } from '@/components/common/Button';
import { QuickAddModal } from '@/components/dashboard/QuickAddModal';
import { formatDate } from '@/lib/utils/formatters';
import type { User } from '@/types';

interface DashboardHeaderProps {
  user: User;
}

export function DashboardHeader({ user }: DashboardHeaderProps) {
  const [isQuickAddOpen, setIsQuickAddOpen] = useState(false);

  const getGreeting = () => {
    const hour = new Date().getHours();
    if (hour < 12) return 'Good morning';
    if (hour < 18) return 'Good afternoon';
    return 'Good evening';
  };

  return (
    <>
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">
            {getGreeting()}, {user.firstName || 'there'}!
          </h1>
          <p className="text-gray-600 mt-1 flex items-center gap-2">
            <Calendar className="h-4 w-4" />
            {formatDate(new Date(), user.dateFormat || 'MMMM d, yyyy')}
          </p>
        </div>

        <Button
          variant="primary"
          icon={Plus}
          onClick={() => setIsQuickAddOpen(true)}
        >
          Quick Add
        </Button>
      </div>

      <QuickAddModal
        isOpen={isQuickAddOpen}
        onClose={() => setIsQuickAddOpen(false)}
      />
    </>
  );
}
```

**Metric Cards Component:**

```
// src/components/dashboard/MetricCards.tsx
import React from 'react';
import { 
  DollarSign, 
  CreditCard, 
  Receipt, 
  TrendingUp, 
  Target,
  Calendar
} from 'lucide-react';
import { Card } from '@/components/common/Card';
import { formatCurrency, formatPercentage } from '@/lib/utils/formatters';
import { cn } from '@/lib/utils';
import type { DashboardMetrics } from '@/types';

interface MetricCardsProps {
  metrics: DashboardMetrics;
  className?: string;
}

export function MetricCards({ metrics, className }: MetricCardsProps) {
  const cards = [
    {
      id: 'total-debt',
      label: 'Total Debt',
      value: formatCurrency(metrics.totalDebt),
      icon: DollarSign,
      color: 'blue',
      trend: metrics.debtChange,
      trendLabel: 'vs last month',
    },
    {
      id: 'monthly-payments',
      label: 'Monthly Payments',
      value: formatCurrency(metrics.totalMonthlyPayments),
      icon: CreditCard,
      color: 'purple',
      subValue: formatCurrency(metrics.minimumPayments) + ' minimum',
    },
    {
      id: 'monthly-bills',
      label: 'Monthly Bills',
      value: formatCurrency(metrics.totalMonthlyBills),
      icon: Receipt,
      color: 'orange',
      subValue: `${metrics.activeBillsCount} active bills`,
    },
    {
      id: 'dti-ratio',
      label: 'DTI Ratio',
      value: formatPercentage(metrics.debtToIncomeRatio),
      icon: TrendingUp,
      color: getDTIColor(metrics.debtToIncomeRatio),
      subValue: getDTILabel(metrics.debtToIncomeRatio),
    },
    {
      id: 'credit-utilization',
      label: 'Credit Utilization',
      value: formatPercentage(metrics.creditUtilization),
      icon: Target,
      color: getUtilizationColor(metrics.creditUtilization),
      subValue: getUtilizationLabel(metrics.creditUtilization),
    },
    {
      id: 'debt-free-date',
      label: 'Debt Free Date',
      value: metrics.projectedDebtFreeDate 
        ? formatDate(metrics.projectedDebtFreeDate, 'MMM yyyy')
        : 'Not set',
      icon: Calendar,
      color: 'green',
      subValue: metrics.monthsToDebtFree 
        ? `${metrics.monthsToDebtFree} months`
        : null,
    },
  ];

  return (
    <div className={cn(
      'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4',
      className
    )}>
      {cards.map((card) => (
        <MetricCard key={card.id} {...card} />
      ))}
    </div>
  );
}

interface MetricCardProps {
  label: string;
  value: string;
  icon: React.ElementType;
  color: string;
  subValue?: string | null;
  trend?: number;
  trendLabel?: string;
}

function MetricCard({
  label,
  value,
  icon: Icon,
  color,
  subValue,
  trend,
  trendLabel,
}: MetricCardProps) {
  const colorClasses = {
    blue: 'bg-blue-100 text-blue-600',
    purple: 'bg-purple-100 text-purple-600',
    orange: 'bg-orange-100 text-orange-600',
    red: 'bg-red-100 text-red-600',
    yellow: 'bg-yellow-100 text-yellow-600',
    green: 'bg-green-100 text-green-600',
  };

  return (
    <Card className="p-4">
      <div className="flex items-start justify-between">
        <div className="flex-1">
          <p className="text-sm text-gray-600 font-medium">
            {label}
          </p>
          <p className="text-2xl font-bold text-gray-900 mt-1">
            {value}
          </p>
          
          {subValue && (
            <p className="text-xs text-gray-500 mt-1">
              {subValue}
            </p>
          )}

          {trend !== undefined && (
            <div className={cn(
              'text-xs font-medium mt-1 flex items-center gap-1',
              trend < 0 ? 'text-green-600' : trend > 0 ? 'text-red-600' : 'text-gray-600'
            )}>
              {trend < 0 ? '↓' : trend > 0 ? '↑' : '→'} 
              {formatCurrency(Math.abs(trend))} {trendLabel}
            </div>
          )}
        </div>

        <div className={cn(
          'p-2 rounded-lg',
          colorClasses[color as keyof typeof colorClasses]
        )}>
          <Icon className="h-5 w-5" />
        </div>
      </div>
    </Card>
  );
}

function getDTIColor(ratio: number): string {
  if (ratio <= 36) return 'green';
  if (ratio <= 43) return 'yellow';
  return 'red';
}

function getDTILabel(ratio: number): string {
  if (ratio <= 36) return 'Excellent';
  if (ratio <= 43) return 'Good';
  if (ratio <= 50) return 'Fair';
  return 'High';
}

function getUtilizationColor(utilization: number): string {
  if (utilization <= 30) return 'green';
  if (utilization <= 50) return 'yellow';
  return 'red';
}

function getUtilizationLabel(utilization: number): string {
  if (utilization <= 30) return 'Excellent';
  if (utilization <= 50) return 'Good';
  if (utilization <= 75) return 'Fair';
  return 'High';
}
```

**Debt Breakdown Chart:**

```
// src/components/dashboard/DebtBreakdownChart.tsx
import React from 'react';
import { PieChart, Pie, Cell, ResponsiveContainer, Legend, Tooltip } from 'recharts';
import { Card } from '@/components/common/Card';
import { formatCurrency } from '@/lib/utils/formatters';
import type { DebtBreakdown } from '@/types';

interface DebtBreakdownChartProps {
  data: DebtBreakdown;
}

export function DebtBreakdownChart({ data }: DebtBreakdownChartProps) {
  const chartData = [
    { name: 'Credit Cards', value: data.creditCards, color: '#3b82f6' },
    { name: 'Loans', value: data.loans, color: '#8b5cf6' },
    { name: 'Mortgage', value: data.mortgage, color: '#10b981' },
  ].filter(item => item.value > 0);

  const total = chartData.reduce((sum, item) => sum + item.value, 0);

  if (total === 0) {
    return (
      <Card className="p-6">
        <h3 className="text-lg font-semibold text-gray-900 mb-4">
          Debt Breakdown
        </h3>
        <div className="flex items-center justify-center h-64 text-gray-500">
          <p>No debt to display. Great job!</p>
        </div>
      </Card>
    );
  }

  return (
    <Card className="p-6">
      <h3 className="text-lg font-semibold text-gray-900 mb-4">
        Debt Breakdown
      </h3>

      <ResponsiveContainer width="100%" height={300}>
        <PieChart>
          <Pie
            data={chartData}
            cx="50%"
            cy="50%"
            labelLine={false}
            label={renderCustomLabel}
            outerRadius={100}
            fill="#8884d8"
            dataKey="value"
          >
            {chartData.map((entry, index) => (
              <Cell key={`cell-${index}`} fill={entry.color} />
            ))}
          </Pie>
          <Tooltip content={<CustomTooltip />} />
          <Legend 
            verticalAlign="bottom" 
            height={36}
            formatter={(value, entry: any) => (
              <span className="text-sm">
                {value}: {formatCurrency(entry.payload.value)}
              </span>
            )}
          />
        </PieChart>
      </ResponsiveContainer>

      {/* Summary Stats */}
      <div className="mt-6 pt-6 border-t border-gray-200">
        <div className="grid grid-cols-3 gap-4 text-center">
          {chartData.map((item) => (
            <div key={item.name}>
              <p className="text-xs text-gray-600">{item.name}</p>
              <p className="text-lg font-semibold text-gray-900 mt-1">
                {formatCurrency(item.value)}
              </p>
              <p className="text-xs text-gray-500">
                {((item.value / total) * 100).toFixed(1)}%
              </p>
            </div>
          ))}
        </div>
      </div>
    </Card>
  );
}

const renderCustomLabel = ({
  cx,
  cy,
  midAngle,
  innerRadius,
  outerRadius,
  percent,
}: any) => {
  const RADIAN = Math.PI / 180;
  const radius = innerRadius + (outerRadius - innerRadius) * 0.5;
  const x = cx + radius * Math.cos(-midAngle * RADIAN);
  const y = cy + radius * Math.sin(-midAngle * RADIAN);

  if (percent < 0.05) return null;

  return (
    <text
      x={x}
      y={y}
      fill="white"
      textAnchor={x > cx ? 'start' : 'end'}
      dominantBaseline="central"
      className="text-sm font-semibold"
    >
      {`${(percent * 100).toFixed(0)}%`}
    </text>
  );
};

const CustomTooltip = ({ active, payload }: any) => {
  if (active && payload && payload.length) {
    return (
      <div className="bg-white px-4 py-2 border border-gray-200 rounded-lg shadow-lg">
        <p className="text-sm font-medium text-gray-900">
          {payload[0].name}
        </p>
        <p className="text-lg font-bold text-gray-900">
          {formatCurrency(payload[0].value)}
        </p>
      </div>
    );
  }
  return null;
};
```

**Progress Over Time Chart:**

```
// src/components/dashboard/ProgressOverTimeChart.tsx
import React, { useState } from 'react';
import {
  LineChart,
  Line,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  Legend,
} from 'recharts';
import { Card } from '@/components/common/Card';
import { Button } from '@/components/common/Button';
import { formatCurrency, formatDate } from '@/lib/utils/formatters';
import type { ProgressHistory } from '@/types';

interface ProgressOverTimeChartProps {
  data: ProgressHistory[];
}

type TimeRange = '3M' | '6M' | '1Y' | 'ALL';

export function ProgressOverTimeChart({ data }: ProgressOverTimeChartProps) {
  const [timeRange, setTimeRange] = useState<TimeRange>('6M');

  const filterDataByRange = (range: TimeRange) => {
    const now = new Date();
    const cutoffDate = new Date();

    switch (range) {
      case '3M':
        cutoffDate.setMonth(now.getMonth() - 3);
        break;
      case '6M':
        cutoffDate.setMonth(now.getMonth() - 6);
        break;
      case '1Y':
        cutoffDate.setFullYear(now.getFullYear() - 1);
        break;
      case 'ALL':
        return data;
    }

    return data.filter(item => new Date(item.date) >= cutoffDate);
  };

  const filteredData = filterDataByRange(timeRange);

  const chartData = filteredData.map(item => ({
    date: formatDate(item.date, 'MMM yy'),
    fullDate: item.date,
    totalDebt: item.totalDebt,
    creditCards: item.creditCardDebt,
    loans: item.loanDebt,
    mortgage: item.mortgageDebt,
  }));

  if (chartData.length === 0) {
    return (
      <Card className="p-6">
        <h3 className="text-lg font-semibold text-gray-900 mb-4">
          Progress Over Time
        </h3>
        <div className="flex items-center justify-center h-64 text-gray-500">
          <p>No historical data available yet. Create your first snapshot!</p>
        </div>
      </Card>
    );
  }

  const totalChange = chartData.length > 1
    ? chartData[chartData.length - 1].totalDebt - chartData[0].totalDebt
    : 0;

  const percentChange = chartData.length > 1 && chartData[0].totalDebt > 0
    ? (totalChange / chartData[0].totalDebt) * 100
    : 0;

  return (
    <Card className="p-6">
      <div className="flex items-center justify-between mb-4">
        <div>
          <h3 className="text-lg font-semibold text-gray-900">
            Progress Over Time
          </h3>
          {chartData.length > 1 && (
            <p className={`text-sm mt-1 ${totalChange < 0 ? 'text-green-600' : 'text-red-600'}`}>
              {totalChange < 0 ? '↓' : '↑'} {formatCurrency(Math.abs(totalChange))} (
              {Math.abs(percentChange).toFixed(1)}%)
            </p>
          )}
        </div>

        <div className="flex gap-2">
          {(['3M', '6M', '1Y', 'ALL'] as TimeRange[]).map((range) => (
            <Button
              key={range}
              variant={timeRange === range ? 'primary' : 'outline'}
              size="sm"
              onClick={() => setTimeRange(range)}
            >
              {range}
            </Button>
          ))}
        </div>
      </div>

      <ResponsiveContainer width="100%" height={300}>
        <LineChart data={chartData}>
          <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
          <XAxis
            dataKey="date"
            stroke="#6b7280"
            style={{ fontSize: '12px' }}
          />
          <YAxis
            stroke="#6b7280"
            style={{ fontSize: '12px' }}
            tickFormatter={(value) => `$${(value / 1000).toFixed(0)}k`}
          />
          <Tooltip content={<CustomTooltip />} />
          <Legend />
          <Line
            type="monotone"
            dataKey="totalDebt"
            stroke="#3b82f6"
            strokeWidth={3}
            dot={{ r: 4 }}
            activeDot={{ r: 6 }}
            name="Total Debt"
          />
          <Line
            type="monotone"
            dataKey="creditCards"
            stroke="#8b5cf6"
            strokeWidth={2}
            dot={false}
            name="Credit Cards"
          />
          <Line
            type="monotone"
            dataKey="loans"
            stroke="#f59e0b"
            strokeWidth={2}
            dot={false}
            name="Loans"
          />
          <Line
            type="monotone"
            dataKey="mortgage"
            stroke="#10b981"
            strokeWidth={2}
            dot={false}
            name="Mortgage"
          />
        </LineChart>
      </ResponsiveContainer>
    </Card>
  );
}

const CustomTooltip = ({ active, payload, label }: any) => {
  if (active && payload && payload.length) {
    return (
      <div className="bg-white px-4 py-3 border border-gray-200 rounded-lg shadow-lg">
        <p className="text-sm font-medium text-gray-900 mb-2">
          {formatDate(payload[0].payload.fullDate, 'MMMM yyyy')}
        </p>
        <div className="space-y-1">
          {payload.map((entry: any) => (
            <div key={entry.name} className="flex items-center justify-between gap-4">
              <span className="text-xs text-gray-600">{entry.name}:</span>
              <span className="text-sm font-semibold" style={{ color: entry.color }}>
                {formatCurrency(entry.value)}
              </span>
            </div>
          ))}
        </div>
      </div>
    );
  }
  return null;
};
```

**Upcoming Payments Component:**

```
// src/components/dashboard/UpcomingPayments.tsx
import React from 'react';
import { Link } from 'react-router-dom';
import { 
  Calendar, 
  CreditCard, 
  Home, 
  Banknote, 
  Receipt,
  ChevronRight,
  AlertCircle
} from 'lucide-react';
import { Card } from '@/components/common/Card';
import { Badge } from '@/components/common/Badge';
import { formatCurrency, formatDate } from '@/lib/utils/formatters';
import { cn } from '@/lib/utils';
import type { UpcomingPayment } from '@/types';

interface UpcomingPaymentsProps {
  payments: UpcomingPayment[];
  className?: string;
}

export function UpcomingPayments({ payments, className }: UpcomingPaymentsProps) {
  // Group payments by status
  const overdue = payments.filter(p => p.status === 'overdue');
  const dueSoon = payments.filter(p => p.status === 'due_soon');
  const upcoming = payments.filter(p => p.status === 'upcoming');

  const allPayments = [...overdue, ...dueSoon, ...upcoming].slice(0, 10);

  if (allPayments.length === 0) {
    return (
      <Card className={cn('p-6', className)}>
        <h3 className="text-lg font-semibold text-gray-900 mb-4">
          Upcoming Payments
        </h3>
        <div className="flex flex-col items-center justify-center h-32 text-gray-500">
          <Calendar className="h-12 w-12 mb-2" />
          <p>No payments due in the next 7 days</p>
        </div>
      </Card>
    );
  }

  const totalDue = allPayments.reduce((sum, p) => sum + p.amount, 0);

  return (
    <Card className={cn('p-6', className)}>
      <div className="flex items-center justify-between mb-4">
        <div>
          <h3 className="text-lg font-semibold text-gray-900">
            Upcoming Payments
          </h3>
          <p className="text-sm text-gray-600 mt-1">
            Next 7 days • {allPayments.length} payment{allPayments.length !== 1 ? 's' : ''} • {formatCurrency(totalDue)}
          </p>
        </div>
        
        {overdue.length > 0 && (
          <Badge variant="danger" className="flex items-center gap-1">
            <AlertCircle className="h-3 w-3" />
            {overdue.length} overdue
          </Badge>
        )}
      </div>

      <div className="space-y-3">
        {allPayments.map((payment) => (
          <PaymentItem key={payment.id} payment={payment} />
        ))}
      </div>

      {payments.length > 10 && (
        <Link
          to="/payments/calendar"
          className="block text-center text-sm text-blue-600 hover:text-blue-700 font-medium mt-4 pt-4 border-t border-gray-200"
        >
          View all payments →
        </Link>
      )}
    </Card>
  );
}

interface PaymentItemProps {
  payment: UpcomingPayment;
}

function PaymentItem({ payment }: PaymentItemProps) {
  const getIcon = () => {
    switch (payment.type) {
      case 'credit_card':
        return CreditCard;
      case 'mortgage':
        return Home;
      case 'loan':
        return Banknote;
      case 'bill':
        return Receipt;
      default:
        return Calendar;
    }
  };

  const Icon = getIcon();

  const getStatusConfig = () => {
    switch (payment.status) {
      case 'overdue':
        return {
          badge: <Badge variant="danger">Overdue</Badge>,
          dateColor: 'text-red-600',
        };
      case 'due_soon':
        return {
          badge: <Badge variant="warning">Due Soon</Badge>,
          dateColor: 'text-orange-600',
        };
      default:
        return {
          badge: null,
          dateColor: 'text-gray-600',
        };
    }
  };

  const config = getStatusConfig();

  return (
    <Link
      to={`/${payment.type}s/${payment.referenceId}`}
      className="flex items-center gap-4 p-3 hover:bg-gray-50 rounded-lg transition-colors group"
    >
      {/* Icon */}
      <div className="flex-shrink-0 w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center group-hover:bg-gray-200 transition-colors">
        <Icon className="h-5 w-5 text-gray-600" />
      </div>

      {/* Content */}
      <div className="flex-1 min-w-0">
        <div className="flex items-center gap-2">
          <p className="text-sm font-medium text-gray-900 truncate">
            {payment.name}
          </p>
          {config.badge}
        </div>
        <p className={cn('text-xs mt-0.5', config.dateColor)}>
          Due {formatDate(payment.dueDate, 'MMM d, yyyy')}
          {payment.autoPay && (
            <span className="ml-2 text-gray-500">• Auto-pay enabled</span>
          )}
        </p>
      </div>

      {/* Amount */}
      <div className="flex items-center gap-3">
        <p className="text-sm font-semibold text-gray-900">
          {formatCurrency(payment.amount)}
        </p>
        <ChevronRight className="h-4 w-4 text-gray-400 group-hover:text-gray-600" />
      </div>
    </Link>
  );
}
```

**Quick Actions Component:**

```
// src/components/dashboard/QuickActions.tsx
import React from 'react';
import { useNavigate } from 'react-router-dom';
import {
  CreditCard,
  Banknote,
  Home,
  Receipt,
  Target,
  Camera,
  TrendingDown,
  Calculator,
} from 'lucide-react';
import { Card } from '@/components/common/Card';
import { cn } from '@/lib/utils';

export function QuickActions() {
  const navigate = useNavigate();

  const actions = [
    {
      id: 'add-credit-card',
      label: 'Add Credit Card',
      icon: CreditCard,
      color: 'blue',
      onClick: () => navigate('/credit-cards/new'),
    },
    {
      id: 'add-loan',
      label: 'Add Loan',
      icon: Banknote,
      color: 'purple',
      onClick: () => navigate('/loans/new'),
    },
    {
      id: 'add-mortgage',
      label: 'Add Mortgage',
      icon: Home,
      color: 'green',
      onClick: () => navigate('/mortgage/new'),
    },
    {
      id: 'add-bill',
      label: 'Add Bill',
      icon: Receipt,
      color: 'orange',
      onClick: () => navigate('/bills/new'),
    },
    {
      id: 'add-goal',
      label: 'Create Goal',
      icon: Target,
      color: 'pink',
      onClick: () => navigate('/goals/new'),
    },
    {
      id: 'create-snapshot',
      label: 'Create Snapshot',
      icon: Camera,
      color: 'indigo',
      onClick: () => navigate('/snapshots/create'),
    },
    {
      id: 'payoff-calculator',
      label: 'Payoff Calculator',
      icon: Calculator,
      color: 'teal',
      onClick: () => navigate('/tools/calculator'),
    },
    {
      id: 'action-plan',
      label: 'View Action Plan',
      icon: TrendingDown,
      color: 'cyan',
      onClick: () => navigate('/action-plan'),
    },
  ];

  return (
    <Card className="p-6">
      <h3 className="text-lg font-semibold text-gray-900 mb-4">
        Quick Actions
      </h3>

      <div className="grid grid-cols-2 gap-3">
        {actions.map((action) => (
          <QuickActionButton key={action.id} {...action} />
        ))}
      </div>
    </Card>
  );
}

interface QuickActionButtonProps {
  label: string;
  icon: React.ElementType;
  color: string;
  onClick: () => void;
}

function QuickActionButton({
  label,
  icon: Icon,
  color,
  onClick,
}: QuickActionButtonProps) {
  const colorClasses = {
    blue: 'bg-blue-100 text-blue-600 hover:bg-blue-200',
    purple: 'bg-purple-100 text-purple-600 hover:bg-purple-200',
    green: 'bg-green-100 text-green-600 hover:bg-green-200',
    orange: 'bg-orange-100 text-orange-600 hover:bg-orange-200',
    pink: 'bg-pink-100 text-pink-600 hover:bg-pink-200',
    indigo: 'bg-indigo-100 text-indigo-600 hover:bg-indigo-200',
    teal: 'bg-teal-100 text-teal-600 hover:bg-teal-200',
    cyan: 'bg-cyan-100 text-cyan-600 hover:bg-cyan-200',
  };

  return (
    <button
      onClick={onClick}
      className={cn(
        'flex flex-col items-center justify-center gap-2 p-4 rounded-lg transition-colors',
        colorClasses[color as keyof typeof colorClasses]
      )}
    >
      <Icon className="h-6 w-6" />
      <span className="text-xs font-medium text-center leading-tight">
        {label}
      </span>
    </button>
  );
}
```

**Recent Activity Component:**

```
// src/components/dashboard/RecentActivity.tsx
import React from 'react';
import { Link } from 'react-router-dom';
import {
  Plus,
  Edit,
  Trash2,
  DollarSign,
  TrendingDown,
  Camera,
  Target,
} from 'lucide-react';
import { Card } from '@/components/common/Card';
import { formatDate, formatCurrency } from '@/lib/utils/formatters';
import { cn } from '@/lib/utils';
import type { Activity } from '@/types';

interface RecentActivityProps {
  activities: Activity[];
}

export function RecentActivity({ activities }: RecentActivityProps) {
  if (activities.length === 0) {
    return (
      <Card className="p-6">
        <h3 className="text-lg font-semibold text-gray-900 mb-4">
          Recent Activity
        </h3>
        <div className="flex flex-col items-center justify-center h-32 text-gray-500">
          <p className="text-sm">No recent activity</p>
        </div>
      </Card>
    );
  }

  return (
    <Card className="p-6">
      <div className="flex items-center justify-between mb-4">
        <h3 className="text-lg font-semibold text-gray-900">
          Recent Activity
        </h3>
        <Link
          to="/activity"
          className="text-sm text-blue-600 hover:text-blue-700 font-medium"
        >
          View all
        </Link>
      </div>

      <div className="space-y-3">
        {activities.map((activity) => (
          <ActivityItem key={activity.id} activity={activity} />
        ))}
      </div>
    </Card>
  );
}

interface ActivityItemProps {
  activity: Activity;
}

function ActivityItem({ activity }: ActivityItemProps) {
  const getIcon = () => {
    switch (activity.action) {
      case 'created':
        return Plus;
      case 'updated':
        return Edit;
      case 'deleted':
        return Trash2;
      case 'payment':
        return DollarSign;
      case 'milestone':
        return Target;
      case 'snapshot':
        return Camera;
      default:
        return TrendingDown;
    }
  };

  const Icon = getIcon();

  const getActionColor = () => {
    switch (activity.action) {
      case 'created':
        return 'text-green-600 bg-green-100';
      case 'updated':
        return 'text-blue-600 bg-blue-100';
      case 'deleted':
        return 'text-red-600 bg-red-100';
      case 'payment':
        return 'text-purple-600 bg-purple-100';
      case 'milestone':
        return 'text-yellow-600 bg-yellow-100';
      case 'snapshot':
        return 'text-indigo-600 bg-indigo-100';
      default:
        return 'text-gray-600 bg-gray-100';
    }
  };

  const getActionText = () => {
    const type = activity.entityType.replace('_', ' ');
    switch (activity.action) {
      case 'created':
        return `Added ${type}`;
      case 'updated':
        return `Updated ${type}`;
      case 'deleted':
        return `Deleted ${type}`;
      case 'payment':
        return `Made payment on ${type}`;
      case 'milestone':
        return `Reached milestone`;
      case 'snapshot':
        return `Created snapshot`;
      default:
        return activity.action;
    }
  };

  return (
    <div className="flex items-start gap-3 p-3 hover:bg-gray-50 rounded-lg transition-colors">
      {/* Icon */}
      <div className={cn(
        'flex-shrink-0 w-8 h-8 rounded-lg flex items-center justify-center',
        getActionColor()
      )}>
        <Icon className="h-4 w-4" />
      </div>

      {/* Content */}
      <div className="flex-1 min-w-0">
        <p className="text-sm text-gray-900">
          {getActionText()}{' '}
          <span className="font-medium">{activity.entityName}</span>
        </p>
        <p className="text-xs text-gray-500 mt-0.5">
          {formatDate(activity.timestamp, 'MMM d, yyyy • h:mm a')}
        </p>
        {activity.metadata?.amount && (
          <p className="text-sm font-medium text-gray-900 mt-1">
            {formatCurrency(activity.metadata.amount)}
          </p>
        )}
      </div>
    </div>
  );
}
```

---

### **5.3 Credit Card Manager** {#5.3-credit-card-manager}

#### **5.3.1 Credit Card List View** {#5.3.1-credit-card-list-view}

**Purpose:** Display all credit cards with sorting, filtering, and quick actions

**User Story:** As a user, I want to view all my credit cards in one place so that I can quickly see my balances, utilization, and upcoming payments

**Components:**

* `CreditCardsPage.tsx` \- Main page container  
* `CreditCardList.tsx` \- List of credit cards  
* `CreditCardCard.tsx` \- Individual card display  
* `CreditCardFilters.tsx` \- Filter and sort controls  
* `CreditCardStats.tsx` \- Summary statistics

**Layout:**

```
┌─────────────────────────────────────────────────────────┐
│  Credit Cards Header + Add New Button                  │
├─────────────────────────────────────────────────────────┤
│  Summary Stats (Total Balance, Utilization, Monthly)   │
├─────────────────────────────────────────────────────────┤
│  Filters & Sort Controls                               │
├─────────────────────────────────────────────────────────┤
│  ┌───────────────────┐ ┌───────────────────┐           │
│  │  Chase Freedom    │ │  Amex Gold        │           │
│  │  $3,500 / $5,000  │ │  $2,100 / $10,000 │           │
│  │  70% utilization  │ │  21% utilization  │           │
│  │  Due: Jan 15      │ │  Due: Jan 20      │           │
│  └───────────────────┘ └───────────────────┘           │
│  ┌───────────────────┐ ┌───────────────────┐           │
│  │  Discover It      │ │  Capital One      │           │
│  │  $1,200 / $3,000  │ │  $0 / $8,000      │           │
│  │  40% utilization  │ │  Paid Off ✓       │           │
│  └───────────────────┘ └───────────────────┘           │
└─────────────────────────────────────────────────────────┘
```

**Full Implementation:**

```
// src/pages/CreditCardsPage.tsx
import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { Plus } from 'lucide-react';
import { useCreditCards } from '@/hooks/api/useCreditCards';
import { Button } from '@/components/common/Button';
import { CreditCardStats } from '@/components/credit-cards/CreditCardStats';
import { CreditCardFilters } from '@/components/credit-cards/CreditCardFilters';
import { CreditCardList } from '@/components/credit-cards/CreditCardList';
import { EmptyState } from '@/components/common/EmptyState';
import { Skeleton } from '@/components/common/Skeleton';
import type { CreditCardFilters as Filters, CreditCardSortBy } from '@/types';

export function CreditCardsPage() {
  const navigate = useNavigate();
  const { data: cards, isLoading, error } = useCreditCards();
  
  const [filters, setFilters] = useState<Filters>({
    status: 'all',
    search: '',
  });
  
  const [sortBy, setSortBy] = useState<CreditCardSortBy>('utilization_desc');

  if (isLoading) {
    return <CreditCardsSkeleton />;
  }

  if (error) {
    return (
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div className="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
          <p className="text-red-800">Failed to load credit cards. Please try again.</p>
        </div>
      </div>
    );
  }

  if (!cards || cards.length === 0) {
    return (
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <EmptyState
          icon={Plus}
          title="No credit cards yet"
          description="Add your first credit card to start tracking your balances and payments"
          action={{
            label: 'Add Credit Card',
            onClick: () => navigate('/credit-cards/new'),
          }}
        />
      </div>
    );
  }

  // Filter cards
  let filteredCards = cards;

  if (filters.status !== 'all') {
    filteredCards = filteredCards.filter(card => card.status === filters.status);
  }

  if (filters.search) {
    const search = filters.search.toLowerCase();
    filteredCards = filteredCards.filter(card =>
      card.cardName.toLowerCase().includes(search) ||
      card.issuer?.toLowerCase().includes(search)
    );
  }

  // Sort cards
  const sortedCards = [...filteredCards].sort((a, b) => {
    switch (sortBy) {
      case 'utilization_desc':
        return b.utilizationPercentage - a.utilizationPercentage;
      case 'utilization_asc':
        return a.utilizationPercentage - b.utilizationPercentage;
      case 'balance_desc':
        return b.balance - a.balance;
      case 'balance_asc':
        return a.balance - b.balance;
      case 'name_asc':
        return a.cardName.localeCompare(b.cardName);
      case 'name_desc':
        return b.cardName.localeCompare(a.cardName);
      case 'due_date':
        if (!a.dueDate) return 1;
        if (!b.dueDate) return -1;
        return a.dueDate - b.dueDate;
      default:
        return 0;
    }
  });

  return (
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {/* Header */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">Credit Cards</h1>
          <p className="text-gray-600 mt-1">
            Manage your credit cards and track utilization
          </p>
        </div>

        <Button
          variant="primary"
          icon={Plus}
          onClick={() => navigate('/credit-cards/new')}
        >
          Add Credit Card
        </Button>
      </div>

      {/* Summary Stats */}
      <CreditCardStats cards={cards} className="mb-8" />

      {/* Filters */}
      <CreditCardFilters
        filters={filters}
        sortBy={sortBy}
        onFiltersChange={setFilters}
        onSortChange={setSortBy}
        className="mb-6"
      />

      {/* Card List */}
      {sortedCards.length === 0 ? (
        <div className="bg-gray-50 rounded-lg p-8 text-center">
          <p className="text-gray-600">
            No credit cards match your filters
          </p>
        </div>
      ) : (
        <CreditCardList cards={sortedCards} />
      )}
    </div>
  );
}

function CreditCardsSkeleton() {
  return (
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <Skeleton className="h-12 w-64 mb-8" />
      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
        {[...Array(3)].map((_, i) => (
          <Skeleton key={i} className="h-24 rounded-lg" />
        ))}
      </div>
      <Skeleton className="h-12 w-full mb-6" />
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {[...Array(6)].map((_, i) => (
          <Skeleton key={i} className="h-64 rounded-lg" />
        ))}
      </div>
    </div>
  );
}
```

**Credit Card Stats Component:**

```
// src/components/credit-cards/CreditCardStats.tsx
import React from 'react';
import { CreditCard, TrendingUp, DollarSign } from 'lucide-react';
import { Card } from '@/components/common/Card';
import { formatCurrency, formatPercentage } from '@/lib/utils/formatters';
import { cn } from '@/lib/utils';
import type { CreditCard as CreditCardType } from '@/types';

interface CreditCardStatsProps {
  cards: CreditCardType[];
  className?: string;
}

export function CreditCardStats({ cards, className }: CreditCardStatsProps) {
  const activeCards = cards.filter(card => card.status === 'active');

  const totalBalance = activeCards.reduce((sum, card) => sum + card.balance, 0);
  const totalCreditLimit = activeCards.reduce((sum, card) => sum + card.creditLimit, 0);
  const totalAvailableCredit = activeCards.reduce((sum, card) => sum + card.availableCredit, 0);
  const totalMinimumPayment = activeCards.reduce((sum, card) => sum + card.minimumPayment, 0);
  const totalMonthlyPayment = activeCards.reduce(
    (sum, card) => sum + card.minimumPayment + card.extraPayment,
    0
  );

  const overallUtilization = totalCreditLimit > 0
    ? (totalBalance / totalCreditLimit) * 100
    : 0;

  const stats = [
    {
      label: 'Total Balance',
      value: formatCurrency(totalBalance),
      subValue: `${activeCards.length} active card${activeCards.length !== 1 ? 's' : ''}`,
      icon: DollarSign,
      color: 'blue',
    },
    {
      label: 'Credit Utilization',
      value: formatPercentage(overallUtilization),
      subValue: `${formatCurrency(totalAvailableCredit)} available`,
      icon: TrendingUp,
      color: overallUtilization <= 30 ? 'green' : overallUtilization <= 50 ? 'yellow' : 'red',
    },
    {
      label: 'Monthly Payments',
      value: formatCurrency(totalMonthlyPayment),
      subValue: `${formatCurrency(totalMinimumPayment)} minimum`,
      icon: CreditCard,
      color: 'purple',
    },
  ];

  return (
    <div className={cn('grid grid-cols-1 sm:grid-cols-3 gap-4', className)}>
      {stats.map((stat) => (
        <StatCard key={stat.label} {...stat} />
      ))}
    </div>
  );
}

interface StatCardProps {
  label: string;
  value: string;
  subValue: string;
  icon: React.ElementType;
  color: string;
}

function StatCard({ label, value, subValue, icon: Icon, color }: StatCardProps) {
  const colorClasses = {
    blue: 'bg-blue-100 text-blue-600',
    green: 'bg-green-100 text-green-600',
    yellow: 'bg-yellow-100 text-yellow-600',
    red: 'bg-red-100 text-red-600',
    purple: 'bg-purple-100 text-purple-600',
  };

  return (
    <Card className="p-6">
      <div className="flex items-start justify-between">
        <div>
          <p className="text-sm text-gray-600 font-medium">{label}</p>
          <p className="text-2xl font-bold text-gray-900 mt-1">{value}</p>
          <p className="text-xs text-gray-500 mt-1">{subValue}</p>
        </div>
        <div className={cn(
          'p-2 rounded-lg',
          colorClasses[color as keyof typeof colorClasses]
        )}>
          <Icon className="h-5 w-5" />
        </div>
      </div>
    </Card>
  );
}
```

**Credit Card Filters Component:**

```
// src/components/credit-cards/CreditCardFilters.tsx
import React from 'react';
import { Search, SlidersHorizontal } from 'lucide-react';
import { Input } from '@/components/common/Input';
import { Select } from '@/components/common/Select';
import { cn } from '@/lib/utils';
import type { CreditCardFilters as Filters, CreditCardSortBy } from '@/types';

interface CreditCardFiltersProps {
  filters: Filters;
  sortBy: CreditCardSortBy;
  onFiltersChange: (filters: Filters) => void;
  onSortChange: (sortBy: CreditCardSortBy) => void;
  className?: string;
}

export function CreditCardFilters({
  filters,
  sortBy,
  onFiltersChange,
  onSortChange,
  className,
}: CreditCardFiltersProps) {
  return (
    <div className={cn('flex flex-col sm:flex-row gap-4', className)}>
      {/* Search */}
      <div className="flex-1">
        <Input
          placeholder="Search cards..."
          icon={Search}
          value={filters.search}
          onChange={(e) => onFiltersChange({ ...filters, search: e.target.value })}
        />
      </div>

      {/* Status Filter */}
      <Select
        value={filters.status}
        onChange={(e) => onFiltersChange({ ...filters, status: e.target.value as any })}
        className="w-full sm:w-40"
      >
        <option value="all">All Cards</option>
        <option value="active">Active</option>
        <option value="paid_off">Paid Off</option>
        <option value="closed">Closed</option>
        <option value="frozen">Frozen</option>
      </Select>

      {/* Sort */}
      <Select
        value={sortBy}
        onChange={(e) => onSortChange(e.target.value as CreditCardSortBy)}
        icon={SlidersHorizontal}
        className="w-full sm:w-56"
      >
        <option value="utilization_desc">Highest Utilization</option>
        <option value="utilization_asc">Lowest Utilization</option>
        <option value="balance_desc">Highest Balance</option>
        <option value="balance_asc">Lowest Balance</option>
        <option value="name_asc">Name (A-Z)</option>
        <option value="name_desc">Name (Z-A)</option>
        <option value="due_date">Due Date</option>
      </Select>
    </div>
  );
}
```

**Credit Card List Component:**

```
// src/components/credit-cards/CreditCardList.tsx
import React from 'react';
import { CreditCardCard } from './CreditCardCard';
import type { CreditCard } from '@/types';

interface CreditCardListProps {
  cards: CreditCard[];
}

export function CreditCardList({ cards }: CreditCardListProps) {
  return (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {cards.map((card) => (
        <CreditCardCard key={card.id} card={card} />
      ))}
    </div>
  );
}
```

**Credit Card Card Component:**

```
// src/components/credit-cards/CreditCardCard.tsx
import React, { useState } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import {
  CreditCard as CreditCardIcon,
  MoreVertical,
  Edit,
  Trash2,
  Eye,
  Calculator,
} from 'lucide-react';
import { Card } from '@/components/common/Card';
import { Badge } from '@/components/common/Badge';
import { DropdownMenu } from '@/components/common/DropdownMenu';
import { ProgressBar } from '@/components/common/ProgressBar';
import { ConfirmDialog } from '@/components/common/ConfirmDialog';
import { useDeleteCreditCard } from '@/hooks/api/useCreditCards';
import { formatCurrency, formatPercentage } from '@/lib/utils/formatters';
import { cn } from '@/lib/utils';
import type { CreditCard } from '@/types';

interface CreditCardCardProps {
  card: CreditCard;
}

export function CreditCardCard({ card }: CreditCardCardProps) {
  const navigate = useNavigate();
  const { mutate: deleteCard } = useDeleteCreditCard();
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);

  const getUtilizationColor = (utilization: number) => {
    if (utilization <= 30) return 'success';
    if (utilization <= 50) return 'warning';
    return 'danger';
  };

  const getStatusBadge = () => {
    switch (card.status) {
      case 'active':
        return <Badge variant="success">Active</Badge>;
      case 'paid_off':
        return <Badge variant="info">Paid Off</Badge>;
      case 'closed':
        return <Badge variant="secondary">Closed</Badge>;
      case 'frozen':
        return <Badge variant="warning">Frozen</Badge>;
      default:
        return null;
    }
  };

  const handleDelete = () => {
    deleteCard(card.id, {
      onSuccess: () => {
        setShowDeleteDialog(false);
      },
    });
  };

  const menuItems = [
    {
      label: 'View Details',
      icon: Eye,
      onClick: () => navigate(`/credit-cards/${card.id}`),
    },
    {
      label: 'Edit',
      icon: Edit,
      onClick: () => navigate(`/credit-cards/${card.id}/edit`),
    },
    {
      label: 'Payoff Calculator',
      icon: Calculator,
      onClick: () => navigate(`/credit-cards/${card.id}/calculator`),
    },
    {
      type: 'divider' as const,
    },
    {
      label: 'Delete',
      icon: Trash2,
      onClick: () => setShowDeleteDialog(true),
      variant: 'danger' as const,
    },
  ];

  return (
    <>
      <Card className="overflow-hidden hover:shadow-lg transition-shadow">
        {/* Card Header */}
        <div className="bg-gradient-to-br from-blue-500 to-blue-600 p-6 text-white">
          <div className="flex items-start justify-between mb-4">
            <div className="flex items-center gap-2">
              <CreditCardIcon className="h-5 w-5" />
              {card.network && (
                <span className="text-xs font-medium opacity-90">
                  {card.network}
                </span>
              )}
            </div>
            <DropdownMenu items={menuItems} trigger={
              <button className="text-white hover:bg-white/20 p-1 rounded transition-colors">
                <MoreVertical className="h-5 w-5" />
              </button>
            } />
          </div>

          <h3 className="text-xl font-bold mb-1">{card.cardName}</h3>
          {card.issuer && (
            <p className="text-sm opacity-90">{card.issuer}</p>
          )}
          {card.lastFourDigits && (
            <p className="text-sm opacity-75 mt-2">•••• {card.lastFourDigits}</p>
          )}
        </div>

        {/* Card Body */}
        <div className="p-6">
          {/* Status Badge */}
          <div className="mb-4">
            {getStatusBadge()}
          </div>

          {/* Balance & Limit */}
          <div className="mb-4">
            <div className="flex items-baseline justify-between mb-1">
              <span className="text-sm text-gray-600">Balance</span>
              <span className="text-2xl font-bold text-gray-900">
                {formatCurrency(card.balance)}
              </span>
            </div>
            <div className="flex items-baseline justify-between text-sm text-gray-600">
              <span>of {formatCurrency(card.creditLimit)} limit</span>
              <span className={cn(
                'font-medium',
                card.utilizationPercentage <= 30 && 'text-green-600',
                card.utilizationPercentage > 30 && card.utilizationPercentage <= 50 && 'text-yellow-600',
                card.utilizationPercentage > 50 && 'text-red-600'
              )}>
                {formatPercentage(card.utilizationPercentage)}
              </span>
            </div>

            {/* Utilization Progress Bar */}
            <ProgressBar
              value={card.utilizationPercentage}
              max={100}
              variant={getUtilizationColor(card.utilizationPercentage)}
              className="mt-2"
            />
          </div>

          {/* Payment Info */}
          <div className="grid grid-cols-2 gap-4 pt-4 border-t border-gray-200">
            <div>
              <p className="text-xs text-gray-600 mb-1">Minimum Payment</p>
              <p className="text-sm font-semibold text-gray-900">
                {formatCurrency(card.minimumPayment)}
              </p>
            </div>
            {card.dueDate && (
              <div>
                <p className="text-xs text-gray-600 mb-1">Due Date</p>
                <p className="text-sm font-semibold text-gray-900">
                  {new Date().getDate() > card.dueDate ? 'Next month' : 'This month'} {card.dueDate}
                </p>
              </div>
            )}
          </div>

          {/* Extra Payment */}
          {card.extraPayment > 0 && (
            <div className="mt-4 p-3 bg-green-50 rounded-lg">
              <p className="text-xs text-green-700 mb-1">Extra Payment</p>
              <p className="text-sm font-semibold text-green-900">
                +{formatCurrency(card.extraPayment)}/month
              </p>
            </div>
          )}

          {/* Auto-pay Badge */}
          {card.autoPay && (
            <div className="mt-4">
              <Badge variant="info" size="sm">Auto-pay enabled</Badge>
            </div>
          )}

          {/* View Details Link */}
          <Link
            to={`/credit-cards/${card.id}`}
            className="block mt-4 text-center text-sm text-blue-600 hover:text-blue-700 font-medium"
          >
            View Details →
          </Link>
        </div>
      </Card>

      {/* Delete Confirmation Dialog */}
      <ConfirmDialog
        isOpen={showDeleteDialog}
        onClose={() => setShowDeleteDialog(false)}
        onConfirm={handleDelete}
        title="Delete Credit Card"
        description={`Are you sure you want to delete "${card.cardName}"? This action cannot be undone.`}
        confirmLabel="Delete"
        variant="danger"
      />
    </>
  );
}
```

#### **5.3.2 Credit Card Detail View** {#5.3.2-credit-card-detail-view}

```
// src/pages/CreditCardDetailPage.tsx
import React, { useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import {
  ArrowLeft,
  Edit,
  Trash2,
  Calculator,
  TrendingDown,
  Calendar,
  DollarSign,
} from 'lucide-react';
import { useCreditCard, useDeleteCreditCard } from '@/hooks/api/useCreditCards';
import { Button } from '@/components/common/Button';
import { Card } from '@/components/common/Card';
import { Badge } from '@/components/common/Badge';
import { ProgressBar } from '@/components/common/ProgressBar';
import { ConfirmDialog } from '@/components/common/ConfirmDialog';
import { PayoffCalculator } from '@/components/credit-cards/PayoffCalculator';
import { PaymentHistory } from '@/components/credit-cards/PaymentHistory';
import { formatCurrency, formatPercentage, formatDate } from '@/lib/utils/formatters';
import { Skeleton } from '@/components/common/Skeleton';

export function CreditCardDetailPage() {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const { data: card, isLoading, error } = useCreditCard(id!);
  const { mutate: deleteCard } = useDeleteCreditCard();
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);

  if (isLoading) {
    return <DetailSkeleton />;
  }

  if (error || !card) {
    return (
      <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div className="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
          <p className="text-red-800">Credit card not found</p>
          <Button
            variant="outline"
            className="mt-4"
            onClick={() => navigate('/credit-cards')}
          >
            Back to Credit Cards
          </Button>
        </div>
      </div>
    );
  }

  const handleDelete = () => {
    deleteCard(card.id, {
      onSuccess: () => {
        navigate('/credit-cards');
      },
    });
  };

  return (
    <>
      <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Header */}
        <div className="flex items-center gap-4 mb-8">
          <Button
            variant="ghost"
            icon={ArrowLeft}
            onClick={() => navigate('/credit-cards')}
          >
            Back
          </Button>

          <div className="flex-1">
            <h1 className="text-3xl font-bold text-gray-900">
              {card.cardName}
            </h1>
            {card.issuer && (
              <p className="text-gray-600 mt-1">{card.issuer}</p>
            )}
          </div>

          <div className="flex gap-2">
            <Button
              variant="outline"
              icon={Edit}
              onClick={() => navigate(`/credit-cards/${card.id}/edit`)}
            >
              Edit
            </Button>
            <Button
              variant="outline"
              icon={Trash2}
              onClick={() => setShowDeleteDialog(true)}
            >
              Delete
            </Button>
          </div>
        </div>

        {/* Overview Card */}
        <Card className="p-6 mb-6">
          <div className="flex items-start justify-between mb-6">
            <div>
              <h2 className="text-lg font-semibold text-gray-900">Overview</h2>
              <div className="flex items-center gap-2 mt-2">
                <Badge variant={card.status === 'active' ? 'success' : 'secondary'}>
                  {card.status}
                </Badge>
                {card.autoPay && (
                  <Badge variant="info">Auto-pay</Badge>
                )}
              </div>
            </div>

            <div className="text-right">
              <p className="text-sm text-gray-600">Account Number</p>
              <p className="text-lg font-semibold text-gray-900">
                •••• {card.lastFourDigits || '****'}
              </p>
            </div>
          </div>

          {/* Balance & Utilization */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <p className="text-sm text-gray-600 mb-2">Current Balance</p>
              <p className="text-3xl font-bold text-gray-900">
                {formatCurrency(card.balance)}
              </p>
              <p className="text-sm text-gray-600 mt-1">
                of {formatCurrency(card.creditLimit)} credit limit
              </p>
            </div>

            <div>
              <p className="text-sm text-gray-600 mb-2">Credit Utilization</p>
              <p className="text-3xl font-bold text-gray-900">
                {formatPercentage(card.utilizationPercentage)}
              </p>
              <ProgressBar
                value={card.utilizationPercentage}
                max={100}
                variant={
                  card.utilizationPercentage <= 30 ? 'success' :
                  card.utilizationPercentage <= 50 ? 'warning' : 'danger'
                }
                className="mt-2"
              />
            </div>
          </div>

          {/* Key Details Grid */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6 pt-6 border-t border-gray-200">
            <DetailItem
              icon={DollarSign}
              label="Available Credit"
              value={formatCurrency(card.availableCredit)}
            />
            <DetailItem
              icon={TrendingDown}
              label="Interest Rate"
              value={formatPercentage(card.interestRate)}
            />
            <DetailItem
              icon={DollarSign}
              label="Minimum Payment"
              value={formatCurrency(card.minimumPayment)}
            />
            {card.dueDate && (
              <DetailItem
                icon={Calendar}
                label="Due Date"
                value={`${card.dueDate}${getDaySuffix(card.dueDate)} of month`}
              />
            )}
          </div>

          {/* Extra Payment */}
          {card.extraPayment > 0 && (
            <div className="mt-6 p-4 bg-green-50 rounded-lg">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-green-900">
                    Extra Monthly Payment
                  </p>
                  <p className="text-xs text-green-700 mt-1">
                    Accelerating your payoff timeline
                  </p>
                </div>
                <p className="text-2xl font-bold text-green-900">
                  {formatCurrency(card.extraPayment)}
                </p>
              </div>
            </div>
          )}
        </Card>

        {/* Payoff Calculator */}
        <PayoffCalculator card={card} className="mb-6" />

        {/* Payment History */}
        <PaymentHistory cardId={card.id} />

        {/* Additional Details */}
        <Card className="p-6 mt-6">
          <h2 className="text-lg font-semibold text-gray-900 mb-4">
            Additional Details
          </h2>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {card.network && (
              <DetailRow label="Network" value={card.network} />
            )}
            {card.cardType && (
              <DetailRow label="Card Type" value={card.cardType} />
            )}
            {card.annualFee > 0 && (
              <DetailRow label="Annual Fee" value={formatCurrency(card.annualFee)} />
            )}
            {card.rewardsProgram && (
              <DetailRow label="Rewards Program" value={card.rewardsProgram} />
            )}
            {card.cashbackRate && (
              <DetailRow
                label="Cashback Rate"
                value={formatPercentage(card.cashbackRate)}
              />
            )}
            {card.pointsBalance && (
              <DetailRow
                label="Points Balance"
                value={card.pointsBalance.toLocaleString()}
              />
            )}
            {card.openedDate && (
              <DetailRow
                label="Opened Date"
                value={formatDate(card.openedDate, 'MMM d, yyyy')}
              />
            )}
            <DetailRow
              label="Created"
              value={formatDate(card.createdAt, 'MMM d, yyyy')}
            />
            <DetailRow
              label="Last Updated"
              value={formatDate(card.updatedAt, 'MMM d, yyyy')}
            />
          </div>

          {card.notes && (
            <div className="mt-6 pt-6 border-t border-gray-200">
              <p className="text-sm font-medium text-gray-900 mb-2">Notes</p>
              <p className="text-sm text-gray-600 whitespace-pre-wrap">
                {card.notes}
              </p>
            </div>
          )}
        </Card>
      </div>

      {/* Delete Dialog */}
      <ConfirmDialog
        isOpen={showDeleteDialog}
        onClose={() => setShowDeleteDialog(false)}
        onConfirm={handleDelete}
        title="Delete Credit Card"
        description={`Are you sure you want to delete "${card.cardName}"? This action cannot be undone.`}
        confirmLabel="Delete"
        variant="danger"
      />
    </>
  );
}

interface DetailItemProps {
  icon: React.ElementType;
  label: string;
  value: string;
}

function DetailItem({ icon: Icon, label, value }: DetailItemProps) {
  return (
    <div>
      <div className="flex items-center gap-2 text-gray-600 mb-1">
        <Icon className="h-4 w-4" />
        <p className="text-xs font-medium">{label}</p>
      </div>
      <p className="text-sm font-semibold text-gray-900">{value}</p>
    </div>
  );
}

interface DetailRowProps {
  label: string;
  value: string;
}

function DetailRow({ label, value }: DetailRowProps) {
  return (
    <div className="flex items-center justify-between py-2">
      <p className="text-sm text-gray-600">{label}</p>
      <p className="text-sm font-medium text-gray-900">{value}</p>
    </div>
  );
}

function getDaySuffix(day: number): string {
  if (day >= 11 && day <= 13) return 'th';
  switch (day % 10) {
    case 1: return 'st';
    case 2: return 'nd';
    case 3: return 'rd';
    default: return 'th';
  }
}

function DetailSkeleton() {
  return (
    <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <Skeleton className="h-12 w-64 mb-8" />
      <Skeleton className="h-64 rounded-lg mb-6" />
      <Skeleton className="h-96 rounded-lg mb-6" />
      <Skeleton className="h-48 rounded-lg" />
    </div>
  );
}
```

#### **5.3.3 Credit Card Form (Add/Edit)** {#5.3.3-credit-card-form-(add/edit)}

**Purpose:** Allow users to add new credit cards or edit existing ones with comprehensive validation

**User Story:** As a user, I want to add my credit cards with all relevant details so that I can track my balances and plan my payoff strategy

**Form Fields:**

| Field | Type | Required | Validation | Default |
| ----- | ----- | ----- | ----- | ----- |
| cardName | text | Yes | 1-255 chars | \- |
| issuer | text | No | Max 100 chars | \- |
| lastFourDigits | text | No | Exactly 4 digits | \- |
| cardType | select | No | credit/charge/secured | credit |
| network | select | No | Visa/Mastercard/Amex/Discover/Other | \- |
| balance | currency | Yes | \>= 0, \<= creditLimit \* 1.1 | 0 |
| creditLimit | currency | Yes | \> 0 | \- |
| interestRate | percentage | Yes | 0-100 | \- |
| annualFee | currency | No | \>= 0 | 0 |
| minimumPayment | currency | Yes | \> 0 | \- |
| minimumPaymentPercentage | percentage | No | 0-100 | 2 |
| extraPayment | currency | No | \>= 0 | 0 |
| dueDate | number | No | 1-31 | \- |
| statementDate | number | No | 1-31 | \- |
| autoPay | boolean | No | \- | false |
| rewardsProgram | text | No | Max 100 chars | \- |
| cashbackRate | percentage | No | 0-100 | \- |
| pointsBalance | number | No | \>= 0 | 0 |
| status | select | Yes | active/paid\_off/closed/frozen | active |
| openedDate | date | No | \<= today | \- |
| notes | textarea | No | Max 1000 chars | \- |

**Implementation:**

```
// src/pages/CreditCardFormPage.tsx
import React, { useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useForm, Controller } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { ArrowLeft, Save, Loader2 } from 'lucide-react';
import {
  useCreditCard,
  useCreateCreditCard,
  useUpdateCreditCard,
} from '@/hooks/api/useCreditCards';
import { creditCardSchema, type CreditCardFormData } from '@/lib/schemas/credit-card.schema';
import { Button } from '@/components/common/Button';
import { Card } from '@/components/common/Card';
import { Input } from '@/components/common/Input';
import { Select } from '@/components/common/Select';
import { Textarea } from '@/components/common/Textarea';
import { Checkbox } from '@/components/common/Checkbox';
import { CurrencyInput } from '@/components/common/CurrencyInput';
import { PercentageInput } from '@/components/common/PercentageInput';
import { FormSection } from '@/components/common/FormSection';
import { Skeleton } from '@/components/common/Skeleton';
import { calculateMinimumPayment } from '@/lib/calculations/credit-cards';

export function CreditCardFormPage() {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const isEditMode = Boolean(id);

  const { data: card, isLoading } = useCreditCard(id!, { enabled: isEditMode });
  const createMutation = useCreateCreditCard();
  const updateMutation = useUpdateCreditCard();

  const {
    register,
    control,
    handleSubmit,
    watch,
    setValue,
    formState: { errors, isSubmitting },
  } = useForm<CreditCardFormData>({
    resolver: zodResolver(creditCardSchema),
    defaultValues: {
      cardType: 'credit',
      status: 'active',
      autoPay: false,
      annualFee: 0,
      extraPayment: 0,
      pointsBalance: 0,
    },
  });

  // Populate form when editing
  useEffect(() => {
    if (card && isEditMode) {
      setValue('cardName', card.cardName);
      setValue('issuer', card.issuer || '');
      setValue('lastFourDigits', card.lastFourDigits || '');
      setValue('cardType', card.cardType || 'credit');
      setValue('network', card.network || '');
      setValue('balance', card.balance);
      setValue('creditLimit', card.creditLimit);
      setValue('interestRate', card.interestRate);
      setValue('annualFee', card.annualFee);
      setValue('minimumPayment', card.minimumPayment);
      setValue('minimumPaymentPercentage', card.minimumPaymentPercentage || 2);
      setValue('extraPayment', card.extraPayment);
      setValue('dueDate', card.dueDate || undefined);
      setValue('statementDate', card.statementDate || undefined);
      setValue('autoPay', card.autoPay);
      setValue('rewardsProgram', card.rewardsProgram || '');
      setValue('cashbackRate', card.cashbackRate || undefined);
      setValue('pointsBalance', card.pointsBalance || 0);
      setValue('status', card.status);
      setValue('openedDate', card.openedDate || '');
      setValue('notes', card.notes || '');
    }
  }, [card, isEditMode, setValue]);

  // Watch values for auto-calculations
  const balance = watch('balance');
  const minimumPaymentPercentage = watch('minimumPaymentPercentage');

  // Auto-calculate minimum payment
  useEffect(() => {
    if (balance && minimumPaymentPercentage) {
      const calculated = calculateMinimumPayment(balance, minimumPaymentPercentage);
      setValue('minimumPayment', calculated);
    }
  }, [balance, minimumPaymentPercentage, setValue]);

  const onSubmit = async (data: CreditCardFormData) => {
    try {
      if (isEditMode && id) {
        await updateMutation.mutateAsync({ id, data });
      } else {
        await createMutation.mutateAsync(data);
      }
      navigate('/credit-cards');
    } catch (error) {
      console.error('Failed to save credit card:', error);
    }
  };

  if (isLoading && isEditMode) {
    return <FormSkeleton />;
  }

  return (
    <div className="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {/* Header */}
      <div className="flex items-center gap-4 mb-8">
        <Button
          variant="ghost"
          icon={ArrowLeft}
          onClick={() => navigate('/credit-cards')}
        >
          Back
        </Button>

        <div className="flex-1">
          <h1 className="text-3xl font-bold text-gray-900">
            {isEditMode ? 'Edit Credit Card' : 'Add Credit Card'}
          </h1>
          <p className="text-gray-600 mt-1">
            {isEditMode
              ? 'Update your credit card information'
              : 'Add a new credit card to track'}
          </p>
        </div>
      </div>

      {/* Form */}
      <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
        {/* Basic Information */}
        <FormSection
          title="Basic Information"
          description="Enter the basic details about your credit card"
        >
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div className="md:col-span-2">
              <Input
                {...register('cardName')}
                label="Card Name"
                placeholder="Chase Freedom Unlimited"
                error={errors.cardName?.message}
                required
                helpText="A friendly name to identify this card"
              />
            </div>

            <Input
              {...register('issuer')}
              label="Issuer/Bank"
              placeholder="JPMorgan Chase Bank"
              error={errors.issuer?.message}
            />

            <Input
              {...register('lastFourDigits')}
              label="Last 4 Digits"
              placeholder="1234"
              maxLength={4}
              error={errors.lastFourDigits?.message}
              helpText="For identification purposes only"
            />

            <Select
              {...register('cardType')}
              label="Card Type"
              error={errors.cardType?.message}
            >
              <option value="credit">Credit Card</option>
              <option value="charge">Charge Card</option>
              <option value="secured">Secured Card</option>
            </Select>

            <Select
              {...register('network')}
              label="Network"
              error={errors.network?.message}
            >
              <option value="">Select network</option>
              <option value="Visa">Visa</option>
              <option value="Mastercard">Mastercard</option>
              <option value="Amex">American Express</option>
              <option value="Discover">Discover</option>
              <option value="Other">Other</option>
            </Select>
          </div>
        </FormSection>

        {/* Financial Details */}
        <FormSection
          title="Financial Details"
          description="Enter your current balance and credit limit"
        >
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <Controller
              name="balance"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Current Balance"
                  error={errors.balance?.message}
                  required
                  helpText="The amount you currently owe"
                />
              )}
            />

            <Controller
              name="creditLimit"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Credit Limit"
                  error={errors.creditLimit?.message}
                  required
                  helpText="Maximum credit available"
                />
              )}
            />

            <Controller
              name="interestRate"
              control={control}
              render={({ field }) => (
                <PercentageInput
                  {...field}
                  label="Interest Rate (APR)"
                  error={errors.interestRate?.message}
                  required
                  helpText="Annual percentage rate"
                  max={100}
                />
              )}
            />

            <Controller
              name="annualFee"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Annual Fee"
                  error={errors.annualFee?.message}
                  helpText="Yearly fee charged by issuer"
                />
              )}
            />
          </div>
        </FormSection>

        {/* Payment Information */}
        <FormSection
          title="Payment Information"
          description="Set up your payment schedule and amounts"
        >
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <Controller
              name="minimumPaymentPercentage"
              control={control}
              render={({ field }) => (
                <PercentageInput
                  {...field}
                  label="Minimum Payment %"
                  error={errors.minimumPaymentPercentage?.message}
                  helpText="Percentage of balance (typically 2-3%)"
                  max={100}
                />
              )}
            />

            <Controller
              name="minimumPayment"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Minimum Payment"
                  error={errors.minimumPayment?.message}
                  required
                  helpText="Auto-calculated based on balance"
                  readOnly
                  className="bg-gray-50"
                />
              )}
            />

            <Controller
              name="extraPayment"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Extra Payment"
                  error={errors.extraPayment?.message}
                  helpText="Additional amount paid each month"
                />
              )}
            />

            <Input
              {...register('dueDate', { valueAsNumber: true })}
              type="number"
              label="Due Date (Day of Month)"
              placeholder="15"
              min={1}
              max={31}
              error={errors.dueDate?.message}
              helpText="Day of month payment is due (1-31)"
            />

            <Input
              {...register('statementDate', { valueAsNumber: true })}
              type="number"
              label="Statement Date (Day of Month)"
              placeholder="20"
              min={1}
              max={31}
              error={errors.statementDate?.message}
              helpText="Day of month statement closes"
            />

            <div className="md:col-span-2">
              <Checkbox
                {...register('autoPay')}
                label="Auto-pay enabled"
                helpText="Payment is automatically deducted each month"
              />
            </div>
          </div>
        </FormSection>

        {/* Rewards & Benefits */}
        <FormSection
          title="Rewards & Benefits"
          description="Optional rewards program information"
        >
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div className="md:col-span-2">
              <Input
                {...register('rewardsProgram')}
                label="Rewards Program"
                placeholder="Chase Ultimate Rewards"
                error={errors.rewardsProgram?.message}
              />
            </div>

            <Controller
              name="cashbackRate"
              control={control}
              render={({ field }) => (
                <PercentageInput
                  {...field}
                  label="Cashback Rate"
                  error={errors.cashbackRate?.message}
                  helpText="Cashback percentage (e.g., 1.5%)"
                  max={100}
                />
              )}
            />

            <Input
              {...register('pointsBalance', { valueAsNumber: true })}
              type="number"
              label="Points/Miles Balance"
              placeholder="25000"
              min={0}
              error={errors.pointsBalance?.message}
              helpText="Current rewards points balance"
            />
          </div>
        </FormSection>

        {/* Status & Dates */}
        <FormSection
          title="Status & Dates"
          description="Card status and important dates"
        >
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <Select
              {...register('status')}
              label="Status"
              error={errors.status?.message}
              required
            >
              <option value="active">Active</option>
              <option value="paid_off">Paid Off</option>
              <option value="closed">Closed</option>
              <option value="frozen">Frozen</option>
            </Select>

            <Input
              {...register('openedDate')}
              type="date"
              label="Date Opened"
              error={errors.openedDate?.message}
              helpText="When you opened this card"
              max={new Date().toISOString().split('T')[0]}
            />
          </div>
        </FormSection>

        {/* Notes */}
        <FormSection
          title="Notes"
          description="Add any additional notes or comments"
        >
          <Textarea
            {...register('notes')}
            label="Notes"
            placeholder="Add any notes about this card..."
            rows={4}
            error={errors.notes?.message}
            maxLength={1000}
            showCount
          />
        </FormSection>

        {/* Form Actions */}
        <div className="flex items-center justify-end gap-4 pt-6 border-t border-gray-200">
          <Button
            type="button"
            variant="outline"
            onClick={() => navigate('/credit-cards')}
          >
            Cancel
          </Button>

          <Button
            type="submit"
            variant="primary"
            disabled={isSubmitting}
            icon={isSubmitting ? Loader2 : Save}
            iconAnimation={isSubmitting ? 'spin' : undefined}
          >
            {isSubmitting
              ? 'Saving...'
              : isEditMode
              ? 'Update Credit Card'
              : 'Add Credit Card'}
          </Button>
        </div>
      </form>
    </div>
  );
}

function FormSkeleton() {
  return (
    <div className="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <Skeleton className="h-12 w-64 mb-8" />
      {[...Array(5)].map((_, i) => (
        <div key={i} className="mb-6">
          <Skeleton className="h-6 w-48 mb-4" />
          <div className="grid grid-cols-2 gap-4">
            <Skeleton className="h-10 rounded" />
            <Skeleton className="h-10 rounded" />
          </div>
        </div>
      ))}
    </div>
  );
}
```

**Schema Definition:**

```ts
// src/lib/schemas/credit-card.schema.ts
import { z } from 'zod';

export const creditCardSchema = z.object({
  // Basic Information
  cardName: z
    .string()
    .min(1, 'Card name is required')
    .max(255, 'Card name must be less than 255 characters'),
  
  issuer: z
    .string()
    .max(100, 'Issuer name must be less than 100 characters')
    .optional(),
  
  lastFourDigits: z
    .string()
    .regex(/^\d{4}$/, 'Must be exactly 4 digits')
    .optional()
    .or(z.literal('')),
  
  cardType: z
    .enum(['credit', 'charge', 'secured'])
    .optional(),
  
  network: z
    .enum(['Visa', 'Mastercard', 'Amex', 'Discover', 'Other'])
    .optional()
    .or(z.literal('')),

  // Financial Details
  balance: z
    .number()
    .min(0, 'Balance must be positive')
    .max(1000000, 'Balance seems unreasonably high'),
  
  creditLimit: z
    .number()
    .min(1, 'Credit limit must be greater than 0')
    .max(1000000, 'Credit limit seems unreasonably high'),
  
  interestRate: z
    .number()
    .min(0, 'Interest rate must be positive')
    .max(100, 'Interest rate cannot exceed 100%'),
  
  annualFee: z
    .number()
    .min(0, 'Annual fee must be positive')
    .max(10000, 'Annual fee seems unreasonably high')
    .optional(),

  // Payment Information
  minimumPayment: z
    .number()
    .min(0, 'Minimum payment must be positive'),
  
  minimumPaymentPercentage: z
    .number()
    .min(0, 'Percentage must be positive')
    .max(100, 'Percentage cannot exceed 100%')
    .optional(),
  
  extraPayment: z
    .number()
    .min(0, 'Extra payment must be positive')
    .max(100000, 'Extra payment seems unreasonably high')
    .optional(),
  
  dueDate: z
    .number()
    .int()
    .min(1, 'Due date must be between 1 and 31')
    .max(31, 'Due date must be between 1 and 31')
    .optional(),
  
  statementDate: z
    .number()
    .int()
    .min(1, 'Statement date must be between 1 and 31')
    .max(31, 'Statement date must be between 1 and 31')
    .optional(),
  
  autoPay: z.boolean().optional(),

  // Rewards & Benefits
  rewardsProgram: z
    .string()
    .max(100, 'Rewards program name must be less than 100 characters')
    .optional()
    .or(z.literal('')),
  
  cashbackRate: z
    .number()
    .min(0, 'Cashback rate must be positive')
    .max(100, 'Cashback rate cannot exceed 100%')
    .optional(),
  
  pointsBalance: z
    .number()
    .int()
    .min(0, 'Points balance must be positive')
    .optional(),

  // Status & Dates
  status: z.enum(['active', 'paid_off', 'closed', 'frozen']),
  
  openedDate: z
    .string()
    .regex(/^\d{4}-\d{2}-\d{2}$/, 'Invalid date format')
    .optional()
    .or(z.literal('')),

  // Notes
  notes: z
    .string()
    .max(1000, 'Notes must be less than 1000 characters')
    .optional()
    .or(z.literal('')),
}).refine(
  (data) => data.balance <= data.creditLimit * 1.1,
  {
    message: 'Balance cannot exceed 110% of credit limit',
    path: ['balance'],
  }
);

export type CreditCardFormData = z.infer<typeof creditCardSchema>;
```

**Helper Functions:**

```ts
// src/lib/calculations/credit-cards.ts

/**
 * Calculate minimum payment based on balance and percentage
 * Typically 2-3% of balance with a minimum floor of $25-35
 */
export function calculateMinimumPayment(
  balance: number,
  percentage: number = 2,
  minimumFloor: number = 25
): number {
  if (balance === 0) return 0;
  
  const calculated = balance * (percentage / 100);
  return Math.max(calculated, minimumFloor);
}

/**
 * Calculate months to payoff with minimum payments only
 * Formula: n = -log(1 - (B * r / P)) / log(1 + r)
 * Where:
 *   B = Balance
 *   r = Monthly interest rate (APR / 12 / 100)
 *   P = Monthly payment
 *   n = Number of months
 */
export function calculateMonthsToPayoff(
  balance: number,
  monthlyPayment: number,
  annualInterestRate: number
): number | 'Never' {
  if (balance === 0) return 0;
  if (monthlyPayment === 0) return 'Never';
  
  const monthlyRate = annualInterestRate / 12 / 100;
  
  // If payment doesn't cover interest, will never pay off
  const monthlyInterest = balance * monthlyRate;
  if (monthlyPayment <= monthlyInterest) {
    return 'Never';
  }
  
  // If no interest, simple division
  if (monthlyRate === 0) {
    return Math.ceil(balance / monthlyPayment);
  }
  
  // Apply formula
  const numerator = -Math.log(1 - (balance * monthlyRate / monthlyPayment));
  const denominator = Math.log(1 + monthlyRate);
  
  return Math.ceil(numerator / denominator);
}

/**
 * Calculate total interest paid over the life of the debt
 */
export function calculateTotalInterest(
  balance: number,
  monthlyPayment: number,
  annualInterestRate: number
): number {
  const months = calculateMonthsToPayoff(balance, monthlyPayment, annualInterestRate);
  
  if (months === 'Never') return Infinity;
  if (months === 0) return 0;
  
  const totalPaid = monthlyPayment * months;
  return totalPaid - balance;
}

/**
 * Calculate credit utilization percentage
 */
export function calculateUtilization(
  balance: number,
  creditLimit: number
): number {
  if (creditLimit === 0) return 0;
  return (balance / creditLimit) * 100;
}

/**
 * Calculate payoff date from current date
 */
export function calculatePayoffDate(
  months: number | 'Never',
  startDate: Date = new Date()
): Date | null {
  if (months === 'Never' || months === 0) return null;
  
  const payoffDate = new Date(startDate);
  payoffDate.setMonth(payoffDate.getMonth() + months);
  
  return payoffDate;
}

/**
 * Generate amortization schedule
 */
export interface AmortizationEntry {
  month: number;
  payment: number;
  principal: number;
  interest: number;
  balance: number;
}

export function generateAmortizationSchedule(
  initialBalance: number,
  monthlyPayment: number,
  annualInterestRate: number,
  maxMonths: number = 360
): AmortizationEntry[] {
  const schedule: AmortizationEntry[] = [];
  let balance = initialBalance;
  const monthlyRate = annualInterestRate / 12 / 100;
  
  for (let month = 1; month <= maxMonths && balance > 0; month++) {
    const interestPayment = balance * monthlyRate;
    const principalPayment = Math.min(monthlyPayment - interestPayment, balance);
    const totalPayment = interestPayment + principalPayment;
    
    balance -= principalPayment;
    
    schedule.push({
      month,
      payment: totalPayment,
      principal: principalPayment,
      interest: interestPayment,
      balance: Math.max(balance, 0),
    });
    
    if (balance <= 0) break;
  }
  
  return schedule;
}
```

#### **5.3.4 Payoff Calculator Component** {#5.3.4-payoff-calculator-component}

**Purpose:** Show users multiple payoff scenarios and help them understand the impact of extra payments

**User Story:** As a user, I want to see how long it will take to pay off my credit card and how much interest I'll pay so that I can make informed payment decisions

**Component Implementation:**

```
// src/components/credit-cards/PayoffCalculator.tsx
import React, { useState, useMemo } from 'react';
import {
  Calculator,
  TrendingDown,
  Calendar,
  DollarSign,
  Zap,
  ChevronDown,
  ChevronUp,
} from 'lucide-react';
import { Card } from '@/components/common/Card';
import { Button } from '@/components/common/Button';
import { CurrencyInput } from '@/components/common/CurrencyInput';
import { Badge } from '@/components/common/Badge';
import { ProgressBar } from '@/components/common/ProgressBar';
import {
  calculateMonthsToPayoff,
  calculateTotalInterest,
  calculatePayoffDate,
  generateAmortizationSchedule,
} from '@/lib/calculations/credit-cards';
import { formatCurrency, formatDate } from '@/lib/utils/formatters';
import { cn } from '@/lib/utils';
import type { CreditCard } from '@/types';

interface PayoffCalculatorProps {
  card: CreditCard;
  className?: string;
}

export function PayoffCalculator({ card, className }: PayoffCalculatorProps) {
  const [customPayment, setCustomPayment] = useState<number>(
    card.minimumPayment + card.extraPayment
  );
  const [showAmortization, setShowAmortization] = useState(false);

  // Calculate three scenarios
  const scenarios = useMemo(() => {
    const minimumOnly = {
      name: 'Minimum Payment Only',
      payment: card.minimumPayment,
      months: calculateMonthsToPayoff(
        card.balance,
        card.minimumPayment,
        card.interestRate
      ),
      totalInterest: calculateTotalInterest(
        card.balance,
        card.minimumPayment,
        card.interestRate
      ),
      payoffDate: null as Date | null,
      color: 'red' as const,
    };

    const withExtra = {
      name: 'Current Plan',
      payment: card.minimumPayment + card.extraPayment,
      months: calculateMonthsToPayoff(
        card.balance,
        card.minimumPayment + card.extraPayment,
        card.interestRate
      ),
      totalInterest: calculateTotalInterest(
        card.balance,
        card.minimumPayment + card.extraPayment,
        card.interestRate
      ),
      payoffDate: null as Date | null,
      color: 'yellow' as const,
    };

    const aggressive = {
      name: 'Aggressive Payoff',
      payment: customPayment,
      months: calculateMonthsToPayoff(
        card.balance,
        customPayment,
        card.interestRate
      ),
      totalInterest: calculateTotalInterest(
        card.balance,
        customPayment,
        card.interestRate
      ),
      payoffDate: null as Date | null,
      color: 'green' as const,
    };

    // Calculate payoff dates
    if (minimumOnly.months !== 'Never') {
      minimumOnly.payoffDate = calculatePayoffDate(minimumOnly.months);
    }
    if (withExtra.months !== 'Never') {
      withExtra.payoffDate = calculatePayoffDate(withExtra.months);
    }
    if (aggressive.months !== 'Never') {
      aggressive.payoffDate = calculatePayoffDate(aggressive.months);
    }

    return [minimumOnly, withExtra, aggressive];
  }, [card.balance, card.minimumPayment, card.extraPayment, card.interestRate, customPayment]);

  // Generate amortization schedule for current plan
  const amortizationSchedule = useMemo(() => {
    if (!showAmortization) return [];
    return generateAmortizationSchedule(
      card.balance,
      card.minimumPayment + card.extraPayment,
      card.interestRate,
      12 // Show first 12 months
    );
  }, [card.balance, card.minimumPayment, card.extraPayment, card.interestRate, showAmortization]);

  // Calculate savings compared to minimum only
  const calculateSavings = (scenario: typeof scenarios[0]) => {
    const minimumScenario = scenarios[0];
    
    if (scenario.months === 'Never' || minimumScenario.months === 'Never') {
      return { months: 0, interest: 0 };
    }

    const monthsSaved = minimumScenario.months - scenario.months;
    const interestSaved = minimumScenario.totalInterest - scenario.totalInterest;

    return { months: monthsSaved, interest: interestSaved };
  };

  if (card.balance === 0) {
    return (
      <Card className={cn('p-6', className)}>
        <div className="flex items-center gap-3 mb-4">
          <div className="p-2 bg-green-100 rounded-lg">
            <Calculator className="h-5 w-5 text-green-600" />
          </div>
          <h2 className="text-lg font-semibold text-gray-900">Payoff Calculator</h2>
        </div>
        <div className="text-center py-8">
          <div className="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4">
            <Zap className="h-8 w-8 text-green-600" />
          </div>
          <p className="text-lg font-medium text-gray-900">Card Paid Off!</p>
          <p className="text-sm text-gray-600 mt-1">
            Congratulations! This card has a zero balance.
          </p>
        </div>
      </Card>
    );
  }

  return (
    <Card className={cn('p-6', className)}>
      {/* Header */}
      <div className="flex items-center gap-3 mb-6">
        <div className="p-2 bg-blue-100 rounded-lg">
          <Calculator className="h-5 w-5 text-blue-600" />
        </div>
        <div className="flex-1">
          <h2 className="text-lg font-semibold text-gray-900">Payoff Calculator</h2>
          <p className="text-sm text-gray-600">
            Compare different payment strategies
          </p>
        </div>
      </div>

      {/* Custom Payment Input */}
      <div className="mb-6 p-4 bg-gray-50 rounded-lg">
        <label className="block text-sm font-medium text-gray-700 mb-2">
          Try a custom payment amount:
        </label>
        <CurrencyInput
          value={customPayment}
          onChange={(e) => setCustomPayment(Number(e.target.value) || 0)}
          placeholder="Enter amount"
          min={card.minimumPayment}
        />
        <p className="text-xs text-gray-500 mt-1">
          Minimum: {formatCurrency(card.minimumPayment)}
        </p>
      </div>

      {/* Scenarios */}
      <div className="space-y-4">
        {scenarios.map((scenario, index) => (
          <ScenarioCard
            key={scenario.name}
            scenario={scenario}
            savings={index > 0 ? calculateSavings(scenario) : undefined}
            isRecommended={index === 1 && card.extraPayment > 0}
          />
        ))}
      </div>

      {/* Comparison Summary */}
      <div className="mt-6 p-4 bg-blue-50 rounded-lg">
        <h3 className="text-sm font-semibold text-blue-900 mb-3">
          Key Insights
        </h3>
        <div className="space-y-2 text-sm">
          {scenarios[1].months !== 'Never' && scenarios[0].months !== 'Never' && (
            <InsightRow
              icon={Calendar}
              label="By paying extra"
              value={`Save ${scenarios[0].months - scenarios[1].months} months`}
              positive
            />
          )}
          {scenarios[1].totalInterest < scenarios[0].totalInterest && (
            <InsightRow
              icon={DollarSign}
              label="Interest savings"
              value={formatCurrency(scenarios[0].totalInterest - scenarios[1].totalInterest)}
              positive
            />
          )}
          {scenarios[2].months !== 'Never' && scenarios[1].months !== 'Never' && 
           customPayment > card.minimumPayment + card.extraPayment && (
            <InsightRow
              icon={TrendingDown}
              label="With aggressive payoff"
              value={`Pay off ${scenarios[1].months - scenarios[2].months} months sooner`}
              positive
            />
          )}
        </div>
      </div>

      {/* Amortization Schedule */}
      <div className="mt-6 pt-6 border-t border-gray-200">
        <Button
          variant="outline"
          fullWidth
          icon={showAmortization ? ChevronUp : ChevronDown}
          onClick={() => setShowAmortization(!showAmortization)}
        >
          {showAmortization ? 'Hide' : 'Show'} Amortization Schedule
        </Button>

        {showAmortization && amortizationSchedule.length > 0 && (
          <div className="mt-4 overflow-x-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="border-b border-gray-200">
                  <th className="text-left py-2 px-2 font-medium text-gray-700">Month</th>
                  <th className="text-right py-2 px-2 font-medium text-gray-700">Payment</th>
                  <th className="text-right py-2 px-2 font-medium text-gray-700">Principal</th>
                  <th className="text-right py-2 px-2 font-medium text-gray-700">Interest</th>
                  <th className="text-right py-2 px-2 font-medium text-gray-700">Balance</th>
                </tr>
              </thead>
              <tbody>
                {amortizationSchedule.map((entry) => (
                  <tr key={entry.month} className="border-b border-gray-100">
                    <td className="py-2 px-2 text-gray-900">{entry.month}</td>
                    <td className="py-2 px-2 text-right text-gray-900">
                      {formatCurrency(entry.payment)}
                    </td>
                    <td className="py-2 px-2 text-right text-green-600">
                      {formatCurrency(entry.principal)}
                    </td>
                    <td className="py-2 px-2 text-right text-red-600">
                      {formatCurrency(entry.interest)}
                    </td>
                    <td className="py-2 px-2 text-right font-medium text-gray-900">
                      {formatCurrency(entry.balance)}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
            {scenarios[1].months !== 'Never' && scenarios[1].months > 12 && (
              <p className="text-xs text-gray-500 mt-2 text-center">
                Showing first 12 months of {scenarios[1].months} total months
              </p>
            )}
          </div>
        )}
      </div>
    </Card>
  );
}

interface ScenarioCardProps {
  scenario: {
    name: string;
    payment: number;
    months: number | 'Never';
    totalInterest: number;
    payoffDate: Date | null;
    color: 'red' | 'yellow' | 'green';
  };
  savings?: { months: number; interest: number };
  isRecommended?: boolean;
}

function ScenarioCard({ scenario, savings, isRecommended }: ScenarioCardProps) {
  const colorClasses = {
    red: 'border-red-200 bg-red-50',
    yellow: 'border-yellow-200 bg-yellow-50',
    green: 'border-green-200 bg-green-50',
  };

  const progressColors = {
    red: 'danger' as const,
    yellow: 'warning' as const,
    green: 'success' as const,
  };

  return (
    <div
      className={cn(
        'p-4 rounded-lg border-2',
        colorClasses[scenario.color]
      )}
    >
      <div className="flex items-start justify-between mb-3">
        <div>
          <h3 className="font-semibold text-gray-900 flex items-center gap-2">
            {scenario.name}
            {isRecommended && (
              <Badge variant="info" size="sm">Current Plan</Badge>
            )}
          </h3>
          <p className="text-sm text-gray-600 mt-1">
            {formatCurrency(scenario.payment)}/month
          </p>
        </div>
      </div>

      {/* Metrics Grid */}
      <div className="grid grid-cols-3 gap-4 mb-3">
        <div>
          <p className="text-xs text-gray-600 mb-1">Time to Payoff</p>
          <p className="text-lg font-bold text-gray-900">
            {scenario.months === 'Never' ? 'Never' : `${scenario.months} mo`}
          </p>
        </div>
        <div>
          <p className="text-xs text-gray-600 mb-1">Total Interest</p>
          <p className="text-lg font-bold text-gray-900">
            {scenario.totalInterest === Infinity
              ? 'N/A'
              : formatCurrency(scenario.totalInterest)}
          </p>
        </div>
        <div>
          <p className="text-xs text-gray-600 mb-1">Payoff Date</p>
          <p className="text-lg font-bold text-gray-900">
            {scenario.payoffDate
              ? formatDate(scenario.payoffDate, 'MMM yyyy')
              : 'N/A'}
          </p>
        </div>
      </div>

      {/* Progress Bar */}
      {scenario.months !== 'Never' && (
        <ProgressBar
          value={100 - (scenario.months / 60) * 100}
          max={100}
          variant={progressColors[scenario.color]}
          className="mb-3"
        />
      )}

      {/* Savings Badge */}
      {savings && savings.months > 0 && (
        <div className="flex items-center gap-4 text-xs text-gray-700 mt-3 pt-3 border-t border-gray-300">
          <div className="flex items-center gap-1">
            <Calendar className="h-3 w-3" />
            <span>Save {savings.months} months</span>
          </div>
          <div className="flex items-center gap-1">
            <DollarSign className="h-3 w-3" />
            <span>Save {formatCurrency(savings.interest)}</span>
          </div>
        </div>
      )}
    </div>
  );
}

interface InsightRowProps {
  icon: React.ElementType;
  label: string;
  value: string;
  positive?: boolean;
}

function InsightRow({ icon: Icon, label, value, positive }: InsightRowProps) {
  return (
    <div className="flex items-center gap-2">
      <Icon className={cn(
        'h-4 w-4',
        positive ? 'text-green-600' : 'text-blue-600'
      )} />
      <span className="text-gray-700">{label}:</span>
      <span className={cn(
        'font-semibold ml-auto',
        positive ? 'text-green-700' : 'text-blue-700'
      )}>
        {value}
      </span>
    </div>
  );
}
```

#### **5.3.5 Payment History Component** {#5.3.5-payment-history-component}

**Purpose:** Display past payments made on a credit card

**User Story:** As a user, I want to see my payment history so that I can track my progress and verify past transactions

**Component Implementation:**

```
// src/components/credit-cards/PaymentHistory.tsx
import React, { useState } from 'react';
import { 
  History, 
  DollarSign, 
  Calendar,
  Download,
  Filter,
  CheckCircle,
} from 'lucide-react';
import { Card } from '@/components/common/Card';
import { Button } from '@/components/common/Button';
import { Badge } from '@/components/common/Badge';
import { Select } from '@/components/common/Select';
import { EmptyState } from '@/components/common/EmptyState';
import { usePaymentHistory } from '@/hooks/api/usePayments';
import { formatCurrency, formatDate } from '@/lib/utils/formatters';
import { cn } from '@/lib/utils';
import type { PaymentHistoryEntry } from '@/types';

interface PaymentHistoryProps {
  cardId: string;
  className?: string;
}

export function PaymentHistory({ cardId, className }: PaymentHistoryProps) {
  const [timeRange, setTimeRange] = useState<'30d' | '90d' | '1y' | 'all'>('90d');
  const { data: payments, isLoading } = usePaymentHistory(cardId, timeRange);

  const handleExport = () => {
    if (!payments) return;

    // Create CSV content
    const headers = ['Date', 'Amount', 'Method', 'Confirmation'];
    const rows = payments.map(p => [
      formatDate(p.paymentDate, 'yyyy-MM-dd'),
      p.amount.toString(),
      p.paymentMethod || '',
      p.confirmationNumber || '',
    ]);

    const csv = [
      headers.join(','),
      ...rows.map(row => row.join(','))
    ].join('\n');

    // Download CSV
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `payment-history-${formatDate(new Date(), 'yyyy-MM-dd')}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
  };

  if (isLoading) {
    return (
      <Card className={cn('p-6', className)}>
        <div className="animate-pulse space-y-4">
          {[...Array(5)].map((_, i) => (
            <div key={i} className="h-16 bg-gray-200 rounded" />
          ))}
        </div>
      </Card>
    );
  }

  const totalPaid = payments?.reduce((sum, p) => sum + p.amount, 0) || 0;

  return (
    <Card className={cn('p-6', className)}>
      {/* Header */}
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-3">
          <div className="p-2 bg-purple-100 rounded-lg">
            <History className="h-5 w-5 text-purple-600" />
          </div>
          <div>
            <h2 className="text-lg font-semibold text-gray-900">
              Payment History
            </h2>
            {payments && payments.length > 0 && (
              <p className="text-sm text-gray-600">
                {payments.length} payment{payments.length !== 1 ? 's' : ''} • {formatCurrency(totalPaid)} total
              </p>
            )}
          </div>
        </div>

        <div className="flex items-center gap-2">
          <Select
            value={timeRange}
            onChange={(e) => setTimeRange(e.target.value as any)}
            icon={Filter}
            className="w-32"
          >
            <option value="30d">Last 30 days</option>
            <option value="90d">Last 90 days</option>
            <option value="1y">Last year</option>
            <option value="all">All time</option>
          </Select>

          {payments && payments.length > 0 && (
            <Button
              variant="outline"
              size="sm"
              icon={Download}
              onClick={handleExport}
            >
              Export
            </Button>
          )}
        </div>
      </div>

      {/* Payment List */}
      {!payments || payments.length === 0 ? (
        <EmptyState
          icon={History}
          title="No payment history"
          description="Payments you make will appear here"
        />
      ) : (
        <div className="space-y-3">
          {payments.map((payment) => (
            <PaymentItem key={payment.id} payment={payment} />
          ))}
        </div>
      )}
    </Card>
  );
}

interface PaymentItemProps {
  payment: PaymentHistoryEntry;
}

function PaymentItem({ payment }: PaymentItemProps) {
  return (
    <div className="flex items-center gap-4 p-4 hover:bg-gray-50 rounded-lg transition-colors">
      {/* Icon */}
      <div className="flex-shrink-0 w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
        <CheckCircle className="h-5 w-5 text-green-600" />
      </div>

      {/* Content */}
      <div className="flex-1 min-w-0">
        <div className="flex items-center gap-2 mb-1">
          <p className="text-sm font-medium text-gray-900">
            Payment Processed
          </p>
          {payment.paymentMethod && (
            <Badge variant="secondary" size="sm">
              {payment.paymentMethod}
            </Badge>
          )}
        </div>
        <div className="flex items-center gap-4 text-xs text-gray-600">
          <span className="flex items-center gap-1">
            <Calendar className="h-3 w-3" />
            {formatDate(payment.paymentDate, 'MMM d, yyyy')}
          </span>
          {payment.confirmationNumber && (
            <span>Conf: {payment.confirmationNumber}</span>
          )}
        </div>
      </div>

      {/* Amount */}
      <div className="text-right">
        <p className="text-lg font-semibold text-green-600">
          {formatCurrency(payment.amount)}
        </p>
      </div>
    </div>
  );
}
```

**Types Definition:**

```ts
// Add to src/types/index.ts

export interface PaymentHistoryEntry {
  id: string;
  cardId: string;
  amount: number;
  paymentDate: string;
  paymentMethod?: 'auto-pay' | 'manual' | 'credit_card' | 'debit_card' | 'bank_transfer' | 'check' | 'cash' | 'other';
  confirmationNumber?: string;
  createdAt: string;
}
```

**API Hook:**

```ts
// src/hooks/api/usePayments.ts
import { useQuery } from '@tanstack/react-query';
import { supabase } from '@/lib/supabase';
import type { PaymentHistoryEntry } from '@/types';

export function usePaymentHistory(
  cardId: string,
  timeRange: '30d' | '90d' | '1y' | 'all'
) {
  return useQuery({
    queryKey: ['payment-history', cardId, timeRange],
    queryFn: async () => {
      let query = supabase
        .from('payment_history')
        .select('*')
        .eq('reference_id', cardId)
        .eq('payment_type', 'credit_card')
        .order('payment_date', { ascending: false });

      // Apply time range filter
      if (timeRange !== 'all') {
        const now = new Date();
        const cutoffDate = new Date();

        switch (timeRange) {
          case '30d':
            cutoffDate.setDate(now.getDate() - 30);
            break;
          case '90d':
            cutoffDate.setDate(now.getDate() - 90);
            break;
          case '1y':
            cutoffDate.setFullYear(now.getFullYear() - 1);
            break;
        }

        query = query.gte('payment_date', cutoffDate.toISOString());
      }

      const { data, error } = await query;

      if (error) throw error;

      return data.map(item => ({
        id: item.id,
        cardId: item.reference_id,
        amount: item.amount,
        paymentDate: item.payment_date,
        paymentMethod: item.payment_method,
        confirmationNumber: item.confirmation_number,
        createdAt: item.created_at,
      })) as PaymentHistoryEntry[];
    },
  });
}

export function useRecordPayment() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async (data: {
      cardId: string;
      amount: number;
      paymentDate: string;
      paymentMethod?: string;
      confirmationNumber?: string;
    }) => {
      const { data: payment, error } = await supabase
        .from('payment_history')
        .insert({
          payment_type: 'credit_card',
          reference_id: data.cardId,
          reference_name: '', // Will be filled by trigger
          amount: data.amount,
          payment_date: data.paymentDate,
          payment_method: data.paymentMethod,
          confirmation_number: data.confirmationNumber,
        })
        .select()
        .single();

      if (error) throw error;
      return payment;
    },
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({ queryKey: ['payment-history', variables.cardId] });
      queryClient.invalidateQueries({ queryKey: ['credit-card', variables.cardId] });
      queryClient.invalidateQueries({ queryKey: ['credit-cards'] });
    },
  });
}
```

---

### **5.4 Loans Manager** {#5.4-loans-manager}

#### **5.4.1 Loans List View** {#5.4.1-loans-list-view}

**Purpose:** Display all loans with key information and quick actions

**User Story:** As a user, I want to view all my loans in one place so that I can track my balances, payments, and payoff progress

**Layout:**

```
┌─────────────────────────────────────────────────────────┐
│  Loans Header + Add New Button                         │
├─────────────────────────────────────────────────────────┤
│  Summary Stats (Total Balance, Monthly Payment, Paid)  │
├─────────────────────────────────────────────────────────┤
│  Filters & Sort Controls                               │
├─────────────────────────────────────────────────────────┤
│  ┌───────────────────┐ ┌───────────────────┐           │
│  │  Auto Loan        │ │  Student Loan     │           │
│  │  $18,500 balance  │ │  $32,000 balance  │           │
│  │  $480/month       │ │  $350/month       │           │
│  │  26% paid off     │ │  15% paid off     │           │
│  │  ▓▓▓▓▓░░░░░ 26%  │ │  ▓▓░░░░░░░░ 15%  │           │
│  └───────────────────┘ └───────────────────┘           │
│  ┌───────────────────┐ ┌───────────────────┐           │
│  │  Personal Loan    │ │  Home Equity      │           │
│  │  $5,200 balance   │ │  $45,000 balance  │           │
│  │  $225/month       │ │  $580/month       │           │
│  │  68% paid off     │ │  10% paid off     │           │
│  └───────────────────┘ └───────────────────┘           │
└─────────────────────────────────────────────────────────┘
```

**Component Implementation:**

```
// src/pages/LoansPage.tsx
import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { Plus } from 'lucide-react';
import { useLoans } from '@/hooks/api/useLoans';
import { Button } from '@/components/common/Button';
import { LoanStats } from '@/components/loans/LoanStats';
import { LoanFilters } from '@/components/loans/LoanFilters';
import { LoanList } from '@/components/loans/LoanList';
import { EmptyState } from '@/components/common/EmptyState';
import { Skeleton } from '@/components/common/Skeleton';
import type { LoanFilters as Filters, LoanSortBy } from '@/types';

export function LoansPage() {
  const navigate = useNavigate();
  const { data: loans, isLoading, error } = useLoans();

  const [filters, setFilters] = useState<Filters>({
    loanType: 'all',
    status: 'all',
    search: '',
  });

  const [sortBy, setSortBy] = useState<LoanSortBy>('balance_desc');

  if (isLoading) {
    return <LoansSkeleton />;
  }

  if (error) {
    return (
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div className="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
          <p className="text-red-800">Failed to load loans. Please try again.</p>
        </div>
      </div>
    );
  }

  if (!loans || loans.length === 0) {
    return (
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <EmptyState
          icon={Plus}
          title="No loans yet"
          description="Add your first loan to start tracking payments and progress"
          action={{
            label: 'Add Loan',
            onClick: () => navigate('/loans/new'),
          }}
        />
      </div>
    );
  }

  // Filter loans
  let filteredLoans = loans;

  if (filters.loanType !== 'all') {
    filteredLoans = filteredLoans.filter(loan => loan.loanType === filters.loanType);
  }

  if (filters.status !== 'all') {
    filteredLoans = filteredLoans.filter(loan => loan.status === filters.status);
  }

  if (filters.search) {
    const search = filters.search.toLowerCase();
    filteredLoans = filteredLoans.filter(loan =>
      loan.loanName.toLowerCase().includes(search) ||
      loan.lender?.toLowerCase().includes(search)
    );
  }

  // Sort loans
  const sortedLoans = [...filteredLoans].sort((a, b) => {
    switch (sortBy) {
      case 'balance_desc':
        return b.currentBalance - a.currentBalance;
      case 'balance_asc':
        return a.currentBalance - b.currentBalance;
      case 'payment_desc':
        return b.monthlyPayment - a.monthlyPayment;
      case 'payment_asc':
        return a.monthlyPayment - b.monthlyPayment;
      case 'progress_desc':
        return b.payoffPercentage - a.payoffPercentage;
      case 'progress_asc':
        return a.payoffPercentage - b.payoffPercentage;
      case 'name_asc':
        return a.loanName.localeCompare(b.loanName);
      case 'name_desc':
        return b.loanName.localeCompare(a.loanName);
      default:
        return 0;
    }
  });

  return (
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {/* Header */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">Loans</h1>
          <p className="text-gray-600 mt-1">
            Track your loan balances and payment progress
          </p>
        </div>

        <Button
          variant="primary"
          icon={Plus}
          onClick={() => navigate('/loans/new')}
        >
          Add Loan
        </Button>
      </div>

      {/* Summary Stats */}
      <LoanStats loans={loans} className="mb-8" />

      {/* Filters */}
      <LoanFilters
        filters={filters}
        sortBy={sortBy}
        onFiltersChange={setFilters}
        onSortChange={setSortBy}
        className="mb-6"
      />

      {/* Loan List */}
      {sortedLoans.length === 0 ? (
        <div className="bg-gray-50 rounded-lg p-8 text-center">
          <p className="text-gray-600">No loans match your filters</p>
        </div>
      ) : (
        <LoanList loans={sortedLoans} />
      )}
    </div>
  );
}

function LoansSkeleton() {
  return (
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <Skeleton className="h-12 w-64 mb-8" />
      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
        {[...Array(3)].map((_, i) => (
          <Skeleton key={i} className="h-24 rounded-lg" />
        ))}
      </div>
      <Skeleton className="h-12 w-full mb-6" />
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {[...Array(6)].map((_, i) => (
          <Skeleton key={i} className="h-64 rounded-lg" />
        ))}
      </div>
    </div>
  );
}
```

**Loan Stats Component:**

```
// src/components/loans/LoanStats.tsx
import React from 'react';
import { Banknote, DollarSign, TrendingUp } from 'lucide-react';
import { Card } from '@/components/common/Card';
import { formatCurrency } from '@/lib/utils/formatters';
import { cn } from '@/lib/utils';
import type { Loan } from '@/types';

interface LoanStatsProps {
  loans: Loan[];
  className?: string;
}

export function LoanStats({ loans, className }: LoanStatsProps) {
  const activeLoans = loans.filter(loan => loan.status === 'active');

  const totalBalance = activeLoans.reduce((sum, loan) => sum + loan.currentBalance, 0);
  const totalMonthlyPayment = activeLoans.reduce(
    (sum, loan) => sum + loan.monthlyPayment + loan.extraPayment,
    0
  );
  const totalPrincipalPaid = activeLoans.reduce(
    (sum, loan) => sum + loan.principalPaid,
    0
  );

  const averageProgress = activeLoans.length > 0
    ? activeLoans.reduce((sum, loan) => sum + loan.payoffPercentage, 0) / activeLoans.length
    : 0;

  const stats = [
    {
      label: 'Total Balance',
      value: formatCurrency(totalBalance),
      subValue: `${activeLoans.length} active loan${activeLoans.length !== 1 ? 's' : ''}`,
      icon: Banknote,
      color: 'blue',
    },
    {
      label: 'Monthly Payments',
      value: formatCurrency(totalMonthlyPayment),
      subValue: `Across all loans`,
      icon: DollarSign,
      color: 'purple',
    },
    {
      label: 'Total Paid',
      value: formatCurrency(totalPrincipalPaid),
      subValue: `${averageProgress.toFixed(1)}% average progress`,
      icon: TrendingUp,
      color: 'green',
    },
  ];

  return (
    <div className={cn('grid grid-cols-1 sm:grid-cols-3 gap-4', className)}>
      {stats.map((stat) => (
        <StatCard key={stat.label} {...stat} />
      ))}
    </div>
  );
}

interface StatCardProps {
  label: string;
  value: string;
  subValue: string;
  icon: React.ElementType;
  color: string;
}

function StatCard({ label, value, subValue, icon: Icon, color }: StatCardProps) {
  const colorClasses = {
    blue: 'bg-blue-100 text-blue-600',
    purple: 'bg-purple-100 text-purple-600',
    green: 'bg-green-100 text-green-600',
  };

  return (
    <Card className="p-6">
      <div className="flex items-start justify-between">
        <div>
          <p className="text-sm text-gray-600 font-medium">{label}</p>
          <p className="text-2xl font-bold text-gray-900 mt-1">{value}</p>
          <p className="text-xs text-gray-500 mt-1">{subValue}</p>
        </div>
        <div className={cn(
          'p-2 rounded-lg',
          colorClasses[color as keyof typeof colorClasses]
        )}>
          <Icon className="h-5 w-5" />
        </div>
      </div>
    </Card>
  );
}
```

**Loan Filters Component:**

```
// src/components/loans/LoanFilters.tsx
import React from 'react';
import { Search, SlidersHorizontal } from 'lucide-react';
import { Input } from '@/components/common/Input';
import { Select } from '@/components/common/Select';
import { cn } from '@/lib/utils';
import type { LoanFilters as Filters, LoanSortBy } from '@/types';

interface LoanFiltersProps {
  filters: Filters;
  sortBy: LoanSortBy;
  onFiltersChange: (filters: Filters) => void;
  onSortChange: (sortBy: LoanSortBy) => void;
  className?: string;
}

export function LoanFilters({
  filters,
  sortBy,
  onFiltersChange,
  onSortChange,
  className,
}: LoanFiltersProps) {
  return (
    <div className={cn('flex flex-col sm:flex-row gap-4', className)}>
      {/* Search */}
      <div className="flex-1">
        <Input
          placeholder="Search loans..."
          icon={Search}
          value={filters.search}
          onChange={(e) => onFiltersChange({ ...filters, search: e.target.value })}
        />
      </div>

      {/* Loan Type Filter */}
      <Select
        value={filters.loanType}
        onChange={(e) => onFiltersChange({ ...filters, loanType: e.target.value as any })}
        className="w-full sm:w-48"
      >
        <option value="all">All Types</option>
        <option value="personal">Personal</option>
        <option value="auto">Auto</option>
        <option value="student">Student</option>
        <option value="home_equity">Home Equity</option>
        <option value="business">Business</option>
        <option value="other">Other</option>
      </Select>

      {/* Status Filter */}
      <Select
        value={filters.status}
        onChange={(e) => onFiltersChange({ ...filters, status: e.target.value as any })}
        className="w-full sm:w-40"
      >
        <option value="all">All Status</option>
        <option value="active">Active</option>
        <option value="deferred">Deferred</option>
        <option value="paid_off">Paid Off</option>
        <option value="in_forbearance">In Forbearance</option>
      </Select>

      {/* Sort */}
      <Select
        value={sortBy}
        onChange={(e) => onSortChange(e.target.value as LoanSortBy)}
        icon={SlidersHorizontal}
        className="w-full sm:w-56"
      >
        <option value="balance_desc">Highest Balance</option>
        <option value="balance_asc">Lowest Balance</option>
        <option value="payment_desc">Highest Payment</option>
        <option value="payment_asc">Lowest Payment</option>
        <option value="progress_desc">Most Progress</option>
        <option value="progress_asc">Least Progress</option>
        <option value="name_asc">Name (A-Z)</option>
        <option value="name_desc">Name (Z-A)</option>
      </Select>
    </div>
  );
}
```

**Loan List and Card Components:**

```
// src/components/loans/LoanList.tsx
import React from 'react';
import { LoanCard } from './LoanCard';
import type { Loan } from '@/types';

interface LoanListProps {
  loans: Loan[];
}

export function LoanList({ loans }: LoanListProps) {
  return (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {loans.map((loan) => (
        <LoanCard key={loan.id} loan={loan} />
      ))}
    </div>
  );
}
```

```
// src/components/loans/LoanCard.tsx
import React, { useState } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import {
  Banknote,
  MoreVertical,
  Edit,
  Trash2,
  Eye,
  Car,
  GraduationCap,
  Home,
  Briefcase,
  HelpCircle,
} from 'lucide-react';
import { Card } from '@/components/common/Card';
import { Badge } from '@/components/common/Badge';
import { DropdownMenu } from '@/components/common/DropdownMenu';
import { ProgressBar } from '@/components/common/ProgressBar';
import { ConfirmDialog } from '@/components/common/ConfirmDialog';
import { useDeleteLoan } from '@/hooks/api/useLoans';
import { formatCurrency, formatPercentage } from '@/lib/utils/formatters';
import { cn } from '@/lib/utils';
import type { Loan } from '@/types';

interface LoanCardProps {
  loan: Loan;
}

export function LoanCard({ loan }: LoanCardProps) {
  const navigate = useNavigate();
  const { mutate: deleteLoan } = useDeleteLoan();
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);

  const getLoanTypeIcon = () => {
    switch (loan.loanType) {
      case 'auto':
        return Car;
      case 'student':
        return GraduationCap;
      case 'home_equity':
        return Home;
      case 'business':
        return Briefcase;
      default:
        return Banknote;
    }
  };

  const Icon = getLoanTypeIcon();

  const getLoanTypeLabel = () => {
    const labels = {
      personal: 'Personal',
      auto: 'Auto',
      student: 'Student',
      home_equity: 'Home Equity',
      business: 'Business',
      other: 'Other',
    };
    return labels[loan.loanType];
  };

  const getStatusBadge = () => {
    switch (loan.status) {
      case 'active':
        return <Badge variant="success">Active</Badge>;
      case 'deferred':
        return <Badge variant="warning">Deferred</Badge>;
      case 'paid_off':
        return <Badge variant="info">Paid Off</Badge>;
      case 'in_forbearance':
        return <Badge variant="warning">Forbearance</Badge>;
      case 'defaulted':
        return <Badge variant="danger">Defaulted</Badge>;
      default:
        return null;
    }
  };

  const handleDelete = () => {
    deleteLoan(loan.id, {
      onSuccess: () => {
        setShowDeleteDialog(false);
      },
    });
  };

  const menuItems = [
    {
      label: 'View Details',
      icon: Eye,
      onClick: () => navigate(`/loans/${loan.id}`),
    },
    {
      label: 'Edit',
      icon: Edit,
      onClick: () => navigate(`/loans/${loan.id}/edit`),
    },
    {
      type: 'divider' as const,
    },
    {
      label: 'Delete',
      icon: Trash2,
      onClick: () => setShowDeleteDialog(true),
      variant: 'danger' as const,
    },
  ];

  return (
    <>
      <Card className="overflow-hidden hover:shadow-lg transition-shadow">
        {/* Card Header */}
        <div className="bg-gradient-to-br from-purple-500 to-purple-600 p-6 text-white">
          <div className="flex items-start justify-between mb-4">
            <div className="flex items-center gap-2">
              <Icon className="h-5 w-5" />
              <span className="text-xs font-medium opacity-90">
                {getLoanTypeLabel()}
              </span>
            </div>
            <DropdownMenu items={menuItems} trigger={
              <button className="text-white hover:bg-white/20 p-1 rounded transition-colors">
                <MoreVertical className="h-5 w-5" />
              </button>
            } />
          </div>

          <h3 className="text-xl font-bold mb-1">{loan.loanName}</h3>
          {loan.lender && (
            <p className="text-sm opacity-90">{loan.lender}</p>
          )}
        </div>

        {/* Card Body */}
        <div className="p-6">
          {/* Status Badge */}
          <div className="mb-4">
            {getStatusBadge()}
          </div>

          {/* Balance */}
          <div className="mb-4">
            <p className="text-sm text-gray-600 mb-1">Current Balance</p>
            <p className="text-2xl font-bold text-gray-900">
              {formatCurrency(loan.currentBalance)}
            </p>
            <p className="text-xs text-gray-500 mt-1">
              of {formatCurrency(loan.principal)} original
            </p>
          </div>

          {/* Progress */}
          <div className="mb-4">
            <div className="flex items-center justify-between text-sm mb-2">
              <span className="text-gray-600">Payoff Progress</span>
              <span className="font-semibold text-gray-900">
                {formatPercentage(loan.payoffPercentage)}
              </span>
            </div>
            <ProgressBar
              value={loan.payoffPercentage}
              max={100}
              variant={
                loan.payoffPercentage >= 75 ? 'success' :
                loan.payoffPercentage >= 50 ? 'warning' : 'danger'
              }
            />
            <p className="text-xs text-gray-500 mt-1">
              {formatCurrency(loan.principalPaid)} paid
            </p>
          </div>

          {/* Payment Info */}
          <div className="grid grid-cols-2 gap-4 pt-4 border-t border-gray-200">
            <div>
              <p className="text-xs text-gray-600 mb-1">Monthly Payment</p>
              <p className="text-sm font-semibold text-gray-900">
                {formatCurrency(loan.monthlyPayment)}
              </p>
            </div>
            <div>
              <p className="text-xs text-gray-600 mb-1">Interest Rate</p>
              <p className="text-sm font-semibold text-gray-900">
                {formatPercentage(loan.interestRate)}
              </p>
            </div>
          </div>

          {/* Extra Payment */}
          {loan.extraPayment > 0 && (
            <div className="mt-4 p-3 bg-green-50 rounded-lg">
              <p className="text-xs text-green-700 mb-1">Extra Payment</p>
              <p className="text-sm font-semibold text-green-900">
                +{formatCurrency(loan.extraPayment)}/month
              </p>
            </div>
          )}

          {/* Auto-pay Badge */}
          {loan.autoPay && (
            <div className="mt-4">
              <Badge variant="info" size="sm">Auto-pay enabled</Badge>
            </div>
          )}

          {/* Remaining Months */}
          {loan.remainingMonths > 0 && (
            <div className="mt-4 pt-4 border-t border-gray-200">
              <p className="text-xs text-gray-600">Est. Time Remaining</p>
              <p className="text-sm font-semibold text-gray-900">
                {loan.remainingMonths} month{loan.remainingMonths !== 1 ? 's' : ''}
              </p>
            </div>
          )}

          {/* View Details Link */}
          <Link
            to={`/loans/${loan.id}`}
            className="block mt-4 text-center text-sm text-blue-600 hover:text-blue-700 font-medium"
          >
            View Details →
          </Link>
        </div>
      </Card>

      {/* Delete Confirmation Dialog */}
      <ConfirmDialog
        isOpen={showDeleteDialog}
        onClose={() => setShowDeleteDialog(false)}
        onConfirm={handleDelete}
        title="Delete Loan"
        description={`Are you sure you want to delete "${loan.loanName}"? This action cannot be undone.`}
        confirmLabel="Delete"
        variant="danger"
      />
    </>
  );
}
```

**Type Definitions:**

```ts
// Add to src/types/index.ts

export interface LoanFilters {
  loanType: 'all' | 'personal' | 'auto' | 'student' | 'home_equity' | 'business' | 'other';
  status: 'all' | 'active' | 'deferred' | 'paid_off' | 'defaulted' | 'in_forbearance';
  search: string;
}

export type LoanSortBy = 
  | 'balance_desc'
  | 'balance_asc'
  | 'payment_desc'
  | 'payment_asc'
  | 'progress_desc'
  | 'progress_asc'
  | 'name_asc'
  | 'name_desc';
```

#### **5.4.2 Loan Detail View** {#5.4.2-loan-detail-view}

```
// src/pages/LoanDetailPage.tsx
import React, { useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import {
  ArrowLeft,
  Edit,
  Trash2,
  DollarSign,
  TrendingDown,
  Calendar,
  Shield,
  AlertCircle,
} from 'lucide-react';
import { useLoan, useDeleteLoan } from '@/hooks/api/useLoans';
import { Button } from '@/components/common/Button';
import { Card } from '@/components/common/Card';
import { Badge } from '@/components/common/Badge';
import { ProgressBar } from '@/components/common/ProgressBar';
import { ConfirmDialog } from '@/components/common/ConfirmDialog';
import { Alert } from '@/components/common/Alert';
import { LoanAmortizationSchedule } from '@/components/loans/LoanAmortizationSchedule';
import { PaymentHistory } from '@/components/loans/LoanPaymentHistory';
import { formatCurrency, formatPercentage, formatDate } from '@/lib/utils/formatters';
import { calculateLoanPayoffDate } from '@/lib/calculations/loans';
import { Skeleton } from '@/components/common/Skeleton';

export function LoanDetailPage() {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const { data: loan, isLoading, error } = useLoan(id!);
  const { mutate: deleteLoan } = useDeleteLoan();
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);

  if (isLoading) {
    return <DetailSkeleton />;
  }

  if (error || !loan) {
    return (
      <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div className="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
          <p className="text-red-800">Loan not found</p>
          <Button
            variant="outline"
            className="mt-4"
            onClick={() => navigate('/loans')}
          >
            Back to Loans
          </Button>
        </div>
      </div>
    );
  }

  const handleDelete = () => {
    deleteLoan(loan.id, {
      onSuccess: () => {
        navigate('/loans');
      },
    });
  };

  const projectedPayoffDate = calculateLoanPayoffDate(
    loan.currentBalance,
    loan.monthlyPayment + loan.extraPayment,
    loan.interestRate
  );

  return (
    <>
      <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Header */}
        <div className="flex items-center gap-4 mb-8">
          <Button
            variant="ghost"
            icon={ArrowLeft}
            onClick={() => navigate('/loans')}
          >
            Back
          </Button>

          <div className="flex-1">
            <h1 className="text-3xl font-bold text-gray-900">
              {loan.loanName}
            </h1>
            {loan.lender && (
              <p className="text-gray-600 mt-1">{loan.lender}</p>
            )}
          </div>

          <div className="flex gap-2">
            <Button
              variant="outline"
              icon={Edit}
              onClick={() => navigate(`/loans/${loan.id}/edit`)}
            >
              Edit
            </Button>
            <Button
              variant="outline"
              icon={Trash2}
              onClick={() => setShowDeleteDialog(true)}
            >
              Delete
            </Button>
          </div>
        </div>

        {/* Alerts */}
        {loan.status === 'deferred' && (
          <Alert variant="warning" className="mb-6">
            <AlertCircle className="h-4 w-4" />
            <span>This loan is currently in deferment. Payments are paused.</span>
          </Alert>
        )}

        {loan.status === 'in_forbearance' && (
          <Alert variant="warning" className="mb-6">
            <AlertCircle className="h-4 w-4" />
            <span>This loan is in forbearance. Interest may still be accruing.</span>
          </Alert>
        )}

        {loan.prepaymentPenalty && (
          <Alert variant="info" className="mb-6">
            <AlertCircle className="h-4 w-4" />
            <span>
              Prepayment penalty applies. 
              {loan.prepaymentPenaltyAmount && ` Fee: ${formatCurrency(loan.prepaymentPenaltyAmount)}`}
            </span>
          </Alert>
        )}

        {/* Overview Card */}
        <Card className="p-6 mb-6">
          <div className="flex items-start justify-between mb-6">
            <div>
              <h2 className="text-lg font-semibold text-gray-900">Overview</h2>
              <div className="flex items-center gap-2 mt-2">
                <Badge variant={loan.status === 'active' ? 'success' : 'secondary'}>
                  {loan.status.replace('_', ' ')}
                </Badge>
                {loan.autoPay && (
                  <Badge variant="info">Auto-pay</Badge>
                )}
                {loan.isSecured && (
                  <Badge variant="secondary">
                    <Shield className="h-3 w-3 mr-1" />
                    Secured
                  </Badge>
                )}
              </div>
            </div>

            <div className="text-right">
              <p className="text-sm text-gray-600">Loan Type</p>
              <p className="text-lg font-semibold text-gray-900 capitalize">
                {loan.loanType.replace('_', ' ')}
              </p>
            </div>
          </div>

          {/* Balance & Progress */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
              <p className="text-sm text-gray-600 mb-2">Current Balance</p>
              <p className="text-3xl font-bold text-gray-900">
                {formatCurrency(loan.currentBalance)}
              </p>
              <p className="text-sm text-gray-600 mt-1">
                of {formatCurrency(loan.principal)} original
              </p>
            </div>

            <div>
              <p className="text-sm text-gray-600 mb-2">Payoff Progress</p>
              <p className="text-3xl font-bold text-gray-900">
                {formatPercentage(loan.payoffPercentage)}
              </p>
              <ProgressBar
                value={loan.payoffPercentage}
                max={100}
                variant={
                  loan.payoffPercentage >= 75 ? 'success' :
                  loan.payoffPercentage >= 50 ? 'warning' : 'danger'
                }
                className="mt-2"
              />
              <p className="text-sm text-gray-600 mt-1">
                {formatCurrency(loan.principalPaid)} paid
              </p>
            </div>
          </div>

          {/* Key Details Grid */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 pt-6 border-t border-gray-200">
            <DetailItem
              icon={DollarSign}
              label="Monthly Payment"
              value={formatCurrency(loan.monthlyPayment)}
            />
            <DetailItem
              icon={TrendingDown}
              label="Interest Rate"
              value={formatPercentage(loan.interestRate)}
            />
            <DetailItem
              icon={Calendar}
              label="Term"
              value={`${loan.termMonths} months`}
            />
            <DetailItem
              icon={Calendar}
              label="Remaining"
              value={`${loan.remainingMonths} months`}
            />
          </div>

          {/* Extra Payment */}
          {loan.extraPayment > 0 && (
            <div className="mt-6 p-4 bg-green-50 rounded-lg">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-green-900">
                    Extra Monthly Payment
                  </p>
                  <p className="text-xs text-green-700 mt-1">
                    Accelerating your payoff timeline
                  </p>
                </div>
                <p className="text-2xl font-bold text-green-900">
                  {formatCurrency(loan.extraPayment)}
                </p>
              </div>
            </div>
          )}

          {/* Projected Payoff */}
          {projectedPayoffDate && (
            <div className="mt-6 p-4 bg-blue-50 rounded-lg">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-blue-900">
                    Projected Payoff Date
                  </p>
                  <p className="text-xs text-blue-700 mt-1">
                    Based on current payment amount
                  </p>
                </div>
                <p className="text-2xl font-bold text-blue-900">
                  {formatDate(projectedPayoffDate, 'MMM yyyy')}
                </p>
              </div>
            </div>
          )}
        </Card>

        {/* Collateral Information */}
        {loan.isSecured && (
          <Card className="p-6 mb-6">
            <h2 className="text-lg font-semibold text-gray-900 mb-4">
              Collateral Information
            </h2>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {loan.collateralType && (
                <DetailRow
                  label="Collateral Type"
                  value={loan.collateralType.replace('_', ' ')}
                />
              )}
              {loan.collateralValue && (
                <DetailRow
                  label="Collateral Value"
                  value={formatCurrency(loan.collateralValue)}
                />
              )}
            </div>

            {loan.collateralValue && loan.currentBalance > 0 && (
              <div className="mt-4 p-3 bg-gray-50 rounded-lg">
                <div className="flex items-center justify-between text-sm">
                  <span className="text-gray-600">Loan-to-Value Ratio</span>
                  <span className="font-semibold text-gray-900">
                    {formatPercentage((loan.currentBalance / loan.collateralValue) * 100)}
                  </span>
                </div>
              </div>
            )}
          </Card>
        )}

        {/* Amortization Schedule */}
        <LoanAmortizationSchedule loan={loan} className="mb-6" />

        {/* Payment History */}
        <PaymentHistory loanId={loan.id} />

        {/* Additional Details */}
        <Card className="p-6 mt-6">
          <h2 className="text-lg font-semibold text-gray-900 mb-4">
            Additional Details
          </h2>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {loan.accountNumber && (
              <DetailRow label="Account Number" value={loan.accountNumber} />
            )}
            {loan.startDate && (
              <DetailRow
                label="Start Date"
                value={formatDate(loan.startDate, 'MMM d, yyyy')}
              />
            )}
            {loan.maturityDate && (
              <DetailRow
                label="Maturity Date"
                value={formatDate(loan.maturityDate, 'MMM d, yyyy')}
              />
            )}
            {loan.firstPaymentDate && (
              <DetailRow
                label="First Payment Date"
                value={formatDate(loan.firstPaymentDate, 'MMM d, yyyy')}
              />
            )}
            {loan.paymentDay && (
              <DetailRow
                label="Payment Day"
                value={`${loan.paymentDay}${getDaySuffix(loan.paymentDay)} of month`}
              />
            )}
            <DetailRow
              label="Created"
              value={formatDate(loan.createdAt, 'MMM d, yyyy')}
            />
            <DetailRow
              label="Last Updated"
              value={formatDate(loan.updatedAt, 'MMM d, yyyy')}
            />
          </div>

          {loan.notes && (
            <div className="mt-6 pt-6 border-t border-gray-200">
              <p className="text-sm font-medium text-gray-900 mb-2">Notes</p>
              <p className="text-sm text-gray-600 whitespace-pre-wrap">
                {loan.notes}
              </p>
            </div>
          )}
        </Card>
      </div>

      {/* Delete Dialog */}
      <ConfirmDialog
        isOpen={showDeleteDialog}
        onClose={() => setShowDeleteDialog(false)}
        onConfirm={handleDelete}
        title="Delete Loan"
        description={`Are you sure you want to delete "${loan.loanName}"? This action cannot be undone.`}
        confirmLabel="Delete"
        variant="danger"
      />
    </>
  );
}

interface DetailItemProps {
  icon: React.ElementType;
  label: string;
  value: string;
}

function DetailItem({ icon: Icon, label, value }: DetailItemProps) {
  return (
    <div>
      <div className="flex items-center gap-2 text-gray-600 mb-1">
        <Icon className="h-4 w-4" />
        <p className="text-xs font-medium">{label}</p>
      </div>
      <p className="text-sm font-semibold text-gray-900">{value}</p>
    </div>
  );
}

interface DetailRowProps {
  label: string;
  value: string;
}

function DetailRow({ label, value }: DetailRowProps) {
  return (
    <div className="flex items-center justify-between py-2">
      <p className="text-sm text-gray-600">{label}</p>
      <p className="text-sm font-medium text-gray-900 capitalize">{value}</p>
    </div>
  );
}

function getDaySuffix(day: number): string {
  if (day >= 11 && day <= 13) return 'th';
  switch (day % 10) {
    case 1: return 'st';
    case 2: return 'nd';
    case 3: return 'rd';
    default: return 'th';
  }
}

function DetailSkeleton() {
  return (
    <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <Skeleton className="h-12 w-64 mb-8" />
      <Skeleton className="h-64 rounded-lg mb-6" />
      <Skeleton className="h-96 rounded-lg mb-6" />
      <Skeleton className="h-48 rounded-lg" />
    </div>
  );
}
```

**Loan Calculation Functions:**

```ts
// src/lib/calculations/loans.ts

/**
 * Calculate monthly payment for a loan
 * Formula: P = L[c(1 + c)^n]/[(1 + c)^n - 1]
 * Where:
 *   L = Loan amount (principal)
 *   c = Monthly interest rate (annual rate / 12 / 100)
 *   n = Number of months
 *   P = Monthly payment
 */
export function calculateLoanPayment(
  principal: number,
  annualInterestRate: number,
  termMonths: number
): number {
  if (principal === 0 || termMonths === 0) return 0;
  
  const monthlyRate = annualInterestRate / 12 / 100;
  
  // If no interest, simple division
  if (monthlyRate === 0) {
    return principal / termMonths;
  }
  
  const numerator = principal * monthlyRate * Math.pow(1 + monthlyRate, termMonths);
  const denominator = Math.pow(1 + monthlyRate, termMonths) - 1;
  
  return numerator / denominator;
}

/**
 * Calculate loan payoff date based on payment amount
 */
export function calculateLoanPayoffDate(
  currentBalance: number,
  monthlyPayment: number,
  annualInterestRate: number,
  startDate: Date = new Date()
): Date | null {
  if (currentBalance === 0) return new Date();
  if (monthlyPayment === 0) return null;
  
  const monthlyRate = annualInterestRate / 12 / 100;
  
  // Check if payment covers interest
  const monthlyInterest = currentBalance * monthlyRate;
  if (monthlyPayment <= monthlyInterest) {
    return null; // Will never pay off
  }
  
  // Calculate months to payoff
  let months: number;
  if (monthlyRate === 0) {
    months = Math.ceil(currentBalance / monthlyPayment);
  } else {
    const numerator = -Math.log(1 - (currentBalance * monthlyRate / monthlyPayment));
    const denominator = Math.log(1 + monthlyRate);
    months = Math.ceil(numerator / denominator);
  }
  
  const payoffDate = new Date(startDate);
  payoffDate.setMonth(payoffDate.getMonth() + months);
  
  return payoffDate;
}

/**
 * Generate loan amortization schedule
 */
export interface LoanAmortizationEntry {
  month: number;
  payment: number;
  principal: number;
  interest: number;
  balance: number;
  cumulativeInterest: number;
}

export function generateLoanAmortizationSchedule(
  initialBalance: number,
  monthlyPayment: number,
  annualInterestRate: number,
  maxMonths: number = 360
): LoanAmortizationEntry[] {
  const schedule: LoanAmortizationEntry[] = [];
  let balance = initialBalance;
  let cumulativeInterest = 0;
  const monthlyRate = annualInterestRate / 12 / 100;
  
  for (let month = 1; month <= maxMonths && balance > 0; month++) {
    const interestPayment = balance * monthlyRate;
    const principalPayment = Math.min(monthlyPayment - interestPayment, balance);
    const totalPayment = interestPayment + principalPayment;
    
    cumulativeInterest += interestPayment;
    balance -= principalPayment;
    
    schedule.push({
      month,
      payment: totalPayment,
      principal: principalPayment,
      interest: interestPayment,
      balance: Math.max(balance, 0),
      cumulativeInterest,
    });
    
    if (balance <= 0) break;
  }
  
  return schedule;
}

/**
 * Calculate total interest over life of loan
 */
export function calculateTotalLoanInterest(
  principal: number,
  monthlyPayment: number,
  annualInterestRate: number
): number {
  const schedule = generateLoanAmortizationSchedule(
    principal,
    monthlyPayment,
    annualInterestRate
  );
  
  if (schedule.length === 0) return 0;
  
  return schedule[schedule.length - 1].cumulativeInterest;
}
```

**Loan Amortization Schedule Component:**

```
// src/components/loans/LoanAmortizationSchedule.tsx
import React, { useState, useMemo } from 'react';
import {
  BarChart3,
  ChevronDown,
  ChevronUp,
  Download,
} from 'lucide-react';
import { Card } from '@/components/common/Card';
import { Button } from '@/components/common/Button';
import { Select } from '@/components/common/Select';
import { generateLoanAmortizationSchedule } from '@/lib/calculations/loans';
import { formatCurrency, formatDate } from '@/lib/utils/formatters';
import { cn } from '@/lib/utils';
import type { Loan } from '@/types';

interface LoanAmortizationScheduleProps {
  loan: Loan;
  className?: string;
}

export function LoanAmortizationSchedule({ loan, className }: LoanAmortizationScheduleProps) {
  const [showSchedule, setShowSchedule] = useState(false);
  const [viewMode, setViewMode] = useState<'monthly' | 'yearly'>('monthly');
  const [displayMonths, setDisplayMonths] = useState<number>(12);

  const schedule = useMemo(() => {
    return generateLoanAmortizationSchedule(
      loan.currentBalance,
      loan.monthlyPayment + loan.extraPayment,
      loan.interestRate
    );
  }, [loan.currentBalance, loan.monthlyPayment, loan.extraPayment, loan.interestRate]);

  const yearlySchedule = useMemo(() => {
    if (viewMode !== 'yearly' || schedule.length === 0) return [];

    const years: typeof schedule = [];
    for (let i = 11; i < schedule.length; i += 12) {
      years.push(schedule[i]);
    }
    // Add final month if not included
    if (schedule.length % 12 !== 0) {
      years.push(schedule[schedule.length - 1]);
    }
    return years;
  }, [schedule, viewMode]);

  const displaySchedule = viewMode === 'yearly' ? yearlySchedule : schedule.slice(0, displayMonths);

  const handleExport = () => {
    const headers = ['Month', 'Payment', 'Principal', 'Interest', 'Balance', 'Cumulative Interest'];
    const rows = schedule.map(entry => [
      entry.month,
      entry.payment.toFixed(2),
      entry.principal.toFixed(2),
      entry.interest.toFixed(2),
      entry.balance.toFixed(2),
      entry.cumulativeInterest.toFixed(2),
    ]);

    const csv = [
      headers.join(','),
      ...rows.map(row => row.join(','))
    ].join('\n');

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `loan-amortization-${loan.loanName.replace(/\s+/g, '-').toLowerCase()}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
  };

  if (schedule.length === 0) {
    return null;
  }

  const totalInterest = schedule[schedule.length - 1].cumulativeInterest;
  const totalPaid = loan.currentBalance + totalInterest;

  return (
    <Card className={cn('p-6', className)}>
      {/* Header */}
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-3">
          <div className="p-2 bg-indigo-100 rounded-lg">
            <BarChart3 className="h-5 w-5 text-indigo-600" />
          </div>
          <div>
            <h2 className="text-lg font-semibold text-gray-900">
              Amortization Schedule
            </h2>
            <p className="text-sm text-gray-600">
              {schedule.length} month{schedule.length !== 1 ? 's' : ''} • {formatCurrency(totalInterest)} total interest
            </p>
          </div>
        </div>

        <Button
          variant="outline"
          icon={showSchedule ? ChevronUp : ChevronDown}
          onClick={() => setShowSchedule(!showSchedule)}
        >
          {showSchedule ? 'Hide' : 'Show'} Schedule
        </Button>
      </div>

      {/* Summary Stats */}
      <div className="grid grid-cols-3 gap-4 mb-6">
        <div className="p-4 bg-blue-50 rounded-lg">
          <p className="text-xs text-blue-700 mb-1">Total to Pay</p>
          <p className="text-lg font-bold text-blue-900">
            {formatCurrency(totalPaid)}
          </p>
        </div>
        <div className="p-4 bg-green-50 rounded-lg">
          <p className="text-xs text-green-700 mb-1">Principal</p>
          <p className="text-lg font-bold text-green-900">
            {formatCurrency(loan.currentBalance)}
          </p>
        </div>
        <div className="p-4 bg-red-50 rounded-lg">
          <p className="text-xs text-red-700 mb-1">Total Interest</p>
          <p className="text-lg font-bold text-red-900">
            {formatCurrency(totalInterest)}
          </p>
        </div>
      </div>

      {/* Schedule Table */}
      {showSchedule && (
        <>
          {/* Controls */}
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-4">
              <Select
                value={viewMode}
                onChange={(e) => setViewMode(e.target.value as 'monthly' | 'yearly')}
                className="w-32"
              >
                <option value="monthly">Monthly</option>
                <option value="yearly">Yearly</option>
              </Select>

              {viewMode === 'monthly' && (
                <Select
                  value={displayMonths}
                  onChange={(e) => setDisplayMonths(Number(e.target.value))}
                  className="w-32"
                >
                  <option value={12}>12 months</option>
                  <option value={24}>24 months</option>
                  <option value={36}>36 months</option>
                  <option value={60}>60 months</option>
                  <option value={schedule.length}>All</option>
                </Select>
              )}
            </div>

            <Button
              variant="outline"
              size="sm"
              icon={Download}
              onClick={handleExport}
            >
              Export CSV
            </Button>
          </div>

          {/* Table */}
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="border-b-2 border-gray-200">
                  <th className="text-left py-3 px-2 font-semibold text-gray-700">
                    {viewMode === 'monthly' ? 'Month' : 'Year'}
                  </th>
                  <th className="text-right py-3 px-2 font-semibold text-gray-700">Payment</th>
                  <th className="text-right py-3 px-2 font-semibold text-gray-700">Principal</th>
                  <th className="text-right py-3 px-2 font-semibold text-gray-700">Interest</th>
                  <th className="text-right py-3 px-2 font-semibold text-gray-700">Balance</th>
                  <th className="text-right py-3 px-2 font-semibold text-gray-700">
                    Total Interest
                  </th>
                </tr>
              </thead>
              <tbody>
                {displaySchedule.map((entry, index) => {
                  const isLastPayment = entry.balance === 0;
                  return (
                    <tr
                      key={entry.month}
                      className={cn(
                        'border-b border-gray-100',
                        isLastPayment && 'bg-green-50'
                      )}
                    >
                      <td className="py-3 px-2 text-gray-900 font-medium">
                        {viewMode === 'monthly' ? entry.month : Math.ceil(entry.month / 12)}
                      </td>
                      <td className="py-3 px-2 text-right text-gray-900">
                        {formatCurrency(entry.payment)}
                      </td>
                      <td className="py-3 px-2 text-right text-green-600 font-medium">
                        {formatCurrency(entry.principal)}
                      </td>
                      <td className="py-3 px-2 text-right text-red-600 font-medium">
                        {formatCurrency(entry.interest)}
                      </td>
                      <td className="py-3 px-2 text-right font-semibold text-gray-900">
                        {formatCurrency(entry.balance)}
                      </td>
                      <td className="py-3 px-2 text-right text-gray-600">
                        {formatCurrency(entry.cumulativeInterest)}
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>

          {/* Footer Note */}
          {viewMode === 'monthly' && displayMonths < schedule.length && (
            <p className="text-xs text-gray-500 mt-4 text-center">
              Showing first {displayMonths} of {schedule.length} months
            </p>
          )}
        </>
      )}
    </Card>
  );
}
```

**Loan Payment History Component:**

```
// src/components/loans/LoanPaymentHistory.tsx
import React, { useState } from 'react';
import { 
  History, 
  DollarSign, 
  Calendar,
  Download,
  Filter,
  CheckCircle,
} from 'lucide-react';
import { Card } from '@/components/common/Card';
import { Button } from '@/components/common/Button';
import { Badge } from '@/components/common/Badge';
import { Select } from '@/components/common/Select';
import { EmptyState } from '@/components/common/EmptyState';
import { usePaymentHistory } from '@/hooks/api/usePayments';
import { formatCurrency, formatDate } from '@/lib/utils/formatters';
import type { PaymentHistoryEntry } from '@/types';

interface LoanPaymentHistoryProps {
  loanId: string;
  className?: string;
}

export function LoanPaymentHistory({ loanId, className }: LoanPaymentHistoryProps) {
  const [timeRange, setTimeRange] = useState<'30d' | '90d' | '1y' | 'all'>('90d');
  const { data: payments, isLoading } = usePaymentHistory(loanId, timeRange, 'loan');

  const handleExport = () => {
    if (!payments) return;

    const headers = ['Date', 'Amount', 'Method', 'Confirmation'];
    const rows = payments.map(p => [
      formatDate(p.paymentDate, 'yyyy-MM-dd'),
      p.amount.toString(),
      p.paymentMethod || '',
      p.confirmationNumber || '',
    ]);

    const csv = [
      headers.join(','),
      ...rows.map(row => row.join(','))
    ].join('\n');

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `loan-payment-history-${formatDate(new Date(), 'yyyy-MM-dd')}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
  };

  if (isLoading) {
    return (
      <Card className="p-6">
        <div className="animate-pulse space-y-4">
          {[...Array(5)].map((_, i) => (
            <div key={i} className="h-16 bg-gray-200 rounded" />
          ))}
        </div>
      </Card>
    );
  }

  const totalPaid = payments?.reduce((sum, p) => sum + p.amount, 0) || 0;

  return (
    <Card className="p-6">
      {/* Header */}
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-3">
          <div className="p-2 bg-purple-100 rounded-lg">
            <History className="h-5 w-5 text-purple-600" />
          </div>
          <div>
            <h2 className="text-lg font-semibold text-gray-900">
              Payment History
            </h2>
            {payments && payments.length > 0 && (
              <p className="text-sm text-gray-600">
                {payments.length} payment{payments.length !== 1 ? 's' : ''} • {formatCurrency(totalPaid)} total
              </p>
            )}
          </div>
        </div>

        <div className="flex items-center gap-2">
          <Select
            value={timeRange}
            onChange={(e) => setTimeRange(e.target.value as any)}
            icon={Filter}
            className="w-32"
          >
            <option value="30d">Last 30 days</option>
            <option value="90d">Last 90 days</option>
            <option value="1y">Last year</option>
            <option value="all">All time</option>
          </Select>

          {payments && payments.length > 0 && (
            <Button
              variant="outline"
              size="sm"
              icon={Download}
              onClick={handleExport}
            >
              Export
            </Button>
          )}
        </div>
      </div>

      {/* Payment List */}
      {!payments || payments.length === 0 ? (
        <EmptyState
          icon={History}
          title="No payment history"
          description="Payments you make will appear here"
        />
      ) : (
        <div className="space-y-3">
          {payments.map((payment) => (
            <PaymentItem key={payment.id} payment={payment} />
          ))}
        </div>
      )}
    </Card>
  );
}

interface PaymentItemProps {
  payment: PaymentHistoryEntry;
}

function PaymentItem({ payment }: PaymentItemProps) {
  return (
    <div className="flex items-center gap-4 p-4 hover:bg-gray-50 rounded-lg transition-colors">
      {/* Icon */}
      <div className="flex-shrink-0 w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
        <CheckCircle className="h-5 w-5 text-green-600" />
      </div>

      {/* Content */}
      <div className="flex-1 min-w-0">
        <div className="flex items-center gap-2 mb-1">
          <p className="text-sm font-medium text-gray-900">
            Payment Processed
          </p>
          {payment.paymentMethod && (
            <Badge variant="secondary" size="sm">
              {payment.paymentMethod}
            </Badge>
          )}
        </div>
        <div className="flex items-center gap-4 text-xs text-gray-600">
          <span className="flex items-center gap-1">
            <Calendar className="h-3 w-3" />
            {formatDate(payment.paymentDate, 'MMM d, yyyy')}
          </span>
          {payment.confirmationNumber && (
            <span>Conf: {payment.confirmationNumber}</span>
          )}
        </div>
      </div>

      {/* Amount */}
      <div className="text-right">
        <p className="text-lg font-semibold text-green-600">
          {formatCurrency(payment.amount)}
        </p>
      </div>
    </div>
  );
}
```

**Update Payment History Hook:**

```ts
// Update src/hooks/api/usePayments.ts
export function usePaymentHistory(
  referenceId: string,
  timeRange: '30d' | '90d' | '1y' | 'all',
  paymentType: 'credit_card' | 'loan' | 'mortgage' | 'bill' = 'credit_card'
) {
  return useQuery({
    queryKey: ['payment-history', referenceId, timeRange, paymentType],
    queryFn: async () => {
      let query = supabase
        .from('payment_history')
        .select('*')
        .eq('reference_id', referenceId)
        .eq('payment_type', paymentType)
        .order('payment_date', { ascending: false });

      // Apply time range filter
      if (timeRange !== 'all') {
        const now = new Date();
        const cutoffDate = new Date();

        switch (timeRange) {
          case '30d':
            cutoffDate.setDate(now.getDate() - 30);
            break;
          case '90d':
            cutoffDate.setDate(now.getDate() - 90);
            break;
          case '1y':
            cutoffDate.setFullYear(now.getFullYear() - 1);
            break;
        }

        query = query.gte('payment_date', cutoffDate.toISOString());
      }

      const { data, error } = await query;

      if (error) throw error;

      return data.map(item => ({
        id: item.id,
        cardId: item.reference_id,
        amount: item.amount,
        paymentDate: item.payment_date,
        paymentMethod: item.payment_method,
        confirmationNumber: item.confirmation_number,
        createdAt: item.created_at,
      })) as PaymentHistoryEntry[];
    },
  });
}
```

#### **5.4.3 Loan Form (Add/Edit)** {#5.4.3-loan-form-(add/edit)}

```
// src/pages/LoanFormPage.tsx
import React, { useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useForm, Controller } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { ArrowLeft, Save, Loader2, Calculator } from 'lucide-react';
import {
  useLoan,
  useCreateLoan,
  useUpdateLoan,
} from '@/hooks/api/useLoans';
import { loanSchema, type LoanFormData } from '@/lib/schemas/loan.schema';
import { calculateLoanPayment } from '@/lib/calculations/loans';
import { Button } from '@/components/common/Button';
import { Card } from '@/components/common/Card';
import { Input } from '@/components/common/Input';
import { Select } from '@/components/common/Select';
import { Textarea } from '@/components/common/Textarea';
import { Checkbox } from '@/components/common/Checkbox';
import { CurrencyInput } from '@/components/common/CurrencyInput';
import { PercentageInput } from '@/components/common/PercentageInput';
import { FormSection } from '@/components/common/FormSection';
import { Alert } from '@/components/common/Alert';
import { Skeleton } from '@/components/common/Skeleton';

export function LoanFormPage() {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const isEditMode = Boolean(id);

  const { data: loan, isLoading } = useLoan(id!, { enabled: isEditMode });
  const createMutation = useCreateLoan();
  const updateMutation = useUpdateLoan();

  const {
    register,
    control,
    handleSubmit,
    watch,
    setValue,
    formState: { errors, isSubmitting },
  } = useForm<LoanFormData>({
    resolver: zodResolver(loanSchema),
    defaultValues: {
      status: 'active',
      autoPay: false,
      prepaymentPenalty: false,
      isSecured: false,
      extraPayment: 0,
    },
  });

  // Populate form when editing
  useEffect(() => {
    if (loan && isEditMode) {
      setValue('loanName', loan.loanName);
      setValue('loanType', loan.loanType);
      setValue('lender', loan.lender || '');
      setValue('accountNumber', loan.accountNumber || '');
      setValue('principal', loan.principal);
      setValue('currentBalance', loan.currentBalance);
      setValue('interestRate', loan.interestRate);
      setValue('termMonths', loan.termMonths);
      setValue('monthlyPayment', loan.monthlyPayment);
      setValue('extraPayment', loan.extraPayment);
      setValue('startDate', loan.startDate);
      setValue('maturityDate', loan.maturityDate || '');
      setValue('firstPaymentDate', loan.firstPaymentDate || '');
      setValue('paymentDay', loan.paymentDay || undefined);
      setValue('autoPay', loan.autoPay);
      setValue('prepaymentPenalty', loan.prepaymentPenalty);
      setValue('prepaymentPenaltyAmount', loan.prepaymentPenaltyAmount || undefined);
      setValue('isSecured', loan.isSecured);
      setValue('collateralType', loan.collateralType || '');
      setValue('collateralValue', loan.collateralValue || undefined);
      setValue('status', loan.status);
      setValue('notes', loan.notes || '');
    }
  }, [loan, isEditMode, setValue]);

  // Watch values for auto-calculations
  const principal = watch('principal');
  const currentBalance = watch('currentBalance');
  const interestRate = watch('interestRate');
  const termMonths = watch('termMonths');
  const isSecured = watch('isSecured');
  const prepaymentPenalty = watch('prepaymentPenalty');

  // Auto-calculate monthly payment
  const handleCalculatePayment = () => {
    if (currentBalance && interestRate && termMonths) {
      const calculated = calculateLoanPayment(currentBalance, interestRate, termMonths);
      setValue('monthlyPayment', Math.round(calculated * 100) / 100);
    }
  };

  const onSubmit = async (data: LoanFormData) => {
    try {
      if (isEditMode && id) {
        await updateMutation.mutateAsync({ id, data });
      } else {
        await createMutation.mutateAsync(data);
      }
      navigate('/loans');
    } catch (error) {
      console.error('Failed to save loan:', error);
    }
  };

  if (isLoading && isEditMode) {
    return <FormSkeleton />;
  }

  return (
    <div className="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {/* Header */}
      <div className="flex items-center gap-4 mb-8">
        <Button
          variant="ghost"
          icon={ArrowLeft}
          onClick={() => navigate('/loans')}
        >
          Back
        </Button>

        <div className="flex-1">
          <h1 className="text-3xl font-bold text-gray-900">
            {isEditMode ? 'Edit Loan' : 'Add Loan'}
          </h1>
          <p className="text-gray-600 mt-1">
            {isEditMode
              ? 'Update your loan information'
              : 'Add a new loan to track'}
          </p>
        </div>
      </div>

      {/* Form */}
      <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
        {/* Basic Information */}
        <FormSection
          title="Basic Information"
          description="Enter the basic details about your loan"
        >
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div className="md:col-span-2">
              <Input
                {...register('loanName')}
                label="Loan Name"
                placeholder="Auto Loan - Honda Civic"
                error={errors.loanName?.message}
                required
                helpText="A friendly name to identify this loan"
              />
            </div>

            <Select
              {...register('loanType')}
              label="Loan Type"
              error={errors.loanType?.message}
              required
            >
              <option value="">Select type</option>
              <option value="personal">Personal Loan</option>
              <option value="auto">Auto Loan</option>
              <option value="student">Student Loan</option>
              <option value="home_equity">Home Equity</option>
              <option value="business">Business Loan</option>
              <option value="other">Other</option>
            </Select>

            <Input
              {...register('lender')}
              label="Lender/Bank"
              placeholder="Wells Fargo Bank"
              error={errors.lender?.message}
            />

            <div className="md:col-span-2">
              <Input
                {...register('accountNumber')}
                label="Account Number"
                placeholder="12345678"
                error={errors.accountNumber?.message}
                helpText="For your reference only"
              />
            </div>
          </div>
        </FormSection>

        {/* Loan Details */}
        <FormSection
          title="Loan Details"
          description="Enter the financial details of your loan"
        >
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <Controller
              name="principal"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Original Loan Amount"
                  error={errors.principal?.message}
                  required
                  helpText="The original amount borrowed"
                />
              )}
            />

            <Controller
              name="currentBalance"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Current Balance"
                  error={errors.currentBalance?.message}
                  required
                  helpText="The amount you currently owe"
                />
              )}
            />

            <Controller
              name="interestRate"
              control={control}
              render={({ field }) => (
                <PercentageInput
                  {...field}
                  label="Interest Rate (APR)"
                  error={errors.interestRate?.message}
                  required
                  helpText="Annual percentage rate"
                  max={100}
                />
              )}
            />

            <Input
              {...register('termMonths', { valueAsNumber: true })}
              type="number"
              label="Loan Term (Months)"
              placeholder="60"
              min={1}
              max={480}
              error={errors.termMonths?.message}
              required
              helpText="Original loan term in months"
            />
          </div>
        </FormSection>

        {/* Payment Information */}
        <FormSection
          title="Payment Information"
          description="Set up your payment schedule and amounts"
        >
          {/* Auto-calculate helper */}
          <Alert variant="info" className="mb-4">
            <Calculator className="h-4 w-4" />
            <div className="flex-1">
              <p className="text-sm">
                Need help calculating your monthly payment?
              </p>
            </div>
            <Button
              type="button"
              variant="outline"
              size="sm"
              onClick={handleCalculatePayment}
              disabled={!currentBalance || !interestRate || !termMonths}
            >
              Calculate Payment
            </Button>
          </Alert>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <Controller
              name="monthlyPayment"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Monthly Payment"
                  error={errors.monthlyPayment?.message}
                  required
                  helpText="Required monthly payment amount"
                />
              )}
            />

            <Controller
              name="extraPayment"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Extra Payment"
                  error={errors.extraPayment?.message}
                  helpText="Additional amount paid each month"
                />
              )}
            />

            <Input
              {...register('paymentDay', { valueAsNumber: true })}
              type="number"
              label="Payment Day (Day of Month)"
              placeholder="15"
              min={1}
              max={31}
              error={errors.paymentDay?.message}
              helpText="Day of month payment is due (1-31)"
            />

            <div className="flex items-end">
              <Checkbox
                {...register('autoPay')}
                label="Auto-pay enabled"
                helpText="Payment is automatically deducted"
              />
            </div>
          </div>
        </FormSection>

        {/* Dates */}
        <FormSection
          title="Important Dates"
          description="Track key dates for your loan"
        >
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <Input
              {...register('startDate')}
              type="date"
              label="Loan Start Date"
              error={errors.startDate?.message}
              required
              helpText="When the loan was originated"
            />

            <Input
              {...register('maturityDate')}
              type="date"
              label="Maturity Date"
              error={errors.maturityDate?.message}
              helpText="Expected final payment date"
            />

            <Input
              {...register('firstPaymentDate')}
              type="date"
              label="First Payment Date"
              error={errors.firstPaymentDate?.message}
              helpText="Date of your first payment"
            />
          </div>
        </FormSection>

        {/* Prepayment Penalty */}
        <FormSection
          title="Prepayment Terms"
          description="Information about prepayment penalties"
        >
          <div className="space-y-4">
            <Checkbox
              {...register('prepaymentPenalty')}
              label="This loan has a prepayment penalty"
              helpText="Check if paying off early incurs a fee"
            />

            {prepaymentPenalty && (
              <Controller
                name="prepaymentPenaltyAmount"
                control={control}
                render={({ field }) => (
                  <CurrencyInput
                    {...field}
                    label="Prepayment Penalty Amount"
                    error={errors.prepaymentPenaltyAmount?.message}
                    helpText="Fee charged for early payoff"
                  />
                )}
              />
            )}
          </div>
        </FormSection>

        {/* Collateral Information */}
        <FormSection
          title="Collateral Information"
          description="Is this loan secured by collateral?"
        >
          <div className="space-y-4">
            <Checkbox
              {...register('isSecured')}
              label="This is a secured loan"
              helpText="Check if this loan is backed by collateral"
            />

            {isSecured && (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <Select
                  {...register('collateralType')}
                  label="Collateral Type"
                  error={errors.collateralType?.message}
                >
                  <option value="">Select type</option>
                  <option value="vehicle">Vehicle</option>
                  <option value="real_estate">Real Estate</option>
                  <option value="securities">Securities</option>
                  <option value="equipment">Equipment</option>
                  <option value="other">Other</option>
                </Select>

                <Controller
                  name="collateralValue"
                  control={control}
                  render={({ field }) => (
                    <CurrencyInput
                      {...field}
                      label="Collateral Value"
                      error={errors.collateralValue?.message}
                      helpText="Current market value"
                    />
                  )}
                />
              </div>
            )}
          </div>
        </FormSection>

        {/* Status */}
        <FormSection
          title="Loan Status"
          description="Current status of the loan"
        >
          <Select
            {...register('status')}
            label="Status"
            error={errors.status?.message}
            required
          >
            <option value="active">Active</option>
            <option value="deferred">Deferred</option>
            <option value="paid_off">Paid Off</option>
            <option value="defaulted">Defaulted</option>
            <option value="in_forbearance">In Forbearance</option>
          </Select>
        </FormSection>

        {/* Notes */}
        <FormSection
          title="Notes"
          description="Add any additional notes or comments"
        >
          <Textarea
            {...register('notes')}
            label="Notes"
            placeholder="Add any notes about this loan..."
            rows={4}
            error={errors.notes?.message}
            maxLength={1000}
            showCount
          />
        </FormSection>

        {/* Form Actions */}
        <div className="flex items-center justify-end gap-4 pt-6 border-t border-gray-200">
          <Button
            type="button"
            variant="outline"
            onClick={() => navigate('/loans')}
          >
            Cancel
          </Button>

          <Button
            type="submit"
            variant="primary"
            disabled={isSubmitting}
            icon={isSubmitting ? Loader2 : Save}
            iconAnimation={isSubmitting ? 'spin' : undefined}
          >
            {isSubmitting
              ? 'Saving...'
              : isEditMode
              ? 'Update Loan'
              : 'Add Loan'}
          </Button>
        </div>
      </form>
    </div>
  );
}

function FormSkeleton() {
  return (
    <div className="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <Skeleton className="h-12 w-64 mb-8" />
      {[...Array(6)].map((_, i) => (
        <div key={i} className="mb-6">
          <Skeleton className="h-6 w-48 mb-4" />
          <div className="grid grid-cols-2 gap-4">
            <Skeleton className="h-10 rounded" />
            <Skeleton className="h-10 rounded" />
          </div>
        </div>
      ))}
    </div>
  );
}
```

**Loan Schema:**

```ts
// src/lib/schemas/loan.schema.ts
import { z } from 'zod';

export const loanSchema = z.object({
  // Basic Information
  loanName: z
    .string()
    .min(1, 'Loan name is required')
    .max(255, 'Loan name must be less than 255 characters'),
  
  loanType: z.enum(['personal', 'auto', 'student', 'home_equity', 'business', 'other']),
  
  lender: z
    .string()
    .max(100, 'Lender name must be less than 100 characters')
    .optional()
    .or(z.literal('')),
  
  accountNumber: z
    .string()
    .max(50, 'Account number must be less than 50 characters')
    .optional()
    .or(z.literal('')),

  // Financial Details
  principal: z
    .number()
    .min(1, 'Principal must be greater than 0')
    .max(10000000, 'Principal seems unreasonably high'),
  
  currentBalance: z
    .number()
    .min(0, 'Balance must be positive')
    .max(10000000, 'Balance seems unreasonably high'),
  
  interestRate: z
    .number()
    .min(0, 'Interest rate must be positive')
    .max(100, 'Interest rate cannot exceed 100%'),
  
  termMonths: z
    .number()
    .int()
    .min(1, 'Term must be at least 1 month')
    .max(480, 'Term cannot exceed 480 months'),
  
  monthlyPayment: z
    .number()
    .min(0, 'Monthly payment must be positive')
    .max(1000000, 'Monthly payment seems unreasonably high'),
  
  extraPayment: z
    .number()
    .min(0, 'Extra payment must be positive')
    .max(100000, 'Extra payment seems unreasonably high')
    .optional(),

  // Dates
  startDate: z
    .string()
    .regex(/^\d{4}-\d{2}-\d{2}$/, 'Invalid date format'),
  
  maturityDate: z
    .string()
    .regex(/^\d{4}-\d{2}-\d{2}$/, 'Invalid date format')
    .optional()
    .or(z.literal('')),
  
  firstPaymentDate: z
    .string()
    .regex(/^\d{4}-\d{2}-\d{2}$/, 'Invalid date format')
    .optional()
    .or(z.literal('')),
  
  paymentDay: z
    .number()
    .int()
    .min(1, 'Payment day must be between 1 and 31')
    .max(31, 'Payment day must be between 1 and 31')
    .optional(),
  
  autoPay: z.boolean().optional(),

  // Prepayment
  prepaymentPenalty: z.boolean().optional(),
  
  prepaymentPenaltyAmount: z
    .number()
    .min(0, 'Penalty amount must be positive')
    .optional(),

  // Collateral
  isSecured: z.boolean().optional(),
  
  collateralType: z
    .enum(['vehicle', 'real_estate', 'securities', 'equipment', 'other'])
    .optional()
    .or(z.literal('')),
  
  collateralValue: z
    .number()
    .min(0, 'Collateral value must be positive')
    .optional(),

  // Status
  status: z.enum(['active', 'deferred', 'paid_off', 'defaulted', 'in_forbearance']),

  // Notes
  notes: z
    .string()
    .max(1000, 'Notes must be less than 1000 characters')
    .optional()
    .or(z.literal('')),
}).refine(
  (data) => data.currentBalance <= data.principal,
  {
    message: 'Current balance cannot exceed original principal',
    path: ['currentBalance'],
  }
);

export type LoanFormData = z.infer<typeof loanSchema>;
```

### **5.5 Mortgage Manager** {#5.5-mortgage-manager}

#### **5.5.1 Mortgage List View** {#5.5.1-mortgage-list-view}

**Purpose:** Display mortgages with comprehensive property and loan information

**User Story:** As a user, I want to view my mortgage details including property information, equity, and total housing costs so that I can track my largest investment

**Layout:**

```
┌─────────────────────────────────────────────────────────┐
│  Mortgage Header + Add New Button                      │
├─────────────────────────────────────────────────────────┤
│  Summary Stats (Total Balance, Equity, Monthly Cost)   │
├─────────────────────────────────────────────────────────┤
│  Filters & Sort Controls                               │
├─────────────────────────────────────────────────────────┤
│  ┌───────────────────┐ ┌───────────────────┐           │
│  │  Primary Home     │ │  Rental Property  │           │
│  │  $335,000 balance │ │  $180,000 balance │           │
│  │  $115,000 equity  │ │  $45,000 equity   │           │
│  │  $2,520/mo total  │ │  $1,680/mo total  │           │
│  │  25.6% equity     │ │  20.0% equity     │           │
│  └───────────────────┘ └───────────────────┘           │
└─────────────────────────────────────────────────────────┘
```

**Component Implementation:**

```
// src/pages/MortgagePage.tsx
import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { Plus } from 'lucide-react';
import { useMortgages } from '@/hooks/api/useMortgages';
import { Button } from '@/components/common/Button';
import { MortgageStats } from '@/components/mortgage/MortgageStats';
import { MortgageFilters } from '@/components/mortgage/MortgageFilters';
import { MortgageList } from '@/components/mortgage/MortgageList';
import { EmptyState } from '@/components/common/EmptyState';
import { Skeleton } from '@/components/common/Skeleton';
import type { MortgageFilters as Filters, MortgageSortBy } from '@/types';

export function MortgagePage() {
  const navigate = useNavigate();
  const { data: mortgages, isLoading, error } = useMortgages();

  const [filters, setFilters] = useState<Filters>({
    status: 'all',
    search: '',
  });

  const [sortBy, setSortBy] = useState<MortgageSortBy>('balance_desc');

  if (isLoading) {
    return <MortgagesSkeleton />;
  }

  if (error) {
    return (
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div className="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
          <p className="text-red-800">Failed to load mortgages. Please try again.</p>
        </div>
      </div>
    );
  }

  if (!mortgages || mortgages.length === 0) {
    return (
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <EmptyState
          icon={Plus}
          title="No mortgages yet"
          description="Add your mortgage to track equity, payments, and property value"
          action={{
            label: 'Add Mortgage',
            onClick: () => navigate('/mortgage/new'),
          }}
        />
      </div>
    );
  }

  // Filter mortgages
  let filteredMortgages = mortgages;

  if (filters.status !== 'all') {
    filteredMortgages = filteredMortgages.filter(m => m.status === filters.status);
  }

  if (filters.search) {
    const search = filters.search.toLowerCase();
    filteredMortgages = filteredMortgages.filter(m =>
      m.propertyAddress?.toLowerCase().includes(search) ||
      m.lender?.toLowerCase().includes(search) ||
      m.propertyCity?.toLowerCase().includes(search)
    );
  }

  // Sort mortgages
  const sortedMortgages = [...filteredMortgages].sort((a, b) => {
    switch (sortBy) {
      case 'balance_desc':
        return b.currentBalance - a.currentBalance;
      case 'balance_asc':
        return a.currentBalance - b.currentBalance;
      case 'equity_desc':
        return b.equity - a.equity;
      case 'equity_asc':
        return a.equity - b.equity;
      case 'ltv_desc':
        return b.loanToValue - a.loanToValue;
      case 'ltv_asc':
        return a.loanToValue - b.loanToValue;
      case 'property_asc':
        return (a.propertyAddress || '').localeCompare(b.propertyAddress || '');
      case 'property_desc':
        return (b.propertyAddress || '').localeCompare(a.propertyAddress || '');
      default:
        return 0;
    }
  });

  return (
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {/* Header */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">Mortgage</h1>
          <p className="text-gray-600 mt-1">
            Track your mortgage, property value, and home equity
          </p>
        </div>

        <Button
          variant="primary"
          icon={Plus}
          onClick={() => navigate('/mortgage/new')}
        >
          Add Mortgage
        </Button>
      </div>

      {/* Summary Stats */}
      <MortgageStats mortgages={mortgages} className="mb-8" />

      {/* Filters */}
      <MortgageFilters
        filters={filters}
        sortBy={sortBy}
        onFiltersChange={setFilters}
        onSortChange={setSortBy}
        className="mb-6"
      />

      {/* Mortgage List */}
      {sortedMortgages.length === 0 ? (
        <div className="bg-gray-50 rounded-lg p-8 text-center">
          <p className="text-gray-600">No mortgages match your filters</p>
        </div>
      ) : (
        <MortgageList mortgages={sortedMortgages} />
      )}
    </div>
  );
}

function MortgagesSkeleton() {
  return (
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <Skeleton className="h-12 w-64 mb-8" />
      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
        {[...Array(3)].map((_, i) => (
          <Skeleton key={i} className="h-24 rounded-lg" />
        ))}
      </div>
      <Skeleton className="h-12 w-full mb-6" />
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {[...Array(4)].map((_, i) => (
          <Skeleton key={i} className="h-80 rounded-lg" />
        ))}
      </div>
    </div>
  );
}
```

**Mortgage Stats Component:**

```
// src/components/mortgage/MortgageStats.tsx
import React from 'react';
import { Home, TrendingUp, DollarSign } from 'lucide-react';
import { Card } from '@/components/common/Card';
import { formatCurrency, formatPercentage } from '@/lib/utils/formatters';
import { cn } from '@/lib/utils';
import type { Mortgage } from '@/types';

interface MortgageStatsProps {
  mortgages: Mortgage[];
  className?: string;
}

export function MortgageStats({ mortgages, className }: MortgageStatsProps) {
  const activeMortgages = mortgages.filter(m => m.status === 'active');

  const totalBalance = activeMortgages.reduce((sum, m) => sum + m.currentBalance, 0);
  const totalEquity = activeMortgages.reduce((sum, m) => sum + m.equity, 0);
  const totalMonthlyHousingCost = activeMortgages.reduce(
    (sum, m) => sum + m.totalMonthlyHousingCost,
    0
  );

  const averageLTV = activeMortgages.length > 0
    ? activeMortgages.reduce((sum, m) => sum + m.loanToValue, 0) / activeMortgages.length
    : 0;

  const stats = [
    {
      label: 'Total Balance',
      value: formatCurrency(totalBalance),
      subValue: `${activeMortgages.length} active mortgage${activeMortgages.length !== 1 ? 's' : ''}`,
      icon: Home,
      color: 'blue',
    },
    {
      label: 'Total Equity',
      value: formatCurrency(totalEquity),
      subValue: `${formatPercentage(100 - averageLTV)} average equity`,
      icon: TrendingUp,
      color: 'green',
    },
    {
      label: 'Monthly Housing Cost',
      value: formatCurrency(totalMonthlyHousingCost),
      subValue: 'P&I, taxes, insurance, PMI',
      icon: DollarSign,
      color: 'orange',
    },
  ];

  return (
    <div className={cn('grid grid-cols-1 sm:grid-cols-3 gap-4', className)}>
      {stats.map((stat) => (
        <StatCard key={stat.label} {...stat} />
      ))}
    </div>
  );
}

interface StatCardProps {
  label: string;
  value: string;
  subValue: string;
  icon: React.ElementType;
  color: string;
}

function StatCard({ label, value, subValue, icon: Icon, color }: StatCardProps) {
  const colorClasses = {
    blue: 'bg-blue-100 text-blue-600',
    green: 'bg-green-100 text-green-600',
    orange: 'bg-orange-100 text-orange-600',
  };

  return (
    <Card className="p-6">
      <div className="flex items-start justify-between">
        <div>
          <p className="text-sm text-gray-600 font-medium">{label}</p>
          <p className="text-2xl font-bold text-gray-900 mt-1">{value}</p>
          <p className="text-xs text-gray-500 mt-1">{subValue}</p>
        </div>
        <div className={cn(
          'p-2 rounded-lg',
          colorClasses[color as keyof typeof colorClasses]
        )}>
          <Icon className="h-5 w-5" />
        </div>
      </div>
    </Card>
  );
}
```

**Mortgage Filters Component:**

```
// src/components/mortgage/MortgageFilters.tsx
import React from 'react';
import { Search, SlidersHorizontal } from 'lucide-react';
import { Input } from '@/components/common/Input';
import { Select } from '@/components/common/Select';
import { cn } from '@/lib/utils';
import type { MortgageFilters as Filters, MortgageSortBy } from '@/types';

interface MortgageFiltersProps {
  filters: Filters;
  sortBy: MortgageSortBy;
  onFiltersChange: (filters: Filters) => void;
  onSortChange: (sortBy: MortgageSortBy) => void;
  className?: string;
}

export function MortgageFilters({
  filters,
  sortBy,
  onFiltersChange,
  onSortChange,
  className,
}: MortgageFiltersProps) {
  return (
    <div className={cn('flex flex-col sm:flex-row gap-4', className)}>
      {/* Search */}
      <div className="flex-1">
        <Input
          placeholder="Search by address, city, or lender..."
          icon={Search}
          value={filters.search}
          onChange={(e) => onFiltersChange({ ...filters, search: e.target.value })}
        />
      </div>

      {/* Status Filter */}
      <Select
        value={filters.status}
        onChange={(e) => onFiltersChange({ ...filters, status: e.target.value as any })}
        className="w-full sm:w-40"
      >
        <option value="all">All Status</option>
        <option value="active">Active</option>
        <option value="paid_off">Paid Off</option>
        <option value="foreclosed">Foreclosed</option>
        <option value="in_forbearance">In Forbearance</option>
      </Select>

      {/* Sort */}
      <Select
        value={sortBy}
        onChange={(e) => onSortChange(e.target.value as MortgageSortBy)}
        icon={SlidersHorizontal}
        className="w-full sm:w-56"
      >
        <option value="balance_desc">Highest Balance</option>
        <option value="balance_asc">Lowest Balance</option>
        <option value="equity_desc">Most Equity</option>
        <option value="equity_asc">Least Equity</option>
        <option value="ltv_desc">Highest LTV</option>
        <option value="ltv_asc">Lowest LTV</option>
        <option value="property_asc">Property (A-Z)</option>
        <option value="property_desc">Property (Z-A)</option>
      </Select>
    </div>
  );
}
```

**Mortgage List and Card Components:**

```
// src/components/mortgage/MortgageList.tsx
import React from 'react';
import { MortgageCard } from './MortgageCard';
import type { Mortgage } from '@/types';

interface MortgageListProps {
  mortgages: Mortgage[];
}

export function MortgageList({ mortgages }: MortgageListProps) {
  return (
    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
      {mortgages.map((mortgage) => (
        <MortgageCard key={mortgage.id} mortgage={mortgage} />
      ))}
    </div>
  );
}
```

```
// src/components/mortgage/MortgageCard.tsx
import React, { useState } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import {
  Home,
  MoreVertical,
  Edit,
  Trash2,
  Eye,
  MapPin,
  TrendingUp,
  DollarSign,
  AlertCircle,
} from 'lucide-react';
import { Card } from '@/components/common/Card';
import { Badge } from '@/components/common/Badge';
import { DropdownMenu } from '@/components/common/DropdownMenu';
import { ProgressBar } from '@/components/common/ProgressBar';
import { ConfirmDialog } from '@/components/common/ConfirmDialog';
import { useDeleteMortgage } from '@/hooks/api/useMortgages';
import { formatCurrency, formatPercentage } from '@/lib/utils/formatters';
import { cn } from '@/lib/utils';
import type { Mortgage } from '@/types';

interface MortgageCardProps {
  mortgage: Mortgage;
}

export function MortgageCard({ mortgage }: MortgageCardProps) {
  const navigate = useNavigate();
  const { mutate: deleteMortgage } = useDeleteMortgage();
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);

  const getStatusBadge = () => {
    switch (mortgage.status) {
      case 'active':
        return <Badge variant="success">Active</Badge>;
      case 'paid_off':
        return <Badge variant="info">Paid Off</Badge>;
      case 'foreclosed':
        return <Badge variant="danger">Foreclosed</Badge>;
      case 'in_forbearance':
        return <Badge variant="warning">Forbearance</Badge>;
      default:
        return null;
    }
  };

  const getLTVColor = (ltv: number) => {
    if (ltv <= 80) return 'success';
    if (ltv <= 90) return 'warning';
    return 'danger';
  };

  const handleDelete = () => {
    deleteMortgage(mortgage.id, {
      onSuccess: () => {
        setShowDeleteDialog(false);
      },
    });
  };

  const menuItems = [
    {
      label: 'View Details',
      icon: Eye,
      onClick: () => navigate(`/mortgage/${mortgage.id}`),
    },
    {
      label: 'Edit',
      icon: Edit,
      onClick: () => navigate(`/mortgage/${mortgage.id}/edit`),
    },
    {
      type: 'divider' as const,
    },
    {
      label: 'Delete',
      icon: Trash2,
      onClick: () => setShowDeleteDialog(true),
      variant: 'danger' as const,
    },
  ];

  return (
    <>
      <Card className="overflow-hidden hover:shadow-lg transition-shadow">
        {/* Card Header */}
        <div className="bg-gradient-to-br from-green-500 to-green-600 p-6 text-white">
          <div className="flex items-start justify-between mb-4">
            <div className="flex items-center gap-2">
              <Home className="h-5 w-5" />
              {mortgage.propertyType && (
                <span className="text-xs font-medium opacity-90 capitalize">
                  {mortgage.propertyType.replace('_', ' ')}
                </span>
              )}
            </div>
            <DropdownMenu items={menuItems} trigger={
              <button className="text-white hover:bg-white/20 p-1 rounded transition-colors">
                <MoreVertical className="h-5 w-5" />
              </button>
            } />
          </div>

          <div className="flex items-start gap-2 mb-2">
            <MapPin className="h-4 w-4 mt-0.5 flex-shrink-0" />
            <div className="flex-1 min-w-0">
              <h3 className="text-lg font-bold truncate">
                {mortgage.propertyAddress || 'Property Address'}
              </h3>
              {(mortgage.propertyCity || mortgage.propertyState) && (
                <p className="text-sm opacity-90">
                  {[mortgage.propertyCity, mortgage.propertyState]
                    .filter(Boolean)
                    .join(', ')}
                </p>
              )}
            </div>
          </div>

          {mortgage.lender && (
            <p className="text-xs opacity-75 mt-2">{mortgage.lender}</p>
          )}
        </div>

        {/* Card Body */}
        <div className="p-6">
          {/* Status Badge */}
          <div className="mb-4">
            {getStatusBadge()}
          </div>

          {/* Balance & Property Value */}
          <div className="grid grid-cols-2 gap-4 mb-4">
            <div>
              <p className="text-xs text-gray-600 mb-1">Loan Balance</p>
              <p className="text-xl font-bold text-gray-900">
                {formatCurrency(mortgage.currentBalance)}
              </p>
            </div>
            <div>
              <p className="text-xs text-gray-600 mb-1">Property Value</p>
              <p className="text-xl font-bold text-gray-900">
                {formatCurrency(mortgage.propertyValue || 0)}
              </p>
            </div>
          </div>

          {/* Equity */}
          <div className="mb-4 p-3 bg-green-50 rounded-lg">
            <div className="flex items-center justify-between mb-2">
              <span className="text-sm font-medium text-green-900">Home Equity</span>
              <TrendingUp className="h-4 w-4 text-green-600" />
            </div>
            <p className="text-2xl font-bold text-green-900">
              {formatCurrency(mortgage.equity)}
            </p>
            <p className="text-xs text-green-700 mt-1">
              {formatPercentage(mortgage.equityPercentage)} of property value
            </p>
          </div>

          {/* LTV */}
          <div className="mb-4">
            <div className="flex items-center justify-between text-sm mb-2">
              <span className="text-gray-600">Loan-to-Value (LTV)</span>
              <span className="font-semibold text-gray-900">
                {formatPercentage(mortgage.loanToValue)}
              </span>
            </div>
            <ProgressBar
              value={mortgage.loanToValue}
              max={100}
              variant={getLTVColor(mortgage.loanToValue)}
            />
          </div>

          {/* PMI Warning */}
          {mortgage.pmi > 0 && mortgage.loanToValue > mortgage.pmiRemovalLtv && (
            <div className="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg flex items-start gap-2">
              <AlertCircle className="h-4 w-4 text-yellow-600 flex-shrink-0 mt-0.5" />
              <div className="flex-1 min-w-0">
                <p className="text-xs font-medium text-yellow-900">PMI Active</p>
                <p className="text-xs text-yellow-700 mt-1">
                  Pay down to {formatPercentage(mortgage.pmiRemovalLtv)} LTV to remove
                </p>
              </div>
            </div>
          )}

          {/* Monthly Costs */}
          <div className="grid grid-cols-2 gap-4 pt-4 border-t border-gray-200">
            <div>
              <p className="text-xs text-gray-600 mb-1">P&I Payment</p>
              <p className="text-sm font-semibold text-gray-900">
                {formatCurrency(mortgage.monthlyPayment)}
              </p>
            </div>
            <div>
              <p className="text-xs text-gray-600 mb-1">Total Monthly</p>
              <p className="text-sm font-semibold text-gray-900">
                {formatCurrency(mortgage.totalMonthlyHousingCost)}
              </p>
            </div>
          </div>

          {/* Interest Rate */}
          <div className="mt-4 pt-4 border-t border-gray-200">
            <div className="flex items-center justify-between text-sm">
              <span className="text-gray-600">Interest Rate</span>
              <span className="font-semibold text-gray-900">
                {formatPercentage(mortgage.interestRate)}
              </span>
            </div>
          </div>

          {/* Extra Payment */}
          {mortgage.extraPayment > 0 && (
            <div className="mt-4 p-3 bg-blue-50 rounded-lg">
              <p className="text-xs text-blue-700 mb-1">Extra Monthly Payment</p>
              <p className="text-sm font-semibold text-blue-900">
                +{formatCurrency(mortgage.extraPayment)}
              </p>
            </div>
          )}

          {/* View Details Link */}
          <Link
            to={`/mortgage/${mortgage.id}`}
            className="block mt-4 text-center text-sm text-blue-600 hover:text-blue-700 font-medium"
          >
            View Details →
          </Link>
        </div>
      </Card>

      {/* Delete Confirmation Dialog */}
      <ConfirmDialog
        isOpen={showDeleteDialog}
        onClose={() => setShowDeleteDialog(false)}
        onConfirm={handleDelete}
        title="Delete Mortgage"
        description={`Are you sure you want to delete the mortgage for "${mortgage.propertyAddress}"? This action cannot be undone.`}
        confirmLabel="Delete"
        variant="danger"
      />
    </>
  );
}
```

**Type Definitions:**

```ts
// Add to src/types/index.ts

export interface MortgageFilters {
  status: 'all' | 'active' | 'paid_off' | 'foreclosed' | 'in_forbearance';
  search: string;
}

export type MortgageSortBy = 
  | 'balance_desc'
  | 'balance_asc'
  | 'equity_desc'
  | 'equity_asc'
  | 'ltv_desc'
  | 'ltv_asc'
  | 'property_asc'
  | 'property_desc';
```

#### **5.5.2 Mortgage Detail View** {#5.5.2-mortgage-detail-view}

```
// src/pages/MortgageDetailPage.tsx
import React, { useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import {
  ArrowLeft,
  Edit,
  Trash2,
  Home,
  DollarSign,
  TrendingDown,
  Calendar,
  MapPin,
  AlertCircle,
  TrendingUp,
} from 'lucide-react';
import { useMortgage, useDeleteMortgage } from '@/hooks/api/useMortgages';
import { Button } from '@/components/common/Button';
import { Card } from '@/components/common/Card';
import { Badge } from '@/components/common/Badge';
import { ProgressBar } from '@/components/common/ProgressBar';
import { ConfirmDialog } from '@/components/common/ConfirmDialog';
import { Alert } from '@/components/common/Alert';
import { RefinanceCalculator } from '@/components/mortgage/RefinanceCalculator';
import { PaymentHistory } from '@/components/mortgage/MortgagePaymentHistory';
import { formatCurrency, formatPercentage, formatDate } from '@/lib/utils/formatters';
import { Skeleton } from '@/components/common/Skeleton';

export function MortgageDetailPage() {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const { data: mortgage, isLoading, error } = useMortgage(id!);
  const { mutate: deleteMortgage } = useDeleteMortgage();
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);

  if (isLoading) {
    return <DetailSkeleton />;
  }

  if (error || !mortgage) {
    return (
      <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div className="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
          <p className="text-red-800">Mortgage not found</p>
          <Button
            variant="outline"
            className="mt-4"
            onClick={() => navigate('/mortgage')}
          >
            Back to Mortgages
          </Button>
        </div>
      </div>
    );
  }

  const handleDelete = () => {
    deleteMortgage(mortgage.id, {
      onSuccess: () => {
        navigate('/mortgage');
      },
    });
  };

  const propertyName = mortgage.propertyAddress || 'Property';

  return (
    <>
      <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Header */}
        <div className="flex items-center gap-4 mb-8">
          <Button
            variant="ghost"
            icon={ArrowLeft}
            onClick={() => navigate('/mortgage')}
          >
            Back
          </Button>

          <div className="flex-1">
            <h1 className="text-3xl font-bold text-gray-900">
              {propertyName}
            </h1>
            {(mortgage.propertyCity || mortgage.propertyState) && (
              <p className="text-gray-600 mt-1 flex items-center gap-1">
                <MapPin className="h-4 w-4" />
                {[mortgage.propertyCity, mortgage.propertyState]
                  .filter(Boolean)
                  .join(', ')}
              </p>
            )}
          </div>

          <div className="flex gap-2">
            <Button
              variant="outline"
              icon={Edit}
              onClick={() => navigate(`/mortgage/${mortgage.id}/edit`)}
            >
              Edit
            </Button>
            <Button
              variant="outline"
              icon={Trash2}
              onClick={() => setShowDeleteDialog(true)}
            >
              Delete
            </Button>
          </div>
        </div>

        {/* Alerts */}
        {mortgage.status === 'in_forbearance' && (
          <Alert variant="warning" className="mb-6">
            <AlertCircle className="h-4 w-4" />
            <span>This mortgage is in forbearance. Contact your lender for details.</span>
          </Alert>
        )}

        {mortgage.pmi > 0 && mortgage.loanToValue <= mortgage.pmiRemovalLtv && (
          <Alert variant="success" className="mb-6">
            <TrendingUp className="h-4 w-4" />
            <span>
              You've reached {formatPercentage(mortgage.pmiRemovalLtv)} LTV! Contact your lender to remove PMI ({formatCurrency(mortgage.pmi)}/month savings).
            </span>
          </Alert>
        )}

        {/* Overview Card */}
        <Card className="p-6 mb-6">
          <div className="flex items-start justify-between mb-6">
            <div>
              <h2 className="text-lg font-semibold text-gray-900">Overview</h2>
              <div className="flex items-center gap-2 mt-2">
                <Badge variant={mortgage.status === 'active' ? 'success' : 'secondary'}>
                  {mortgage.status.replace('_', ' ')}
                </Badge>
                {mortgage.isRefinanced && (
                  <Badge variant="info">Refinanced</Badge>
                )}
                {mortgage.hasEscrow && (
                  <Badge variant="secondary">Escrow</Badge>
                )}
              </div>
            </div>

            <div className="text-right">
              <p className="text-sm text-gray-600">Loan Type</p>
              <p className="text-lg font-semibold text-gray-900 uppercase">
                {mortgage.loanType || 'Conventional'}
              </p>
            </div>
          </div>

          {/* Key Metrics Grid */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div>
              <p className="text-sm text-gray-600 mb-2">Loan Balance</p>
              <p className="text-3xl font-bold text-gray-900">
                {formatCurrency(mortgage.currentBalance)}
              </p>
              <p className="text-sm text-gray-600 mt-1">
                of {formatCurrency(mortgage.loanAmount)} original
              </p>
            </div>

            <div>
              <p className="text-sm text-gray-600 mb-2">Property Value</p>
              <p className="text-3xl font-bold text-gray-900">
                {formatCurrency(mortgage.propertyValue || 0)}
              </p>
              <p className="text-sm text-gray-600 mt-1">
                Current market value
              </p>
            </div>

            <div>
              <p className="text-sm text-gray-600 mb-2">Home Equity</p>
              <p className="text-3xl font-bold text-green-600">
                {formatCurrency(mortgage.equity)}
              </p>
              <p className="text-sm text-gray-600 mt-1">
                {formatPercentage(mortgage.equityPercentage)} of value
              </p>
            </div>
          </div>

          {/* LTV Progress */}
          <div className="mb-6">
            <div className="flex items-center justify-between text-sm mb-2">
              <span className="text-gray-600">Loan-to-Value Ratio</span>
              <span className="font-semibold text-gray-900">
                {formatPercentage(mortgage.loanToValue)}
              </span>
            </div>
            <ProgressBar
              value={mortgage.loanToValue}
              max={100}
              variant={
                mortgage.loanToValue <= 80 ? 'success' :
                mortgage.loanToValue <= 90 ? 'warning' : 'danger'
              }
            />
          </div>

          {/* Principal Paid */}
          <div className="p-4 bg-blue-50 rounded-lg">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-blue-900">
                  Principal Paid
                </p>
                <p className="text-xs text-blue-700 mt-1">
                  Since loan origination
                </p>
              </div>
              <p className="text-2xl font-bold text-blue-900">
                {formatCurrency(mortgage.principalPaid)}
              </p>
            </div>
          </div>
        </Card>

        {/* Monthly Housing Costs */}
        <Card className="p-6 mb-6">
          <h2 className="text-lg font-semibold text-gray-900 mb-4">
            Monthly Housing Costs
          </h2>

          <div className="space-y-3">
            <CostRow
              label="Principal & Interest"
              amount={mortgage.monthlyPayment}
              isPrimary
            />
            <CostRow
              label="Property Tax"
              amount={mortgage.propertyTax / 12}
            />
            <CostRow
              label="Homeowners Insurance"
              amount={mortgage.homeownersInsurance / 12}
            />
            {mortgage.hoaFees > 0 && (
              <CostRow
                label="HOA Fees"
                amount={mortgage.hoaFees / 12}
              />
            )}
            {mortgage.pmi > 0 && (
              <CostRow
                label="PMI/MIP"
                amount={mortgage.pmi}
                highlight="warning"
              />
            )}
            {mortgage.extraPayment > 0 && (
              <CostRow
                label="Extra Principal Payment"
                amount={mortgage.extraPayment}
                highlight="success"
              />
            )}

            <div className="pt-3 border-t-2 border-gray-200">
              <CostRow
                label="Total Monthly Housing Cost"
                amount={mortgage.totalMonthlyHousingCost}
                isPrimary
                isTotal
              />
            </div>
          </div>

          {/* Annual breakdown */}
          <div className="mt-6 pt-6 border-t border-gray-200">
            <p className="text-sm font-medium text-gray-900 mb-3">Annual Breakdown</p>
            <div className="grid grid-cols-2 gap-4 text-sm">
              <div>
                <p className="text-gray-600">Property Tax</p>
                <p className="font-semibold text-gray-900">
                  {formatCurrency(mortgage.propertyTax)}
                </p>
              </div>
              <div>
                <p className="text-gray-600">Insurance</p>
                <p className="font-semibold text-gray-900">
                  {formatCurrency(mortgage.homeownersInsurance)}
                </p>
              </div>
              {mortgage.hoaFees > 0 && (
                <div>
                  <p className="text-gray-600">HOA Fees</p>
                  <p className="font-semibold text-gray-900">
                    {formatCurrency(mortgage.hoaFees)}
                  </p>
                </div>
              )}
              {mortgage.pmi > 0 && (
                <div>
                  <p className="text-gray-600">PMI</p>
                  <p className="font-semibold text-gray-900">
                    {formatCurrency(mortgage.pmi * 12)}
                  </p>
                </div>
              )}
            </div>
          </div>
        </Card>

        {/* Loan Details */}
        <Card className="p-6 mb-6">
          <h2 className="text-lg font-semibold text-gray-900 mb-4">
            Loan Details
          </h2>

          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <DetailItem
              icon={TrendingDown}
              label="Interest Rate"
              value={formatPercentage(mortgage.interestRate)}
            />
            <DetailItem
              icon={Calendar}
              label="Loan Term"
              value={`${mortgage.termYears} years`}
            />
            <DetailItem
              icon={DollarSign}
              label="P&I Payment"
              value={formatCurrency(mortgage.monthlyPayment)}
            />
            {mortgage.startDate && (
              <DetailItem
                icon={Calendar}
                label="Start Date"
                value={formatDate(mortgage.startDate, 'MMM yyyy')}
              />
            )}
          </div>

          {mortgage.isRefinanced && (
            <div className="p-4 bg-blue-50 rounded-lg">
              <h3 className="text-sm font-semibold text-blue-900 mb-2">
                Refinance Information
              </h3>
              <div className="grid grid-cols-2 gap-4 text-sm">
                {mortgage.originalLoanDate && (
                  <div>
                    <p className="text-blue-700">Original Loan Date</p>
                    <p className="font-medium text-blue-900">
                      {formatDate(mortgage.originalLoanDate, 'MMM d, yyyy')}
                    </p>
                  </div>
                )}
                {mortgage.refinanceDate && (
                  <div>
                    <p className="text-blue-700">Refinance Date</p>
                    <p className="font-medium text-blue-900">
                      {formatDate(mortgage.refinanceDate, 'MMM d, yyyy')}
                    </p>
                  </div>
                )}
              </div>
              {mortgage.refinanceReason && (
                <p className="text-sm text-blue-800 mt-3">
                  {mortgage.refinanceReason}
                </p>
              )}
            </div>
          )}
        </Card>

        {/* Refinance Calculator */}
        <RefinanceCalculator mortgage={mortgage} className="mb-6" />

        {/* Payment History */}
        <PaymentHistory mortgageId={mortgage.id} />

        {/* Additional Details */}
        <Card className="p-6 mt-6">
          <h2 className="text-lg font-semibold text-gray-900 mb-4">
            Additional Details
          </h2>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {mortgage.lender && (
              <DetailRow label="Lender" value={mortgage.lender} />
            )}
            {mortgage.loanNumber && (
              <DetailRow label="Loan Number" value={mortgage.loanNumber} />
            )}
            {mortgage.propertyType && (
              <DetailRow
                label="Property Type"
                value={mortgage.propertyType.replace('_', ' ')}
              />
            )}
            {mortgage.propertyZip && (
              <DetailRow label="ZIP Code" value={mortgage.propertyZip} />
            )}
            {mortgage.escrowBalance && (
              <DetailRow
                label="Escrow Balance"
                value={formatCurrency(mortgage.escrowBalance)}
              />
            )}
            <DetailRow
              label="Created"
              value={formatDate(mortgage.createdAt, 'MMM d, yyyy')}
            />
            <DetailRow
              label="Last Updated"
              value={formatDate(mortgage.updatedAt, 'MMM d, yyyy')}
            />
          </div>

          {mortgage.notes && (
            <div className="mt-6 pt-6 border-t border-gray-200">
              <p className="text-sm font-medium text-gray-900 mb-2">Notes</p>
              <p className="text-sm text-gray-600 whitespace-pre-wrap">
                {mortgage.notes}
              </p>
            </div>
          )}
        </Card>
      </div>

      {/* Delete Dialog */}
      <ConfirmDialog
        isOpen={showDeleteDialog}
        onClose={() => setShowDeleteDialog(false)}
        onConfirm={handleDelete}
        title="Delete Mortgage"
        description={`Are you sure you want to delete the mortgage for "${propertyName}"? This action cannot be undone.`}
        confirmLabel="Delete"
        variant="danger"
      />
    </>
  );
}

interface CostRowProps {
  label: string;
  amount: number;
  isPrimary?: boolean;
  isTotal?: boolean;
  highlight?: 'success' | 'warning';
}

function CostRow({ label, amount, isPrimary, isTotal, highlight }: CostRowProps) {
  return (
    <div className={cn(
      'flex items-center justify-between py-2',
      isTotal && 'font-semibold'
    )}>
      <span className={cn(
        'text-sm',
        isPrimary ? 'font-medium text-gray-900' : 'text-gray-600'
      )}>
        {label}
      </span>
      <span className={cn(
        'text-sm font-semibold',
        highlight === 'success' && 'text-green-600',
        highlight === 'warning' && 'text-orange-600',
        !highlight && 'text-gray-900'
      )}>
        {formatCurrency(amount)}
      </span>
    </div>
  );
}

interface DetailItemProps {
  icon: React.ElementType;
  label: string;
  value: string;
}

function DetailItem({ icon: Icon, label, value }: DetailItemProps) {
  return (
    <div>
      <div className="flex items-center gap-2 text-gray-600 mb-1">
        <Icon className="h-4 w-4" />
        <p className="text-xs font-medium">{label}</p>
      </div>
      <p className="text-sm font-semibold text-gray-900 capitalize">{value}</p>
    </div>
  );
}

interface DetailRowProps {
  label: string;
  value: string;
}

function DetailRow({ label, value }: DetailRowProps) {
  return (
    <div className="flex items-center justify-between py-2">
      <p className="text-sm text-gray-600">{label}</p>
      <p className="text-sm font-medium text-gray-900 capitalize">{value}</p>
    </div>
  );
}

function DetailSkeleton() {
  return (
    <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <Skeleton className="h-12 w-64 mb-8" />
      <Skeleton className="h-64 rounded-lg mb-6" />
      <Skeleton className="h-48 rounded-lg mb-6" />
      <Skeleton className="h-96 rounded-lg mb-6" />
      <Skeleton className="h-48 rounded-lg" />
    </div>
  );
}
```

**Refinance Calculator Component:**

```
// src/components/mortgage/RefinanceCalculator.tsx
import React, { useState, useMemo } from 'react';
import {
  Calculator,
  TrendingDown,
  DollarSign,
  Calendar,
  AlertCircle,
} from 'lucide-react';
import { Card } from '@/components/common/Card';
import { PercentageInput } from '@/components/common/PercentageInput';
import { CurrencyInput } from '@/components/common/CurrencyInput';
import { Input } from '@/components/common/Input';
import { Alert } from '@/components/common/Alert';
import { calculateLoanPayment } from '@/lib/calculations/loans';
import { formatCurrency, formatPercentage } from '@/lib/utils/formatters';
import { cn } from '@/lib/utils';
import type { Mortgage } from '@/types';

interface RefinanceCalculatorProps {
  mortgage: Mortgage;
  className?: string;
}

export function RefinanceCalculator({ mortgage, className }: RefinanceCalculatorProps) {
  const [newRate, setNewRate] = useState(mortgage.interestRate - 0.5);
  const [newTermYears, setNewTermYears] = useState(mortgage.termYears);
  const [closingCosts, setClosingCosts] = useState(3000);

  const analysis = useMemo(() => {
    // Current loan calculations
    const currentMonthlyPI = mortgage.monthlyPayment;
    const currentRemainingMonths = mortgage.remainingMonths || 0;
    const currentTotalPayments = currentMonthlyPI * currentRemainingMonths;
    
    // New loan calculations
    const newMonthlyPI = calculateLoanPayment(
      mortgage.currentBalance,
      newRate,
      newTermYears * 12
    );
    const newTotalMonths = newTermYears * 12;
    const newTotalPayments = newMonthlyPI * newTotalMonths;

    // Savings calculations
    const monthlySavings = currentMonthlyPI - newMonthlyPI;
    const lifetimeSavings = currentTotalPayments - newTotalPayments - closingCosts;
    const breakEvenMonths = monthlySavings > 0 ? Math.ceil(closingCosts / monthlySavings) : 0;

    // Total interest comparison
    const currentTotalInterest = currentTotalPayments - mortgage.currentBalance;
    const newTotalInterest = newTotalPayments - mortgage.currentBalance;
    const interestSavings = currentTotalInterest - newTotalInterest;

    return {
      currentMonthlyPI,
      currentTotalPayments,
      currentTotalInterest,
      newMonthlyPI,
      newTotalPayments,
      newTotalInterest,
      monthlySavings,
      lifetimeSavings,
      interestSavings,
      breakEvenMonths,
      isWorthwhile: lifetimeSavings > 0 && breakEvenMonths > 0 && breakEvenMonths < 60,
    };
  }, [mortgage, newRate, newTermYears, closingCosts]);

  return (
    <Card className={cn('p-6', className)}>
      {/* Header */}
      <div className="flex items-center gap-3 mb-6">
        <div className="p-2 bg-purple-100 rounded-lg">
          <Calculator className="h-5 w-5 text-purple-600" />
        </div>
        <div>
          <h2 className="text-lg font-semibold text-gray-900">
            Refinance Calculator
          </h2>
          <p className="text-sm text-gray-600">
            Explore refinancing options and potential savings
          </p>
        </div>
      </div>

      {/* Input Fields */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <PercentageInput
          label="New Interest Rate"
          value={newRate}
          onChange={(e) => setNewRate(Number(e.target.value) || 0)}
          max={100}
          step={0.125}
        />
        
        <Input
          type="number"
          label="New Loan Term (Years)"
          value={newTermYears}
          onChange={(e) => setNewTermYears(Number(e.target.value) || 0)}
          min={1}
          max={30}
        />

        <CurrencyInput
          label="Estimated Closing Costs"
          value={closingCosts}
          onChange={(e) => setClosingCosts(Number(e.target.value) || 0)}
        />
      </div>

      {/* Analysis Results */}
      <div className="space-y-4">
        {/* Monthly Payment Comparison */}
        <div className="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg">
          <div>
            <p className="text-xs text-gray-600 mb-1">Current P&I Payment</p>
            <p className="text-xl font-bold text-gray-900">
              {formatCurrency(analysis.currentMonthlyPI)}
            </p>
          </div>
          <div>
            <p className="text-xs text-gray-600 mb-1">New P&I Payment</p>
            <p className="text-xl font-bold text-gray-900">
              {formatCurrency(analysis.newMonthlyPI)}
            </p>
          </div>
        </div>

        {/* Monthly Savings */}
        <div className={cn(
          'p-4 rounded-lg',
          analysis.monthlySavings > 0 ? 'bg-green-50' : 'bg-red-50'
        )}>
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-gray-900">
                Monthly Savings
              </p>
              <p className="text-xs text-gray-600 mt-1">
                {analysis.monthlySavings > 0 ? 'Save' : 'Increase'} in monthly payment
              </p>
            </div>
            <div className="text-right">
              <p className={cn(
                'text-2xl font-bold',
                analysis.monthlySavings > 0 ? 'text-green-600' : 'text-red-600'
              )}>
                {analysis.monthlySavings > 0 ? '+' : ''}
                {formatCurrency(Math.abs(analysis.monthlySavings))}
              </p>
            </div>
          </div>
        </div>

        {/* Break Even Analysis */}
        {analysis.monthlySavings > 0 && (
          <div className="p-4 bg-blue-50 rounded-lg">
            <div className="flex items-center gap-3 mb-3">
              <Calendar className="h-5 w-5 text-blue-600" />
              <h3 className="text-sm font-semibold text-blue-900">
                Break-Even Analysis
              </h3>
            </div>
            <div className="grid grid-cols-3 gap-4">
              <div>
                <p className="text-xs text-blue-700 mb-1">Closing Costs</p>
                <p className="text-lg font-bold text-blue-900">
                  {formatCurrency(closingCosts)}
                </p>
              </div>
              <div>
                <p className="text-xs text-blue-700 mb-1">Break-Even</p>
                <p className="text-lg font-bold text-blue-900">
                  {analysis.breakEvenMonths} months
                </p>
              </div>
              <div>
                <p className="text-xs text-blue-700 mb-1">Years</p>
                <p className="text-lg font-bold text-blue-900">
                  {(analysis.breakEvenMonths / 12).toFixed(1)} years
                </p>
              </div>
            </div>
          </div>
        )}

        {/* Total Cost Comparison */}
        <div className="space-y-3">
          <h3 className="text-sm font-semibold text-gray-900">
            Total Cost Over Life of Loan
          </h3>
          
          <ComparisonRow
            label="Total Payments"
            current={analysis.currentTotalPayments}
            new={analysis.newTotalPayments}
          />
          
          <ComparisonRow
            label="Total Interest"
            current={analysis.currentTotalInterest}
            new={analysis.newTotalInterest}
          />
          
          <ComparisonRow
            label="With Closing Costs"
            current={analysis.currentTotalPayments}
            new={analysis.newTotalPayments + closingCosts}
            isTotal
          />
        </div>

        {/* Lifetime Savings */}
        <div className={cn(
          'p-4 rounded-lg border-2',
          analysis.lifetimeSavings > 0 ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'
        )}>
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-semibold text-gray-900">
                Lifetime Savings (After Closing Costs)
              </p>
              <p className="text-xs text-gray-600 mt-1">
                Total savings over life of loan
              </p>
            </div>
            <div className="text-right">
              <p className={cn(
                'text-3xl font-bold',
                analysis.lifetimeSavings > 0 ? 'text-green-600' : 'text-red-600'
              )}>
                {analysis.lifetimeSavings > 0 ? '+' : ''}
                {formatCurrency(Math.abs(analysis.lifetimeSavings))}
              </p>
            </div>
          </div>
        </div>

        {/* Recommendation */}
        {analysis.isWorthwhile ? (
          <Alert variant="success">
            <DollarSign className="h-4 w-4" />
            <div>
              <p className="font-semibold">Refinancing may be worthwhile!</p>
              <p className="text-sm mt-1">
                You'll break even in {analysis.breakEvenMonths} months and save{' '}
                {formatCurrency(analysis.lifetimeSavings)} over the life of the loan.
              </p>
            </div>
          </Alert>
        ) : analysis.monthlySavings <= 0 ? (
          <Alert variant="warning">
            <AlertCircle className="h-4 w-4" />
            <div>
              <p className="font-semibold">Consider carefully</p>
              <p className="text-sm mt-1">
                This refinance would increase your monthly payment. Make sure the
                benefits justify the higher cost.
              </p>
            </div>
          </Alert>
        ) : (
          <Alert variant="warning">
            <AlertCircle className="h-4 w-4" />
            <div>
              <p className="font-semibold">Long break-even period</p>
              <p className="text-sm mt-1">
                It would take {analysis.breakEvenMonths} months ({(analysis.breakEvenMonths / 12).toFixed(1)} years)
                to recover your closing costs. Consider how long you plan to stay in the home.
              </p>
            </div>
          </Alert>
        )}

        {/* Disclaimer */}
        <p className="text-xs text-gray-500 mt-4">
          * This is a simplified calculation for estimation purposes only. Actual refinance
          terms and savings may vary. Consult with a mortgage professional for accurate
          quotes and personalized advice.
        </p>
      </div>
    </Card>
  );
}

interface ComparisonRowProps {
  label: string;
  current: number;
  new: number;
  isTotal?: boolean;
}

function ComparisonRow({ label, current, new: newValue, isTotal }: ComparisonRowProps) {
  const difference = current - newValue;
  
  return (
    <div className={cn(
      'flex items-center justify-between py-2',
      isTotal && 'pt-3 border-t-2 border-gray-200'
    )}>
      <span className={cn(
        'text-sm',
        isTotal ? 'font-semibold text-gray-900' : 'text-gray-600'
      )}>
        {label}
      </span>
      <div className="flex items-center gap-4">
        <span className="text-sm text-gray-600 line-through">
          {formatCurrency(current)}
        </span>
        <span className="text-sm font-semibold text-gray-900">
          {formatCurrency(newValue)}
        </span>
        {difference !== 0 && (
          <span className={cn(
            'text-xs font-medium',
            difference > 0 ? 'text-green-600' : 'text-red-600'
          )}>
            {difference > 0 ? '↓' : '↑'} {formatCurrency(Math.abs(difference))}
          </span>
        )}
      </div>
    </div>
  );
}
```

**Mortgage Payment History Component:**

```
// src/components/mortgage/MortgagePaymentHistory.tsx
import React, { useState } from 'react';
import { 
  History, 
  Calendar,
  Download,
  Filter,
  CheckCircle,
} from 'lucide-react';
import { Card } from '@/components/common/Card';
import { Button } from '@/components/common/Button';
import { Badge } from '@/components/common/Badge';
import { Select } from '@/components/common/Select';
import { EmptyState } from '@/components/common/EmptyState';
import { usePaymentHistory } from '@/hooks/api/usePayments';
import { formatCurrency, formatDate } from '@/lib/utils/formatters';

interface MortgagePaymentHistoryProps {
  mortgageId: string;
  className?: string;
}

export function MortgagePaymentHistory({ mortgageId, className }: MortgagePaymentHistoryProps) {
  const [timeRange, setTimeRange] = useState<'30d' | '90d' | '1y' | 'all'>('1y');
  const { data: payments, isLoading } = usePaymentHistory(mortgageId, timeRange, 'mortgage');

  const handleExport = () => {
    if (!payments) return;

    const headers = ['Date', 'Amount', 'Method', 'Confirmation'];
    const rows = payments.map(p => [
      formatDate(p.paymentDate, 'yyyy-MM-dd'),
      p.amount.toString(),
      p.paymentMethod || '',
      p.confirmationNumber || '',
    ]);

    const csv = [
      headers.join(','),
      ...rows.map(row => row.join(','))
    ].join('\n');

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `mortgage-payment-history-${formatDate(new Date(), 'yyyy-MM-dd')}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
  };

  if (isLoading) {
    return (
      <Card className="p-6">
        <div className="animate-pulse space-y-4">
          {[...Array(5)].map((_, i) => (
            <div key={i} className="h-16 bg-gray-200 rounded" />
          ))}
        </div>
      </Card>
    );
  }

  const totalPaid = payments?.reduce((sum, p) => sum + p.amount, 0) || 0;

  return (
    <Card className="p-6">
      {/* Header */}
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-3">
          <div className="p-2 bg-purple-100 rounded-lg">
            <History className="h-5 w-5 text-purple-600" />
          </div>
          <div>
            <h2 className="text-lg font-semibold text-gray-900">
              Payment History
            </h2>
            {payments && payments.length > 0 && (
              <p className="text-sm text-gray-600">
                {payments.length} payment{payments.length !== 1 ? 's' : ''} • {formatCurrency(totalPaid)} total
              </p>
            )}
          </div>
        </div>

        <div className="flex items-center gap-2">
          <Select
            value={timeRange}
            onChange={(e) => setTimeRange(e.target.value as any)}
            icon={Filter}
            className="w-32"
          >
            <option value="30d">Last 30 days</option>
            <option value="90d">Last 90 days</option>
            <option value="1y">Last year</option>
            <option value="all">All time</option>
          </Select>

          {payments && payments.length > 0 && (
            <Button
              variant="outline"
              size="sm"
              icon={Download}
              onClick={handleExport}
            >
              Export
            </Button>
          )}
        </div>
      </div>

      {/* Payment List */}
      {!payments || payments.length === 0 ? (
        <EmptyState
          icon={History}
          title="No payment history"
          description="Payments you make will appear here"
        />
      ) : (
        <div className="space-y-3">
          {payments.map((payment) => (
            <PaymentItem key={payment.id} payment={payment} />
          ))}
        </div>
      )}
    </Card>
  );
}

interface PaymentItemProps {
  payment: any;
}

function PaymentItem({ payment }: PaymentItemProps) {
  return (
    <div className="flex items-center gap-4 p-4 hover:bg-gray-50 rounded-lg transition-colors">
      {/* Icon */}
      <div className="flex-shrink-0 w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
        <CheckCircle className="h-5 w-5 text-green-600" />
      </div>

      {/* Content */}
      <div className="flex-1 min-w-0">
        <div className="flex items-center gap-2 mb-1">
          <p className="text-sm font-medium text-gray-900">
            Payment Processed
          </p>
          {payment.paymentMethod && (
            <Badge variant="secondary" size="sm">
              {payment.paymentMethod}
            </Badge>
          )}
        </div>
        <div className="flex items-center gap-4 text-xs text-gray-600">
          <span className="flex items-center gap-1">
            <Calendar className="h-3 w-3" />
            {formatDate(payment.paymentDate, 'MMM d, yyyy')}
          </span>
          {payment.confirmationNumber && (
            <span>Conf: {payment.confirmationNumber}</span>
          )}
        </div>
      </div>

      {/* Amount */}
      <div className="text-right">
        <p className="text-lg font-semibold text-green-600">
          {formatCurrency(payment.amount)}
        </p>
      </div>
    </div>
  );
}
```

#### **5.5.3 Mortgage Form (Add/Edit)** {#5.5.3-mortgage-form-(add/edit)}

```
// src/pages/MortgageFormPage.tsx
import React, { useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useForm, Controller } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { ArrowLeft, Save, Loader2 } from 'lucide-react';
import {
  useMortgage,
  useCreateMortgage,
  useUpdateMortgage,
} from '@/hooks/api/useMortgages';
import { mortgageSchema, type MortgageFormData } from '@/lib/schemas/mortgage.schema';
import { Button } from '@/components/common/Button';
import { Card } from '@/components/common/Card';
import { Input } from '@/components/common/Input';
import { Select } from '@/components/common/Select';
import { Textarea } from '@/components/common/Textarea';
import { Checkbox } from '@/components/common/Checkbox';
import { CurrencyInput } from '@/components/common/CurrencyInput';
import { PercentageInput } from '@/components/common/PercentageInput';
import { FormSection } from '@/components/common/FormSection';
import { Skeleton } from '@/components/common/Skeleton';

export function MortgageFormPage() {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const isEditMode = Boolean(id);

  const { data: mortgage, isLoading } = useMortgage(id!, { enabled: isEditMode });
  const createMutation = useCreateMortgage();
  const updateMutation = useUpdateMortgage();

  const {
    register,
    control,
    handleSubmit,
    watch,
    setValue,
    formState: { errors, isSubmitting },
  } = useForm<MortgageFormData>({
    resolver: zodResolver(mortgageSchema),
    defaultValues: {
      status: 'active',
      hasEscrow: false,
      isRefinanced: false,
      extraPayment: 0,
      propertyTax: 0,
      homeownersInsurance: 0,
      hoaFees: 0,
      pmi: 0,
      pmiRemovalLtv: 80,
    },
  });

  // Populate form when editing
  useEffect(() => {
    if (mortgage && isEditMode) {
      setValue('propertyAddress', mortgage.propertyAddress || '');
      setValue('propertyCity', mortgage.propertyCity || '');
      setValue('propertyState', mortgage.propertyState || '');
      setValue('propertyZip', mortgage.propertyZip || '');
      setValue('propertyType', mortgage.propertyType || '');
      setValue('propertyValue', mortgage.propertyValue || 0);
      setValue('lender', mortgage.lender || '');
      setValue('loanNumber', mortgage.loanNumber || '');
      setValue('loanType', mortgage.loanType || '');
      setValue('loanAmount', mortgage.loanAmount);
      setValue('currentBalance', mortgage.currentBalance);
      setValue('interestRate', mortgage.interestRate);
      setValue('termYears', mortgage.termYears);
      setValue('monthlyPayment', mortgage.monthlyPayment);
      setValue('extraPayment', mortgage.extraPayment);
      setValue('startDate', mortgage.startDate || '');
      setValue('propertyTax', mortgage.propertyTax);
      setValue('homeownersInsurance', mortgage.homeownersInsurance);
      setValue('hoaFees', mortgage.hoaFees || 0);
      setValue('pmi', mortgage.pmi || 0);
      setValue('pmiRemovalLtv', mortgage.pmiRemovalLtv);
      setValue('hasEscrow', mortgage.hasEscrow);
      setValue('escrowBalance', mortgage.escrowBalance || undefined);
      setValue('isRefinanced', mortgage.isRefinanced);
      setValue('originalLoanDate', mortgage.originalLoanDate || '');
      setValue('refinanceDate', mortgage.refinanceDate || '');
      setValue('refinanceReason', mortgage.refinanceReason || '');
      setValue('status', mortgage.status);
      setValue('notes', mortgage.notes || '');
    }
  }, [mortgage, isEditMode, setValue]);

  // Watch values for conditional rendering
  const hasEscrow = watch('hasEscrow');
  const isRefinanced = watch('isRefinanced');
  const pmi = watch('pmi');

  const onSubmit = async (data: MortgageFormData) => {
    try {
      if (isEditMode && id) {
        await updateMutation.mutateAsync({ id, data });
      } else {
        await createMutation.mutateAsync(data);
      }
      navigate('/mortgage');
    } catch (error) {
      console.error('Failed to save mortgage:', error);
    }
  };

  if (isLoading && isEditMode) {
    return <FormSkeleton />;
  }

  return (
    <div className="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {/* Header */}
      <div className="flex items-center gap-4 mb-8">
        <Button
          variant="ghost"
          icon={ArrowLeft}
          onClick={() => navigate('/mortgage')}
        >
          Back
        </Button>

        <div className="flex-1">
          <h1 className="text-3xl font-bold text-gray-900">
            {isEditMode ? 'Edit Mortgage' : 'Add Mortgage'}
          </h1>
          <p className="text-gray-600 mt-1">
            {isEditMode
              ? 'Update your mortgage information'
              : 'Add your mortgage to track equity and payments'}
          </p>
        </div>
      </div>

      {/* Form */}
      <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
        {/* Property Information */}
        <FormSection
          title="Property Information"
          description="Enter details about the property"
        >
          <div className="space-y-4">
            <Input
              {...register('propertyAddress')}
              label="Property Address"
              placeholder="123 Main Street"
              error={errors.propertyAddress?.message}
              required
            />

            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <Input
                {...register('propertyCity')}
                label="City"
                placeholder="San Francisco"
                error={errors.propertyCity?.message}
              />

              <Input
                {...register('propertyState')}
                label="State"
                placeholder="CA"
                maxLength={2}
                error={errors.propertyState?.message}
              />

              <Input
                {...register('propertyZip')}
                label="ZIP Code"
                placeholder="94102"
                maxLength={10}
                error={errors.propertyZip?.message}
              />
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <Select
                {...register('propertyType')}
                label="Property Type"
                error={errors.propertyType?.message}
              >
                <option value="">Select type</option>
                <option value="single_family">Single Family</option>
                <option value="condo">Condo</option>
                <option value="townhouse">Townhouse</option>
                <option value="multi_family">Multi-Family</option>
                <option value="manufactured">Manufactured</option>
                <option value="other">Other</option>
              </Select>

              <Controller
                name="propertyValue"
                control={control}
                render={({ field }) => (
                  <CurrencyInput
                    {...field}
                    label="Current Property Value"
                    error={errors.propertyValue?.message}
                    required
                    helpText="Current estimated market value"
                  />
                )}
              />
            </div>
          </div>
        </FormSection>

        {/* Lender Information */}
        <FormSection
          title="Lender Information"
          description="Details about your mortgage lender"
        >
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <Input
              {...register('lender')}
              label="Lender/Bank"
              placeholder="Wells Fargo"
              error={errors.lender?.message}
            />

            <Input
              {...register('loanNumber')}
              label="Loan Number"
              placeholder="123456789"
              error={errors.loanNumber?.message}
            />

            <Select
              {...register('loanType')}
              label="Loan Type"
              error={errors.loanType?.message}
            >
              <option value="">Select type</option>
              <option value="conventional">Conventional</option>
              <option value="fha">FHA</option>
              <option value="va">VA</option>
              <option value="usda">USDA</option>
              <option value="jumbo">Jumbo</option>
              <option value="other">Other</option>
            </Select>
          </div>
        </FormSection>

        {/* Loan Details */}
        <FormSection
          title="Loan Details"
          description="Financial details of your mortgage"
        >
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <Controller
              name="loanAmount"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Original Loan Amount"
                  error={errors.loanAmount?.message}
                  required
                />
              )}
            />

            <Controller
              name="currentBalance"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Current Balance"
                  error={errors.currentBalance?.message}
                  required
                />
              )}
            />

            <Controller
              name="interestRate"
              control={control}
              render={({ field }) => (
                <PercentageInput
                  {...field}
                  label="Interest Rate"
                  error={errors.interestRate?.message}
                  required
                  max={100}
                />
              )}
            />

            <Input
              {...register('termYears', { valueAsNumber: true })}
              type="number"
              label="Loan Term (Years)"
              placeholder="30"
              min={1}
              max={40}
              error={errors.termYears?.message}
              required
            />

            <Controller
              name="monthlyPayment"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Monthly P&I Payment"
                  error={errors.monthlyPayment?.message}
                  required
                  helpText="Principal & Interest only"
                />
              )}
            />

            <Controller
              name="extraPayment"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Extra Principal Payment"
                  error={errors.extraPayment?.message}
                  helpText="Additional monthly payment toward principal"
                />
              )}
            />

            <div className="md:col-span-2">
              <Input
                {...register('startDate')}
                type="date"
                label="Loan Start Date"
                error={errors.startDate?.message}
                required
              />
            </div>
          </div>
        </FormSection>

        {/* Additional Monthly Costs */}
        <FormSection
          title="Additional Monthly Costs"
          description="Property taxes, insurance, and other recurring costs"
        >
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <Controller
              name="propertyTax"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Annual Property Tax"
                  error={errors.propertyTax?.message}
                  required
                  helpText="Total annual amount"
                />
              )}
            />

            <Controller
              name="homeownersInsurance"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Annual Homeowners Insurance"
                  error={errors.homeownersInsurance?.message}
                  required
                  helpText="Total annual premium"
                />
              )}
            />

            <Controller
              name="hoaFees"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Annual HOA Fees"
                  error={errors.hoaFees?.message}
                  helpText="Leave blank if none"
                />
              )}
            />

            <Controller
              name="pmi"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Monthly PMI/MIP"
                  error={errors.pmi?.message}
                  helpText="Private mortgage insurance"
                />
              )}
            />

            {pmi > 0 && (
              <Controller
                name="pmiRemovalLtv"
                control={control}
                render={({ field }) => (
                  <PercentageInput
                    {...field}
                    label="PMI Removal LTV"
                    error={errors.pmiRemovalLtv?.message}
                    helpText="LTV threshold to remove PMI (typically 80%)"
                    max={100}
                  />
                )}
              />
            )}
          </div>
        </FormSection>

        {/* Escrow Information */}
        <FormSection
          title="Escrow Account"
          description="Information about your escrow account if applicable"
        >
          <div className="space-y-4">
            <Checkbox
              {...register('hasEscrow')}
              label="This mortgage has an escrow account"
              helpText="Taxes and insurance are paid through escrow"
            />

            {hasEscrow && (
              <Controller
                name="escrowBalance"
                control={control}
                render={({ field }) => (
                  <CurrencyInput
                    {...field}
                    label="Current Escrow Balance"
                    error={errors.escrowBalance?.message}
                    helpText="Current amount in escrow account"
                  />
                )}
              />
            )}
          </div>
        </FormSection>

        {/* Refinance Information */}
        <FormSection
          title="Refinance Information"
          description="If this loan is a refinance, provide details"
        >
          <div className="space-y-4">
            <Checkbox
              {...register('isRefinanced')}
              label="This is a refinanced mortgage"
            />

            {isRefinanced && (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <Input
                  {...register('originalLoanDate')}
                  type="date"
                  label="Original Loan Date"
                  error={errors.originalLoanDate?.message}
                  helpText="Date of original mortgage"
                />

                <Input
                  {...register('refinanceDate')}
                  type="date"
                  label="Refinance Date"
                  error={errors.refinanceDate?.message}
                  helpText="Date loan was refinanced"
                />

                <div className="md:col-span-2">
                  <Input
                    {...register('refinanceReason')}
                    label="Refinance Reason"
                    placeholder="Lower rate, cash-out, etc."
                    error={errors.refinanceReason?.message}
                  />
                </div>
              </div>
            )}
          </div>
        </FormSection>

        {/* Status */}
        <FormSection
          title="Mortgage Status"
          description="Current status of the mortgage"
        >
          <Select
            {...register('status')}
            label="Status"
            error={errors.status?.message}
            required
          >
            <option value="active">Active</option>
            <option value="paid_off">Paid Off</option>
            <option value="foreclosed">Foreclosed</option>
            <option value="in_forbearance">In Forbearance</option>
          </Select>
        </FormSection>

        {/* Notes */}
        <FormSection
          title="Notes"
          description="Add any additional notes or comments"
        >
          <Textarea
            {...register('notes')}
            label="Notes"
            placeholder="Add any notes about this mortgage..."
            rows={4}
            error={errors.notes?.message}
            maxLength={1000}
            showCount
          />
        </FormSection>

        {/* Form Actions */}
        <div className="flex items-center justify-end gap-4 pt-6 border-t border-gray-200">
          <Button
            type="button"
            variant="outline"
            onClick={() => navigate('/mortgage')}
          >
            Cancel
          </Button>

          <Button
            type="submit"
            variant="primary"
            disabled={isSubmitting}
            icon={isSubmitting ? Loader2 : Save}
            iconAnimation={isSubmitting ? 'spin' : undefined}
          >
            {isSubmitting
              ? 'Saving...'
              : isEditMode
              ? 'Update Mortgage'
              : 'Add Mortgage'}
          </Button>
        </div>
      </form>
    </div>
  );
}

function FormSkeleton() {
  return (
    <div className="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <Skeleton className="h-12 w-64 mb-8" />
      {[...Array(7)].map((_, i) => (
        <div key={i} className="mb-6">
          <Skeleton className="h-6 w-48 mb-4" />
          <div className="grid grid-cols-2 gap-4">
            <Skeleton className="h-10 rounded" />
            <Skeleton className="h-10 rounded" />
          </div>
        </div>
      ))}
    </div>
  );
}
```

**Mortgage Schema:**

```ts
// src/lib/schemas/mortgage.schema.ts
import { z } from 'zod';

export const mortgageSchema = z.object({
  // Property Information
  propertyAddress: z
    .string()
    .min(1, 'Property address is required')
    .max(255, 'Address must be less than 255 characters'),
  
  propertyCity: z
    .string()
    .max(100, 'City must be less than 100 characters')
    .optional()
    .or(z.literal('')),
  
  propertyState: z
    .string()
    .length(2, 'State must be 2 characters')
    .optional()
    .or(z.literal('')),
  
  propertyZip: z
    .string()
    .max(10, 'ZIP code must be less than 10 characters')
    .optional()
    .or(z.literal('')),
  
  propertyType: z
    .enum(['single_family', 'condo', 'townhouse', 'multi_family', 'manufactured', 'other'])
    .optional()
    .or(z.literal('')),
  
  propertyValue: z
    .number()
    .min(1, 'Property value is required')
    .max(100000000, 'Property value seems unreasonably high'),

  // Lender Information
  lender: z
    .string()
    .max(100, 'Lender name must be less than 100 characters')
    .optional()
    .or(z.literal('')),
  
  loanNumber: z
    .string()
    .max(50, 'Loan number must be less than 50 characters')
    .optional()
    .or(z.literal('')),
  
  loanType: z
    .enum(['conventional', 'fha', 'va', 'usda', 'jumbo', 'other'])
    .optional()
    .or(z.literal('')),

  // Loan Details
  loanAmount: z
    .number()
    .min(1, 'Loan amount is required')
    .max(100000000, 'Loan amount seems unreasonably high'),
  
  currentBalance: z
    .number()
    .min(0, 'Balance must be positive')
    .max(100000000, 'Balance seems unreasonably high'),
  
  interestRate: z
    .number()
    .min(0, 'Interest rate must be positive')
    .max(100, 'Interest rate cannot exceed 100%'),
  
  termYears: z
    .number()
    .int()
    .min(1, 'Term must be at least 1 year')
    .max(40, 'Term cannot exceed 40 years'),
  
  monthlyPayment: z
    .number()
    .min(0, 'Monthly payment must be positive')
    .max(1000000, 'Monthly payment seems unreasonably high'),
  
  extraPayment: z
    .number()
    .min(0, 'Extra payment must be positive')
    .max(100000, 'Extra payment seems unreasonably high')
    .optional(),
  
  startDate: z
    .string()
    .regex(/^\d{4}-\d{2}-\d{2}$/, 'Invalid date format'),

  // Additional Costs
  propertyTax: z
    .number()
    .min(0, 'Property tax must be positive')
    .max(1000000, 'Property tax seems unreasonably high'),
  
  homeownersInsurance: z
    .number()
    .min(0, 'Insurance must be positive')
    .max(100000, 'Insurance seems unreasonably high'),
  
  hoaFees: z
    .number()
    .min(0, 'HOA fees must be positive')
    .max(100000, 'HOA fees seem unreasonably high')
    .optional(),
  
  pmi: z
    .number()
    .min(0, 'PMI must be positive')
    .max(10000, 'PMI seems unreasonably high')
    .optional(),
  
  pmiRemovalLtv: z
    .number()
    .min(0, 'LTV must be positive')
    .max(100, 'LTV cannot exceed 100%')
    .optional(),

  // Escrow
  hasEscrow: z.boolean().optional(),
  
  escrowBalance: z
    .number()
    .min(0, 'Escrow balance must be positive')
    .optional(),

  // Refinance
  isRefinanced: z.boolean().optional(),
  
  originalLoanDate: z
    .string()
    .regex(/^\d{4}-\d{2}-\d{2}$/, 'Invalid date format')
    .optional()
    .or(z.literal('')),
  
  refinanceDate: z
    .string()
    .regex(/^\d{4}-\d{2}-\d{2}$/, 'Invalid date format')
    .optional()
    .or(z.literal('')),
  
  refinanceReason: z
    .string()
    .max(255, 'Reason must be less than 255 characters')
    .optional()
    .or(z.literal('')),

  // Status
  status: z.enum(['active', 'paid_off', 'foreclosed', 'in_forbearance']),

  // Notes
  notes: z
    .string()
    .max(1000, 'Notes must be less than 1000 characters')
    .optional()
    .or(z.literal('')),
}).refine(
  (data) => data.currentBalance <= data.loanAmount,
  {
    message: 'Current balance cannot exceed original loan amount',
    path: ['currentBalance'],
  }
);

export type MortgageFormData = z.infer<typeof mortgageSchema>;
```

### **5.6 Bills Tracker** {#5.6-bills-tracker}

#### **5.6.1 Bills List View** {#5.6.1-bills-list-view}

**Purpose:** Display all recurring and one-time bills with payment status and upcoming due dates

**User Story:** As a user, I want to see all my bills in one place so that I can track what's due, what's paid, and manage my monthly expenses

**Layout:**

```
┌─────────────────────────────────────────────────────────┐
│  Bills Header + Add New Button                         │
├─────────────────────────────────────────────────────────┤
│  Summary Stats (Monthly Total, Upcoming, Overdue)      │
├─────────────────────────────────────────────────────────┤
│  Filters & Sort Controls + Calendar View Toggle        │
├─────────────────────────────────────────────────────────┤
│  ┌───────────────────┐ ┌───────────────────┐           │
│  │  Netflix          │ │  Electric Bill    │           │
│  │  $15.99/month     │ │  $120.00/month    │           │
│  │  Due: Dec 5       │ │  Due: Dec 15      │           │
│  │  [PAID] Auto-pay  │ │  [UPCOMING] 5 days│           │
│  └───────────────────┘ └───────────────────┘           │
│  ┌───────────────────┐ ┌───────────────────┐           │
│  │  Internet         │ │  Car Insurance    │           │
│  │  $80.00/month     │ │  $150.00/month    │           │
│  │  [OVERDUE] 2 days │ │  Due: Dec 20      │           │
│  └───────────────────┘ └───────────────────┘           │
└─────────────────────────────────────────────────────────┘
```

**Component Implementation:**

```
// src/pages/BillsPage.tsx
import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { Plus, Calendar as CalendarIcon, List } from 'lucide-react';
import { useBills } from '@/hooks/api/useBills';
import { Button } from '@/components/common/Button';
import { BillStats } from '@/components/bills/BillStats';
import { BillFilters } from '@/components/bills/BillFilters';
import { BillList } from '@/components/bills/BillList';
import { BillCalendar } from '@/components/bills/BillCalendar';
import { EmptyState } from '@/components/common/EmptyState';
import { Skeleton } from '@/components/common/Skeleton';
import type { BillFilters as Filters, BillSortBy } from '@/types';

export function BillsPage() {
  const navigate = useNavigate();
  const { data: bills, isLoading, error } = useBills();
  
  const [viewMode, setViewMode] = useState<'list' | 'calendar'>('list');
  const [filters, setFilters] = useState<Filters>({
    category: 'all',
    status: 'all',
    frequency: 'all',
    search: '',
  });
  const [sortBy, setSortBy] = useState<BillSortBy>('due_date_asc');

  if (isLoading) {
    return <BillsSkeleton />;
  }

  if (error) {
    return (
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div className="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
          <p className="text-red-800">Failed to load bills. Please try again.</p>
        </div>
      </div>
    );
  }

  if (!bills || bills.length === 0) {
    return (
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <EmptyState
          icon={Plus}
          title="No bills yet"
          description="Add your first bill to start tracking payments and due dates"
          action={{
            label: 'Add Bill',
            onClick: () => navigate('/bills/new'),
          }}
        />
      </div>
    );
  }

  // Filter bills
  let filteredBills = bills;

  if (filters.category !== 'all') {
    filteredBills = filteredBills.filter(b => b.category === filters.category);
  }

  if (filters.status !== 'all') {
    filteredBills = filteredBills.filter(b => b.paymentStatus === filters.status);
  }

  if (filters.frequency !== 'all') {
    filteredBills = filteredBills.filter(b => b.frequency === filters.frequency);
  }

  if (filters.search) {
    const search = filters.search.toLowerCase();
    filteredBills = filteredBills.filter(b =>
      b.billName.toLowerCase().includes(search) ||
      b.payee?.toLowerCase().includes(search)
    );
  }

  // Sort bills
  const sortedBills = [...filteredBills].sort((a, b) => {
    switch (sortBy) {
      case 'due_date_asc':
        return (a.nextDueDate || '').localeCompare(b.nextDueDate || '');
      case 'due_date_desc':
        return (b.nextDueDate || '').localeCompare(a.nextDueDate || '');
      case 'amount_desc':
        return b.amount - a.amount;
      case 'amount_asc':
        return a.amount - b.amount;
      case 'name_asc':
        return a.billName.localeCompare(b.billName);
      case 'name_desc':
        return b.billName.localeCompare(a.billName);
      default:
        return 0;
    }
  });

  return (
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {/* Header */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">Bills</h1>
          <p className="text-gray-600 mt-1">
            Track recurring bills and upcoming payments
          </p>
        </div>

        <div className="flex gap-2">
          <div className="flex bg-gray-100 rounded-lg p-1">
            <button
              onClick={() => setViewMode('list')}
              className={`px-3 py-1.5 rounded-md text-sm font-medium transition-colors ${
                viewMode === 'list'
                  ? 'bg-white text-gray-900 shadow-sm'
                  : 'text-gray-600 hover:text-gray-900'
              }`}
            >
              <List className="h-4 w-4" />
            </button>
            <button
              onClick={() => setViewMode('calendar')}
              className={`px-3 py-1.5 rounded-md text-sm font-medium transition-colors ${
                viewMode === 'calendar'
                  ? 'bg-white text-gray-900 shadow-sm'
                  : 'text-gray-600 hover:text-gray-900'
              }`}
            >
              <CalendarIcon className="h-4 w-4" />
            </button>
          </div>

          <Button
            variant="primary"
            icon={Plus}
            onClick={() => navigate('/bills/new')}
          >
            Add Bill
          </Button>
        </div>
      </div>

      {/* Summary Stats */}
      <BillStats bills={bills} className="mb-8" />

      {/* Filters */}
      <BillFilters
        filters={filters}
        sortBy={sortBy}
        onFiltersChange={setFilters}
        onSortChange={setSortBy}
        className="mb-6"
      />

      {/* Bills Content */}
      {sortedBills.length === 0 ? (
        <div className="bg-gray-50 rounded-lg p-8 text-center">
          <p className="text-gray-600">No bills match your filters</p>
        </div>
      ) : viewMode === 'list' ? (
        <BillList bills={sortedBills} />
      ) : (
        <BillCalendar bills={sortedBills} />
      )}
    </div>
  );
}

function BillsSkeleton() {
  return (
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <Skeleton className="h-12 w-64 mb-8" />
      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
        {[...Array(3)].map((_, i) => (
          <Skeleton key={i} className="h-24 rounded-lg" />
        ))}
      </div>
      <Skeleton className="h-12 w-full mb-6" />
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {[...Array(6)].map((_, i) => (
          <Skeleton key={i} className="h-48 rounded-lg" />
        ))}
      </div>
    </div>
  );
}
```

**Bill Stats Component:**

```
// src/components/bills/BillStats.tsx
import React, { useMemo } from 'react';
import { Receipt, AlertCircle, Calendar } from 'lucide-react';
import { Card } from '@/components/common/Card';
import { formatCurrency } from '@/lib/utils/formatters';
import { cn } from '@/lib/utils';
import type { Bill } from '@/types';

interface BillStatsProps {
  bills: Bill[];
  className?: string;
}

export function BillStats({ bills, className }: BillStatsProps) {
  const stats = useMemo(() => {
    const now = new Date();
    const thirtyDaysFromNow = new Date();
    thirtyDaysFromNow.setDate(now.getDate() + 30);

    const activeBills = bills.filter(b => b.isActive);
    
    // Calculate monthly total (annualized amounts converted to monthly)
    const monthlyTotal = activeBills.reduce((sum, bill) => {
      let monthlyAmount = 0;
      
      switch (bill.frequency) {
        case 'monthly':
          monthlyAmount = bill.amount;
          break;
        case 'weekly':
          monthlyAmount = (bill.amount * 52) / 12;
          break;
        case 'biweekly':
          monthlyAmount = (bill.amount * 26) / 12;
          break;
        case 'quarterly':
          monthlyAmount = bill.amount / 3;
          break;
        case 'semi_annual':
          monthlyAmount = bill.amount / 6;
          break;
        case 'annual':
          monthlyAmount = bill.amount / 12;
          break;
        case 'one_time':
          monthlyAmount = 0; // Don't include one-time bills in monthly total
          break;
      }
      
      return sum + monthlyAmount;
    }, 0);

    // Count upcoming bills (due in next 30 days, not yet paid)
    const upcomingCount = activeBills.filter(bill => {
      if (!bill.nextDueDate || bill.paymentStatus === 'paid') return false;
      const dueDate = new Date(bill.nextDueDate);
      return dueDate >= now && dueDate <= thirtyDaysFromNow;
    }).length;

    // Count overdue bills
    const overdueCount = activeBills.filter(bill => {
      if (!bill.nextDueDate || bill.paymentStatus === 'paid') return false;
      const dueDate = new Date(bill.nextDueDate);
      return dueDate < now;
    }).length;

    // Sum of upcoming bills amounts
    const upcomingAmount = activeBills
      .filter(bill => {
        if (!bill.nextDueDate || bill.paymentStatus === 'paid') return false;
        const dueDate = new Date(bill.nextDueDate);
        return dueDate >= now && dueDate <= thirtyDaysFromNow;
      })
      .reduce((sum, bill) => sum + bill.amount, 0);

    return {
      monthlyTotal,
      upcomingCount,
      upcomingAmount,
      overdueCount,
    };
  }, [bills]);

  const statItems = [
    {
      label: 'Monthly Bills Total',
      value: formatCurrency(stats.monthlyTotal),
      subValue: 'Estimated monthly expense',
      icon: Receipt,
      color: 'blue',
    },
    {
      label: 'Upcoming Bills',
      value: stats.upcomingCount.toString(),
      subValue: `${formatCurrency(stats.upcomingAmount)} due in 30 days`,
      icon: Calendar,
      color: 'green',
    },
    {
      label: 'Overdue Bills',
      value: stats.overdueCount.toString(),
      subValue: stats.overdueCount > 0 ? 'Requires attention' : 'All caught up',
      icon: AlertCircle,
      color: stats.overdueCount > 0 ? 'red' : 'gray',
    },
  ];

  return (
    <div className={cn('grid grid-cols-1 sm:grid-cols-3 gap-4', className)}>
      {statItems.map((stat) => (
        <StatCard key={stat.label} {...stat} />
      ))}
    </div>
  );
}

interface StatCardProps {
  label: string;
  value: string;
  subValue: string;
  icon: React.ElementType;
  color: string;
}

function StatCard({ label, value, subValue, icon: Icon, color }: StatCardProps) {
  const colorClasses = {
    blue: 'bg-blue-100 text-blue-600',
    green: 'bg-green-100 text-green-600',
    red: 'bg-red-100 text-red-600',
    gray: 'bg-gray-100 text-gray-600',
  };

  return (
    <Card className="p-6">
      <div className="flex items-start justify-between">
        <div>
          <p className="text-sm text-gray-600 font-medium">{label}</p>
          <p className="text-2xl font-bold text-gray-900 mt-1">{value}</p>
          <p className="text-xs text-gray-500 mt-1">{subValue}</p>
        </div>
        <div className={cn(
          'p-2 rounded-lg',
          colorClasses[color as keyof typeof colorClasses]
        )}>
          <Icon className="h-5 w-5" />
        </div>
      </div>
    </Card>
  );
}
```

**Bill Filters Component:**

```
// src/components/bills/BillFilters.tsx
import React from 'react';
import { Search, SlidersHorizontal } from 'lucide-react';
import { Input } from '@/components/common/Input';
import { Select } from '@/components/common/Select';
import { cn } from '@/lib/utils';
import type { BillFilters as Filters, BillSortBy } from '@/types';

interface BillFiltersProps {
  filters: Filters;
  sortBy: BillSortBy;
  onFiltersChange: (filters: Filters) => void;
  onSortChange: (sortBy: BillSortBy) => void;
  className?: string;
}

export function BillFilters({
  filters,
  sortBy,
  onFiltersChange,
  onSortChange,
  className,
}: BillFiltersProps) {
  return (
    <div className={cn('flex flex-col sm:flex-row gap-4', className)}>
      {/* Search */}
      <div className="flex-1">
        <Input
          placeholder="Search bills..."
          icon={Search}
          value={filters.search}
          onChange={(e) => onFiltersChange({ ...filters, search: e.target.value })}
        />
      </div>

      {/* Category Filter */}
      <Select
        value={filters.category}
        onChange={(e) => onFiltersChange({ ...filters, category: e.target.value as any })}
        className="w-full sm:w-48"
      >
        <option value="all">All Categories</option>
        <option value="utilities">Utilities</option>
        <option value="subscriptions">Subscriptions</option>
        <option value="insurance">Insurance</option>
        <option value="loans">Loans</option>
        <option value="rent">Rent/Mortgage</option>
        <option value="healthcare">Healthcare</option>
        <option value="education">Education</option>
        <option value="memberships">Memberships</option>
        <option value="other">Other</option>
      </Select>

      {/* Status Filter */}
      <Select
        value={filters.status}
        onChange={(e) => onFiltersChange({ ...filters, status: e.target.value as any })}
        className="w-full sm:w-40"
      >
        <option value="all">All Status</option>
        <option value="paid">Paid</option>
        <option value="pending">Pending</option>
        <option value="overdue">Overdue</option>
      </Select>

      {/* Frequency Filter */}
      <Select
        value={filters.frequency}
        onChange={(e) => onFiltersChange({ ...filters, frequency: e.target.value as any })}
        className="w-full sm:w-40"
      >
        <option value="all">All Frequencies</option>
        <option value="weekly">Weekly</option>
        <option value="biweekly">Bi-weekly</option>
        <option value="monthly">Monthly</option>
        <option value="quarterly">Quarterly</option>
        <option value="semi_annual">Semi-annual</option>
        <option value="annual">Annual</option>
        <option value="one_time">One-time</option>
      </Select>

      {/* Sort */}
      <Select
        value={sortBy}
        onChange={(e) => onSortChange(e.target.value as BillSortBy)}
        icon={SlidersHorizontal}
        className="w-full sm:w-48"
      >
        <option value="due_date_asc">Due Date (Soonest)</option>
        <option value="due_date_desc">Due Date (Latest)</option>
        <option value="amount_desc">Highest Amount</option>
        <option value="amount_asc">Lowest Amount</option>
        <option value="name_asc">Name (A-Z)</option>
        <option value="name_desc">Name (Z-A)</option>
      </Select>
    </div>
  );
}
```

**Bill List and Card Components:**

```
// src/components/bills/BillList.tsx
import React from 'react';
import { BillCard } from './BillCard';
import type { Bill } from '@/types';

interface BillListProps {
  bills: Bill[];
}

export function BillList({ bills }: BillListProps) {
  return (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {bills.map((bill) => (
        <BillCard key={bill.id} bill={bill} />
      ))}
    </div>
  );
}
```

```
// src/components/bills/BillCard.tsx
import React, { useState } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import {
  Receipt,
  MoreVertical,
  Edit,
  Trash2,
  Eye,
  Calendar,
  AlertCircle,
  CheckCircle,
  Clock,
  Zap,
} from 'lucide-react';
import { Card } from '@/components/common/Card';
import { Badge } from '@/components/common/Badge';
import { DropdownMenu } from '@/components/common/DropdownMenu';
import { ConfirmDialog } from '@/components/common/ConfirmDialog';
import { useDeleteBill, useMarkBillPaid } from '@/hooks/api/useBills';
import { formatCurrency, formatDate } from '@/lib/utils/formatters';
import { getDaysUntilDue, getBillStatusInfo } from '@/lib/utils/bills';
import { cn } from '@/lib/utils';
import type { Bill } from '@/types';

interface BillCardProps {
  bill: Bill;
}

export function BillCard({ bill }: BillCardProps) {
  const navigate = useNavigate();
  const { mutate: deleteBill } = useDeleteBill();
  const { mutate: markPaid } = useMarkBillPaid();
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);

  const statusInfo = getBillStatusInfo(bill);
  const daysUntil = bill.nextDueDate ? getDaysUntilDue(bill.nextDueDate) : null;

  const getCategoryColor = (category: string) => {
    const colors: Record<string, string> = {
      utilities: 'blue',
      subscriptions: 'purple',
      insurance: 'green',
      loans: 'orange',
      rent: 'indigo',
      healthcare: 'pink',
      education: 'cyan',
      memberships: 'teal',
      other: 'gray',
    };
    return colors[category] || 'gray';
  };

  const categoryColor = getCategoryColor(bill.category);

  const handleDelete = () => {
    deleteBill(bill.id, {
      onSuccess: () => {
        setShowDeleteDialog(false);
      },
    });
  };

  const handleMarkPaid = () => {
    markPaid(bill.id);
  };

  const menuItems = [
    {
      label: 'View Details',
      icon: Eye,
      onClick: () => navigate(`/bills/${bill.id}`),
    },
    {
      label: 'Edit',
      icon: Edit,
      onClick: () => navigate(`/bills/${bill.id}/edit`),
    },
    ...(bill.paymentStatus !== 'paid' ? [{
      label: 'Mark as Paid',
      icon: CheckCircle,
      onClick: handleMarkPaid,
    }] : []),
    {
      type: 'divider' as const,
    },
    {
      label: 'Delete',
      icon: Trash2,
      onClick: () => setShowDeleteDialog(true),
      variant: 'danger' as const,
    },
  ];

  return (
    <>
      <Card className="overflow-hidden hover:shadow-lg transition-shadow">
        {/* Card Header */}
        <div className={cn(
          'p-6 text-white',
          `bg-gradient-to-br from-${categoryColor}-500 to-${categoryColor}-600`
        )}
        style={{
          background: `linear-gradient(to bottom right, var(--tw-gradient-stops))`,
          '--tw-gradient-from': getCategoryGradientColor(categoryColor, 500),
          '--tw-gradient-to': getCategoryGradientColor(categoryColor, 600),
          '--tw-gradient-stops': 'var(--tw-gradient-from), var(--tw-gradient-to)',
        } as React.CSSProperties}>
          <div className="flex items-start justify-between mb-4">
            <div className="flex items-center gap-2">
              <Receipt className="h-5 w-5" />
              <span className="text-xs font-medium opacity-90 capitalize">
                {bill.category}
              </span>
            </div>
            <DropdownMenu items={menuItems} trigger={
              <button className="text-white hover:bg-white/20 p-1 rounded transition-colors">
                <MoreVertical className="h-5 w-5" />
              </button>
            } />
          </div>

          <h3 className="text-xl font-bold mb-1">{bill.billName}</h3>
          {bill.payee && (
            <p className="text-sm opacity-90">{bill.payee}</p>
          )}
        </div>

        {/* Card Body */}
        <div className="p-6">
          {/* Status Badge */}
          <div className="mb-4">
            <Badge variant={statusInfo.variant} className="flex items-center gap-1">
              <statusInfo.icon className="h-3 w-3" />
              {statusInfo.label}
            </Badge>
          </div>

          {/* Amount */}
          <div className="mb-4">
            <p className="text-sm text-gray-600 mb-1">Amount</p>
            <p className="text-2xl font-bold text-gray-900">
              {formatCurrency(bill.amount)}
            </p>
            <p className="text-xs text-gray-500 mt-1 capitalize">
              {bill.frequency.replace('_', '-')}
            </p>
          </div>

          {/* Due Date */}
          {bill.nextDueDate && (
            <div className="mb-4 p-3 bg-gray-50 rounded-lg">
              <div className="flex items-center gap-2 mb-1">
                <Calendar className="h-4 w-4 text-gray-600" />
                <p className="text-sm font-medium text-gray-900">Next Due Date</p>
              </div>
              <p className="text-lg font-semibold text-gray-900">
                {formatDate(bill.nextDueDate, 'MMM d, yyyy')}
              </p>
              {daysUntil !== null && (
                <p className={cn(
                  'text-xs mt-1',
                  daysUntil < 0 ? 'text-red-600' :
                  daysUntil <= 7 ? 'text-orange-600' :
                  'text-gray-600'
                )}>
                  {daysUntil < 0
                    ? `${Math.abs(daysUntil)} days overdue`
                    : daysUntil === 0
                    ? 'Due today'
                    : `${daysUntil} days until due`}
                </p>
              )}
            </div>
          )}

          {/* Auto-pay */}
          {bill.autoPay && (
            <div className="mb-4">
              <Badge variant="info" size="sm" className="flex items-center gap-1">
                <Zap className="h-3 w-3" />
                Auto-pay enabled
              </Badge>
            </div>
          )}

          {/* Payment Method */}
          {bill.paymentMethod && (
            <div className="pt-4 border-t border-gray-200">
              <p className="text-xs text-gray-600">Payment Method</p>
              <p className="text-sm font-medium text-gray-900 mt-1 capitalize">
                {bill.paymentMethod.replace('_', ' ')}
              </p>
            </div>
          )}

          {/* View Details Link */}
          <Link
            to={`/bills/${bill.id}`}
            className="block mt-4 text-center text-sm text-blue-600 hover:text-blue-700 font-medium"
          >
            View Details →
          </Link>
        </div>
      </Card>

      {/* Delete Confirmation Dialog */}
      <ConfirmDialog
        isOpen={showDeleteDialog}
        onClose={() => setShowDeleteDialog(false)}
        onConfirm={handleDelete}
        title="Delete Bill"
        description={`Are you sure you want to delete "${bill.billName}"? This action cannot be undone.`}
        confirmLabel="Delete"
        variant="danger"
      />
    </>
  );
}

// Helper function to get gradient colors
function getCategoryGradientColor(color: string, shade: number): string {
  const colors: Record<string, Record<number, string>> = {
    blue: { 500: '#3b82f6', 600: '#2563eb' },
    purple: { 500: '#a855f7', 600: '#9333ea' },
    green: { 500: '#22c55e', 600: '#16a34a' },
    orange: { 500: '#f97316', 600: '#ea580c' },
    indigo: { 500: '#6366f1', 600: '#4f46e5' },
    pink: { 500: '#ec4899', 600: '#db2777' },
    cyan: { 500: '#06b6d4', 600: '#0891b2' },
    teal: { 500: '#14b8a6', 600: '#0d9488' },
    gray: { 500: '#6b7280', 600: '#4b5563' },
  };
  return colors[color]?.[shade] || colors.gray[shade];
}
```

**Bill Utilities:**

```ts
// src/lib/utils/bills.ts
import type { Bill } from '@/types';

export function getDaysUntilDue(dueDate: string): number {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  const due = new Date(dueDate);
  due.setHours(0, 0, 0, 0);
  
  const diffTime = due.getTime() - today.getTime();
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  return diffDays;
}

export function getBillStatusInfo(bill: Bill) {
  if (bill.paymentStatus === 'paid') {
    return {
      label: 'Paid',
      variant: 'success' as const,
      icon: import('lucide-react').then(m => m.CheckCircle),
    };
  }

  if (!bill.nextDueDate) {
    return {
      label: 'No Due Date',
      variant: 'secondary' as const,
      icon: import('lucide-react').then(m => m.Calendar),
    };
  }

  const daysUntil = getDaysUntilDue(bill.nextDueDate);

  if (daysUntil < 0) {
    return {
      label: 'Overdue',
      variant: 'danger' as const,
      icon: import('lucide-react').then(m => m.AlertCircle),
    };
  }

  if (daysUntil <= 7) {
    return {
      label: 'Due Soon',
      variant: 'warning' as const,
      icon: import('lucide-react').then(m => m.Clock),
    };
  }

  return {
    label: 'Upcoming',
    variant: 'info' as const,
    icon: import('lucide-react').then(m => m.Calendar),
  };
}

export function calculateNextDueDate(
  startDate: string,
  frequency: Bill['frequency'],
  currentDate: Date = new Date()
): string | null {
  if (frequency === 'one_time') {
    // For one-time bills, next due date is the start date if in future
    const start = new Date(startDate);
    return start > currentDate ? startDate : null;
  }

  const start = new Date(startDate);
  let next = new Date(start);

  // Keep adding periods until we're in the future
  while (next <= currentDate) {
    switch (frequency) {
      case 'weekly':
        next.setDate(next.getDate() + 7);
        break;
      case 'biweekly':
        next.setDate(next.getDate() + 14);
        break;
      case 'monthly':
        next.setMonth(next.getMonth() + 1);
        break;
      case 'quarterly':
        next.setMonth(next.getMonth() + 3);
        break;
      case 'semi_annual':
        next.setMonth(next.getMonth() + 6);
        break;
      case 'annual':
        next.setFullYear(next.getFullYear() + 1);
        break;
    }
  }

  return next.toISOString().split('T')[0];
}
```

**Type Definitions:**

```ts
// Add to src/types/index.ts

export interface BillFilters {
  category: 'all' | Bill['category'];
  status: 'all' | 'paid' | 'pending' | 'overdue';
  frequency: 'all' | Bill['frequency'];
  search: string;
}

export type BillSortBy = 
  | 'due_date_asc'
  | 'due_date_desc'
  | 'amount_desc'
  | 'amount_asc'
  | 'name_asc'
  | 'name_desc';

export interface Bill {
  id: string;
  userId: string;
  billName: string;
  payee: string | null;
  category: 'utilities' | 'subscriptions' | 'insurance' | 'loans' | 'rent' | 'healthcare' | 'education' | 'memberships' | 'other';
  amount: number;
  frequency: 'weekly' | 'biweekly' | 'monthly' | 'quarterly' | 'semi_annual' | 'annual' | 'one_time';
  nextDueDate: string | null;
  paymentMethod: 'auto_pay' | 'manual' | 'credit_card' | 'debit_card' | 'bank_transfer' | 'check' | 'cash' | 'other' | null;
  autoPay: boolean;
  paymentStatus: 'paid' | 'pending' | 'overdue';
  isActive: boolean;
  url: string | null;
  accountNumber: string | null;
  confirmationNumber: string | null;
  notes: string | null;
  createdAt: string;
  updatedAt: string;
}
```

**Bill Calendar Component:**

```
// src/components/bills/BillCalendar.tsx
import React, { useState, useMemo } from 'react';
import { ChevronLeft, ChevronRight } from 'lucide-react';
import { Card } from '@/components/common/Card';
import { Button } from '@/components/common/Button';
import { Badge } from '@/components/common/Badge';
import { formatCurrency, formatDate } from '@/lib/utils/formatters';
import { getDaysUntilDue } from '@/lib/utils/bills';
import { cn } from '@/lib/utils';
import type { Bill } from '@/types';

interface BillCalendarProps {
  bills: Bill[];
}

export function BillCalendar({ bills }: BillCalendarProps) {
  const [currentDate, setCurrentDate] = useState(new Date());

  const { year, month } = useMemo(() => ({
    year: currentDate.getFullYear(),
    month: currentDate.getMonth(),
  }), [currentDate]);

  const calendarData = useMemo(() => {
    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay(); // 0 = Sunday

    // Create array of dates
    const dates: Array<{
      date: number;
      month: number; // 0 = current, -1 = previous, 1 = next
      bills: Bill[];
    }> = [];

    // Add previous month's trailing days
    const prevMonthLastDay = new Date(year, month, 0).getDate();
    for (let i = startingDayOfWeek - 1; i >= 0; i--) {
      dates.push({
        date: prevMonthLastDay - i,
        month: -1,
        bills: [],
      });
    }

    // Add current month's days
    for (let date = 1; date <= daysInMonth; date++) {
      const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
      const dayBills = bills.filter(bill => {
        if (!bill.nextDueDate) return false;
        const billDate = new Date(bill.nextDueDate);
        return (
          billDate.getFullYear() === year &&
          billDate.getMonth() === month &&
          billDate.getDate() === date
        );
      });

      dates.push({
        date,
        month: 0,
        bills: dayBills,
      });
    }

    // Add next month's leading days to complete the grid
    const totalCells = Math.ceil(dates.length / 7) * 7;
    for (let i = 1; i <= totalCells - dates.length; i++) {
      dates.push({
        date: i,
        month: 1,
        bills: [],
      });
    }

    return dates;
  }, [bills, year, month]);

  const handlePrevMonth = () => {
    setCurrentDate(new Date(year, month - 1, 1));
  };

  const handleNextMonth = () => {
    setCurrentDate(new Date(year, month + 1, 1));
  };

  const handleToday = () => {
    setCurrentDate(new Date());
  };

  const monthName = new Date(year, month).toLocaleDateString('en-US', { 
    month: 'long',
    year: 'numeric'
  });

  const isToday = (date: number, monthOffset: number) => {
    const today = new Date();
    return (
      today.getFullYear() === year &&
      today.getMonth() === month + monthOffset &&
      today.getDate() === date
    );
  };

  return (
    <Card className="p-6">
      {/* Calendar Header */}
      <div className="flex items-center justify-between mb-6">
        <h2 className="text-xl font-bold text-gray-900">{monthName}</h2>
        
        <div className="flex items-center gap-2">
          <Button
            variant="outline"
            size="sm"
            onClick={handleToday}
          >
            Today
          </Button>
          <div className="flex">
            <Button
              variant="ghost"
              size="sm"
              icon={ChevronLeft}
              onClick={handlePrevMonth}
            />
            <Button
              variant="ghost"
              size="sm"
              icon={ChevronRight}
              onClick={handleNextMonth}
            />
          </div>
        </div>
      </div>

      {/* Calendar Grid */}
      <div className="grid grid-cols-7 gap-1">
        {/* Day headers */}
        {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
          <div
            key={day}
            className="text-center text-xs font-semibold text-gray-600 py-2"
          >
            {day}
          </div>
        ))}

        {/* Calendar dates */}
        {calendarData.map((cell, index) => (
          <CalendarCell
            key={index}
            date={cell.date}
            isCurrentMonth={cell.month === 0}
            isToday={isToday(cell.date, cell.month)}
            bills={cell.bills}
          />
        ))}
      </div>

      {/* Legend */}
      <div className="flex items-center gap-4 mt-6 pt-6 border-t border-gray-200 text-sm">
        <div className="flex items-center gap-2">
          <div className="w-3 h-3 bg-red-500 rounded-full" />
          <span className="text-gray-600">Overdue</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-3 h-3 bg-orange-500 rounded-full" />
          <span className="text-gray-600">Due Soon (≤7 days)</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-3 h-3 bg-blue-500 rounded-full" />
          <span className="text-gray-600">Upcoming</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-3 h-3 bg-green-500 rounded-full" />
          <span className="text-gray-600">Paid</span>
        </div>
      </div>
    </Card>
  );
}

interface CalendarCellProps {
  date: number;
  isCurrentMonth: boolean;
  isToday: boolean;
  bills: Bill[];
}

function CalendarCell({ date, isCurrentMonth, isToday, bills }: CalendarCellProps) {
  const [showPopover, setShowPopover] = useState(false);

  return (
    <div
      className={cn(
        'min-h-[100px] border border-gray-200 p-2 relative',
        isCurrentMonth ? 'bg-white' : 'bg-gray-50',
        isToday && 'ring-2 ring-blue-500 ring-inset'
      )}
      onMouseEnter={() => bills.length > 0 && setShowPopover(true)}
      onMouseLeave={() => setShowPopover(false)}
    >
      {/* Date number */}
      <div className={cn(
        'text-sm font-medium mb-1',
        isCurrentMonth ? 'text-gray-900' : 'text-gray-400',
        isToday && 'flex items-center justify-center w-6 h-6 bg-blue-500 text-white rounded-full'
      )}>
        {date}
      </div>

      {/* Bill indicators */}
      <div className="space-y-1">
        {bills.slice(0, 3).map((bill) => {
          const daysUntil = bill.nextDueDate ? getDaysUntilDue(bill.nextDueDate) : null;
          const color = 
            bill.paymentStatus === 'paid' ? 'bg-green-500' :
            daysUntil !== null && daysUntil < 0 ? 'bg-red-500' :
            daysUntil !== null && daysUntil <= 7 ? 'bg-orange-500' :
            'bg-blue-500';

          return (
            <div
              key={bill.id}
              className={cn(
                'text-xs px-1.5 py-0.5 rounded text-white truncate',
                color
              )}
            >
              {bill.billName}
            </div>
          );
        })}
        {bills.length > 3 && (
          <div className="text-xs text-gray-600 px-1.5">
            +{bills.length - 3} more
          </div>
        )}
      </div>

      {/* Popover */}
      {showPopover && bills.length > 0 && (
        <div className="absolute z-10 top-full left-0 mt-1 w-64 bg-white rounded-lg shadow-lg border border-gray-200 p-3">
          <div className="space-y-2">
            {bills.map((bill) => (
              <div key={bill.id} className="border-b border-gray-100 pb-2 last:border-0 last:pb-0">
                <p className="text-sm font-semibold text-gray-900">{bill.billName}</p>
                <div className="flex items-center justify-between mt-1">
                  <p className="text-xs text-gray-600">{formatCurrency(bill.amount)}</p>
                  <Badge
                    variant={
                      bill.paymentStatus === 'paid' ? 'success' :
                      bill.paymentStatus === 'overdue' ? 'danger' : 'warning'
                    }
                    size="sm"
                  >
                    {bill.paymentStatus}
                  </Badge>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
}
```

#### **5.6.2 Bill Detail View** {#5.6.2-bill-detail-view}

```
// src/pages/BillDetailPage.tsx
import React, { useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import {
  ArrowLeft,
  Edit,
  Trash2,
  Receipt,
  DollarSign,
  Calendar,
  Zap,
  AlertCircle,
  CheckCircle,
  CreditCard,
  ExternalLink,
} from 'lucide-react';
import { useBill, useDeleteBill, useMarkBillPaid } from '@/hooks/api/useBills';
import { Button } from '@/components/common/Button';
import { Card } from '@/components/common/Card';
import { Badge } from '@/components/common/Badge';
import { ConfirmDialog } from '@/components/common/ConfirmDialog';
import { Alert } from '@/components/common/Alert';
import { PaymentHistory } from '@/components/bills/BillPaymentHistory';
import { formatCurrency, formatDate } from '@/lib/utils/formatters';
import { getDaysUntilDue, getBillStatusInfo } from '@/lib/utils/bills';
import { Skeleton } from '@/components/common/Skeleton';

export function BillDetailPage() {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const { data: bill, isLoading, error } = useBill(id!);
  const { mutate: deleteBill } = useDeleteBill();
  const { mutate: markPaid } = useMarkBillPaid();
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);

  if (isLoading) {
    return <DetailSkeleton />;
  }

  if (error || !bill) {
    return (
      <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div className="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
          <p className="text-red-800">Bill not found</p>
          <Button
            variant="outline"
            className="mt-4"
            onClick={() => navigate('/bills')}
          >
            Back to Bills
          </Button>
        </div>
      </div>
    );
  }

  const handleDelete = () => {
    deleteBill(bill.id, {
      onSuccess: () => {
        navigate('/bills');
      },
    });
  };

  const handleMarkPaid = () => {
    markPaid(bill.id);
  };

  const statusInfo = getBillStatusInfo(bill);
  const daysUntil = bill.nextDueDate ? getDaysUntilDue(bill.nextDueDate) : null;

  return (
    <>
      <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Header */}
        <div className="flex items-center gap-4 mb-8">
          <Button
            variant="ghost"
            icon={ArrowLeft}
            onClick={() => navigate('/bills')}
          >
            Back
          </Button>

          <div className="flex-1">
            <h1 className="text-3xl font-bold text-gray-900">
              {bill.billName}
            </h1>
            {bill.payee && (
              <p className="text-gray-600 mt-1">{bill.payee}</p>
            )}
          </div>

          <div className="flex gap-2">
            {bill.paymentStatus !== 'paid' && (
              <Button
                variant="primary"
                icon={CheckCircle}
                onClick={handleMarkPaid}
              >
                Mark Paid
              </Button>
            )}
            <Button
              variant="outline"
              icon={Edit}
              onClick={() => navigate(`/bills/${bill.id}/edit`)}
            >
              Edit
            </Button>
            <Button
              variant="outline"
              icon={Trash2}
              onClick={() => setShowDeleteDialog(true)}
            >
              Delete
            </Button>
          </div>
        </div>

        {/* Alerts */}
        {bill.paymentStatus === 'overdue' && (
          <Alert variant="danger" className="mb-6">
            <AlertCircle className="h-4 w-4" />
            <div>
              <p className="font-semibold">Payment Overdue</p>
              <p className="text-sm mt-1">
                This bill was due on {formatDate(bill.nextDueDate!, 'MMM d, yyyy')}. 
                Please make payment as soon as possible.
              </p>
            </div>
          </Alert>
        )}

        {daysUntil !== null && daysUntil >= 0 && daysUntil <= 7 && bill.paymentStatus !== 'paid' && (
          <Alert variant="warning" className="mb-6">
            <AlertCircle className="h-4 w-4" />
            <div>
              <p className="font-semibold">Payment Due Soon</p>
              <p className="text-sm mt-1">
                This bill is due in {daysUntil} day{daysUntil !== 1 ? 's' : ''} on{' '}
                {formatDate(bill.nextDueDate!, 'MMM d, yyyy')}.
              </p>
            </div>
          </Alert>
        )}

        {/* Overview Card */}
        <Card className="p-6 mb-6">
          <div className="flex items-start justify-between mb-6">
            <div>
              <h2 className="text-lg font-semibold text-gray-900">Overview</h2>
              <div className="flex items-center gap-2 mt-2">
                <Badge variant={statusInfo.variant}>
                  {statusInfo.label}
                </Badge>
                {bill.autoPay && (
                  <Badge variant="info">
                    <Zap className="h-3 w-3 mr-1" />
                    Auto-pay
                  </Badge>
                )}
                {!bill.isActive && (
                  <Badge variant="secondary">Inactive</Badge>
                )}
              </div>
            </div>

            <div className="text-right">
              <p className="text-sm text-gray-600">Category</p>
              <p className="text-lg font-semibold text-gray-900 capitalize">
                {bill.category}
              </p>
            </div>
          </div>

          {/* Key Metrics */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div>
              <p className="text-sm text-gray-600 mb-2">Amount</p>
              <p className="text-3xl font-bold text-gray-900">
                {formatCurrency(bill.amount)}
              </p>
              <p className="text-sm text-gray-600 mt-1 capitalize">
                {bill.frequency.replace('_', '-')}
              </p>
            </div>

            {bill.nextDueDate && (
              <div>
                <p className="text-sm text-gray-600 mb-2">Next Due Date</p>
                <p className="text-2xl font-bold text-gray-900">
                  {formatDate(bill.nextDueDate, 'MMM d, yyyy')}
                </p>
                {daysUntil !== null && (
                  <p className="text-sm text-gray-600 mt-1">
                    {daysUntil < 0
                      ? `${Math.abs(daysUntil)} days overdue`
                      : daysUntil === 0
                      ? 'Due today'
                      : `In ${daysUntil} days`}
                  </p>
                )}
              </div>
            )}

            <div>
              <p className="text-sm text-gray-600 mb-2">Annual Cost</p>
              <p className="text-2xl font-bold text-gray-900">
                {formatCurrency(calculateAnnualCost(bill.amount, bill.frequency))}
              </p>
              <p className="text-sm text-gray-600 mt-1">
                Estimated yearly expense
              </p>
            </div>
          </div>

          {/* Payment Method */}
          {bill.paymentMethod && (
            <div className="p-4 bg-blue-50 rounded-lg">
              <div className="flex items-center gap-3">
                <CreditCard className="h-5 w-5 text-blue-600" />
                <div>
                  <p className="text-sm font-medium text-blue-900">Payment Method</p>
                  <p className="text-sm text-blue-700 capitalize">
                    {bill.paymentMethod.replace('_', ' ')}
                  </p>
                </div>
              </div>
            </div>
          )}
        </Card>

        {/* Payment Details */}
        <Card className="p-6 mb-6">
          <h2 className="text-lg font-semibold text-gray-900 mb-4">
            Payment Details
          </h2>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {bill.accountNumber && (
              <DetailRow label="Account Number" value={bill.accountNumber} />
            )}
            {bill.confirmationNumber && (
              <DetailRow label="Confirmation Number" value={bill.confirmationNumber} />
            )}
            {bill.url && (
              <div className="md:col-span-2">
                <p className="text-sm text-gray-600 mb-1">Website</p>
                
                  href={bill.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-sm text-blue-600 hover:text-blue-700 flex items-center gap-1"
                >
                  {bill.url}
                  <ExternalLink className="h-3 w-3" />
                </a>
              </div>
            )}
          </div>
        </Card>

        {/* Payment History */}
        <PaymentHistory billId={bill.id} />

        {/* Additional Details */}
        <Card className="p-6 mt-6">
          <h2 className="text-lg font-semibold text-gray-900 mb-4">
            Additional Details
          </h2>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <DetailRow
              label="Created"
              value={formatDate(bill.createdAt, 'MMM d, yyyy')}
            />
            <DetailRow
              label="Last Updated"
              value={formatDate(bill.updatedAt, 'MMM d, yyyy')}
            />
          </div>

          {bill.notes && (
            <div className="mt-6 pt-6 border-t border-gray-200">
              <p className="text-sm font-medium text-gray-900 mb-2">Notes</p>
              <p className="text-sm text-gray-600 whitespace-pre-wrap">
                {bill.notes}
              </p>
            </div>
          )}
        </Card>
      </div>

      {/* Delete Dialog */}
      <ConfirmDialog
        isOpen={showDeleteDialog}
        onClose={() => setShowDeleteDialog(false)}
        onConfirm={handleDelete}
        title="Delete Bill"
        description={`Are you sure you want to delete "${bill.billName}"? This action cannot be undone.`}
        confirmLabel="Delete"
        variant="danger"
      />
    </>
  );
}

interface DetailRowProps {
  label: string;
  value: string;
}

function DetailRow({ label, value }: DetailRowProps) {
  return (
    <div className="flex items-center justify-between py-2">
      <p className="text-sm text-gray-600">{label}</p>
      <p className="text-sm font-medium text-gray-900">{value}</p>
    </div>
  );
}

function calculateAnnualCost(amount: number, frequency: Bill['frequency']): number {
  switch (frequency) {
    case 'weekly':
      return amount * 52;
    case 'biweekly':
      return amount * 26;
    case 'monthly':
      return amount * 12;
    case 'quarterly':
      return amount * 4;
    case 'semi_annual':
      return amount * 2;
    case 'annual':
    case 'one_time':
      return amount;
    default:
      return 0;
  }
}

function DetailSkeleton() {
  return (
    <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <Skeleton className="h-12 w-64 mb-8" />
      <Skeleton className="h-64 rounded-lg mb-6" />
      <Skeleton className="h-48 rounded-lg mb-6" />
      <Skeleton className="h-96 rounded-lg mb-6" />
      <Skeleton className="h-48 rounded-lg" />
    </div>
  );
}
```

**Bill Payment History Component:**

```
// src/components/bills/BillPaymentHistory.tsx
import React, { useState } from 'react';
import { 
  History, 
  Calendar,
  Download,
  Filter,
  CheckCircle,
} from 'lucide-react';
import { Card } from '@/components/common/Card';
import { Button } from '@/components/common/Button';
import { Badge } from '@/components/common/Badge';
import { Select } from '@/components/common/Select';
import { EmptyState } from '@/components/common/EmptyState';
import { usePaymentHistory } from '@/hooks/api/usePayments';
import { formatCurrency, formatDate } from '@/lib/utils/formatters';

interface BillPaymentHistoryProps {
  billId: string;
  className?: string;
}

export function BillPaymentHistory({ billId, className }: BillPaymentHistoryProps) {
  const [timeRange, setTimeRange] = useState<'30d' | '90d' | '1y' | 'all'>('1y');
  const { data: payments, isLoading } = usePaymentHistory(billId, timeRange, 'bill');

  const handleExport = () => {
    if (!payments) return;

    const headers = ['Date', 'Amount', 'Method', 'Confirmation'];
    const rows = payments.map(p => [
      formatDate(p.paymentDate, 'yyyy-MM-dd'),
      p.amount.toString(),
      p.paymentMethod || '',
      p.confirmationNumber || '',
    ]);

    const csv = [
      headers.join(','),
      ...rows.map(row => row.join(','))
    ].join('\n');

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `bill-payment-history-${formatDate(new Date(), 'yyyy-MM-dd')}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
  };

  if (isLoading) {
    return (
      <Card className="p-6">
        <div className="animate-pulse space-y-4">
          {[...Array(5)].map((_, i) => (
            <div key={i} className="h-16 bg-gray-200 rounded" />
          ))}
        </div>
      </Card>
    );
  }

  const totalPaid = payments?.reduce((sum, p) => sum + p.amount, 0) || 0;

  return (
    <Card className="p-6">
      {/* Header */}
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-3">
          <div className="p-2 bg-purple-100 rounded-lg">
            <History className="h-5 w-5 text-purple-600" />
          </div>
          <div>
            <h2 className="text-lg font-semibold text-gray-900">
              Payment History
            </h2>
            {payments && payments.length > 0 && (
              <p className="text-sm text-gray-600">
                {payments.length} payment{payments.length !== 1 ? 's' : ''} • {formatCurrency(totalPaid)} total
              </p>
            )}
          </div>
        </div>

        <div className="flex items-center gap-2">
          <Select
            value={timeRange}
            onChange={(e) => setTimeRange(e.target.value as any)}
            icon={Filter}
            className="w-32"
          >
            <option value="30d">Last 30 days</option>
            <option value="90d">Last 90 days</option>
            <option value="1y">Last year</option>
            <option value="all">All time</option>
          </Select>

          {payments && payments.length > 0 && (
            <Button
              variant="outline"
              size="sm"
              icon={Download}
              onClick={handleExport}
            >
              Export
            </Button>
          )}
        </div>
      </div>

      {/* Payment List */}
      {!payments || payments.length === 0 ? (
        <EmptyState
          icon={History}
          title="No payment history"
          description="Payments you make will appear here"
        />
      ) : (
        <div className="space-y-3">
          {payments.map((payment) => (
            <PaymentItem key={payment.id} payment={payment} />
          ))}
        </div>
      )}
    </Card>
  );
}

interface PaymentItemProps {
  payment: any;
}

function PaymentItem({ payment }: PaymentItemProps) {
  return (
    <div className="flex items-center gap-4 p-4 hover:bg-gray-50 rounded-lg transition-colors">
      {/* Icon */}
      <div className="flex-shrink-0 w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
        <CheckCircle className="h-5 w-5 text-green-600" />
      </div>

      {/* Content */}
      <div className="flex-1 min-w-0">
        <div className="flex items-center gap-2 mb-1">
          <p className="text-sm font-medium text-gray-900">
            Payment Processed
          </p>
          {payment.paymentMethod && (
            <Badge variant="secondary" size="sm">
              {payment.paymentMethod}
            </Badge>
          )}
        </div>
        <div className="flex items-center gap-4 text-xs text-gray-600">
          <span className="flex items-center gap-1">
            <Calendar className="h-3 w-3" />
            {formatDate(payment.paymentDate, 'MMM d, yyyy')}
          </span>
          {payment.confirmationNumber && (
            <span>Conf: {payment.confirmationNumber}</span>
          )}
        </div>
      </div>

      {/* Amount */}
      <div className="text-right">
        <p className="text-lg font-semibold text-green-600">
          {formatCurrency(payment.amount)}
        </p>
      </div>
    </div>
  );
}
```

#### **5.6.3 Bill Form (Add/Edit)** {#5.6.3-bill-form-(add/edit)}

```
// src/pages/BillFormPage.tsx
import React, { useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useForm, Controller } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { ArrowLeft, Save, Loader2 } from 'lucide-react';
import {
  useBill,
  useCreateBill,
  useUpdateBill,
} from '@/hooks/api/useBills';
import { billSchema, type BillFormData } from '@/lib/schemas/bill.schema';
import { calculateNextDueDate } from '@/lib/utils/bills';
import { Button } from '@/components/common/Button';
import { Input } from '@/components/common/Input';
import { Select } from '@/components/common/Select';
import { Textarea } from '@/components/common/Textarea';
import { Checkbox } from '@/components/common/Checkbox';
import { CurrencyInput } from '@/components/common/CurrencyInput';
import { FormSection } from '@/components/common/FormSection';
import { Skeleton } from '@/components/common/Skeleton';

export function BillFormPage() {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const isEditMode = Boolean(id);

  const { data: bill, isLoading } = useBill(id!, { enabled: isEditMode });
  const createMutation = useCreateBill();
  const updateMutation = useUpdateBill();

  const {
    register,
    control,
    handleSubmit,
    watch,
    setValue,
    formState: { errors, isSubmitting },
  } = useForm<BillFormData>({
    resolver: zodResolver(billSchema),
    defaultValues: {
      isActive: true,
      autoPay: false,
      paymentStatus: 'pending',
    },
  });

  // Populate form when editing
  useEffect(() => {
    if (bill && isEditMode) {
      setValue('billName', bill.billName);
      setValue('payee', bill.payee || '');
      setValue('category', bill.category);
      setValue('amount', bill.amount);
      setValue('frequency', bill.frequency);
      setValue('nextDueDate', bill.nextDueDate || '');
      setValue('paymentMethod', bill.paymentMethod || '');
      setValue('autoPay', bill.autoPay);
      setValue('paymentStatus', bill.paymentStatus);
      setValue('isActive', bill.isActive);
      setValue('url', bill.url || '');
      setValue('accountNumber', bill.accountNumber || '');
      setValue('confirmationNumber', bill.confirmationNumber || '');
      setValue('notes', bill.notes || '');
    }
  }, [bill, isEditMode, setValue]);

  // Watch frequency to auto-calculate next due date
  const frequency = watch('frequency');
  const nextDueDate = watch('nextDueDate');

  const onSubmit = async (data: BillFormData) => {
    try {
      // Auto-calculate next due date if not provided
      if (!data.nextDueDate && data.frequency !== 'one_time') {
        const today = new Date().toISOString().split('T')[0];
        data.nextDueDate = calculateNextDueDate(today, data.frequency) || '';
      }

      if (isEditMode && id) {
        await updateMutation.mutateAsync({ id, data });
      } else {
        await createMutation.mutateAsync(data);
      }
      navigate('/bills');
    } catch (error) {
      console.error('Failed to save bill:', error);
    }
  };

  if (isLoading && isEditMode) {
    return <FormSkeleton />;
  }

  return (
    <div className="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {/* Header */}
      <div className="flex items-center gap-4 mb-8">
        <Button
          variant="ghost"
          icon={ArrowLeft}
          onClick={() => navigate('/bills')}
        >
          Back
        </Button>

        <div className="flex-1">
          <h1 className="text-3xl font-bold text-gray-900">
            {isEditMode ? 'Edit Bill' : 'Add Bill'}
          </h1>
          <p className="text-gray-600 mt-1">
            {isEditMode
              ? 'Update your bill information'
              : 'Add a new bill to track'}
          </p>
        </div>
      </div>

      {/* Form */}
      <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
        {/* Basic Information */}
        <FormSection
          title="Basic Information"
          description="Enter the basic details about your bill"
        >
          <div className="space-y-4">
            <Input
              {...register('billName')}
              label="Bill Name"
              placeholder="Netflix Subscription"
              error={errors.billName?.message}
              required
              helpText="A friendly name to identify this bill"
            />

            <Input
              {...register('payee')}
              label="Payee/Company"
              placeholder="Netflix, Inc."
              error={errors.payee?.message}
              helpText="Who you're paying"
            />

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <Select
                {...register('category')}
                label="Category"
                error={errors.category?.message}
                required
              >
                <option value="">Select category</option>
                <option value="utilities">Utilities</option>
                <option value="subscriptions">Subscriptions</option>
                <option value="insurance">Insurance</option>
                <option value="loans">Loans</option>
                <option value="rent">Rent/Mortgage</option>
                <option value="healthcare">Healthcare</option>
                <option value="education">Education</option>
                <option value="memberships">Memberships</option>
                <option value="other">Other</option>
              </Select>

              <Controller
                name="amount"
                control={control}
                render={({ field }) => (
                  <CurrencyInput
                    {...field}
                    label="Amount"
                    error={errors.amount?.message}
                    required
                  />
                )}
              />
            </div>
          </div>
        </FormSection>

        {/* Billing Schedule */}
        <FormSection
          title="Billing Schedule"
          description="Set up your billing frequency and due dates"
        >
          <div className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <Select
                {...register('frequency')}
                label="Frequency"
                error={errors.frequency?.message}
                required
              >
                <option value="">Select frequency</option>
                <option value="weekly">Weekly</option>
                <option value="biweekly">Bi-weekly</option>
                <option value="monthly">Monthly</option>
                <option value="quarterly">Quarterly</option>
                <option value="semi_annual">Semi-annual</option>
                <option value="annual">Annual</option>
                <option value="one_time">One-time</option>
              </Select>

              <Input
                {...register('nextDueDate')}
                type="date"
                label="Next Due Date"
                error={errors.nextDueDate?.message}
                helpText={frequency === 'one_time' ? 'Due date for payment' : 'Next occurrence'}
              />
            </div>

            <Checkbox
              {...register('isActive')}
              label="This bill is active"
              helpText="Uncheck to pause tracking this bill"
            />
          </div>
        </FormSection>

        {/* Payment Information */}
        <FormSection
          title="Payment Information"
          description="How you pay this bill"
        >
          <div className="space-y-4">
            <Select
              {...register('paymentMethod')}
              label="Payment Method"
              error={errors.paymentMethod?.message}
            >
              <option value="">Select method</option>
              <option value="auto_pay">Auto-pay</option>
              <option value="manual">Manual Payment</option>
              <option value="credit_card">Credit Card</option>
              <option value="debit_card">Debit Card</option>
              <option value="bank_transfer">Bank Transfer</option>
              <option value="check">Check</option>
              <option value="cash">Cash</option>
              <option value="other">Other</option>
            </Select>

            <Checkbox
              {...register('autoPay')}
              label="Auto-pay is enabled"
              helpText="Payment is automatically deducted"
            />

            <Select
              {...register('paymentStatus')}
              label="Payment Status"
              error={errors.paymentStatus?.message}
              required
            >
              <option value="paid">Paid</option>
              <option value="pending">Pending</option>
              <option value="overdue">Overdue</option>
            </Select>
          </div>
        </FormSection>

        {/* Account Details */}
        <FormSection
          title="Account Details"
          description="Optional account and reference information"
        >
          <div className="space-y-4">
            <Input
              {...register('accountNumber')}
              label="Account Number"
              placeholder="123456789"
              error={errors.accountNumber?.message}
              helpText="For your reference only"
            />

            <Input
              {...register('confirmationNumber')}
              label="Confirmation Number"
              placeholder="CONF-12345"
              error={errors.confirmationNumber?.message}
              helpText="Payment confirmation or reference number"
            />

            <Input
              {...register('url')}
              type="url"
              label="Website URL"
              placeholder="https://www.example.com"
              error={errors.url?.message}
              helpText="Link to payment portal or bill website"
            />
          </div>
        </FormSection>

        {/* Notes */}
        <FormSection
          title="Notes"
          description="Add any additional notes or reminders"
        >
          <Textarea
            {...register('notes')}
            label="Notes"
            placeholder="Add any notes about this bill..."
            rows={4}
            error={errors.notes?.message}
            maxLength={1000}
            showCount
          />
        </FormSection>

        {/* Form Actions */}
        <div className="flex items-center justify-end gap-4 pt-6 border-t border-gray-200">
          <Button
            type="button"
            variant="outline"
            onClick={() => navigate('/bills')}
          >
            Cancel
          </Button>

          <Button
            type="submit"
            variant="primary"
            disabled={isSubmitting}
            icon={isSubmitting ? Loader2 : Save}
            iconAnimation={isSubmitting ? 'spin' : undefined}
          >
            {isSubmitting
              ? 'Saving...'
              : isEditMode
              ? 'Update Bill'
              : 'Add Bill'}
          </Button>
        </div>
      </form>
    </div>
  );
}

function FormSkeleton() {
  return (
    <div className="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <Skeleton className="h-12 w-64 mb-8" />
      {[...Array(5)].map((_, i) => (
        <div key={i} className="mb-6">
          <Skeleton className="h-6 w-48 mb-4" />
          <div className="grid grid-cols-2 gap-4">
            <Skeleton className="h-10 rounded" />
            <Skeleton className="h-10 rounded" />
          </div>
        </div>
      ))}
    </div>
  );
}
```

**Bill Schema:**

```ts
// src/lib/schemas/bill.schema.ts
import { z } from 'zod';

export const billSchema = z.object({
  // Basic Information
  billName: z
    .string()
    .min(1, 'Bill name is required')
    .max(255, 'Bill name must be less than 255 characters'),
  
  payee: z
    .string()
    .max(100, 'Payee name must be less than 100 characters')
    .optional()
    .or(z.literal('')),
  
  category: z.enum([
    'utilities',
    'subscriptions',
    'insurance',
    'loans',
    'rent',
    'healthcare',
    'education',
    'memberships',
    'other'
  ]),
  
  amount: z
    .number()
    .min(0.01, 'Amount must be greater than 0')
    .max(1000000, 'Amount seems unreasonably high'),
  
  // Schedule
  frequency: z.enum([
    'weekly',
    'biweekly',
    'monthly',
    'quarterly',
    'semi_annual',
    'annual',
    'one_time'
  ]),
  
  nextDueDate: z
    .string()
    .regex(/^\d{4}-\d{2}-\d{2}$/, 'Invalid date format')
    .optional()
    .or(z.literal('')),
  
  // Payment
  paymentMethod: z
    .enum([
      'auto_pay',
      'manual',
      'credit_card',
      'debit_card',
      'bank_transfer',
      'check',
      'cash',
      'other'
    ])
    .optional()
    .or(z.literal('')),
  
  autoPay: z.boolean().optional(),
  
  paymentStatus: z.enum(['paid', 'pending', 'overdue']),
  
  isActive: z.boolean().optional(),
  
  // Account Details
  accountNumber: z
    .string()
    .max(50, 'Account number must be less than 50 characters')
    .optional()
    .or(z.literal('')),
  
  confirmationNumber: z
    .string()
    .max(100, 'Confirmation number must be less than 100 characters')
    .optional()
    .or(z.literal('')),
  
  url: z
    .string()
    .url('Must be a valid URL')
    .optional()
    .or(z.literal('')),
  
  // Notes
  notes: z
    .string()
    .max(1000, 'Notes must be less than 1000 characters')
    .optional()
    .or(z.literal('')),
});

export type BillFormData = z.infer<typeof billSchema>;
```

### **5.7 Goals Tracker** {#5.7-goals-tracker}

#### **5.7.1 Goals List View** {#5.7.1-goals-list-view}

**Purpose:** Display financial goals with progress tracking and milestone management

**User Story:** As a user, I want to track my financial goals so that I can stay motivated and monitor my progress toward achieving them

**Layout:**

```
┌─────────────────────────────────────────────────────────┐
│  Goals Header + Add New Button                         │
├─────────────────────────────────────────────────────────┤
│  Summary Stats (Total Goals, In Progress, Achieved)    │
├─────────────────────────────────────────────────────────┤
│  Filters & Sort Controls                               │
├─────────────────────────────────────────────────────────┤
│  ┌───────────────────┐ ┌───────────────────┐           │
│  │  Emergency Fund   │ │  Vacation 2026    │           │
│  │  $15,000 goal     │ │  $5,000 goal      │           │
│  │  $8,500 saved     │ │  $2,100 saved     │           │
│  │  ▓▓▓▓▓▓░░░░ 57%  │ │  ▓▓▓░░░░░░░ 42%  │           │
│  │  Due: Dec 2025    │ │  Due: Jun 2026    │           │
│  └───────────────────┘ └───────────────────┘           │
│  ┌───────────────────┐ ┌───────────────────┐           │
│  │  Down Payment     │ │  New Car          │           │
│  │  $50,000 goal     │ │  $30,000 goal     │           │
│  │  $12,000 saved    │ │  $30,000 saved    │           │
│  │  ▓▓░░░░░░░░ 24%  │ │  ▓▓▓▓▓▓▓▓▓▓ 100% │           │
│  └───────────────────┘ └───────────────────┘           │
└─────────────────────────────────────────────────────────┘
```

**Component Implementation:**

```
// src/pages/GoalsPage.tsx
import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { Plus, Target } from 'lucide-react';
import { useGoals } from '@/hooks/api/useGoals';
import { Button } from '@/components/common/Button';
import { GoalStats } from '@/components/goals/GoalStats';
import { GoalFilters } from '@/components/goals/GoalFilters';
import { GoalList } from '@/components/goals/GoalList';
import { EmptyState } from '@/components/common/EmptyState';
import { Skeleton } from '@/components/common/Skeleton';
import type { GoalFilters as Filters, GoalSortBy } from '@/types';

export function GoalsPage() {
  const navigate = useNavigate();
  const { data: goals, isLoading, error } = useGoals();

  const [filters, setFilters] = useState<Filters>({
    category: 'all',
    status: 'all',
    search: '',
  });

  const [sortBy, setSortBy] = useState<GoalSortBy>('progress_desc');

  if (isLoading) {
    return <GoalsSkeleton />;
  }

  if (error) {
    return (
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div className="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
          <p className="text-red-800">Failed to load goals. Please try again.</p>
        </div>
      </div>
    );
  }

  if (!goals || goals.length === 0) {
    return (
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <EmptyState
          icon={Target}
          title="No goals yet"
          description="Set your first financial goal and start tracking your progress"
          action={{
            label: 'Create Goal',
            onClick: () => navigate('/goals/new'),
          }}
        />
      </div>
    );
  }

  // Filter goals
  let filteredGoals = goals;

  if (filters.category !== 'all') {
    filteredGoals = filteredGoals.filter(g => g.category === filters.category);
  }

  if (filters.status !== 'all') {
    filteredGoals = filteredGoals.filter(g => g.status === filters.status);
  }

  if (filters.search) {
    const search = filters.search.toLowerCase();
    filteredGoals = filteredGoals.filter(g =>
      g.goalName.toLowerCase().includes(search) ||
      g.description?.toLowerCase().includes(search)
    );
  }

  // Sort goals
  const sortedGoals = [...filteredGoals].sort((a, b) => {
    switch (sortBy) {
      case 'progress_desc':
        return b.progressPercentage - a.progressPercentage;
      case 'progress_asc':
        return a.progressPercentage - b.progressPercentage;
      case 'target_desc':
        return b.targetAmount - a.targetAmount;
      case 'target_asc':
        return a.targetAmount - b.targetAmount;
      case 'deadline_asc':
        return (a.targetDate || '9999-12-31').localeCompare(b.targetDate || '9999-12-31');
      case 'deadline_desc':
        return (b.targetDate || '0000-01-01').localeCompare(a.targetDate || '0000-01-01');
      case 'name_asc':
        return a.goalName.localeCompare(b.goalName);
      case 'name_desc':
        return b.goalName.localeCompare(a.goalName);
      default:
        return 0;
    }
  });

  return (
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {/* Header */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">Goals</h1>
          <p className="text-gray-600 mt-1">
            Track your financial goals and celebrate your progress
          </p>
        </div>

        <Button
          variant="primary"
          icon={Plus}
          onClick={() => navigate('/goals/new')}
        >
          Create Goal
        </Button>
      </div>

      {/* Summary Stats */}
      <GoalStats goals={goals} className="mb-8" />

      {/* Filters */}
      <GoalFilters
        filters={filters}
        sortBy={sortBy}
        onFiltersChange={setFilters}
        onSortChange={setSortBy}
        className="mb-6"
      />

      {/* Goals List */}
      {sortedGoals.length === 0 ? (
        <div className="bg-gray-50 rounded-lg p-8 text-center">
          <p className="text-gray-600">No goals match your filters</p>
        </div>
      ) : (
        <GoalList goals={sortedGoals} />
      )}
    </div>
  );
}

function GoalsSkeleton() {
  return (
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <Skeleton className="h-12 w-64 mb-8" />
      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
        {[...Array(3)].map((_, i) => (
          <Skeleton key={i} className="h-24 rounded-lg" />
        ))}
      </div>
      <Skeleton className="h-12 w-full mb-6" />
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {[...Array(6)].map((_, i) => (
          <Skeleton key={i} className="h-64 rounded-lg" />
        ))}
      </div>
    </div>
  );
}
```

**Goal Stats Component:**

```
// src/components/goals/GoalStats.tsx
import React, { useMemo } from 'react';
import { Target, TrendingUp, CheckCircle } from 'lucide-react';
import { Card } from '@/components/common/Card';
import { formatCurrency } from '@/lib/utils/formatters';
import { cn } from '@/lib/utils';
import type { Goal } from '@/types';

interface GoalStatsProps {
  goals: Goal[];
  className?: string;
}

export function GoalStats({ goals, className }: GoalStatsProps) {
  const stats = useMemo(() => {
    const activeGoals = goals.filter(g => g.status !== 'archived');
    const inProgressGoals = goals.filter(g => g.status === 'in_progress');
    const achievedGoals = goals.filter(g => g.status === 'achieved');

    const totalTarget = activeGoals.reduce((sum, g) => sum + g.targetAmount, 0);
    const totalSaved = activeGoals.reduce((sum, g) => sum + g.currentAmount, 0);
    const overallProgress = totalTarget > 0 ? (totalSaved / totalTarget) * 100 : 0;

    return {
      totalGoals: activeGoals.length,
      inProgress: inProgressGoals.length,
      achieved: achievedGoals.length,
      totalTarget,
      totalSaved,
      overallProgress,
    };
  }, [goals]);

  const statItems = [
    {
      label: 'Total Goals',
      value: stats.totalGoals.toString(),
      subValue: `${formatCurrency(stats.totalSaved)} of ${formatCurrency(stats.totalTarget)}`,
      icon: Target,
      color: 'blue',
    },
    {
      label: 'In Progress',
      value: stats.inProgress.toString(),
      subValue: `${stats.overallProgress.toFixed(1)}% overall progress`,
      icon: TrendingUp,
      color: 'orange',
    },
    {
      label: 'Achieved',
      value: stats.achieved.toString(),
      subValue: stats.achieved > 0 ? 'Celebrate your wins!' : 'Keep working toward your goals',
      icon: CheckCircle,
      color: 'green',
    },
  ];

  return (
    <div className={cn('grid grid-cols-1 sm:grid-cols-3 gap-4', className)}>
      {statItems.map((stat) => (
        <StatCard key={stat.label} {...stat} />
      ))}
    </div>
  );
}

interface StatCardProps {
  label: string;
  value: string;
  subValue: string;
  icon: React.ElementType;
  color: string;
}

function StatCard({ label, value, subValue, icon: Icon, color }: StatCardProps) {
  const colorClasses = {
    blue: 'bg-blue-100 text-blue-600',
    orange: 'bg-orange-100 text-orange-600',
    green: 'bg-green-100 text-green-600',
  };

  return (
    <Card className="p-6">
      <div className="flex items-start justify-between">
        <div>
          <p className="text-sm text-gray-600 font-medium">{label}</p>
          <p className="text-2xl font-bold text-gray-900 mt-1">{value}</p>
          <p className="text-xs text-gray-500 mt-1">{subValue}</p>
        </div>
        <div className={cn(
          'p-2 rounded-lg',
          colorClasses[color as keyof typeof colorClasses]
        )}>
          <Icon className="h-5 w-5" />
        </div>
      </div>
    </Card>
  );
}
```

**Goal Filters Component:**

```
// src/components/goals/GoalFilters.tsx
import React from 'react';
import { Search, SlidersHorizontal } from 'lucide-react';
import { Input } from '@/components/common/Input';
import { Select } from '@/components/common/Select';
import { cn } from '@/lib/utils';
import type { GoalFilters as Filters, GoalSortBy } from '@/types';

interface GoalFiltersProps {
  filters: Filters;
  sortBy: GoalSortBy;
  onFiltersChange: (filters: Filters) => void;
  onSortChange: (sortBy: GoalSortBy) => void;
  className?: string;
}

export function GoalFilters({
  filters,
  sortBy,
  onFiltersChange,
  onSortChange,
  className,
}: GoalFiltersProps) {
  return (
    <div className={cn('flex flex-col sm:flex-row gap-4', className)}>
      {/* Search */}
      <div className="flex-1">
        <Input
          placeholder="Search goals..."
          icon={Search}
          value={filters.search}
          onChange={(e) => onFiltersChange({ ...filters, search: e.target.value })}
        />
      </div>

      {/* Category Filter */}
      <Select
        value={filters.category}
        onChange={(e) => onFiltersChange({ ...filters, category: e.target.value as any })}
        className="w-full sm:w-48"
      >
        <option value="all">All Categories</option>
        <option value="emergency_fund">Emergency Fund</option>
        <option value="savings">Savings</option>
        <option value="debt_payoff">Debt Payoff</option>
        <option value="investment">Investment</option>
        <option value="purchase">Large Purchase</option>
        <option value="retirement">Retirement</option>
        <option value="education">Education</option>
        <option value="other">Other</option>
      </Select>

      {/* Status Filter */}
      <Select
        value={filters.status}
        onChange={(e) => onFiltersChange({ ...filters, status: e.target.value as any })}
        className="w-full sm:w-40"
      >
        <option value="all">All Status</option>
        <option value="in_progress">In Progress</option>
        <option value="achieved">Achieved</option>
        <option value="on_hold">On Hold</option>
        <option value="archived">Archived</option>
      </Select>

      {/* Sort */}
      <Select
        value={sortBy}
        onChange={(e) => onSortChange(e.target.value as GoalSortBy)}
        icon={SlidersHorizontal}
        className="w-full sm:w-56"
      >
        <option value="progress_desc">Most Progress</option>
        <option value="progress_asc">Least Progress</option>
        <option value="target_desc">Highest Target</option>
        <option value="target_asc">Lowest Target</option>
        <option value="deadline_asc">Soonest Deadline</option>
        <option value="deadline_desc">Latest Deadline</option>
        <option value="name_asc">Name (A-Z)</option>
        <option value="name_desc">Name (Z-A)</option>
      </Select>
    </div>
  );
}
```

**Goal List and Card Components:**

```
// src/components/goals/GoalList.tsx
import React from 'react';
import { GoalCard } from './GoalCard';
import type { Goal } from '@/types';

interface GoalListProps {
  goals: Goal[];
}

export function GoalList({ goals }: GoalListProps) {
  return (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {goals.map((goal) => (
        <GoalCard key={goal.id} goal={goal} />
      ))}
    </div>
  );
}
```

```
// src/components/goals/GoalCard.tsx
import React, { useState } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import {
  Target,
  MoreVertical,
  Edit,
  Trash2,
  Eye,
  Calendar,
  TrendingUp,
  CheckCircle,
  Pause,
  Archive,
} from 'lucide-react';
import { Card } from '@/components/common/Card';
import { Badge } from '@/components/common/Badge';
import { DropdownMenu } from '@/components/common/DropdownMenu';
import { ProgressBar } from '@/components/common/ProgressBar';
import { ConfirmDialog } from '@/components/common/ConfirmDialog';
import { useDeleteGoal, useUpdateGoalStatus } from '@/hooks/api/useGoals';
import { formatCurrency, formatDate, formatPercentage } from '@/lib/utils/formatters';
import { getDaysUntilDate } from '@/lib/utils/dates';
import { cn } from '@/lib/utils';
import type { Goal } from '@/types';

interface GoalCardProps {
  goal: Goal;
}

export function GoalCard({ goal }: GoalCardProps) {
  const navigate = useNavigate();
  const { mutate: deleteGoal } = useDeleteGoal();
  const { mutate: updateStatus } = useUpdateGoalStatus();
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);

  const getCategoryColor = (category: string) => {
    const colors: Record<string, string> = {
      emergency_fund: 'red',
      savings: 'blue',
      debt_payoff: 'orange',
      investment: 'purple',
      purchase: 'green',
      retirement: 'indigo',
      education: 'pink',
      other: 'gray',
    };
    return colors[category] || 'gray';
  };

  const categoryColor = getCategoryColor(goal.category);

  const getStatusBadge = () => {
    switch (goal.status) {
      case 'in_progress':
        return <Badge variant="info">In Progress</Badge>;
      case 'achieved':
        return <Badge variant="success">Achieved</Badge>;
      case 'on_hold':
        return <Badge variant="warning">On Hold</Badge>;
      case 'archived':
        return <Badge variant="secondary">Archived</Badge>;
      default:
        return null;
    }
  };

  const getProgressColor = (percentage: number) => {
    if (percentage >= 100) return 'success';
    if (percentage >= 75) return 'info';
    if (percentage >= 50) return 'warning';
    return 'danger';
  };

  const daysUntil = goal.targetDate ? getDaysUntilDate(goal.targetDate) : null;

  const handleDelete = () => {
    deleteGoal(goal.id, {
      onSuccess: () => {
        setShowDeleteDialog(false);
      },
    });
  };

  const handleMarkAchieved = () => {
    updateStatus({ id: goal.id, status: 'achieved' });
  };

  const handleToggleHold = () => {
    updateStatus({
      id: goal.id,
      status: goal.status === 'on_hold' ? 'in_progress' : 'on_hold',
    });
  };

  const menuItems = [
    {
      label: 'View Details',
      icon: Eye,
      onClick: () => navigate(`/goals/${goal.id}`),
    },
    {
      label: 'Edit',
      icon: Edit,
      onClick: () => navigate(`/goals/${goal.id}/edit`),
    },
    ...(goal.status !== 'achieved' ? [{
      label: 'Mark as Achieved',
      icon: CheckCircle,
      onClick: handleMarkAchieved,
    }] : []),
    {
      label: goal.status === 'on_hold' ? 'Resume' : 'Put on Hold',
      icon: Pause,
      onClick: handleToggleHold,
    },
    {
      type: 'divider' as const,
    },
    {
      label: 'Delete',
      icon: Trash2,
      onClick: () => setShowDeleteDialog(true),
      variant: 'danger' as const,
    },
  ];

  return (
    <>
      <Card className="overflow-hidden hover:shadow-lg transition-shadow">
        {/* Card Header */}
        <div
          className="p-6 text-white"
          style={{
            background: `linear-gradient(to bottom right, ${getCategoryGradientColor(categoryColor, 500)}, ${getCategoryGradientColor(categoryColor, 600)})`,
          }}
        >
          <div className="flex items-start justify-between mb-4">
            <div className="flex items-center gap-2">
              <Target className="h-5 w-5" />
              <span className="text-xs font-medium opacity-90 capitalize">
                {goal.category.replace('_', ' ')}
              </span>
            </div>
            <DropdownMenu items={menuItems} trigger={
              <button className="text-white hover:bg-white/20 p-1 rounded transition-colors">
                <MoreVertical className="h-5 w-5" />
              </button>
            } />
          </div>

          <h3 className="text-xl font-bold mb-1">{goal.goalName}</h3>
          {goal.description && (
            <p className="text-sm opacity-90 line-clamp-2">{goal.description}</p>
          )}
        </div>

        {/* Card Body */}
        <div className="p-6">
          {/* Status Badge */}
          <div className="mb-4">
            {getStatusBadge()}
          </div>

          {/* Target Amount */}
          <div className="mb-4">
            <p className="text-sm text-gray-600 mb-1">Target Amount</p>
            <p className="text-2xl font-bold text-gray-900">
              {formatCurrency(goal.targetAmount)}
            </p>
          </div>

          {/* Progress */}
          <div className="mb-4">
            <div className="flex items-center justify-between text-sm mb-2">
              <span className="text-gray-600">Progress</span>
              <span className="font-semibold text-gray-900">
                {formatCurrency(goal.currentAmount)}
              </span>
            </div>
            <ProgressBar
              value={goal.progressPercentage}
              max={100}
              variant={getProgressColor(goal.progressPercentage)}
              className="mb-2"
            />
            <div className="flex items-center justify-between text-xs">
              <span className="text-gray-600">
                {formatPercentage(goal.progressPercentage)} complete
              </span>
              <span className="text-gray-600">
                {formatCurrency(goal.remainingAmount)} to go
              </span>
            </div>
          </div>

          {/* Target Date */}
          {goal.targetDate && (
            <div className="p-3 bg-gray-50 rounded-lg">
              <div className="flex items-center gap-2 mb-1">
                <Calendar className="h-4 w-4 text-gray-600" />
                <p className="text-sm font-medium text-gray-900">Target Date</p>
              </div>
              <p className="text-sm text-gray-900">
                {formatDate(goal.targetDate, 'MMM d, yyyy')}
              </p>
              {daysUntil !== null && goal.status !== 'achieved' && (
                <p className={cn(
                  'text-xs mt-1',
                  daysUntil < 0 ? 'text-red-600' :
                  daysUntil <= 30 ? 'text-orange-600' :
                  'text-gray-600'
                )}>
                  {daysUntil < 0
                    ? `${Math.abs(daysUntil)} days overdue`
                    : daysUntil === 0
                    ? 'Target date today'
                    : `${daysUntil} days remaining`}
                </p>
              )}
            </div>
          )}

          {/* Monthly Contribution */}
          {goal.monthlyContribution > 0 && (
            <div className="mt-4 pt-4 border-t border-gray-200">
              <div className="flex items-center justify-between text-sm">
                <span className="text-gray-600">Monthly Contribution</span>
                <span className="font-semibold text-gray-900">
                  {formatCurrency(goal.monthlyContribution)}
                </span>
              </div>
            </div>
          )}

          {/* View Details Link */}
          <Link
            to={`/goals/${goal.id}`}
            className="block mt-4 text-center text-sm text-blue-600 hover:text-blue-700 font-medium"
          >
            View Details →
          </Link>
        </div>
      </Card>

      {/* Delete Confirmation Dialog */}
      <ConfirmDialog
        isOpen={showDeleteDialog}
        onClose={() => setShowDeleteDialog(false)}
        onConfirm={handleDelete}
        title="Delete Goal"
        description={`Are you sure you want to delete "${goal.goalName}"? This action cannot be undone.`}
        confirmLabel="Delete"
        variant="danger"
      />
    </>
  );
}

// Helper function to get gradient colors
function getCategoryGradientColor(color: string, shade: number): string {
  const colors: Record<string, Record<number, string>> = {
    red: { 500: '#ef4444', 600: '#dc2626' },
    blue: { 500: '#3b82f6', 600: '#2563eb' },
    orange: { 500: '#f97316', 600: '#ea580c' },
    purple: { 500: '#a855f7', 600: '#9333ea' },
    green: { 500: '#22c55e', 600: '#16a34a' },
    indigo: { 500: '#6366f1', 600: '#4f46e5' },
    pink: { 500: '#ec4899', 600: '#db2777' },
    gray: { 500: '#6b7280', 600: '#4b5563' },
  };
  return colors[color]?.[shade] || colors.gray[shade];
}
```

**Date Utilities:**

```ts
// src/lib/utils/dates.ts
export function getDaysUntilDate(targetDate: string): number {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  const target = new Date(targetDate);
  target.setHours(0, 0, 0, 0);
  
  const diffTime = target.getTime() - today.getTime();
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  return diffDays;
}

export function addMonths(date: Date, months: number): Date {
  const result = new Date(date);
  result.setMonth(result.getMonth() + months);
  return result;
}

export function getMonthsBetween(startDate: string, endDate: string): number {
  const start = new Date(startDate);
  const end = new Date(endDate);
  
  const months = (end.getFullYear() - start.getFullYear()) * 12 +
    (end.getMonth() - start.getMonth());
  
  return Math.max(0, months);
}
```

**Type Definitions:**

```ts
// Add to src/types/index.ts

export interface GoalFilters {
  category: 'all' | Goal['category'];
  status: 'all' | Goal['status'];
  search: string;
}

export type GoalSortBy = 
  | 'progress_desc'
  | 'progress_asc'
  | 'target_desc'
  | 'target_asc'
  | 'deadline_asc'
  | 'deadline_desc'
  | 'name_asc'
  | 'name_desc';

export interface Goal {
  id: string;
  userId: string;
  goalName: string;
  description: string | null;
  category: 'emergency_fund' | 'savings' | 'debt_payoff' | 'investment' | 'purchase' | 'retirement' | 'education' | 'other';
  targetAmount: number;
  currentAmount: number;
  remainingAmount: number;
  progressPercentage: number;
  monthlyContribution: number;
  targetDate: string | null;
  status: 'in_progress' | 'achieved' | 'on_hold' | 'archived';
  priority: 'low' | 'medium' | 'high';
  milestones: GoalMilestone[];
  createdAt: string;
  updatedAt: string;
}

export interface GoalMilestone {
  id: string;
  goalId: string;
  name: string;
  targetAmount: number;
  isCompleted: boolean;
  completedAt: string | null;
  order: number;
  createdAt: string;
}
```

#### **5.7.2 Goal Detail View** {#5.7.2-goal-detail-view}

```
// src/pages/GoalDetailPage.tsx
import React, { useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import {
  ArrowLeft,
  Edit,
  Trash2,
  Target,
  TrendingUp,
  Calendar,
  DollarSign,
  CheckCircle,
  Plus,
  AlertCircle,
} from 'lucide-react';
import { useGoal, useDeleteGoal, useUpdateGoalStatus } from '@/hooks/api/useGoals';
import { Button } from '@/components/common/Button';
import { Card } from '@/components/common/Card';
import { Badge } from '@/components/common/Badge';
import { ProgressBar } from '@/components/common/ProgressBar';
import { ConfirmDialog } from '@/components/common/ConfirmDialog';
import { Alert } from '@/components/common/Alert';
import { GoalMilestones } from '@/components/goals/GoalMilestones';
import { GoalProgressChart } from '@/components/goals/GoalProgressChart';
import { GoalContributionCalculator } from '@/components/goals/GoalContributionCalculator';
import { formatCurrency, formatDate, formatPercentage } from '@/lib/utils/formatters';
import { getDaysUntilDate, getMonthsBetween } from '@/lib/utils/dates';
import { Skeleton } from '@/components/common/Skeleton';

export function GoalDetailPage() {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const { data: goal, isLoading, error } = useGoal(id!);
  const { mutate: deleteGoal } = useDeleteGoal();
  const { mutate: updateStatus } = useUpdateGoalStatus();
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);

  if (isLoading) {
    return <DetailSkeleton />;
  }

  if (error || !goal) {
    return (
      <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div className="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
          <p className="text-red-800">Goal not found</p>
          <Button
            variant="outline"
            className="mt-4"
            onClick={() => navigate('/goals')}
          >
            Back to Goals
          </Button>
        </div>
      </div>
    );
  }

  const handleDelete = () => {
    deleteGoal(goal.id, {
      onSuccess: () => {
        navigate('/goals');
      },
    });
  };

  const handleMarkAchieved = () => {
    updateStatus({ id: goal.id, status: 'achieved' });
  };

  const daysUntil = goal.targetDate ? getDaysUntilDate(goal.targetDate) : null;
  const monthsRemaining = goal.targetDate
    ? getMonthsBetween(new Date().toISOString().split('T')[0], goal.targetDate)
    : null;

  const requiredMonthlyContribution = monthsRemaining && monthsRemaining > 0
    ? goal.remainingAmount / monthsRemaining
    : 0;

  return (
    <>
      <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Header */}
        <div className="flex items-center gap-4 mb-8">
          <Button
            variant="ghost"
            icon={ArrowLeft}
            onClick={() => navigate('/goals')}
          >
            Back
          </Button>

          <div className="flex-1">
            <h1 className="text-3xl font-bold text-gray-900">
              {goal.goalName}
            </h1>
            {goal.description && (
              <p className="text-gray-600 mt-1">{goal.description}</p>
            )}
          </div>

          <div className="flex gap-2">
            {goal.status !== 'achieved' && goal.progressPercentage >= 100 && (
              <Button
                variant="primary"
                icon={CheckCircle}
                onClick={handleMarkAchieved}
              >
                Mark Achieved
              </Button>
            )}
            <Button
              variant="outline"
              icon={Edit}
              onClick={() => navigate(`/goals/${goal.id}/edit`)}
            >
              Edit
            </Button>
            <Button
              variant="outline"
              icon={Trash2}
              onClick={() => setShowDeleteDialog(true)}
            >
              Delete
            </Button>
          </div>
        </div>

        {/* Alerts */}
        {goal.progressPercentage >= 100 && goal.status !== 'achieved' && (
          <Alert variant="success" className="mb-6">
            <CheckCircle className="h-4 w-4" />
            <div>
              <p className="font-semibold">Goal Reached!</p>
              <p className="text-sm mt-1">
                Congratulations! You've reached your target amount. Mark this goal as achieved.
              </p>
            </div>
          </Alert>
        )}

        {daysUntil !== null && daysUntil < 0 && goal.status !== 'achieved' && (
          <Alert variant="warning" className="mb-6">
            <AlertCircle className="h-4 w-4" />
            <div>
              <p className="font-semibold">Target Date Passed</p>
              <p className="text-sm mt-1">
                The target date for this goal was {formatDate(goal.targetDate!, 'MMM d, yyyy')}. 
                Consider updating your timeline or marking the goal as achieved.
              </p>
            </div>
          </Alert>
        )}

        {requiredMonthlyContribution > goal.monthlyContribution * 1.5 && 
         goal.monthlyContribution > 0 && 
         goal.status !== 'achieved' && (
          <Alert variant="info" className="mb-6">
            <TrendingUp className="h-4 w-4" />
            <div>
              <p className="font-semibold">Increase Contributions</p>
              <p className="text-sm mt-1">
                To reach your goal by the target date, you'll need to contribute{' '}
                {formatCurrency(requiredMonthlyContribution)}/month instead of your current{' '}
                {formatCurrency(goal.monthlyContribution)}/month.
              </p>
            </div>
          </Alert>
        )}

        {/* Overview Card */}
        <Card className="p-6 mb-6">
          <div className="flex items-start justify-between mb-6">
            <div>
              <h2 className="text-lg font-semibold text-gray-900">Progress Overview</h2>
              <div className="flex items-center gap-2 mt-2">
                <Badge variant={
                  goal.status === 'achieved' ? 'success' :
                  goal.status === 'in_progress' ? 'info' :
                  goal.status === 'on_hold' ? 'warning' : 'secondary'
                }>
                  {goal.status.replace('_', ' ')}
                </Badge>
                <Badge variant={
                  goal.priority === 'high' ? 'danger' :
                  goal.priority === 'medium' ? 'warning' : 'secondary'
                }>
                  {goal.priority} priority
                </Badge>
              </div>
            </div>

            <div className="text-right">
              <p className="text-sm text-gray-600">Category</p>
              <p className="text-lg font-semibold text-gray-900 capitalize">
                {goal.category.replace('_', ' ')}
              </p>
            </div>
          </div>

          {/* Key Metrics */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div>
              <p className="text-sm text-gray-600 mb-2">Current Amount</p>
              <p className="text-3xl font-bold text-gray-900">
                {formatCurrency(goal.currentAmount)}
              </p>
              <p className="text-sm text-gray-600 mt-1">
                of {formatCurrency(goal.targetAmount)} goal
              </p>
            </div>

            <div>
              <p className="text-sm text-gray-600 mb-2">Progress</p>
              <p className="text-3xl font-bold text-green-600">
                {formatPercentage(goal.progressPercentage)}
              </p>
              <ProgressBar
                value={goal.progressPercentage}
                max={100}
                variant={
                  goal.progressPercentage >= 100 ? 'success' :
                  goal.progressPercentage >= 75 ? 'info' :
                  goal.progressPercentage >= 50 ? 'warning' : 'danger'
                }
                className="mt-2"
              />
            </div>

            <div>
              <p className="text-sm text-gray-600 mb-2">Remaining</p>
              <p className="text-3xl font-bold text-gray-900">
                {formatCurrency(goal.remainingAmount)}
              </p>
              {monthsRemaining !== null && monthsRemaining > 0 && (
                <p className="text-sm text-gray-600 mt-1">
                  {monthsRemaining} month{monthsRemaining !== 1 ? 's' : ''} to go
                </p>
              )}
            </div>
          </div>

          {/* Timeline */}
          {goal.targetDate && (
            <div className="p-4 bg-blue-50 rounded-lg">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <Calendar className="h-5 w-5 text-blue-600" />
                  <div>
                    <p className="text-sm font-medium text-blue-900">Target Date</p>
                    <p className="text-sm text-blue-700">
                      {formatDate(goal.targetDate, 'MMM d, yyyy')}
                    </p>
                  </div>
                </div>
                {daysUntil !== null && goal.status !== 'achieved' && (
                  <p className="text-sm font-semibold text-blue-900">
                    {daysUntil < 0
                      ? `${Math.abs(daysUntil)} days overdue`
                      : daysUntil === 0
                      ? 'Target date today'
                      : `${daysUntil} days remaining`}
                  </p>
                )}
              </div>
            </div>
          )}

          {/* Monthly Contribution */}
          {goal.monthlyContribution > 0 && (
            <div className="mt-6 p-4 bg-green-50 rounded-lg">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-green-900">
                    Monthly Contribution
                  </p>
                  <p className="text-xs text-green-700 mt-1">
                    Current contribution amount
                  </p>
                </div>
                <p className="text-2xl font-bold text-green-900">
                  {formatCurrency(goal.monthlyContribution)}
                </p>
              </div>
            </div>
          )}
        </Card>

        {/* Milestones */}
        <GoalMilestones goal={goal} className="mb-6" />

        {/* Progress Chart */}
        <GoalProgressChart goal={goal} className="mb-6" />

        {/* Contribution Calculator */}
        <GoalContributionCalculator goal={goal} className="mb-6" />

        {/* Additional Details */}
        <Card className="p-6">
          <h2 className="text-lg font-semibold text-gray-900 mb-4">
            Additional Details
          </h2>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <DetailRow
              label="Created"
              value={formatDate(goal.createdAt, 'MMM d, yyyy')}
            />
            <DetailRow
              label="Last Updated"
              value={formatDate(goal.updatedAt, 'MMM d, yyyy')}
            />
          </div>
        </Card>
      </div>

      {/* Delete Dialog */}
      <ConfirmDialog
        isOpen={showDeleteDialog}
        onClose={() => setShowDeleteDialog(false)}
        onConfirm={handleDelete}
        title="Delete Goal"
        description={`Are you sure you want to delete "${goal.goalName}"? This action cannot be undone.`}
        confirmLabel="Delete"
        variant="danger"
      />
    </>
  );
}

interface DetailRowProps {
  label: string;
  value: string;
}

function DetailRow({ label, value }: DetailRowProps) {
  return (
    <div className="flex items-center justify-between py-2">
      <p className="text-sm text-gray-600">{label}</p>
      <p className="text-sm font-medium text-gray-900">{value}</p>
    </div>
  );
}

function DetailSkeleton() {
  return (
    <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <Skeleton className="h-12 w-64 mb-8" />
      <Skeleton className="h-64 rounded-lg mb-6" />
      <Skeleton className="h-48 rounded-lg mb-6" />
      <Skeleton className="h-96 rounded-lg mb-6" />
      <Skeleton className="h-48 rounded-lg" />
    </div>
  );
}
```

**Goal Milestones Component:**

```
// src/components/goals/GoalMilestones.tsx
import React, { useState } from 'react';
import {
  Trophy,
  Plus,
  Check,
  Circle,
  Edit,
  Trash2,
  ChevronDown,
  ChevronUp,
} from 'lucide-react';
import { Card } from '@/components/common/Card';
import { Button } from '@/components/common/Button';
import { Badge } from '@/components/common/Badge';
import { Input } from '@/components/common/Input';
import { CurrencyInput } from '@/components/common/CurrencyInput';
import { ConfirmDialog } from '@/components/common/ConfirmDialog';
import {
  useCreateMilestone,
  useUpdateMilestone,
  useDeleteMilestone,
  useToggleMilestone,
} from '@/hooks/api/useMilestones';
import { formatCurrency, formatDate, formatPercentage } from '@/lib/utils/formatters';
import { cn } from '@/lib/utils';
import type { Goal, GoalMilestone } from '@/types';

interface GoalMilestonesProps {
  goal: Goal;
  className?: string;
}

export function GoalMilestones({ goal, className }: GoalMilestonesProps) {
  const [showAddForm, setShowAddForm] = useState(false);
  const [editingId, setEditingId] = useState<string | null>(null);
  const [deletingId, setDeletingId] = useState<string | null>(null);
  const [expanded, setExpanded] = useState(true);

  const createMutation = useCreateMilestone();
  const updateMutation = useUpdateMilestone();
  const deleteMutation = useDeleteMilestone();
  const toggleMutation = useToggleMilestone();

  const sortedMilestones = [...(goal.milestones || [])].sort(
    (a, b) => a.order - b.order
  );

  const completedCount = sortedMilestones.filter(m => m.isCompleted).length;
  const totalCount = sortedMilestones.length;

  return (
    <Card className={cn('p-6', className)}>
      {/* Header */}
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-3">
          <div className="p-2 bg-yellow-100 rounded-lg">
            <Trophy className="h-5 w-5 text-yellow-600" />
          </div>
          <div>
            <h2 className="text-lg font-semibold text-gray-900">Milestones</h2>
            <p className="text-sm text-gray-600">
              {completedCount} of {totalCount} completed
            </p>
          </div>
        </div>

        <div className="flex items-center gap-2">
          {!showAddForm && (
            <Button
              variant="outline"
              size="sm"
              icon={Plus}
              onClick={() => setShowAddForm(true)}
            >
              Add Milestone
            </Button>
          )}
          <Button
            variant="ghost"
            size="sm"
            icon={expanded ? ChevronUp : ChevronDown}
            onClick={() => setExpanded(!expanded)}
          />
        </div>
      </div>

      {expanded && (
        <>
          {/* Progress Bar */}
          {totalCount > 0 && (
            <div className="mb-6">
              <div className="flex items-center justify-between text-sm mb-2">
                <span className="text-gray-600">Overall Progress</span>
                <span className="font-semibold text-gray-900">
                  {formatPercentage((completedCount / totalCount) * 100)}
                </span>
              </div>
              <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                <div
                  className="h-full bg-gradient-to-r from-yellow-500 to-yellow-600 transition-all duration-300"
                  style={{ width: `${(completedCount / totalCount) * 100}%` }}
                />
              </div>
            </div>
          )}

          {/* Add Form */}
          {showAddForm && (
            <MilestoneForm
              goalId={goal.id}
              onSubmit={(data) => {
                createMutation.mutate(
                  { goalId: goal.id, data },
                  {
                    onSuccess: () => setShowAddForm(false),
                  }
                );
              }}
              onCancel={() => setShowAddForm(false)}
            />
          )}

          {/* Milestones List */}
          {sortedMilestones.length === 0 ? (
            <div className="text-center py-8">
              <Trophy className="h-12 w-12 text-gray-400 mx-auto mb-3" />
              <p className="text-gray-600">No milestones yet</p>
              <p className="text-sm text-gray-500 mt-1">
                Add milestones to break your goal into smaller, achievable steps
              </p>
            </div>
          ) : (
            <div className="space-y-3">
              {sortedMilestones.map((milestone, index) => (
                <MilestoneItem
                  key={milestone.id}
                  milestone={milestone}
                  goalCurrentAmount={goal.currentAmount}
                  isEditing={editingId === milestone.id}
                  onToggle={() => toggleMutation.mutate(milestone.id)}
                  onEdit={() => setEditingId(milestone.id)}
                  onUpdate={(data) => {
                    updateMutation.mutate(
                      { id: milestone.id, data },
                      {
                        onSuccess: () => setEditingId(null),
                      }
                    );
                  }}
                  onCancelEdit={() => setEditingId(null)}
                  onDelete={() => setDeletingId(milestone.id)}
                />
              ))}
            </div>
          )}
        </>
      )}

      {/* Delete Confirmation */}
      <ConfirmDialog
        isOpen={!!deletingId}
        onClose={() => setDeletingId(null)}
        onConfirm={() => {
          if (deletingId) {
            deleteMutation.mutate(deletingId, {
              onSuccess: () => setDeletingId(null),
            });
          }
        }}
        title="Delete Milestone"
        description="Are you sure you want to delete this milestone? This action cannot be undone."
        confirmLabel="Delete"
        variant="danger"
      />
    </Card>
  );
}

interface MilestoneFormProps {
  goalId: string;
  milestone?: GoalMilestone;
  onSubmit: (data: { name: string; targetAmount: number }) => void;
  onCancel: () => void;
}

function MilestoneForm({ milestone, onSubmit, onCancel }: MilestoneFormProps) {
  const [name, setName] = useState(milestone?.name || '');
  const [targetAmount, setTargetAmount] = useState(milestone?.targetAmount || 0);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (name && targetAmount > 0) {
      onSubmit({ name, targetAmount });
    }
  };

  return (
    <form onSubmit={handleSubmit} className="p-4 bg-gray-50 rounded-lg mb-4">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <Input
          label="Milestone Name"
          value={name}
          onChange={(e) => setName(e.target.value)}
          placeholder="e.g., First $5,000"
          required
        />

        <CurrencyInput
          label="Target Amount"
          value={targetAmount}
          onChange={(e) => setTargetAmount(Number(e.target.value) || 0)}
          required
        />
      </div>

      <div className="flex items-center justify-end gap-2">
        <Button type="button" variant="ghost" size="sm" onClick={onCancel}>
          Cancel
        </Button>
        <Button type="submit" variant="primary" size="sm">
          {milestone ? 'Update' : 'Add'} Milestone
        </Button>
      </div>
    </form>
  );
}

interface MilestoneItemProps {
  milestone: GoalMilestone;
  goalCurrentAmount: number;
  isEditing: boolean;
  onToggle: () => void;
  onEdit: () => void;
  onUpdate: (data: { name: string; targetAmount: number }) => void;
  onCancelEdit: () => void;
  onDelete: () => void;
}

function MilestoneItem({
  milestone,
  goalCurrentAmount,
  isEditing,
  onToggle,
  onEdit,
  onUpdate,
  onCancelEdit,
  onDelete,
}: MilestoneItemProps) {
  const isAchieved = goalCurrentAmount >= milestone.targetAmount;
  const progress = Math.min((goalCurrentAmount / milestone.targetAmount) * 100, 100);

  if (isEditing) {
    return (
      <MilestoneForm
        milestone={milestone}
        goalId={milestone.goalId}
        onSubmit={onUpdate}
        onCancel={onCancelEdit}
      />
    );
  }

  return (
    <div
      className={cn(
        'p-4 rounded-lg border-2 transition-all',
        milestone.isCompleted
          ? 'bg-green-50 border-green-200'
          : isAchieved
          ? 'bg-yellow-50 border-yellow-200'
          : 'bg-white border-gray-200'
      )}
    >
      <div className="flex items-start gap-3">
        {/* Checkbox */}
        <button
          onClick={onToggle}
          className={cn(
            'flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors mt-0.5',
            milestone.isCompleted
              ? 'bg-green-500 border-green-500 text-white'
              : isAchieved
              ? 'bg-yellow-500 border-yellow-500 text-white'
              : 'border-gray-300 hover:border-gray-400'
          )}
        >
          {milestone.isCompleted ? (
            <Check className="h-4 w-4" />
          ) : isAchieved ? (
            <Circle className="h-3 w-3 fill-current" />
          ) : null}
        </button>

        {/* Content */}
        <div className="flex-1 min-w-0">
          <div className="flex items-start justify-between mb-2">
            <div className="flex-1">
              <h4
                className={cn(
                  'font-medium text-gray-900',
                  milestone.isCompleted && 'line-through text-gray-600'
                )}
              >
                {milestone.name}
              </h4>
              <p className="text-sm text-gray-600 mt-1">
                Target: {formatCurrency(milestone.targetAmount)}
              </p>
            </div>

            <div className="flex items-center gap-2">
              {milestone.isCompleted && milestone.completedAt && (
                <Badge variant="success" size="sm">
                  {formatDate(milestone.completedAt, 'MMM d')}
                </Badge>
              )}
              {isAchieved && !milestone.isCompleted && (
                <Badge variant="warning" size="sm">Ready!</Badge>
              )}
            </div>
          </div>

          {/* Progress Bar */}
          {!milestone.isCompleted && (
            <div className="mb-2">
              <div className="h-1.5 bg-gray-200 rounded-full overflow-hidden">
                <div
                  className={cn(
                    'h-full transition-all duration-300',
                    isAchieved
                      ? 'bg-gradient-to-r from-yellow-500 to-yellow-600'
                      : 'bg-gradient-to-r from-blue-500 to-blue-600'
                  )}
                  style={{ width: `${progress}%` }}
                />
              </div>
              <p className="text-xs text-gray-600 mt-1">
                {formatPercentage(progress)} complete
              </p>
            </div>
          )}

          {/* Actions */}
          <div className="flex items-center gap-2 mt-2">
            <button
              onClick={onEdit}
              className="text-xs text-blue-600 hover:text-blue-700 flex items-center gap-1"
            >
              <Edit className="h-3 w-3" />
              Edit
            </button>
            <button
              onClick={onDelete}
              className="text-xs text-red-600 hover:text-red-700 flex items-center gap-1"
            >
              <Trash2 className="h-3 w-3" />
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}
```

**Goal Progress Chart Component:**

```
// src/components/goals/GoalProgressChart.tsx
import React, { useMemo } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';
import { TrendingUp } from 'lucide-react';
import { Card } from '@/components/common/Card';
import { formatCurrency } from '@/lib/utils/formatters';
import { cn } from '@/lib/utils';
import type { Goal } from '@/types';

interface GoalProgressChartProps {
  goal: Goal;
  className?: string;
}

export function GoalProgressChart({ goal, className }: GoalProgressChartProps) {
  // Generate projection data
  const chartData = useMemo(() => {
    const data: Array<{
      month: string;
      actual: number;
      projected: number;
      target: number;
    }> = [];

    const startDate = new Date(goal.createdAt);
    const today = new Date();
    const targetDate = goal.targetDate ? new Date(goal.targetDate) : new Date(today.getFullYear() + 1, today.getMonth());

    // Calculate months from start to target
    const monthsTotal = Math.ceil(
      (targetDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24 * 30)
    );

    const monthsPassed = Math.ceil(
      (today.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24 * 30)
    );

    // Generate historical data points (every month up to now)
    for (let i = 0; i <= Math.min(monthsPassed, monthsTotal); i++) {
      const date = new Date(startDate);
      date.setMonth(date.getMonth() + i);
      
      const monthName = date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
      
      // Simulate progressive growth (in real app, this would come from snapshots)
      const progressRatio = i / monthsPassed;
      const actualAmount = goal.currentAmount * progressRatio;
      
      data.push({
        month: monthName,
        actual: Math.round(actualAmount),
        projected: Math.round((goal.targetAmount / monthsTotal) * i),
        target: goal.targetAmount,
      });
    }

    // Generate future projection points
    for (let i = monthsPassed + 1; i <= monthsTotal; i++) {
      const date = new Date(startDate);
      date.setMonth(date.getMonth() + i);
      
      const monthName = date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
      
      // Project based on monthly contribution
      const monthsRemaining = i - monthsPassed;
      const projectedAmount = goal.currentAmount + (goal.monthlyContribution * monthsRemaining);
      
      data.push({
        month: monthName,
        actual: 0, // No actual data for future
        projected: Math.round(Math.min(projectedAmount, goal.targetAmount)),
        target: goal.targetAmount,
      });
    }

    return data;
  }, [goal]);

  const CustomTooltip = ({ active, payload }: any) => {
    if (!active || !payload || !payload.length) return null;

    return (
      <div className="bg-white p-3 rounded-lg shadow-lg border border-gray-200">
        <p className="text-sm font-semibold text-gray-900 mb-2">
          {payload[0].payload.month}
        </p>
        {payload.map((entry: any, index: number) => (
          <div key={index} className="flex items-center justify-between gap-4 text-xs">
            <span className="text-gray-600 capitalize">{entry.name}:</span>
            <span className="font-semibold" style={{ color: entry.color }}>
              {formatCurrency(entry.value)}
            </span>
          </div>
        ))}
      </div>
    );
  };

  return (
    <Card className={cn('p-6', className)}>
      {/* Header */}
      <div className="flex items-center gap-3 mb-6">
        <div className="p-2 bg-blue-100 rounded-lg">
          <TrendingUp className="h-5 w-5 text-blue-600" />
        </div>
        <div>
          <h2 className="text-lg font-semibold text-gray-900">Progress Over Time</h2>
          <p className="text-sm text-gray-600">
            Track your journey toward your goal
          </p>
        </div>
      </div>

      {/* Chart */}
      <div className="h-64">
        <ResponsiveContainer width="100%" height="100%">
          <LineChart data={chartData}>
            <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
            <XAxis
              dataKey="month"
              tick={{ fontSize: 12, fill: '#6b7280' }}
              tickLine={false}
            />
            <YAxis
              tick={{ fontSize: 12, fill: '#6b7280' }}
              tickLine={false}
              tickFormatter={(value) => `$${(value / 1000).toFixed(0)}k`}
            />
            <Tooltip content={<CustomTooltip />} />
            
            {/* Target line */}
            <Line
              type="monotone"
              dataKey="target"
              stroke="#d1d5db"
              strokeWidth={2}
              strokeDasharray="5 5"
              dot={false}
              name="Target"
            />
            
            {/* Projected line */}
            <Line
              type="monotone"
              dataKey="projected"
              stroke="#3b82f6"
              strokeWidth={2}
              strokeDasharray="3 3"
              dot={false}
              name="Projected"
            />
            
            {/* Actual line */}
            <Line
              type="monotone"
              dataKey="actual"
              stroke="#10b981"
              strokeWidth={3}
              dot={{ fill: '#10b981', r: 4 }}
              name="Actual"
            />
          </LineChart>
        </ResponsiveContainer>
      </div>

      {/* Legend */}
      <div className="flex items-center justify-center gap-6 mt-4 text-sm">
        <div className="flex items-center gap-2">
          <div className="w-8 h-0.5 bg-green-500" />
          <span className="text-gray-600">Actual</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-8 h-0.5 bg-blue-500 border-dashed border-t-2 border-blue-500" />
          <span className="text-gray-600">Projected</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-8 h-0.5 bg-gray-400 border-dashed border-t-2 border-gray-400" />
          <span className="text-gray-600">Target</span>
        </div>
      </div>
    </Card>
  );
}
```

**Goal Contribution Calculator Component:**

```
// src/components/goals/GoalContributionCalculator.tsx
import React, { useState, useMemo } from 'react';
import { Calculator, Calendar, DollarSign, TrendingUp } from 'lucide-react';
import { Card } from '@/components/common/Card';
import { CurrencyInput } from '@/components/common/CurrencyInput';
import { Input } from '@/components/common/Input';
import { Alert } from '@/components/common/Alert';
import { formatCurrency, formatDate } from '@/lib/utils/formatters';
import { addMonths } from '@/lib/utils/dates';
import { cn } from '@/lib/utils';
import type { Goal } from '@/types';

interface GoalContributionCalculatorProps {
  goal: Goal;
  className?: string;
}

export function GoalContributionCalculator({ goal, className }: GoalContributionCalculatorProps) {
  const [monthlyAmount, setMonthlyAmount] = useState(goal.monthlyContribution);
  const [targetMonths, setTargetMonths] = useState(12);

  const calculations = useMemo(() => {
    // Calculate completion date based on monthly contribution
    const monthsToComplete = monthlyAmount > 0
      ? Math.ceil(goal.remainingAmount / monthlyAmount)
      : 0;

    const completionDate = monthsToComplete > 0
      ? addMonths(new Date(), monthsToComplete)
      : null;

    // Calculate required monthly amount based on target months
    const requiredMonthly = targetMonths > 0
      ? goal.remainingAmount / targetMonths
      : 0;

    // Calculate total amount that will be saved
    const totalSaved = goal.currentAmount + (monthlyAmount * monthsToComplete);

    // Check if on track (if target date exists)
    let onTrack = null;
    let monthsBehind = 0;
    
    if (goal.targetDate) {
      const targetDate = new Date(goal.targetDate);
      const today = new Date();
      const monthsRemaining = Math.ceil(
        (targetDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24 * 30)
      );
      
      const requiredForTarget = monthsRemaining > 0
        ? goal.remainingAmount / monthsRemaining
        : goal.remainingAmount;
      
      onTrack = monthlyAmount >= requiredForTarget;
      
      if (!onTrack && monthlyAmount > 0) {
        monthsBehind = monthsToComplete - monthsRemaining;
      }
    }

    return {
      monthsToComplete,
      completionDate,
      requiredMonthly,
      totalSaved,
      onTrack,
      monthsBehind,
    };
  }, [goal, monthlyAmount, targetMonths]);

  return (
    <Card className={cn('p-6', className)}>
      {/* Header */}
      <div className="flex items-center gap-3 mb-6">
        <div className="p-2 bg-purple-100 rounded-lg">
          <Calculator className="h-5 w-5 text-purple-600" />
        </div>
        <div>
          <h2 className="text-lg font-semibold text-gray-900">
            Contribution Calculator
          </h2>
          <p className="text-sm text-gray-600">
            Plan your path to reaching your goal
          </p>
        </div>
      </div>

      {/* Calculators */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        {/* Monthly Contribution Input */}
        <div className="p-4 bg-gray-50 rounded-lg">
          <h3 className="text-sm font-semibold text-gray-900 mb-3">
            By Monthly Amount
          </h3>
          <CurrencyInput
            label="Monthly Contribution"
            value={monthlyAmount}
            onChange={(e) => setMonthlyAmount(Number(e.target.value) || 0)}
            placeholder="0.00"
          />

          {calculations.monthsToComplete > 0 && (
            <div className="mt-4 space-y-2">
              <ResultRow
                icon={Calendar}
                label="Time to Complete"
                value={`${calculations.monthsToComplete} months`}
              />
              {calculations.completionDate && (
                <ResultRow
                  icon={Calendar}
                  label="Completion Date"
                  value={formatDate(calculations.completionDate, 'MMM yyyy')}
                />
              )}
              <ResultRow
                icon={DollarSign}
                label="Final Amount"
                value={formatCurrency(calculations.totalSaved)}
              />
            </div>
          )}
        </div>

        {/* Target Timeline Input */}
        <div className="p-4 bg-gray-50 rounded-lg">
          <h3 className="text-sm font-semibold text-gray-900 mb-3">
            By Target Timeline
          </h3>
          <Input
            type="number"
            label="Months to Goal"
            value={targetMonths}
            onChange={(e) => setTargetMonths(Number(e.target.value) || 0)}
            min={1}
            max={120}
          />

          {calculations.requiredMonthly > 0 && (
            <div className="mt-4 space-y-2">
              <ResultRow
                icon={DollarSign}
                label="Required Monthly"
                value={formatCurrency(calculations.requiredMonthly)}
              />
              <ResultRow
                icon={Calendar}
                label="Completion Date"
                value={formatDate(addMonths(new Date(), targetMonths), 'MMM yyyy')}
              />
              <ResultRow
                icon={TrendingUp}
                label="Total Saved"
                value={formatCurrency(goal.currentAmount + (calculations.requiredMonthly * targetMonths))}
              />
            </div>
          )}
        </div>
      </div>

      {/* Status Alert */}
      {goal.targetDate && calculations.onTrack !== null && (
        <Alert variant={calculations.onTrack ? 'success' : 'warning'}>
          {calculations.onTrack ? (
            <>
              <TrendingUp className="h-4 w-4" />
              <div>
                <p className="font-semibold">On Track!</p>
                <p className="text-sm mt-1">
                  Your current contribution of {formatCurrency(monthlyAmount)}/month will 
                  help you reach your goal by {formatDate(goal.targetDate, 'MMM d, yyyy')}.
                </p>
              </div>
            </>
          ) : (
            <>
              <Calendar className="h-4 w-4" />
              <div>
                <p className="font-semibold">Adjust Your Timeline</p>
                <p className="text-sm mt-1">
                  At {formatCurrency(monthlyAmount)}/month, you'll reach your goal{' '}
                  {calculations.monthsBehind > 0
                    ? `${calculations.monthsBehind} month${calculations.monthsBehind !== 1 ? 's' : ''} after`
                    : 'before'}{' '}
                  your target date. Consider increasing your contribution to{' '}
                  {formatCurrency(calculations.requiredMonthly)}/month.
                </p>
              </div>
            </>
          )}
        </Alert>
      )}

      {/* Tips */}
      <div className="mt-6 p-4 bg-blue-50 rounded-lg">
        <h3 className="text-sm font-semibold text-blue-900 mb-2">
          Quick Tips
        </h3>
        <ul className="text-sm text-blue-800 space-y-1">
          <li>• Set up automatic transfers to stay consistent</li>
          <li>• Review and adjust your contribution monthly</li>
          <li>• Celebrate milestones along the way</li>
          <li>• Consider increasing contributions when you get raises or bonuses</li>
        </ul>
      </div>
    </Card>
  );
}

interface ResultRowProps {
  icon: React.ElementType;
  label: string;
  value: string;
}

function ResultRow({ icon: Icon, label, value }: ResultRowProps) {
  return (
    <div className="flex items-center justify-between py-1.5">
      <div className="flex items-center gap-2 text-gray-600">
        <Icon className="h-4 w-4" />
        <span className="text-sm">{label}</span>
      </div>
      <span className="text-sm font-semibold text-gray-900">{value}</span>
    </div>
  );
}
```

#### **5.7.3 Goal Form (Add/Edit)** {#5.7.3-goal-form-(add/edit)}

```
// src/pages/GoalFormPage.tsx
import React, { useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useForm, Controller } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { ArrowLeft, Save, Loader2 } from 'lucide-react';
import {
  useGoal,
  useCreateGoal,
  useUpdateGoal,
} from '@/hooks/api/useGoals';
import { goalSchema, type GoalFormData } from '@/lib/schemas/goal.schema';
import { Button } from '@/components/common/Button';
import { Input } from '@/components/common/Input';
import { Select } from '@/components/common/Select';
import { Textarea } from '@/components/common/Textarea';
import { CurrencyInput } from '@/components/common/CurrencyInput';
import { FormSection } from '@/components/common/FormSection';
import { Skeleton } from '@/components/common/Skeleton';

export function GoalFormPage() {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const isEditMode = Boolean(id);

  const { data: goal, isLoading } = useGoal(id!, { enabled: isEditMode });
  const createMutation = useCreateGoal();
  const updateMutation = useUpdateGoal();

  const {
    register,
    control,
    handleSubmit,
    setValue,
    formState: { errors, isSubmitting },
  } = useForm<GoalFormData>({
    resolver: zodResolver(goalSchema),
    defaultValues: {
      status: 'in_progress',
      priority: 'medium',
      currentAmount: 0,
      monthlyContribution: 0,
    },
  });

  // Populate form when editing
  useEffect(() => {
    if (goal && isEditMode) {
      setValue('goalName', goal.goalName);
      setValue('description', goal.description || '');
      setValue('category', goal.category);
      setValue('targetAmount', goal.targetAmount);
      setValue('currentAmount', goal.currentAmount);
      setValue('monthlyContribution', goal.monthlyContribution);
      setValue('targetDate', goal.targetDate || '');
      setValue('status', goal.status);
      setValue('priority', goal.priority);
    }
  }, [goal, isEditMode, setValue]);

  const onSubmit = async (data: GoalFormData) => {
    try {
      if (isEditMode && id) {
        await updateMutation.mutateAsync({ id, data });
      } else {
        await createMutation.mutateAsync(data);
      }
      navigate('/goals');
    } catch (error) {
      console.error('Failed to save goal:', error);
    }
  };

  if (isLoading && isEditMode) {
    return <FormSkeleton />;
  }

  return (
    <div className="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {/* Header */}
      <div className="flex items-center gap-4 mb-8">
        <Button
          variant="ghost"
          icon={ArrowLeft}
          onClick={() => navigate('/goals')}
        >
          Back
        </Button>

        <div className="flex-1">
          <h1 className="text-3xl font-bold text-gray-900">
            {isEditMode ? 'Edit Goal' : 'Create Goal'}
          </h1>
          <p className="text-gray-600 mt-1">
            {isEditMode
              ? 'Update your goal information'
              : 'Set a new financial goal to track'}
          </p>
        </div>
      </div>

      {/* Form */}
      <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
        {/* Basic Information */}
        <FormSection
          title="Basic Information"
          description="Define your goal and what you're working toward"
        >
          <div className="space-y-4">
            <Input
              {...register('goalName')}
              label="Goal Name"
              placeholder="Emergency Fund"
              error={errors.goalName?.message}
              required
              helpText="Give your goal a memorable name"
            />

            <Textarea
              {...register('description')}
              label="Description"
              placeholder="Build a 6-month emergency fund for peace of mind..."
              rows={3}
              error={errors.description?.message}
              maxLength={500}
              showCount
              helpText="Describe what this goal means to you"
            />

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <Select
                {...register('category')}
                label="Category"
                error={errors.category?.message}
                required
              >
                <option value="">Select category</option>
                <option value="emergency_fund">Emergency Fund</option>
                <option value="savings">Savings</option>
                <option value="debt_payoff">Debt Payoff</option>
                <option value="investment">Investment</option>
                <option value="purchase">Large Purchase</option>
                <option value="retirement">Retirement</option>
                <option value="education">Education</option>
                <option value="other">Other</option>
              </Select>

              <Select
                {...register('priority')}
                label="Priority"
                error={errors.priority?.message}
                required
              >
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
              </Select>
            </div>
          </div>
        </FormSection>

        {/* Financial Details */}
        <FormSection
          title="Financial Details"
          description="Set your target amount and current progress"
        >
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <Controller
              name="targetAmount"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Target Amount"
                  error={errors.targetAmount?.message}
                  required
                  helpText="How much do you want to save?"
                />
              )}
            />

            <Controller
              name="currentAmount"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Current Amount"
                  error={errors.currentAmount?.message}
                  helpText="How much have you saved so far?"
                />
              )}
            />

            <Controller
              name="monthlyContribution"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Monthly Contribution"
                  error={errors.monthlyContribution?.message}
                  helpText="How much will you save each month?"
                />
              )}
            />

            <Input
              {...register('targetDate')}
              type="date"
              label="Target Date"
              error={errors.targetDate?.message}
              helpText="When do you want to achieve this goal?"
            />
          </div>
        </FormSection>

        {/* Status */}
        <FormSection
          title="Goal Status"
          description="Track the current state of your goal"
        >
          <Select
            {...register('status')}
            label="Status"
            error={errors.status?.message}
            required
          >
            <option value="in_progress">In Progress</option>
            <option value="achieved">Achieved</option>
            <option value="on_hold">On Hold</option>
            <option value="archived">Archived</option>
          </Select>
        </FormSection>

        {/* Form Actions */}
        <div className="flex items-center justify-end gap-4 pt-6 border-t border-gray-200">
          <Button
            type="button"
            variant="outline"
            onClick={() => navigate('/goals')}
          >
            Cancel
          </Button>

          <Button
            type="submit"
            variant="primary"
            disabled={isSubmitting}
            icon={isSubmitting ? Loader2 : Save}
            iconAnimation={isSubmitting ? 'spin' : undefined}
          >
            {isSubmitting
              ? 'Saving...'
              : isEditMode
              ? 'Update Goal'
              : 'Create Goal'}
          </Button>
        </div>
      </form>
    </div>
  );
}

function FormSkeleton() {
  return (
    <div className="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <Skeleton className="h-12 w-64 mb-8" />
      {[...Array(3)].map((_, i) => (
        <div key={i} className="mb-6">
          <Skeleton className="h-6 w-48 mb-4" />
          <div className="grid grid-cols-2 gap-4">
            <Skeleton className="h-10 rounded" />
            <Skeleton className="h-10 rounded" />
          </div>
        </div>
      ))}
    </div>
  );
}
```

**Goal Schema:**

```ts
// src/lib/schemas/goal.schema.ts
import { z } from 'zod';

export const goalSchema = z.object({
  // Basic Information
  goalName: z
    .string()
    .min(1, 'Goal name is required')
    .max(255, 'Goal name must be less than 255 characters'),
  
  description: z
    .string()
    .max(500, 'Description must be less than 500 characters')
    .optional()
    .or(z.literal('')),
  
  category: z.enum([
    'emergency_fund',
    'savings',
    'debt_payoff',
    'investment',
    'purchase',
    'retirement',
    'education',
    'other'
  ]),
  
  priority: z.enum(['low', 'medium', 'high']),

  // Financial Details
  targetAmount: z
    .number()
    .min(1, 'Target amount must be greater than 0')
    .max(10000000, 'Target amount seems unreasonably high'),
  
  currentAmount: z
    .number()
    .min(0, 'Current amount must be positive')
    .max(10000000, 'Current amount seems unreasonably high'),
  
  monthlyContribution: z
    .number()
    .min(0, 'Monthly contribution must be positive')
    .max(1000000, 'Monthly contribution seems unreasonably high'),
  
  targetDate: z
    .string()
    .regex(/^\d{4}-\d{2}-\d{2}$/, 'Invalid date format')
    .optional()
    .or(z.literal('')),

  // Status
  status: z.enum(['in_progress', 'achieved', 'on_hold', 'archived']),
}).refine(
  (data) => data.currentAmount <= data.targetAmount,
  {
    message: 'Current amount cannot exceed target amount',
    path: ['currentAmount'],
  }
);

export type GoalFormData = z.infer<typeof goalSchema>;
```

### **5.8 Snapshots** {#5.8-snapshots}

#### **5.8.1 Snapshots List View** {#5.8.1-snapshots-list-view}

**Purpose:** Display financial snapshots over time to track net worth and financial progress

**User Story:** As a user, I want to capture periodic snapshots of my financial state so that I can track my net worth growth and see my financial progress over time

**Layout:**

```
┌─────────────────────────────────────────────────────────┐
│  Snapshots Header + Create Snapshot Button             │
├─────────────────────────────────────────────────────────┤
│  Current Net Worth Card (Latest Snapshot)              │
├─────────────────────────────────────────────────────────┤
│  Net Worth Chart (Last 12 months)                      │
├─────────────────────────────────────────────────────────┤
│  Filters & View Mode Toggle (Timeline/Grid)            │
├─────────────────────────────────────────────────────────┤
│  Timeline View:                                         │
│  ──────●──────────●──────────●────────●─────           │
│     Dec 2024   Nov 2024   Oct 2024  Sep 2024           │
│     $125K      $122K      $118K     $115K              │
│                                                         │
│  Or Grid View:                                          │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐               │
│  │ Dec 2024 │ │ Nov 2024 │ │ Oct 2024 │               │
│  │ $125,000 │ │ $122,000 │ │ $118,000 │               │
│  │ +2.5% ↑  │ │ +3.4% ↑  │ │ +2.6% ↑  │               │
│  └──────────┘ └──────────┘ └──────────┘               │
└─────────────────────────────────────────────────────────┘
```

**Component Implementation:**

```
// src/pages/SnapshotsPage.tsx
import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { Plus, Camera, LayoutGrid, Timeline } from 'lucide-react';
import { useSnapshots } from '@/hooks/api/useSnapshots';
import { Button } from '@/components/common/Button';
import { CurrentNetWorthCard } from '@/components/snapshots/CurrentNetWorthCard';
import { NetWorthChart } from '@/components/snapshots/NetWorthChart';
import { SnapshotFilters } from '@/components/snapshots/SnapshotFilters';
import { SnapshotTimeline } from '@/components/snapshots/SnapshotTimeline';
import { SnapshotGrid } from '@/components/snapshots/SnapshotGrid';
import { EmptyState } from '@/components/common/EmptyState';
import { Skeleton } from '@/components/common/Skeleton';
import type { SnapshotFilters as Filters } from '@/types';

type ViewMode = 'timeline' | 'grid';

export function SnapshotsPage() {
  const navigate = useNavigate();
  const { data: snapshots, isLoading, error } = useSnapshots();

  const [filters, setFilters] = useState<Filters>({
    dateRange: '1y',
    search: '',
  });

  const [viewMode, setViewMode] = useState<ViewMode>('timeline');

  if (isLoading) {
    return <SnapshotsSkeleton />;
  }

  if (error) {
    return (
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div className="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
          <p className="text-red-800">Failed to load snapshots. Please try again.</p>
        </div>
      </div>
    );
  }

  if (!snapshots || snapshots.length === 0) {
    return (
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <EmptyState
          icon={Camera}
          title="No snapshots yet"
          description="Create your first financial snapshot to start tracking your net worth over time"
          action={{
            label: 'Create Snapshot',
            onClick: () => navigate('/snapshots/new'),
          }}
        />
      </div>
    );
  }

  // Filter snapshots by date range
  let filteredSnapshots = snapshots;

  if (filters.dateRange !== 'all') {
    const now = new Date();
    const ranges: Record<string, number> = {
      '1m': 30,
      '3m': 90,
      '6m': 180,
      '1y': 365,
      '2y': 730,
    };

    const days = ranges[filters.dateRange];
    const cutoffDate = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);

    filteredSnapshots = filteredSnapshots.filter(s =>
      new Date(s.snapshotDate) >= cutoffDate
    );
  }

  if (filters.search) {
    const search = filters.search.toLowerCase();
    filteredSnapshots = filteredSnapshots.filter(s =>
      s.notes?.toLowerCase().includes(search)
    );
  }

  // Sort by date descending (newest first)
  const sortedSnapshots = [...filteredSnapshots].sort(
    (a, b) => new Date(b.snapshotDate).getTime() - new Date(a.snapshotDate).getTime()
  );

  const latestSnapshot = sortedSnapshots[0];

  return (
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {/* Header */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">Financial Snapshots</h1>
          <p className="text-gray-600 mt-1">
            Track your net worth and financial progress over time
          </p>
        </div>

        <Button
          variant="primary"
          icon={Plus}
          onClick={() => navigate('/snapshots/new')}
        >
          Create Snapshot
        </Button>
      </div>

      {/* Current Net Worth */}
      <CurrentNetWorthCard
        snapshot={latestSnapshot}
        previousSnapshot={sortedSnapshots[1]}
        className="mb-8"
      />

      {/* Net Worth Chart */}
      <NetWorthChart
        snapshots={sortedSnapshots}
        dateRange={filters.dateRange}
        className="mb-8"
      />

      {/* Filters and View Toggle */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
        <SnapshotFilters
          filters={filters}
          onFiltersChange={setFilters}
        />

        <div className="flex items-center gap-2">
          <Button
            variant={viewMode === 'timeline' ? 'primary' : 'outline'}
            size="sm"
            icon={Timeline}
            onClick={() => setViewMode('timeline')}
          >
            Timeline
          </Button>
          <Button
            variant={viewMode === 'grid' ? 'primary' : 'outline'}
            size="sm"
            icon={LayoutGrid}
            onClick={() => setViewMode('grid')}
          >
            Grid
          </Button>
        </div>
      </div>

      {/* Snapshots Display */}
      {sortedSnapshots.length === 0 ? (
        <div className="bg-gray-50 rounded-lg p-8 text-center">
          <p className="text-gray-600">No snapshots match your filters</p>
        </div>
      ) : viewMode === 'timeline' ? (
        <SnapshotTimeline snapshots={sortedSnapshots} />
      ) : (
        <SnapshotGrid snapshots={sortedSnapshots} />
      )}
    </div>
  );
}

function SnapshotsSkeleton() {
  return (
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <Skeleton className="h-12 w-64 mb-8" />
      <Skeleton className="h-40 rounded-lg mb-8" />
      <Skeleton className="h-96 rounded-lg mb-8" />
      <Skeleton className="h-12 w-full mb-6" />
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        {[...Array(6)].map((_, i) => (
          <Skeleton key={i} className="h-48 rounded-lg" />
        ))}
      </div>
    </div>
  );
}
```

**Current Net Worth Card:**

```
// src/components/snapshots/CurrentNetWorthCard.tsx
import React from 'react';
import { TrendingUp, TrendingDown, DollarSign, Briefcase, CreditCard } from 'lucide-react';
import { Card } from '@/components/common/Card';
import { Badge } from '@/components/common/Badge';
import { formatCurrency, formatDate, formatPercentage } from '@/lib/utils/formatters';
import { cn } from '@/lib/utils';
import type { Snapshot } from '@/types';

interface CurrentNetWorthCardProps {
  snapshot: Snapshot;
  previousSnapshot?: Snapshot;
  className?: string;
}

export function CurrentNetWorthCard({
  snapshot,
  previousSnapshot,
  className,
}: CurrentNetWorthCardProps) {
  const change = previousSnapshot
    ? snapshot.netWorth - previousSnapshot.netWorth
    : 0;

  const changePercentage = previousSnapshot && previousSnapshot.netWorth !== 0
    ? (change / Math.abs(previousSnapshot.netWorth)) * 100
    : 0;

  const isPositive = change >= 0;

  return (
    <Card className={cn('p-6', className)}>
      <div className="flex items-start justify-between mb-6">
        <div>
          <p className="text-sm text-gray-600 font-medium">Current Net Worth</p>
          <h2 className="text-4xl font-bold text-gray-900 mt-2">
            {formatCurrency(snapshot.netWorth)}
          </h2>
          {previousSnapshot && (
            <div className="flex items-center gap-2 mt-2">
              <Badge variant={isPositive ? 'success' : 'danger'}>
                {isPositive ? (
                  <TrendingUp className="h-3 w-3 mr-1" />
                ) : (
                  <TrendingDown className="h-3 w-3 mr-1" />
                )}
                {isPositive ? '+' : ''}{formatCurrency(change)}
              </Badge>
              <span className={cn(
                'text-sm font-medium',
                isPositive ? 'text-green-600' : 'text-red-600'
              )}>
                {isPositive ? '+' : ''}{formatPercentage(changePercentage)}
              </span>
              <span className="text-sm text-gray-500">
                since {formatDate(previousSnapshot.snapshotDate, 'MMM d')}
              </span>
            </div>
          )}
        </div>

        <div className="text-right">
          <p className="text-sm text-gray-600">As of</p>
          <p className="text-lg font-semibold text-gray-900">
            {formatDate(snapshot.snapshotDate, 'MMM d, yyyy')}
          </p>
        </div>
      </div>

      {/* Breakdown */}
      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <BreakdownItem
          icon={DollarSign}
          label="Assets"
          value={snapshot.totalAssets}
          color="green"
        />
        <BreakdownItem
          icon={CreditCard}
          label="Liabilities"
          value={snapshot.totalLiabilities}
          color="red"
        />
        <BreakdownItem
          icon={Briefcase}
          label="Investments"
          value={snapshot.investments}
          color="blue"
        />
      </div>
    </Card>
  );
}

interface BreakdownItemProps {
  icon: React.ElementType;
  label: string;
  value: number;
  color: 'green' | 'red' | 'blue';
}

function BreakdownItem({ icon: Icon, label, value, color }: BreakdownItemProps) {
  const colorClasses = {
    green: 'bg-green-100 text-green-600',
    red: 'bg-red-100 text-red-600',
    blue: 'bg-blue-100 text-blue-600',
  };

  return (
    <div className="p-4 bg-gray-50 rounded-lg">
      <div className="flex items-center gap-2 mb-2">
        <div className={cn('p-1.5 rounded', colorClasses[color])}>
          <Icon className="h-4 w-4" />
        </div>
        <p className="text-sm text-gray-600">{label}</p>
      </div>
      <p className="text-xl font-bold text-gray-900">
        {formatCurrency(value)}
      </p>
    </div>
  );
}
```

**Net Worth Chart:**

```
// src/components/snapshots/NetWorthChart.tsx
import React from 'react';
import {
  LineChart,
  Line,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  Area,
  AreaChart,
} from 'recharts';
import { TrendingUp } from 'lucide-react';
import { Card } from '@/components/common/Card';
import { formatCurrency, formatDate } from '@/lib/utils/formatters';
import { cn } from '@/lib/utils';
import type { Snapshot } from '@/types';

interface NetWorthChartProps {
  snapshots: Snapshot[];
  dateRange: string;
  className?: string;
}

export function NetWorthChart({ snapshots, dateRange, className }: NetWorthChartProps) {
  // Prepare chart data (reverse to show oldest first)
  const chartData = [...snapshots]
    .reverse()
    .map(snapshot => ({
      date: snapshot.snapshotDate,
      netWorth: snapshot.netWorth,
      assets: snapshot.totalAssets,
      liabilities: snapshot.totalLiabilities,
    }));

  const CustomTooltip = ({ active, payload }: any) => {
    if (!active || !payload || !payload.length) return null;

    const data = payload[0].payload;

    return (
      <div className="bg-white p-4 rounded-lg shadow-lg border border-gray-200">
        <p className="text-sm font-semibold text-gray-900 mb-2">
          {formatDate(data.date, 'MMM d, yyyy')}
        </p>
        <div className="space-y-1">
          <div className="flex items-center justify-between gap-6">
            <span className="text-xs text-gray-600">Net Worth:</span>
            <span className="text-sm font-semibold text-blue-600">
              {formatCurrency(data.netWorth)}
            </span>
          </div>
          <div className="flex items-center justify-between gap-6">
            <span className="text-xs text-gray-600">Assets:</span>
            <span className="text-sm font-semibold text-green-600">
              {formatCurrency(data.assets)}
            </span>
          </div>
          <div className="flex items-center justify-between gap-6">
            <span className="text-xs text-gray-600">Liabilities:</span>
            <span className="text-sm font-semibold text-red-600">
              {formatCurrency(data.liabilities)}
            </span>
          </div>
        </div>
      </div>
    );
  };

  const formatXAxis = (date: string) => {
    const ranges: Record<string, string> = {
      '1m': 'MMM d',
      '3m': 'MMM d',
      '6m': 'MMM',
      '1y': 'MMM',
      '2y': 'MMM yy',
      'all': 'MMM yy',
    };
    return formatDate(date, ranges[dateRange] || 'MMM yy');
  };

  return (
    <Card className={cn('p-6', className)}>
      {/* Header */}
      <div className="flex items-center gap-3 mb-6">
        <div className="p-2 bg-blue-100 rounded-lg">
          <TrendingUp className="h-5 w-5 text-blue-600" />
        </div>
        <div>
          <h2 className="text-lg font-semibold text-gray-900">
            Net Worth Over Time
          </h2>
          <p className="text-sm text-gray-600">
            Track your financial growth
          </p>
        </div>
      </div>

      {/* Chart */}
      <div className="h-80">
        <ResponsiveContainer width="100%" height="100%">
          <AreaChart data={chartData}>
            <defs>
              <linearGradient id="netWorthGradient" x1="0" y1="0" x2="0" y2="1">
                <stop offset="5%" stopColor="#3b82f6" stopOpacity={0.3} />
                <stop offset="95%" stopColor="#3b82f6" stopOpacity={0} />
              </linearGradient>
            </defs>
            <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
            <XAxis
              dataKey="date"
              tickFormatter={formatXAxis}
              tick={{ fontSize: 12, fill: '#6b7280' }}
              tickLine={false}
            />
            <YAxis
              tickFormatter={(value) => `$${(value / 1000).toFixed(0)}k`}
              tick={{ fontSize: 12, fill: '#6b7280' }}
              tickLine={false}
            />
            <Tooltip content={<CustomTooltip />} />
            
            <Area
              type="monotone"
              dataKey="netWorth"
              stroke="#3b82f6"
              strokeWidth={3}
              fill="url(#netWorthGradient)"
            />
          </AreaChart>
        </ResponsiveContainer>
      </div>

      {/* Legend */}
      <div className="flex items-center justify-center gap-6 mt-4 text-sm">
        <div className="flex items-center gap-2">
          <div className="w-8 h-0.5 bg-blue-500" />
          <span className="text-gray-600">Net Worth</span>
        </div>
      </div>
    </Card>
  );
}
```

**Snapshot Filters:**

```
// src/components/snapshots/SnapshotFilters.tsx
import React from 'react';
import { Search, Calendar } from 'lucide-react';
import { Input } from '@/components/common/Input';
import { Select } from '@/components/common/Select';
import { cn } from '@/lib/utils';
import type { SnapshotFilters as Filters } from '@/types';

interface SnapshotFiltersProps {
  filters: Filters;
  onFiltersChange: (filters: Filters) => void;
  className?: string;
}

export function SnapshotFilters({
  filters,
  onFiltersChange,
  className,
}: SnapshotFiltersProps) {
  return (
    <div className={cn('flex flex-col sm:flex-row gap-4', className)}>
      {/* Search */}
      <div className="flex-1">
        <Input
          placeholder="Search notes..."
          icon={Search}
          value={filters.search}
          onChange={(e) => onFiltersChange({ ...filters, search: e.target.value })}
        />
      </div>

      {/* Date Range */}
      <Select
        value={filters.dateRange}
        onChange={(e) => onFiltersChange({ ...filters, dateRange: e.target.value as any })}
        icon={Calendar}
        className="w-full sm:w-48"
      >
        <option value="1m">Last Month</option>
        <option value="3m">Last 3 Months</option>
        <option value="6m">Last 6 Months</option>
        <option value="1y">Last Year</option>
        <option value="2y">Last 2 Years</option>
        <option value="all">All Time</option>
      </Select>
    </div>
  );
}
```

**Snapshot Timeline:**

```
// src/components/snapshots/SnapshotTimeline.tsx
import React from 'react';
import { useNavigate } from 'react-router-dom';
import {
  Camera,
  TrendingUp,
  TrendingDown,
  Minus,
  Calendar,
  FileText,
} from 'lucide-react';
import { Card } from '@/components/common/Card';
import { Badge } from '@/components/common/Badge';
import { formatCurrency, formatDate, formatPercentage } from '@/lib/utils/formatters';
import { cn } from '@/lib/utils';
import type { Snapshot } from '@/types';

interface SnapshotTimelineProps {
  snapshots: Snapshot[];
}

export function SnapshotTimeline({ snapshots }: SnapshotTimelineProps) {
  const navigate = useNavigate();

  return (
    <div className="relative">
      {/* Timeline line */}
      <div className="absolute left-8 top-0 bottom-0 w-0.5 bg-gray-200" />

      {/* Timeline items */}
      <div className="space-y-8">
        {snapshots.map((snapshot, index) => {
          const previousSnapshot = snapshots[index + 1];
          const change = previousSnapshot
            ? snapshot.netWorth - previousSnapshot.netWorth
            : 0;
          const changePercentage = previousSnapshot && previousSnapshot.netWorth !== 0
            ? (change / Math.abs(previousSnapshot.netWorth)) * 100
            : 0;

          const isPositive = change > 0;
          const isNeutral = change === 0;

          return (
            <div key={snapshot.id} className="relative flex gap-6">
              {/* Timeline dot */}
              <div className={cn(
                'relative z-10 flex-shrink-0 w-16 h-16 rounded-full flex items-center justify-center',
                isPositive ? 'bg-green-100' :
                isNeutral ? 'bg-gray-100' :
                'bg-red-100'
              )}>
                <Camera className={cn(
                  'h-6 w-6',
                  isPositive ? 'text-green-600' :
                  isNeutral ? 'text-gray-600' :
                  'text-red-600'
                )} />
              </div>

              {/* Content */}
              <Card
                className="flex-1 p-6 hover:shadow-lg transition-shadow cursor-pointer"
                onClick={() => navigate(`/snapshots/${snapshot.id}`)}
              >
                <div className="flex items-start justify-between mb-4">
                  <div>
                    <h3 className="text-xl font-bold text-gray-900">
                      {formatCurrency(snapshot.netWorth)}
                    </h3>
                    <div className="flex items-center gap-2 mt-1">
                      <Calendar className="h-4 w-4 text-gray-500" />
                      <p className="text-sm text-gray-600">
                        {formatDate(snapshot.snapshotDate, 'EEEE, MMM d, yyyy')}
                      </p>
                    </div>
                  </div>

                  {previousSnapshot && (
                    <div className="text-right">
                      <Badge variant={
                        isPositive ? 'success' :
                        isNeutral ? 'secondary' :
                        'danger'
                      }>
                        {isPositive ? (
                          <TrendingUp className="h-3 w-3 mr-1" />
                        ) : isNeutral ? (
                          <Minus className="h-3 w-3 mr-1" />
                        ) : (
                          <TrendingDown className="h-3 w-3 mr-1" />
                        )}
                        {isPositive ? '+' : ''}{formatCurrency(change)}
                      </Badge>
                      <p className={cn(
                        'text-sm font-medium mt-1',
                        isPositive ? 'text-green-600' :
                        isNeutral ? 'text-gray-600' :
                        'text-red-600'
                      )}>
                        {isPositive ? '+' : ''}{formatPercentage(changePercentage)}
                      </p>
                    </div>
                  )}
                </div>

                {/* Breakdown */}
                <div className="grid grid-cols-3 gap-4 mb-4">
                  <div>
                    <p className="text-xs text-gray-600 mb-1">Assets</p>
                    <p className="text-sm font-semibold text-green-600">
                      {formatCurrency(snapshot.totalAssets)}
                    </p>
                  </div>
                  <div>
                    <p className="text-xs text-gray-600 mb-1">Liabilities</p>
                    <p className="text-sm font-semibold text-red-600">
                      {formatCurrency(snapshot.totalLiabilities)}
                    </p>
                  </div>
                  <div>
                    <p className="text-xs text-gray-600 mb-1">Investments</p>
                    <p className="text-sm font-semibold text-blue-600">
                      {formatCurrency(snapshot.investments)}
                    </p>
                  </div>
                </div>

                {/* Notes */}
                {snapshot.notes && (
                  <div className="p-3 bg-gray-50 rounded-lg">
                    <div className="flex items-start gap-2">
                      <FileText className="h-4 w-4 text-gray-500 mt-0.5 flex-shrink-0" />
                      <p className="text-sm text-gray-700 line-clamp-2">
                        {snapshot.notes}
                      </p>
                    </div>
                  </div>
                )}
              </Card>
            </div>
          );
        })}
      </div>
    </div>
  );
}
```

**Snapshot Grid:**

```
// src/components/snapshots/SnapshotGrid.tsx
import React from 'react';
import { useNavigate } from 'react-router-dom';
import {
  Camera,
  TrendingUp,
  TrendingDown,
  Minus,
  Calendar,
  Eye,
} from 'lucide-react';
import { Card } from '@/components/common/Card';
import { Badge } from '@/components/common/Badge';
import { Button } from '@/components/common/Button';
import { formatCurrency, formatDate, formatPercentage } from '@/lib/utils/formatters';
import { cn } from '@/lib/utils';
import type { Snapshot } from '@/types';

interface SnapshotGridProps {
  snapshots: Snapshot[];
}

export function SnapshotGrid({ snapshots }: SnapshotGridProps) {
  const navigate = useNavigate();

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {snapshots.map((snapshot, index) => {
        const previousSnapshot = snapshots[index + 1];
        const change = previousSnapshot
          ? snapshot.netWorth - previousSnapshot.netWorth
          : 0;
        const changePercentage = previousSnapshot && previousSnapshot.netWorth !== 0
          ? (change / Math.abs(previousSnapshot.netWorth)) * 100
          : 0;

        const isPositive = change > 0;
        const isNeutral = change === 0;

        return (
          <Card
            key={snapshot.id}
            className="overflow-hidden hover:shadow-lg transition-shadow"
          >
            {/* Header */}
            <div className={cn(
              'p-6 text-white',
              isPositive ? 'bg-gradient-to-br from-green-500 to-green-600' :
              isNeutral ? 'bg-gradient-to-br from-gray-500 to-gray-600' :
              'bg-gradient-to-br from-red-500 to-red-600'
            )}>
              <div className="flex items-start justify-between mb-4">
                <Camera className="h-6 w-6" />
                {previousSnapshot && (
                  <div className="flex items-center gap-1 text-sm">
                    {isPositive ? (
                      <TrendingUp className="h-4 w-4" />
                    ) : isNeutral ? (
                      <Minus className="h-4 w-4" />
                    ) : (
                      <TrendingDown className="h-4 w-4" />
                    )}
                    <span className="font-semibold">
                      {isPositive ? '+' : ''}{formatPercentage(changePercentage)}
                    </span>
                  </div>
                )}
              </div>

              <h3 className="text-2xl font-bold mb-1">
                {formatCurrency(snapshot.netWorth)}
              </h3>
              <div className="flex items-center gap-2 text-sm opacity-90">
                <Calendar className="h-4 w-4" />
                <span>{formatDate(snapshot.snapshotDate, 'MMM d, yyyy')}</span>
              </div>
            </div>

            {/* Body */}
            <div className="p-6">
              {/* Breakdown */}
              <div className="space-y-3 mb-4">
                <div className="flex items-center justify-between text-sm">
                  <span className="text-gray-600">Assets</span>
                  <span className="font-semibold text-green-600">
                    {formatCurrency(snapshot.totalAssets)}
                  </span>
                </div>
                <div className="flex items-center justify-between text-sm">
                  <span className="text-gray-600">Liabilities</span>
                  <span className="font-semibold text-red-600">
                    {formatCurrency(snapshot.totalLiabilities)}
                  </span>
                </div>
                <div className="flex items-center justify-between text-sm">
                  <span className="text-gray-600">Investments</span>
                  <span className="font-semibold text-blue-600">
                    {formatCurrency(snapshot.investments)}
                  </span>
                </div>
              </div>

              {/* Change indicator */}
              {previousSnapshot && (
                <div className={cn(
                  'p-3 rounded-lg mb-4',
                  isPositive ? 'bg-green-50' :
                  isNeutral ? 'bg-gray-50' :
                  'bg-red-50'
                )}>
                  <p className="text-xs text-gray-600 mb-1">
                    Since {formatDate(previousSnapshot.snapshotDate, 'MMM d')}
                  </p>
                  <p className={cn(
                    'text-lg font-bold',
                    isPositive ? 'text-green-600' :
                    isNeutral ? 'text-gray-600' :
                    'text-red-600'
                  )}>
                    {isPositive ? '+' : ''}{formatCurrency(change)}
                  </p>
                </div>
              )}

              {/* Notes preview */}
              {snapshot.notes && (
                <p className="text-sm text-gray-600 line-clamp-2 mb-4">
                  {snapshot.notes}
                </p>
              )}

              {/* View button */}
              <Button
                variant="outline"
                size="sm"
                icon={Eye}
                onClick={() => navigate(`/snapshots/${snapshot.id}`)}
                className="w-full"
              >
                View Details
              </Button>
            </div>
          </Card>
        );
      })}
    </div>
  );
}
```

**Type Definitions:**

```ts
// Add to src/types/index.ts

export interface SnapshotFilters {
  dateRange: '1m' | '3m' | '6m' | '1y' | '2y' | 'all';
  search: string;
}

export interface Snapshot {
  id: string;
  userId: string;
  snapshotDate: string;
  
  // Assets
  cash: number;
  checkingAccounts: number;
  savingsAccounts: number;
  investments: number;
  retirement: number;
  realEstate: number;
  vehicles: number;
  otherAssets: number;
  totalAssets: number;
  
  // Liabilities
  creditCards: number;
  studentLoans: number;
  autoLoans: number;
  mortgages: number;
  personalLoans: number;
  otherLiabilities: number;
  totalLiabilities: number;
  
  // Net Worth
  netWorth: number;
  
  // Additional
  notes: string | null;
  createdAt: string;
  updatedAt: string;
}
```

#### **5.8.2 Snapshot Detail View** {#5.8.2-snapshot-detail-view}

```
// src/pages/SnapshotDetailPage.tsx
import React, { useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import {
  ArrowLeft,
  Edit,
  Trash2,
  Camera,
  TrendingUp,
  TrendingDown,
  Minus,
  FileText,
  DollarSign,
  Calendar,
  Download,
} from 'lucide-react';
import {
  useSnapshot,
  useDeleteSnapshot,
  useSnapshots,
} from '@/hooks/api/useSnapshots';
import { Button } from '@/components/common/Button';
import { Card } from '@/components/common/Card';
import { Badge } from '@/components/common/Badge';
import { ConfirmDialog } from '@/components/common/ConfirmDialog';
import { Alert } from '@/components/common/Alert';
import { AssetLiabilityBreakdown } from '@/components/snapshots/AssetLiabilityBreakdown';
import { SnapshotComparison } from '@/components/snapshots/SnapshotComparison';
import { formatCurrency, formatDate, formatPercentage } from '@/lib/utils/formatters';
import { Skeleton } from '@/components/common/Skeleton';
import { cn } from '@/lib/utils';

export function SnapshotDetailPage() {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const { data: snapshot, isLoading, error } = useSnapshot(id!);
  const { data: allSnapshots } = useSnapshots();
  const { mutate: deleteSnapshot } = useDeleteSnapshot();
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);
  const [compareWithId, setCompareWithId] = useState<string | null>(null);

  if (isLoading) {
    return <DetailSkeleton />;
  }

  if (error || !snapshot) {
    return (
      <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div className="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
          <p className="text-red-800">Snapshot not found</p>
          <Button
            variant="outline"
            className="mt-4"
            onClick={() => navigate('/snapshots')}
          >
            Back to Snapshots
          </Button>
        </div>
      </div>
    );
  }

  const handleDelete = () => {
    deleteSnapshot(snapshot.id, {
      onSuccess: () => {
        navigate('/snapshots');
      },
    });
  };

  const handleExport = () => {
    const data = {
      date: snapshot.snapshotDate,
      netWorth: snapshot.netWorth,
      assets: {
        cash: snapshot.cash,
        checking: snapshot.checkingAccounts,
        savings: snapshot.savingsAccounts,
        investments: snapshot.investments,
        retirement: snapshot.retirement,
        realEstate: snapshot.realEstate,
        vehicles: snapshot.vehicles,
        other: snapshot.otherAssets,
        total: snapshot.totalAssets,
      },
      liabilities: {
        creditCards: snapshot.creditCards,
        studentLoans: snapshot.studentLoans,
        autoLoans: snapshot.autoLoans,
        mortgages: snapshot.mortgages,
        personalLoans: snapshot.personalLoans,
        other: snapshot.otherLiabilities,
        total: snapshot.totalLiabilities,
      },
      notes: snapshot.notes,
    };

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `snapshot-${snapshot.snapshotDate}.json`;
    a.click();
    window.URL.revokeObjectURL(url);
  };

  // Find previous snapshot for comparison
  const sortedSnapshots = allSnapshots
    ? [...allSnapshots].sort(
        (a, b) => new Date(b.snapshotDate).getTime() - new Date(a.snapshotDate).getTime()
      )
    : [];

  const currentIndex = sortedSnapshots.findIndex(s => s.id === snapshot.id);
  const previousSnapshot = currentIndex < sortedSnapshots.length - 1
    ? sortedSnapshots[currentIndex + 1]
    : null;

  const change = previousSnapshot
    ? snapshot.netWorth - previousSnapshot.netWorth
    : 0;

  const changePercentage = previousSnapshot && previousSnapshot.netWorth !== 0
    ? (change / Math.abs(previousSnapshot.netWorth)) * 100
    : 0;

  const isPositive = change > 0;
  const isNeutral = change === 0;

  const compareSnapshot = compareWithId
    ? sortedSnapshots.find(s => s.id === compareWithId)
    : null;

  return (
    <>
      <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Header */}
        <div className="flex items-center gap-4 mb-8">
          <Button
            variant="ghost"
            icon={ArrowLeft}
            onClick={() => navigate('/snapshots')}
          >
            Back
          </Button>

          <div className="flex-1">
            <h1 className="text-3xl font-bold text-gray-900">
              Financial Snapshot
            </h1>
            <p className="text-gray-600 mt-1">
              {formatDate(snapshot.snapshotDate, 'EEEE, MMMM d, yyyy')}
            </p>
          </div>

          <div className="flex gap-2">
            <Button
              variant="outline"
              size="sm"
              icon={Download}
              onClick={handleExport}
            >
              Export
            </Button>
            <Button
              variant="outline"
              icon={Edit}
              onClick={() => navigate(`/snapshots/${snapshot.id}/edit`)}
            >
              Edit
            </Button>
            <Button
              variant="outline"
              icon={Trash2}
              onClick={() => setShowDeleteDialog(true)}
            >
              Delete
            </Button>
          </div>
        </div>

        {/* Change Alert */}
        {previousSnapshot && !isNeutral && (
          <Alert variant={isPositive ? 'success' : 'warning'} className="mb-6">
            {isPositive ? (
              <TrendingUp className="h-4 w-4" />
            ) : (
              <TrendingDown className="h-4 w-4" />
            )}
            <div>
              <p className="font-semibold">
                {isPositive ? 'Net Worth Increased' : 'Net Worth Decreased'}
              </p>
              <p className="text-sm mt-1">
                Your net worth {isPositive ? 'grew' : 'decreased'} by{' '}
                {formatCurrency(Math.abs(change))} ({formatPercentage(Math.abs(changePercentage))})
                since {formatDate(previousSnapshot.snapshotDate, 'MMM d, yyyy')}.
              </p>
            </div>
          </Alert>
        )}

        {/* Net Worth Card */}
        <Card className="p-6 mb-6">
          <div className="flex items-start justify-between mb-6">
            <div>
              <p className="text-sm text-gray-600 font-medium">Net Worth</p>
              <h2 className="text-4xl font-bold text-gray-900 mt-2">
                {formatCurrency(snapshot.netWorth)}
              </h2>
              {previousSnapshot && (
                <div className="flex items-center gap-2 mt-2">
                  <Badge variant={isPositive ? 'success' : isNeutral ? 'secondary' : 'danger'}>
                    {isPositive ? (
                      <TrendingUp className="h-3 w-3 mr-1" />
                    ) : isNeutral ? (
                      <Minus className="h-3 w-3 mr-1" />
                    ) : (
                      <TrendingDown className="h-3 w-3 mr-1" />
                    )}
                    {isPositive ? '+' : ''}{formatCurrency(change)}
                  </Badge>
                  <span className={cn(
                    'text-sm font-medium',
                    isPositive ? 'text-green-600' :
                    isNeutral ? 'text-gray-600' :
                    'text-red-600'
                  )}>
                    {isPositive ? '+' : ''}{formatPercentage(changePercentage)}
                  </span>
                </div>
              )}
            </div>

            <div className="p-3 bg-blue-100 rounded-lg">
              <Camera className="h-6 w-6 text-blue-600" />
            </div>
          </div>

          {/* Summary Stats */}
          <div className="grid grid-cols-2 gap-4">
            <div className="p-4 bg-green-50 rounded-lg">
              <p className="text-sm text-green-900 font-medium mb-1">Total Assets</p>
              <p className="text-2xl font-bold text-green-600">
                {formatCurrency(snapshot.totalAssets)}
              </p>
            </div>
            <div className="p-4 bg-red-50 rounded-lg">
              <p className="text-sm text-red-900 font-medium mb-1">Total Liabilities</p>
              <p className="text-2xl font-bold text-red-600">
                {formatCurrency(snapshot.totalLiabilities)}
              </p>
            </div>
          </div>
        </Card>

        {/* Asset & Liability Breakdown Charts */}
        <AssetLiabilityBreakdown snapshot={snapshot} className="mb-6" />

        {/* Detailed Breakdown */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          {/* Assets */}
          <Card className="p-6">
            <h3 className="text-lg font-semibold text-gray-900 mb-4">
              Assets Breakdown
            </h3>
            <div className="space-y-3">
              <BreakdownRow label="Cash" value={snapshot.cash} />
              <BreakdownRow label="Checking Accounts" value={snapshot.checkingAccounts} />
              <BreakdownRow label="Savings Accounts" value={snapshot.savingsAccounts} />
              <BreakdownRow label="Investments" value={snapshot.investments} />
              <BreakdownRow label="Retirement" value={snapshot.retirement} />
              <BreakdownRow label="Real Estate" value={snapshot.realEstate} />
              <BreakdownRow label="Vehicles" value={snapshot.vehicles} />
              <BreakdownRow label="Other Assets" value={snapshot.otherAssets} />
              <div className="pt-3 border-t border-gray-200">
                <BreakdownRow
                  label="Total Assets"
                  value={snapshot.totalAssets}
                  isTotal
                />
              </div>
            </div>
          </Card>

          {/* Liabilities */}
          <Card className="p-6">
            <h3 className="text-lg font-semibold text-gray-900 mb-4">
              Liabilities Breakdown
            </h3>
            <div className="space-y-3">
              <BreakdownRow label="Credit Cards" value={snapshot.creditCards} />
              <BreakdownRow label="Student Loans" value={snapshot.studentLoans} />
              <BreakdownRow label="Auto Loans" value={snapshot.autoLoans} />
              <BreakdownRow label="Mortgages" value={snapshot.mortgages} />
              <BreakdownRow label="Personal Loans" value={snapshot.personalLoans} />
              <BreakdownRow label="Other Liabilities" value={snapshot.otherLiabilities} />
              <div className="pt-3 border-t border-gray-200">
                <BreakdownRow
                  label="Total Liabilities"
                  value={snapshot.totalLiabilities}
                  isTotal
                />
              </div>
            </div>
          </Card>
        </div>

        {/* Notes */}
        {snapshot.notes && (
          <Card className="p-6 mb-6">
            <div className="flex items-start gap-3">
              <FileText className="h-5 w-5 text-gray-600 mt-0.5" />
              <div className="flex-1">
                <h3 className="text-lg font-semibold text-gray-900 mb-2">Notes</h3>
                <p className="text-gray-700 whitespace-pre-wrap">{snapshot.notes}</p>
              </div>
            </div>
          </Card>
        )}

        {/* Comparison Section */}
        {sortedSnapshots.length > 1 && (
          <Card className="p-6 mb-6">
            <h3 className="text-lg font-semibold text-gray-900 mb-4">
              Compare with Another Snapshot
            </h3>
            <div className="flex items-center gap-4">
              <select
                value={compareWithId || ''}
                onChange={(e) => setCompareWithId(e.target.value || null)}
                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
                <option value="">Select a snapshot to compare</option>
                {sortedSnapshots
                  .filter(s => s.id !== snapshot.id)
                  .map(s => (
                    <option key={s.id} value={s.id}>
                      {formatDate(s.snapshotDate, 'MMM d, yyyy')} - {formatCurrency(s.netWorth)}
                    </option>
                  ))}
              </select>
              {compareWithId && (
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => setCompareWithId(null)}
                >
                  Clear
                </Button>
              )}
            </div>
          </Card>
        )}

        {/* Comparison Display */}
        {compareSnapshot && (
          <SnapshotComparison
            snapshot1={snapshot}
            snapshot2={compareSnapshot}
            className="mb-6"
          />
        )}

        {/* Metadata */}
        <Card className="p-6">
          <h3 className="text-lg font-semibold text-gray-900 mb-4">
            Snapshot Information
          </h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <DetailRow
              label="Created"
              value={formatDate(snapshot.createdAt, 'MMM d, yyyy h:mm a')}
            />
            <DetailRow
              label="Last Updated"
              value={formatDate(snapshot.updatedAt, 'MMM d, yyyy h:mm a')}
            />
          </div>
        </Card>
      </div>

      {/* Delete Dialog */}
      <ConfirmDialog
        isOpen={showDeleteDialog}
        onClose={() => setShowDeleteDialog(false)}
        onConfirm={handleDelete}
        title="Delete Snapshot"
        description="Are you sure you want to delete this snapshot? This action cannot be undone."
        confirmLabel="Delete"
        variant="danger"
      />
    </>
  );
}

interface BreakdownRowProps {
  label: string;
  value: number;
  isTotal?: boolean;
}

function BreakdownRow({ label, value, isTotal }: BreakdownRowProps) {
  return (
    <div className="flex items-center justify-between">
      <span className={cn(
        'text-sm',
        isTotal ? 'font-semibold text-gray-900' : 'text-gray-600'
      )}>
        {label}
      </span>
      <span className={cn(
        'text-sm',
        isTotal ? 'font-bold text-gray-900' : 'font-medium text-gray-900'
      )}>
        {formatCurrency(value)}
      </span>
    </div>
  );
}

interface DetailRowProps {
  label: string;
  value: string;
}

function DetailRow({ label, value }: DetailRowProps) {
  return (
    <div className="flex items-center justify-between py-2">
      <p className="text-sm text-gray-600">{label}</p>
      <p className="text-sm font-medium text-gray-900">{value}</p>
    </div>
  );
}

function DetailSkeleton() {
  return (
    <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <Skeleton className="h-12 w-64 mb-8" />
      <Skeleton className="h-48 rounded-lg mb-6" />
      <Skeleton className="h-96 rounded-lg mb-6" />
      <div className="grid grid-cols-2 gap-6 mb-6">
        <Skeleton className="h-64 rounded-lg" />
        <Skeleton className="h-64 rounded-lg" />
      </div>
      <Skeleton className="h-32 rounded-lg" />
    </div>
  );
}
```

**Asset & Liability Breakdown Component:**

```
// src/components/snapshots/AssetLiabilityBreakdown.tsx
import React from 'react';
import { PieChart, Pie, Cell, ResponsiveContainer, Legend, Tooltip } from 'recharts';
import { Card } from '@/components/common/Card';
import { formatCurrency, formatPercentage } from '@/lib/utils/formatters';
import { cn } from '@/lib/utils';
import type { Snapshot } from '@/types';

interface AssetLiabilityBreakdownProps {
  snapshot: Snapshot;
  className?: string;
}

export function AssetLiabilityBreakdown({ snapshot, className }: AssetLiabilityBreakdownProps) {
  // Prepare assets data
  const assetsData = [
    { name: 'Cash', value: snapshot.cash, color: '#10b981' },
    { name: 'Checking', value: snapshot.checkingAccounts, color: '#059669' },
    { name: 'Savings', value: snapshot.savingsAccounts, color: '#047857' },
    { name: 'Investments', value: snapshot.investments, color: '#3b82f6' },
    { name: 'Retirement', value: snapshot.retirement, color: '#2563eb' },
    { name: 'Real Estate', value: snapshot.realEstate, color: '#8b5cf6' },
    { name: 'Vehicles', value: snapshot.vehicles, color: '#a855f7' },
    { name: 'Other', value: snapshot.otherAssets, color: '#6b7280' },
  ].filter(item => item.value > 0);

  // Prepare liabilities data
  const liabilitiesData = [
    { name: 'Credit Cards', value: snapshot.creditCards, color: '#ef4444' },
    { name: 'Student Loans', value: snapshot.studentLoans, color: '#dc2626' },
    { name: 'Auto Loans', value: snapshot.autoLoans, color: '#f97316' },
    { name: 'Mortgages', value: snapshot.mortgages, color: '#ea580c' },
    { name: 'Personal Loans', value: snapshot.personalLoans, color: '#f59e0b' },
    { name: 'Other', value: snapshot.otherLiabilities, color: '#6b7280' },
  ].filter(item => item.value > 0);

  const CustomTooltip = ({ active, payload }: any) => {
    if (!active || !payload || !payload.length) return null;

    const data = payload[0];
    const percentage = (data.value / data.payload.total) * 100;

    return (
      <div className="bg-white p-3 rounded-lg shadow-lg border border-gray-200">
        <p className="text-sm font-semibold text-gray-900 mb-1">{data.name}</p>
        <p className="text-sm text-gray-600">
          {formatCurrency(data.value)} ({formatPercentage(percentage)})
        </p>
      </div>
    );
  };

  return (
    <div className={cn('grid grid-cols-1 lg:grid-cols-2 gap-6', className)}>
      {/* Assets Chart */}
      {assetsData.length > 0 && (
        <Card className="p-6">
          <h3 className="text-lg font-semibold text-gray-900 mb-4">
            Assets Composition
          </h3>
          <div className="h-64">
            <ResponsiveContainer width="100%" height="100%">
              <PieChart>
                <Pie
                  data={assetsData.map(d => ({ ...d, total: snapshot.totalAssets }))}
                  cx="50%"
                  cy="50%"
                  labelLine={false}
                  outerRadius={80}
                  fill="#8884d8"
                  dataKey="value"
                >
                  {assetsData.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={entry.color} />
                  ))}
                </Pie>
                <Tooltip content={<CustomTooltip />} />
              </PieChart>
            </ResponsiveContainer>
          </div>
          <div className="mt-4 space-y-2">
            {assetsData.map((item, index) => (
              <LegendItem
                key={index}
                name={item.name}
                value={item.value}
                color={item.color}
                total={snapshot.totalAssets}
              />
            ))}
          </div>
        </Card>
      )}

      {/* Liabilities Chart */}
      {liabilitiesData.length > 0 && (
        <Card className="p-6">
          <h3 className="text-lg font-semibold text-gray-900 mb-4">
            Liabilities Composition
          </h3>
          <div className="h-64">
            <ResponsiveContainer width="100%" height="100%">
              <PieChart>
                <Pie
                  data={liabilitiesData.map(d => ({ ...d, total: snapshot.totalLiabilities }))}
                  cx="50%"
                  cy="50%"
                  labelLine={false}
                  outerRadius={80}
                  fill="#8884d8"
                  dataKey="value"
                >
                  {liabilitiesData.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={entry.color} />
                  ))}
                </Pie>
                <Tooltip content={<CustomTooltip />} />
              </PieChart>
            </ResponsiveContainer>
          </div>
          <div className="mt-4 space-y-2">
            {liabilitiesData.map((item, index) => (
              <LegendItem
                key={index}
                name={item.name}
                value={item.value}
                color={item.color}
                total={snapshot.totalLiabilities}
              />
            ))}
          </div>
        </Card>
      )}
    </div>
  );
}

interface LegendItemProps {
  name: string;
  value: number;
  color: string;
  total: number;
}

function LegendItem({ name, value, color, total }: LegendItemProps) {
  const percentage = total > 0 ? (value / total) * 100 : 0;

  return (
    <div className="flex items-center justify-between text-sm">
      <div className="flex items-center gap-2">
        <div
          className="w-3 h-3 rounded-full"
          style={{ backgroundColor: color }}
        />
        <span className="text-gray-700">{name}</span>
      </div>
      <div className="flex items-center gap-2">
        <span className="text-gray-600">{formatPercentage(percentage)}</span>
        <span className="font-semibold text-gray-900">
          {formatCurrency(value)}
        </span>
      </div>
    </div>
  );
}
```

**Snapshot Comparison Component:**

```
// src/components/snapshots/SnapshotComparison.tsx
import React from 'react';
import { TrendingUp, TrendingDown, Minus, ArrowRight } from 'lucide-react';
import { Card } from '@/components/common/Card';
import { Badge } from '@/components/common/Badge';
import { formatCurrency, formatDate, formatPercentage } from '@/lib/utils/formatters';
import { cn } from '@/lib/utils';
import type { Snapshot } from '@/types';

interface SnapshotComparisonProps {
  snapshot1: Snapshot;
  snapshot2: Snapshot;
  className?: string;
}

export function SnapshotComparison({ snapshot1, snapshot2, className }: SnapshotComparisonProps) {
  // Determine which is newer
  const isSnapshot1Newer = new Date(snapshot1.snapshotDate) > new Date(snapshot2.snapshotDate);
  const [newer, older] = isSnapshot1Newer
    ? [snapshot1, snapshot2]
    : [snapshot2, snapshot1];

  // Calculate differences
  const netWorthChange = newer.netWorth - older.netWorth;
  const netWorthChangePercent = older.netWorth !== 0
    ? (netWorthChange / Math.abs(older.netWorth)) * 100
    : 0;

  const assetsChange = newer.totalAssets - older.totalAssets;
  const liabilitiesChange = newer.totalLiabilities - older.totalLiabilities;

  const comparisons = [
    {
      label: 'Net Worth',
      older: older.netWorth,
      newer: newer.netWorth,
      change: netWorthChange,
      changePercent: netWorthChangePercent,
    },
    {
      label: 'Total Assets',
      older: older.totalAssets,
      newer: newer.totalAssets,
      change: assetsChange,
      changePercent: older.totalAssets !== 0
        ? (assetsChange / older.totalAssets) * 100
        : 0,
    },
    {
      label: 'Total Liabilities',
      older: older.totalLiabilities,
      newer: newer.totalLiabilities,
      change: liabilitiesChange,
      changePercent: older.totalLiabilities !== 0
        ? (liabilitiesChange / older.totalLiabilities) * 100
        : 0,
      isLiability: true,
    },
    {
      label: 'Cash',
      older: older.cash,
      newer: newer.cash,
      change: newer.cash - older.cash,
      changePercent: older.cash !== 0
        ? ((newer.cash - older.cash) / older.cash) * 100
        : 0,
    },
    {
      label: 'Investments',
      older: older.investments,
      newer: newer.investments,
      change: newer.investments - older.investments,
      changePercent: older.investments !== 0
        ? ((newer.investments - older.investments) / older.investments) * 100
        : 0,
    },
    {
      label: 'Retirement',
      older: older.retirement,
      newer: newer.retirement,
      change: newer.retirement - older.retirement,
      changePercent: older.retirement !== 0
        ? ((newer.retirement - older.retirement) / older.retirement) * 100
        : 0,
    },
  ];

  return (
    <Card className={cn('p-6', className)}>
      <div className="mb-6">
        <h3 className="text-lg font-semibold text-gray-900 mb-2">
          Snapshot Comparison
        </h3>
        <div className="flex items-center gap-4 text-sm text-gray-600">
          <span>{formatDate(older.snapshotDate, 'MMM d, yyyy')}</span>
          <ArrowRight className="h-4 w-4" />
          <span>{formatDate(newer.snapshotDate, 'MMM d, yyyy')}</span>
        </div>
      </div>

      <div className="space-y-4">
        {comparisons.map((item, index) => {
          const isPositive = item.change > 0;
          const isNeutral = item.change === 0;

          // For liabilities, positive change (increase) is bad
          const isGoodChange = item.isLiability
            ? item.change < 0
            : item.change > 0;

          return (
            <div
              key={index}
              className="p-4 bg-gray-50 rounded-lg"
            >
              <div className="flex items-center justify-between mb-3">
                <h4 className="text-sm font-semibold text-gray-900">
                  {item.label}
                </h4>
                <Badge variant={
                  isNeutral ? 'secondary' :
                  isGoodChange ? 'success' : 'warning'
                }>
                  {isPositive ? (
                    <TrendingUp className="h-3 w-3 mr-1" />
                  ) : isNeutral ? (
                    <Minus className="h-3 w-3 mr-1" />
                  ) : (
                    <TrendingDown className="h-3 w-3 mr-1" />
                  )}
                  {isPositive ? '+' : ''}{formatCurrency(item.change)}
                </Badge>
              </div>

              <div className="grid grid-cols-3 gap-4 text-sm">
                <div>
                  <p className="text-gray-600 mb-1">Starting</p>
                  <p className="font-semibold text-gray-900">
                    {formatCurrency(item.older)}
                  </p>
                </div>
                <div>
                  <p className="text-gray-600 mb-1">Current</p>
                  <p className="font-semibold text-gray-900">
                    {formatCurrency(item.newer)}
                  </p>
                </div>
                <div>
                  <p className="text-gray-600 mb-1">Change</p>
                  <p className={cn(
                    'font-semibold',
                    isNeutral ? 'text-gray-600' :
                    isGoodChange ? 'text-green-600' : 'text-orange-600'
                  )}>
                    {isPositive ? '+' : ''}{formatPercentage(item.changePercent)}
                  </p>
                </div>
              </div>
            </div>
          );
        })}
      </div>
    </Card>
  );
}
```

#### **5.8.3 Snapshot Form (Add/Edit)** {#5.8.3-snapshot-form-(add/edit)}

```
// src/pages/SnapshotFormPage.tsx
import React, { useEffect, useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useForm, Controller } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { ArrowLeft, Save, Loader2, Calculator } from 'lucide-react';
import {
  useSnapshot,
  useCreateSnapshot,
  useUpdateSnapshot,
} from '@/hooks/api/useSnapshots';
import { snapshotSchema, type SnapshotFormData } from '@/lib/schemas/snapshot.schema';
import { Button } from '@/components/common/Button';
import { Input } from '@/components/common/Input';
import { Textarea } from '@/components/common/Textarea';
import { CurrencyInput } from '@/components/common/CurrencyInput';
import { FormSection } from '@/components/common/FormSection';
import { Card } from '@/components/common/Card';
import { Skeleton } from '@/components/common/Skeleton';
import { formatCurrency } from '@/lib/utils/formatters';

export function SnapshotFormPage() {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const isEditMode = Boolean(id);

  const { data: snapshot, isLoading } = useSnapshot(id!, { enabled: isEditMode });
  const createMutation = useCreateSnapshot();
  const updateMutation = useUpdateSnapshot();

  const {
    register,
    control,
    handleSubmit,
    setValue,
    watch,
    formState: { errors, isSubmitting },
  } = useForm<SnapshotFormData>({
    resolver: zodResolver(snapshotSchema),
    defaultValues: {
      snapshotDate: new Date().toISOString().split('T')[0],
      cash: 0,
      checkingAccounts: 0,
      savingsAccounts: 0,
      investments: 0,
      retirement: 0,
      realEstate: 0,
      vehicles: 0,
      otherAssets: 0,
      creditCards: 0,
      studentLoans: 0,
      autoLoans: 0,
      mortgages: 0,
      personalLoans: 0,
      otherLiabilities: 0,
    },
  });

  // Populate form when editing
  useEffect(() => {
    if (snapshot && isEditMode) {
      setValue('snapshotDate', snapshot.snapshotDate);
      setValue('cash', snapshot.cash);
      setValue('checkingAccounts', snapshot.checkingAccounts);
      setValue('savingsAccounts', snapshot.savingsAccounts);
      setValue('investments', snapshot.investments);
      setValue('retirement', snapshot.retirement);
      setValue('realEstate', snapshot.realEstate);
      setValue('vehicles', snapshot.vehicles);
      setValue('otherAssets', snapshot.otherAssets);
      setValue('creditCards', snapshot.creditCards);
      setValue('studentLoans', snapshot.studentLoans);
      setValue('autoLoans', snapshot.autoLoans);
      setValue('mortgages', snapshot.mortgages);
      setValue('personalLoans', snapshot.personalLoans);
      setValue('otherLiabilities', snapshot.otherLiabilities);
      setValue('notes', snapshot.notes || '');
    }
  }, [snapshot, isEditMode, setValue]);

  // Watch all values for totals calculation
  const values = watch();

  const totalAssets =
    (values.cash || 0) +
    (values.checkingAccounts || 0) +
    (values.savingsAccounts || 0) +
    (values.investments || 0) +
    (values.retirement || 0) +
    (values.realEstate || 0) +
    (values.vehicles || 0) +
    (values.otherAssets || 0);

  const totalLiabilities =
    (values.creditCards || 0) +
    (values.studentLoans || 0) +
    (values.autoLoans || 0) +
    (values.mortgages || 0) +
    (values.personalLoans || 0) +
    (values.otherLiabilities || 0);

  const netWorth = totalAssets - totalLiabilities;

  const onSubmit = async (data: SnapshotFormData) => {
    try {
      if (isEditMode && id) {
        await updateMutation.mutateAsync({ id, data });
      } else {
        await createMutation.mutateAsync(data);
      }
      navigate('/snapshots');
    } catch (error) {
      console.error('Failed to save snapshot:', error);
    }
  };

  if (isLoading && isEditMode) {
    return <FormSkeleton />;
  }

  return (
    <div className="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {/* Header */}
      <div className="flex items-center gap-4 mb-8">
        <Button
          variant="ghost"
          icon={ArrowLeft}
          onClick={() => navigate('/snapshots')}
        >
          Back
        </Button>

        <div className="flex-1">
          <h1 className="text-3xl font-bold text-gray-900">
            {isEditMode ? 'Edit Snapshot' : 'Create Snapshot'}
          </h1>
          <p className="text-gray-600 mt-1">
            {isEditMode
              ? 'Update your financial snapshot'
              : 'Capture your current financial state'}
          </p>
        </div>
      </div>

      {/* Summary Card */}
      <Card className="p-6 mb-8 bg-gradient-to-br from-blue-50 to-indigo-50">
        <div className="flex items-center gap-3 mb-4">
          <Calculator className="h-6 w-6 text-blue-600" />
          <h2 className="text-lg font-semibold text-gray-900">
            Calculated Net Worth
          </h2>
        </div>
        
        <div className="grid grid-cols-3 gap-4 text-center">
          <div>
            <p className="text-sm text-gray-600 mb-1">Assets</p>
            <p className="text-xl font-bold text-green-600">
              {formatCurrency(totalAssets)}
            </p>
          </div>
          <div>
            <p className="text-sm text-gray-600 mb-1">Liabilities</p>
            <p className="text-xl font-bold text-red-600">
              {formatCurrency(totalLiabilities)}
            </p>
          </div>
          <div>
            <p className="text-sm text-gray-600 mb-1">Net Worth</p>
            <p className="text-2xl font-bold text-blue-600">
              {formatCurrency(netWorth)}
            </p>
          </div>
        </div>
      </Card>

      {/* Form */}
      <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
        {/* Snapshot Date */}
        <FormSection
          title="Snapshot Date"
          description="When is this snapshot from?"
        >
          <Input
            {...register('snapshotDate')}
            type="date"
            label="Date"
            error={errors.snapshotDate?.message}
            required
          />
        </FormSection>

        {/* Assets */}
        <FormSection
          title="Assets"
          description="Enter all your assets and their current values"
        >
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <Controller
              name="cash"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Cash"
                  error={errors.cash?.message}
                  helpText="Physical cash on hand"
                />
              )}
            />

            <Controller
              name="checkingAccounts"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Checking Accounts"
                  error={errors.checkingAccounts?.message}
                  helpText="Total in all checking accounts"
                />
              )}
            />

            <Controller
              name="savingsAccounts"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Savings Accounts"
                  error={errors.savingsAccounts?.message}
                  helpText="Total in all savings accounts"
                />
              )}
            />

            <Controller
              name="investments"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Investments"
                  error={errors.investments?.message}
                  helpText="Brokerage accounts, stocks, bonds"
                />
              )}
            />

            <Controller
              name="retirement"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Retirement"
                  error={errors.retirement?.message}
                  helpText="401(k), IRA, pension"
                />
              )}
            />

            <Controller
              name="realEstate"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Real Estate"
                  error={errors.realEstate?.message}
                  helpText="Current market value"
                />
              )}
            />

            <Controller
              name="vehicles"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Vehicles"
                  error={errors.vehicles?.message}
                  helpText="Current market value"
                />
              )}
            />

            <Controller
              name="otherAssets"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Other Assets"
                  error={errors.otherAssets?.message}
                  helpText="Jewelry, collectibles, etc."
                />
              )}
            />
          </div>

          <div className="mt-4 p-4 bg-green-50 rounded-lg">
            <div className="flex items-center justify-between">
              <span className="text-sm font-medium text-green-900">
                Total Assets
              </span>
              <span className="text-lg font-bold text-green-600">
                {formatCurrency(totalAssets)}
              </span>
            </div>
          </div>
        </FormSection>

        {/* Liabilities */}
        <FormSection
          title="Liabilities"
          description="Enter all your debts and their current balances"
        >
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <Controller
              name="creditCards"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Credit Cards"
                  error={errors.creditCards?.message}
                  helpText="Total credit card debt"
                />
              )}
            />

            <Controller
              name="studentLoans"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Student Loans"
                  error={errors.studentLoans?.message}
                  helpText="Education loan balances"
                />
              )}
            />

            <Controller
              name="autoLoans"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Auto Loans"
                  error={errors.autoLoans?.message}
                  helpText="Vehicle loan balances"
                />
              )}
            />

            <Controller
              name="mortgages"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Mortgages"
                  error={errors.mortgages?.message}
                  helpText="Home loan balances"
                />
              )}
            />

            <Controller
              name="personalLoans"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Personal Loans"
                  error={errors.personalLoans?.message}
                  helpText="Other personal debt"
                />
              )}
            />

            <Controller
              name="otherLiabilities"
              control={control}
              render={({ field }) => (
                <CurrencyInput
                  {...field}
                  label="Other Liabilities"
                  error={errors.otherLiabilities?.message}
                  helpText="Medical bills, tax debt, etc."
                />
              )}
            />
          </div>

          <div className="mt-4 p-4 bg-red-50 rounded-lg">
            <div className="flex items-center justify-between">
              <span className="text-sm font-medium text-red-900">
                Total Liabilities
              </span>
              <span className="text-lg font-bold text-red-600">
                {formatCurrency(totalLiabilities)}
              </span>
            </div>
          </div>
        </FormSection>

        {/* Notes */}
        <FormSection
          title="Notes"
          description="Add any relevant notes about this snapshot"
        >
          <Textarea
            {...register('notes')}
            label="Notes"
            placeholder="Received year-end bonus, paid off car loan, etc..."
            rows={4}
            error={errors.notes?.message}
            maxLength={1000}
            showCount
          />
        </FormSection>

        {/* Form Actions */}
        <div className="flex items-center justify-end gap-4 pt-6 border-t border-gray-200">
          <Button
            type="button"
            variant="outline"
            onClick={() => navigate('/snapshots')}
          >
            Cancel
          </Button>

          <Button
            type="submit"
            variant="primary"
            disabled={isSubmitting}
            icon={isSubmitting ? Loader2 : Save}
            iconAnimation={isSubmitting ? 'spin' : undefined}
          >
            {isSubmitting
              ? 'Saving...'
              : isEditMode
              ? 'Update Snapshot'
              : 'Create Snapshot'}
          </Button>
        </div>
      </form>
    </div>
  );
}

function FormSkeleton() {
  return (
    <div className="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <Skeleton className="h-12 w-64 mb-8" />
      <Skeleton className="h-32 rounded-lg mb-8" />
      {[...Array(3)].map((_, i) => (
        <div key={i} className="mb-6">
          <Skeleton className="h-6 w-48 mb-4" />
          <div className="grid grid-cols-2 gap-4">
            {[...Array(4)].map((_, j) => (
              <Skeleton key={j} className="h-10 rounded" />
            ))}
          </div>
        </div>
      ))}
    </div>
  );
}
```

**Snapshot Schema:**

```ts
// src/lib/schemas/snapshot.schema.ts
import { z } from 'zod';

export const snapshotSchema = z.object({
  // Date
  snapshotDate: z
    .string()
    .regex(/^\d{4}-\d{2}-\d{2}$/, 'Invalid date format'),

  // Assets
  cash: z
    .number()
    .min(0, 'Cash must be positive')
    .max(10000000, 'Value seems unreasonably high'),

  checkingAccounts: z
    .number()
    .min(0, 'Checking accounts must be positive')
    .max(10000000, 'Value seems unreasonably high'),

  savingsAccounts: z
    .number()
    .min(0, 'Savings accounts must be positive')
    .max(10000000, 'Value seems unreasonably high'),

  investments: z
    .number()
    .min(0, 'Investments must be positive')
    .max(100000000, 'Value seems unreasonably high'),

  retirement: z
    .number()
    .min(0, 'Retirement must be positive')
    .max(100000000, 'Value seems unreasonably high'),

  realEstate: z
    .number()
    .min(0, 'Real estate must be positive')
    .max(100000000, 'Value seems unreasonably high'),

  vehicles: z
    .number()
    .min(0, 'Vehicles must be positive')
    .max(10000000, 'Value seems unreasonably high'),

  otherAssets: z
    .number()
    .min(0, 'Other assets must be positive')
    .max(10000000, 'Value seems unreasonably high'),

  // Liabilities
  creditCards: z
    .number()
    .min(0, 'Credit cards must be positive')
    .max(1000000, 'Value seems unreasonably high'),

  studentLoans: z
    .number()
    .min(0, 'Student loans must be positive')
    .max(10000000, 'Value seems unreasonably high'),

  autoLoans: z
    .number()
    .min(0, 'Auto loans must be positive')
    .max(1000000, 'Value seems unreasonably high'),

  mortgages: z
    .number()
    .min(0, 'Mortgages must be positive')
    .max(100000000, 'Value seems unreasonably high'),

  personalLoans: z
    .number()
    .min(0, 'Personal loans must be positive')
    .max(1000000, 'Value seems unreasonably high'),

  otherLiabilities: z
    .number()
    .min(0, 'Other liabilities must be positive')
    .max(1000000, 'Value seems unreasonably high'),

  // Notes
  notes: z
    .string()
    .max(1000, 'Notes must be less than 1000 characters')
    .optional()
    .or(z.literal('')),
});

export type SnapshotFormData = z.infer<typeof snapshotSchema>;
```

### **5.9 Debt Action Plan** {#5.9-debt-action-plan}

#### **5.9.1 Debt Action Plan Overview Page** {#5.9.1-debt-action-plan-overview-page}

**Purpose:** Strategic debt payoff planning with multiple methodologies (snowball, avalanche, custom)

**User Story:** As a user, I want to create a strategic plan to pay off my debts so that I can become debt-free as quickly and efficiently as possible

**Layout:**

```
┌─────────────────────────────────────────────────────────┐
│  Debt Action Plan Header + Create Plan Button          │
├─────────────────────────────────────────────────────────┤
│  Current Debt Summary (Total, # Debts, Avg Interest)   │
├─────────────────────────────────────────────────────────┤
│  Strategy Selector (Snowball/Avalanche/Custom)         │
├─────────────────────────────────────────────────────────┤
│  Payoff Timeline Visualization                         │
├─────────────────────────────────────────────────────────┤
│  Monthly Payment Breakdown Table                       │
├─────────────────────────────────────────────────────────┤
│  Strategy Comparison Chart                             │
└─────────────────────────────────────────────────────────┘
```

**Component Implementation:**

```
// src/pages/DebtActionPlanPage.tsx
import React, { useState, useMemo } from 'react';
import { useNavigate } from 'react-router-dom';
import { Target, TrendingDown, Calculator, DollarSign, Percent } from 'lucide-react';
import { useCreditCards } from '@/hooks/api/useCreditCards';
import { useLoans } from '@/hooks/api/useLoans';
import { useMortgages } from '@/hooks/api/useMortgages';
import { Button } from '@/components/common/Button';
import { Card } from '@/components/common/Card';
import { DebtSummaryStats } from '@/components/debt-plan/DebtSummaryStats';
import { PayoffStrategySelector } from '@/components/debt-plan/PayoffStrategySelector';
import { DebtTimeline } from '@/components/debt-plan/DebtTimeline';
import { PaymentScheduleCalculator } from '@/components/debt-plan/PaymentScheduleCalculator';
import { StrategyComparison } from '@/components/debt-plan/StrategyComparison';
import { MonthlyPaymentBreakdown } from '@/components/debt-plan/MonthlyPaymentBreakdown';
import { EmptyState } from '@/components/common/EmptyState';
import { Skeleton } from '@/components/common/Skeleton';
import { calculatePayoffSchedule } from '@/lib/utils/debt-payoff';
import type { DebtItem, PayoffStrategy } from '@/types';

export function DebtActionPlanPage() {
  const navigate = useNavigate();
  const { data: creditCards, isLoading: loadingCards } = useCreditCards();
  const { data: loans, isLoading: loadingLoans } = useLoans();
  const { data: mortgages, isLoading: loadingMortgages } = useMortgages();

  const [strategy, setStrategy] = useState<PayoffStrategy>('avalanche');
  const [extraPayment, setExtraPayment] = useState(0);

  const isLoading = loadingCards || loadingLoans || loadingMortgages;

  // Combine all debts into a unified list
  const allDebts = useMemo<DebtItem[]>(() => {
    const debts: DebtItem[] = [];

    // Add credit cards
    if (creditCards) {
      creditCards.forEach(card => {
        if (card.currentBalance > 0) {
          debts.push({
            id: card.id,
            name: card.cardName,
            type: 'credit_card',
            balance: card.currentBalance,
            interestRate: card.apr,
            minimumPayment: card.minimumPayment || card.currentBalance * 0.02, // 2% default
            monthlyPayment: card.minimumPayment || card.currentBalance * 0.02,
          });
        }
      });
    }

    // Add loans
    if (loans) {
      loans.forEach(loan => {
        if (loan.remainingBalance > 0) {
          debts.push({
            id: loan.id,
            name: loan.loanName,
            type: 'loan',
            balance: loan.remainingBalance,
            interestRate: loan.interestRate,
            minimumPayment: loan.monthlyPayment,
            monthlyPayment: loan.monthlyPayment,
          });
        }
      });
    }

    // Add mortgages
    if (mortgages) {
      mortgages.forEach(mortgage => {
        if (mortgage.remainingBalance > 0) {
          debts.push({
            id: mortgage.id,
            name: mortgage.propertyName,
            type: 'mortgage',
            balance: mortgage.remainingBalance,
            interestRate: mortgage.interestRate,
            minimumPayment: mortgage.monthlyPayment,
            monthlyPayment: mortgage.monthlyPayment,
          });
        }
      });
    }

    return debts;
  }, [creditCards, loans, mortgages]);

  // Calculate payoff schedule
  const payoffSchedule = useMemo(() => {
    if (allDebts.length === 0) return null;
    return calculatePayoffSchedule(allDebts, strategy, extraPayment);
  }, [allDebts, strategy, extraPayment]);

  if (isLoading) {
    return <DebtPlanSkeleton />;
  }

  if (allDebts.length === 0) {
    return (
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <EmptyState
          icon={Target}
          title="No debts found"
          description="You don't have any debts to create a payoff plan for. Great job being debt-free!"
          action={{
            label: 'Add Credit Card',
            onClick: () => navigate('/credit-cards/new'),
          }}
        />
      </div>
    );
  }

  return (
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {/* Header */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">Debt Action Plan</h1>
          <p className="text-gray-600 mt-1">
            Create a strategic plan to become debt-free
          </p>
        </div>

        <Button
          variant="primary"
          icon={Calculator}
          onClick={() => navigate('/debt-plan/calculator')}
        >
          Payment Calculator
        </Button>
      </div>

      {/* Debt Summary Stats */}
      <DebtSummaryStats debts={allDebts} className="mb-8" />

      {/* Strategy Selector */}
      <PayoffStrategySelector
        strategy={strategy}
        onStrategyChange={setStrategy}
        extraPayment={extraPayment}
        onExtraPaymentChange={setExtraPayment}
        className="mb-8"
      />

      {/* Payoff Timeline */}
      {payoffSchedule && (
        <DebtTimeline
          schedule={payoffSchedule}
          strategy={strategy}
          className="mb-8"
        />
      )}

      {/* Monthly Payment Breakdown */}
      {payoffSchedule && (
        <MonthlyPaymentBreakdown
          debts={allDebts}
          schedule={payoffSchedule}
          extraPayment={extraPayment}
          className="mb-8"
        />
      )}

      {/* Strategy Comparison */}
      <StrategyComparison
        debts={allDebts}
        extraPayment={extraPayment}
        className="mb-8"
      />
    </div>
  );
}

function DebtPlanSkeleton() {
  return (
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <Skeleton className="h-12 w-64 mb-8" />
      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
        {[...Array(3)].map((_, i) => (
          <Skeleton key={i} className="h-24 rounded-lg" />
        ))}
      </div>
      <Skeleton className="h-32 rounded-lg mb-8" />
      <Skeleton className="h-96 rounded-lg mb-8" />
      <Skeleton className="h-64 rounded-lg" />
    </div>
  );
}
```

**Debt Summary Stats Component:**

```
// src/components/debt-plan/DebtSummaryStats.tsx
import React, { useMemo } from 'react';
import { CreditCard, DollarSign, Percent, Calendar } from 'lucide-react';
import { Card } from '@/components/common/Card';
import { formatCurrency, formatPercentage } from '@/lib/utils/formatters';
import { cn } from '@/lib/utils';
import type { DebtItem } from '@/types';

interface DebtSummaryStatsProps {
  debts: DebtItem[];
  className?: string;
}

export function DebtSummaryStats({ debts, className }: DebtSummaryStatsProps) {
  const stats = useMemo(() => {
    const totalDebt = debts.reduce((sum, d) => sum + d.balance, 0);
    const totalMinPayment = debts.reduce((sum, d) => sum + d.minimumPayment, 0);
    
    // Weighted average interest rate
    const weightedRate = debts.reduce(
      (sum, d) => sum + (d.interestRate * d.balance),
      0
    ) / totalDebt;

    // Simple debt-free calculation (assumes minimum payments only)
    const monthsToPayoff = totalMinPayment > 0
      ? Math.ceil(totalDebt / totalMinPayment)
      : 0;

    return {
      totalDebt,
      debtCount: debts.length,
      averageRate: weightedRate,
      totalMinPayment,
      monthsToPayoff,
    };
  }, [debts]);

  const statItems = [
    {
      label: 'Total Debt',
      value: formatCurrency(stats.totalDebt),
      subValue: `${stats.debtCount} debt${stats.debtCount !== 1 ? 's' : ''}`,
      icon: DollarSign,
      color: 'red',
    },
    {
      label: 'Avg Interest Rate',
      value: formatPercentage(stats.averageRate),
      subValue: 'Weighted average',
      icon: Percent,
      color: 'orange',
    },
    {
      label: 'Min Monthly Payment',
      value: formatCurrency(stats.totalMinPayment),
      subValue: 'Combined minimum',
      icon: CreditCard,
      color: 'blue',
    },
  ];

  return (
    <div className={cn('grid grid-cols-1 sm:grid-cols-3 gap-4', className)}>
      {statItems.map((stat) => (
        <StatCard key={stat.label} {...stat} />
      ))}
    </div>
  );
}

interface StatCardProps {
  label: string;
  value: string;
  subValue: string;
  icon: React.ElementType;
  color: string;
}

function StatCard({ label, value, subValue, icon: Icon, color }: StatCardProps) {
  const colorClasses = {
    red: 'bg-red-100 text-red-600',
    orange: 'bg-orange-100 text-orange-600',
    blue: 'bg-blue-100 text-blue-600',
  };

  return (
    <Card className="p-6">
      <div className="flex items-start justify-between">
        <div>
          <p className="text-sm text-gray-600 font-medium">{label}</p>
          <p className="text-2xl font-bold text-gray-900 mt-1">{value}</p>
          <p className="text-xs text-gray-500 mt-1">{subValue}</p>
        </div>
        <div className={cn(
          'p-2 rounded-lg',
          colorClasses[color as keyof typeof colorClasses]
        )}>
          <Icon className="h-5 w-5" />
        </div>
      </div>
    </Card>
  );
}
```

**Payoff Strategy Selector Component:**

```
// src/components/debt-plan/PayoffStrategySelector.tsx
import React from 'react';
import { TrendingDown, Zap, Settings, Info } from 'lucide-react';
import { Card } from '@/components/common/Card';
import { CurrencyInput } from '@/components/common/CurrencyInput';
import { Tooltip } from '@/components/common/Tooltip';
import { cn } from '@/lib/utils';
import type { PayoffStrategy } from '@/types';

interface PayoffStrategySelectorProps {
  strategy: PayoffStrategy;
  onStrategyChange: (strategy: PayoffStrategy) => void;
  extraPayment: number;
  onExtraPaymentChange: (amount: number) => void;
  className?: string;
}

export function PayoffStrategySelector({
  strategy,
  onStrategyChange,
  extraPayment,
  onExtraPaymentChange,
  className,
}: PayoffStrategySelectorProps) {
  const strategies = [
    {
      id: 'snowball' as PayoffStrategy,
      name: 'Debt Snowball',
      icon: TrendingDown,
      description: 'Pay off smallest debts first',
      details: 'Focus on quick wins by eliminating smallest balances first. Provides psychological motivation through early victories.',
      color: 'blue',
    },
    {
      id: 'avalanche' as PayoffStrategy,
      name: 'Debt Avalanche',
      icon: Zap,
      description: 'Pay off highest interest first',
      details: 'Mathematically optimal approach. Saves the most money on interest by targeting highest rates first.',
      color: 'purple',
    },
    {
      id: 'custom' as PayoffStrategy,
      name: 'Custom Strategy',
      icon: Settings,
      description: 'Create your own plan',
      details: 'Manually set payment priorities based on your preferences and financial situation.',
      color: 'green',
    },
  ];

  return (
    <div className={className}>
      <Card className="p-6">
        <h2 className="text-lg font-semibold text-gray-900 mb-4">
          Choose Your Payoff Strategy
        </h2>

        {/* Strategy Cards */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          {strategies.map((s) => {
            const Icon = s.icon;
            const isSelected = strategy === s.id;

            return (
              <button
                key={s.id}
                onClick={() => onStrategyChange(s.id)}
                className={cn(
                  'p-4 rounded-lg border-2 text-left transition-all',
                  isSelected
                    ? 'border-blue-500 bg-blue-50'
                    : 'border-gray-200 hover:border-gray-300 bg-white'
                )}
              >
                <div className="flex items-start justify-between mb-3">
                  <div className={cn(
                    'p-2 rounded-lg',
                    isSelected ? 'bg-blue-100' : 'bg-gray-100'
                  )}>
                    <Icon className={cn(
                      'h-5 w-5',
                      isSelected ? 'text-blue-600' : 'text-gray-600'
                    )} />
                  </div>
                  <Tooltip content={s.details}>
                    <Info className="h-4 w-4 text-gray-400" />
                  </Tooltip>
                </div>

                <h3 className={cn(
                  'font-semibold mb-1',
                  isSelected ? 'text-blue-900' : 'text-gray-900'
                )}>
                  {s.name}
                </h3>
                <p className={cn(
                  'text-sm',
                  isSelected ? 'text-blue-700' : 'text-gray-600'
                )}>
                  {s.description}
                </p>
              </button>
            );
          })}
        </div>

        {/* Extra Payment Input */}
        <div className="p-4 bg-green-50 rounded-lg">
          <div className="flex items-start gap-4">
            <div className="flex-1">
              <label className="block text-sm font-medium text-green-900 mb-2">
                Extra Monthly Payment
              </label>
              <CurrencyInput
                value={extraPayment}
                onChange={(e) => onExtraPaymentChange(Number(e.target.value) || 0)}
                placeholder="0.00"
              />
            </div>
            <div className="flex-1">
              <p className="text-sm text-green-800 mb-1">
                Accelerate Your Payoff
              </p>
              <p className="text-xs text-green-700">
                Adding extra payments can dramatically reduce your debt-free date and save thousands in interest.
              </p>
            </div>
          </div>
        </div>
      </Card>
    </div>
  );
}
```

**Debt Timeline Component:**

```
// src/components/debt-plan/DebtTimeline.tsx
import React from 'react';
import { Calendar, TrendingDown, DollarSign } from 'lucide-react';
import { Card } from '@/components/common/Card';
import { Badge } from '@/components/common/Badge';
import { formatCurrency, formatDate } from '@/lib/utils/formatters';
import { cn } from '@/lib/utils';
import type { PayoffSchedule, PayoffStrategy } from '@/types';

interface DebtTimelineProps {
  schedule: PayoffSchedule;
  strategy: PayoffStrategy;
  className?: string;
}

export function DebtTimeline({ schedule, strategy, className }: DebtTimelineProps) {
  const payoffDate = new Date();
  payoffDate.setMonth(payoffDate.getMonth() + schedule.monthsToPayoff);

  const milestones = schedule.debts.map((debt, index) => {
    const monthsUntilPayoff = debt.payoffMonth;
    const payoffDate = new Date();
    payoffDate.setMonth(payoffDate.getMonth() + monthsUntilPayoff);

    return {
      name: debt.name,
      month: monthsUntilPayoff,
      date: payoffDate,
      amount: debt.balance,
      order: index + 1,
    };
  }).sort((a, b) => a.month - b.month);

  return (
    <Card className={cn('p-6', className)}>
      {/* Header */}
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-3">
          <div className="p-2 bg-green-100 rounded-lg">
            <Calendar className="h-5 w-5 text-green-600" />
          </div>
          <div>
            <h2 className="text-lg font-semibold text-gray-900">
              Debt-Free Timeline
            </h2>
            <p className="text-sm text-gray-600">
              Using {strategy === 'snowball' ? 'Snowball' : strategy === 'avalanche' ? 'Avalanche' : 'Custom'} strategy
            </p>
          </div>
        </div>

        <div className="text-right">
          <p className="text-sm text-gray-600">Debt-Free Date</p>
          <p className="text-xl font-bold text-green-600">
            {formatDate(payoffDate, 'MMM yyyy')}
          </p>
          <p className="text-sm text-gray-600 mt-1">
            {schedule.monthsToPayoff} months
          </p>
        </div>
      </div>

      {/* Summary Stats */}
      <div className="grid grid-cols-3 gap-4 mb-6">
        <div className="p-4 bg-gray-50 rounded-lg">
          <p className="text-sm text-gray-600 mb-1">Total Principal</p>
          <p className="text-lg font-bold text-gray-900">
            {formatCurrency(schedule.totalPrincipal)}
          </p>
        </div>
        <div className="p-4 bg-red-50 rounded-lg">
          <p className="text-sm text-red-900 mb-1">Total Interest</p>
          <p className="text-lg font-bold text-red-600">
            {formatCurrency(schedule.totalInterest)}
          </p>
        </div>
        <div className="p-4 bg-blue-50 rounded-lg">
          <p className="text-sm text-blue-900 mb-1">Total Paid</p>
          <p className="text-lg font-bold text-blue-600">
            {formatCurrency(schedule.totalPaid)}
          </p>
        </div>
      </div>

      {/* Timeline Visualization */}
      <div className="relative">
        {/* Timeline line */}
        <div className="absolute left-8 top-0 bottom-0 w-0.5 bg-gray-200" />

        {/* Milestones */}
        <div className="space-y-6">
          {milestones.map((milestone, index) => (
            <div key={index} className="relative flex gap-6">
              {/* Timeline dot */}
              <div className="relative z-10 flex-shrink-0 w-16 h-16 bg-green-500 rounded-full flex items-center justify-center text-white font-bold">
                {milestone.order}
              </div>

              {/* Content */}
              <div className="flex-1 pb-6">
                <div className="flex items-start justify-between mb-2">
                  <div>
                    <h3 className="font-semibold text-gray-900">
                      {milestone.name}
                    </h3>
                    <p className="text-sm text-gray-600">
                      {formatDate(milestone.date, 'MMMM yyyy')}
                    </p>
                  </div>
                  <Badge variant="success">
                    Month {milestone.month}
                  </Badge>
                </div>

                <div className="flex items-center gap-4 text-sm">
                  <div className="flex items-center gap-1 text-gray-600">
                    <DollarSign className="h-4 w-4" />
                    <span>{formatCurrency(milestone.amount)} paid off</span>
                  </div>
                </div>
              </div>
            </div>
          ))}

          {/* Final milestone - Debt Free */}
          <div className="relative flex gap-6">
            <div className="relative z-10 flex-shrink-0 w-16 h-16 bg-gradient-to-br from-green-500 to-emerald-600 rounded-full flex items-center justify-center">
              <TrendingDown className="h-8 w-8 text-white" />
            </div>

            <div className="flex-1">
              <div className="p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border-2 border-green-200">
                <h3 className="font-bold text-green-900 text-lg mb-1">
                  🎉 Debt-Free!
                </h3>
                <p className="text-sm text-green-700">
                  All debts paid off by {formatDate(payoffDate, 'MMMM d, yyyy')}
                </p>
                <p className="text-xs text-green-600 mt-2">
                  You saved {formatCurrency(schedule.interestSaved || 0)} compared to minimum payments only
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </Card>
  );
}
```

**Monthly Payment Breakdown Component:**

```
// src/components/debt-plan/MonthlyPaymentBreakdown.tsx
import React, { useState } from 'react';
import { Receipt, ChevronDown, ChevronUp } from 'lucide-react';
import { Card } from '@/components/common/Card';
import { Badge } from '@/components/common/Badge';
import { formatCurrency } from '@/lib/utils/formatters';
import { cn } from '@/lib/utils';
import type { DebtItem, PayoffSchedule } from '@/types';

interface MonthlyPaymentBreakdownProps {
  debts: DebtItem[];
  schedule: PayoffSchedule;
  extraPayment: number;
  className?: string;
}

export function MonthlyPaymentBreakdown({
  debts,
  schedule,
  extraPayment,
  className,
}: MonthlyPaymentBreakdownProps) {
  const [expanded, setExpanded] = useState(true);

  const totalMinimum = debts.reduce((sum, d) => sum + d.minimumPayment, 0);
  const totalMonthly = totalMinimum + extraPayment;

  return (
    <Card className={cn('p-6', className)}>
      {/* Header */}
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-3">
          <div className="p-2 bg-blue-100 rounded-lg">
            <Receipt className="h-5 w-5 text-blue-600" />
          </div>
          <div>
            <h2 className="text-lg font-semibold text-gray-900">
              Monthly Payment Plan
            </h2>
            <p className="text-sm text-gray-600">
              Breakdown of your monthly debt payments
            </p>
          </div>
        </div>

        <button
          onClick={() => setExpanded(!expanded)}
          className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
        >
          {expanded ? (
            <ChevronUp className="h-5 w-5 text-gray-600" />
          ) : (
            <ChevronDown className="h-5 w-5 text-gray-600" />
          )}
        </button>
      </div>

      {/* Total Summary */}
      <div className="grid grid-cols-3 gap-4 mb-6">
        <div className="p-4 bg-gray-50 rounded-lg">
          <p className="text-sm text-gray-600 mb-1">Minimum Payments</p>
          <p className="text-xl font-bold text-gray-900">
            {formatCurrency(totalMinimum)}
          </p>
        </div>
        <div className="p-4 bg-green-50 rounded-lg">
          <p className="text-sm text-green-900 mb-1">Extra Payment</p>
          <p className="text-xl font-bold text-green-600">
            {formatCurrency(extraPayment)}
          </p>
        </div>
        <div className="p-4 bg-blue-50 rounded-lg">
          <p className="text-sm text-blue-900 mb-1">Total Monthly</p>
          <p className="text-xl font-bold text-blue-600">
            {formatCurrency(totalMonthly)}
          </p>
        </div>
      </div>

      {/* Debt Breakdown */}
      {expanded && (
        <div className="space-y-3">
          {schedule.debts.map((debt, index) => (
            <DebtPaymentRow
              key={debt.id}
              debt={debt}
              order={index + 1}
              isTarget={index === 0} // First debt gets extra payment
              extraPayment={index === 0 ? extraPayment : 0}
            />
          ))}
        </div>
      )}
    </Card>
  );
}

interface DebtPaymentRowProps {
  debt: any;
  order: number;
  isTarget: boolean;
  extraPayment: number;
}

function DebtPaymentRow({ debt, order, isTarget, extraPayment }: DebtPaymentRowProps) {
  const totalPayment = debt.minimumPayment + (isTarget ? extraPayment : 0);

  return (
    <div className={cn(
      'p-4 rounded-lg border-2',
      isTarget ? 'border-green-500 bg-green-50' : 'border-gray-200 bg-white'
    )}>
      <div className="flex items-start justify-between mb-3">
        <div className="flex items-center gap-3">
          <div className={cn(
            'w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold',
            isTarget ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700'
          )}>
            {order}
          </div>
          <div>
            <h4 className="font-semibold text-gray-900">{debt.name}</h4>
            <p className="text-sm text-gray-600">
              {formatCurrency(debt.balance)} @ {debt.interestRate.toFixed(2)}% APR
            </p>
          </div>
        </div>

        {isTarget && (
          <Badge variant="success">Target Debt</Badge>
        )}
      </div>

      <div className="grid grid-cols-3 gap-4 text-sm">
        <div>
          <p className="text-gray-600 mb-1">Minimum</p>
          <p className="font-semibold text-gray-900">
            {formatCurrency(debt.minimumPayment)}
          </p>
        </div>
        {isTarget && extraPayment > 0 && (
          <div>
            <p className="text-green-700 mb-1">+ Extra</p>
            <p className="font-semibold text-green-600">
              {formatCurrency(extraPayment)}
            </p>
          </div>
        )}
        <div>
          <p className="text-gray-600 mb-1">Total</p>
          <p className="font-semibold text-blue-600">
            {formatCurrency(totalPayment)}
          </p>
        </div>
      </div>

      {/* Progress indicator */}
      <div className="mt-3">
        <div className="flex items-center justify-between text-xs text-gray-600 mb-1">
          <span>Payoff: Month {debt.payoffMonth}</span>
          <span>{formatCurrency(debt.totalInterest)} interest</span>
        </div>
      </div>
    </div>
  );
}
```

**Strategy Comparison Component:**

```
// src/components/debt-plan/StrategyComparison.tsx
import React, { useMemo } from 'react';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend } from 'recharts';
import { TrendingDown } from 'lucide-react';
import { Card } from '@/components/common/Card';
import { formatCurrency } from '@/lib/utils/formatters';
import { calculatePayoffSchedule } from '@/lib/utils/debt-payoff';
import type { DebtItem } from '@/types';

interface StrategyComparisonProps {
  debts: DebtItem[];
  extraPayment: number;
  className?: string;
}

export function StrategyComparison({ debts, extraPayment, className }: StrategyComparisonProps) {
  const comparison = useMemo(() => {
    const snowball = calculatePayoffSchedule(debts, 'snowball', extraPayment);
    const avalanche = calculatePayoffSchedule(debts, 'avalanche', extraPayment);

    return {
      snowball,
      avalanche,
      chartData: [
        {
          strategy: 'Snowball',
          months: snowball.monthsToPayoff,
          interest: snowball.totalInterest,
          total: snowball.totalPaid,
        },
        {
          strategy: 'Avalanche',
          months: avalanche.monthsToPayoff,
          interest: avalanche.totalInterest,
          total: avalanche.totalPaid,
        },
      ],
    };
  }, [debts, extraPayment]);

  const savings = comparison.snowball.totalInterest - comparison.avalanche.totalInterest;
  const monthsSaved = comparison.snowball.monthsToPayoff - comparison.avalanche.monthsToPayoff;

  const CustomTooltip = ({ active, payload }: any) => {
    if (!active || !payload || !payload.length) return null;

    return (
      <div className="bg-white p-3 rounded-lg shadow-lg border border-gray-200">
        <p className="text-sm font-semibold text-gray-900 mb-2">
          {payload[0].payload.strategy}
        </p>
        <div className="space-y-1">
          <div className="flex items-center justify-between gap-4">
            <span className="text-xs text-gray-600">Months:</span>
            <span className="text-sm font-semibold text-gray-900">
              {payload[0].payload.months}
            </span>
          </div>
          <div className="flex items-center justify-between gap-4">
            <span className="text-xs text-gray-600">Interest:</span>
            <span className="text-sm font-semibold text-red-600">
              {formatCurrency(payload[0].payload.interest)}
            </span>
          </div>
          <div className="flex items-center justify-between gap-4">
            <span className="text-xs text-gray-600">Total Paid:</span>
            <span className="text-sm font-semibold text-blue-600">
              {formatCurrency(payload[0].payload.total)}
            </span>
          </div>
        </div>
      </div>
    );
  };

  return (
    <Card className={className}>
      <div className="p-6">
        {/* Header */}
        <div className="flex items-center gap-3 mb-6">
          <div className="p-2 bg-purple-100 rounded-lg">
            <TrendingDown className="h-5 w-5 text-purple-600" />
          </div>
          <div>
            <h2 className="text-lg font-semibold text-gray-900">
              Strategy Comparison
            </h2>
            <p className="text-sm text-gray-600">
              See which approach saves you the most
            </p>
          </div>
        </div>

        {/* Savings Highlight */}
        {savings > 0 && (
          <div className="p-4 bg-green-50 rounded-lg mb-6">
            <p className="text-sm text-green-900 mb-1">
              💡 Avalanche Strategy Saves You
            </p>
            <p className="text-2xl font-bold text-green-600">
              {formatCurrency(savings)}
            </p>
            <p className="text-sm text-green-700 mt-1">
              {monthsSaved > 0 && `and ${monthsSaved} month${monthsSaved !== 1 ? 's' : ''} `}
              in interest compared to Snowball
            </p>
          </div>
        )}

        {/* Comparison Chart */}
        <div className="h-64 mb-6">
          <ResponsiveContainer width="100%" height="100%">
            <BarChart data={comparison.chartData}>
              <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
              <XAxis
                dataKey="strategy"
                tick={{ fontSize: 12, fill: '#6b7280' }}
                tickLine={false}
              />
              <YAxis
                tick={{ fontSize: 12, fill: '#6b7280' }}
                tickLine={false}
                tickFormatter={(value) => `$${(value / 1000).toFixed(0)}k`}
              />
              <Tooltip content={<CustomTooltip />} />
              <Legend />
              <Bar dataKey="interest" name="Total Interest" fill="#ef4444" />
              <Bar dataKey="total" name="Total Paid" fill="#3b82f6" />
            </BarChart>
          </ResponsiveContainer>
        </div>

        {/* Detailed Comparison Table */}
        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead>
              <tr className="border-b border-gray-200">
                <th className="text-left py-3 px-4 font-semibold text-gray-900">
                  Metric
                </th>
                <th className="text-right py-3 px-4 font-semibold text-gray-900">
                  Snowball
                </th>
                <th className="text-right py-3 px-4 font-semibold text-gray-900">
                  Avalanche
                </th>
                <th className="text-right py-3 px-4 font-semibold text-gray-900">
                  Difference
                </th>
              </tr>
            </thead>
            <tbody>
              <tr className="border-b border-gray-100">
                <td className="py-3 px-4 text-gray-600">Time to Payoff</td>
                <td className="py-3 px-4 text-right text-gray-900">
                  {comparison.snowball.monthsToPayoff} months
                </td>
                <td className="py-3 px-4 text-right text-gray-900">
                  {comparison.avalanche.monthsToPayoff} months
                </td>
                <td className="py-3 px-4 text-right font-semibold text-green-600">
                  {monthsSaved > 0 ? `-${monthsSaved}` : monthsSaved} months
                </td>
              </tr>
              <tr className="border-b border-gray-100">
                <td className="py-3 px-4 text-gray-600">Total Interest</td>
                <td className="py-3 px-4 text-right text-gray-900">
                  {formatCurrency(comparison.snowball.totalInterest)}
                </td>
                <td className="py-3 px-4 text-right text-gray-900">
                  {formatCurrency(comparison.avalanche.totalInterest)}
                </td>
                <td className="py-3 px-4 text-right font-semibold text-green-600">
                  {savings > 0 ? `-${formatCurrency(savings)}` : formatCurrency(Math.abs(savings))}
                </td>
              </tr>
              <tr>
                <td className="py-3 px-4 text-gray-600">Total Amount Paid</td>
                <td className="py-3 px-4 text-right text-gray-900">
                  {formatCurrency(comparison.snowball.totalPaid)}
                </td>
                <td className="py-3 px-4 text-right text-gray-900">
                  {formatCurrency(comparison.avalanche.totalPaid)}
                </td>
                <td className="py-3 px-4 text-right font-semibold text-green-600">
                  {savings > 0 ? `-${formatCurrency(savings)}` : formatCurrency(Math.abs(savings))}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </Card>
  );
}
```

**Type Definitions:**

```ts
// Add to src/types/index.ts

export type PayoffStrategy = 'snowball' | 'avalanche' | 'custom';

export interface DebtItem {
  id: string;
  name: string;
  type: 'credit_card' | 'loan' | 'mortgage';
  balance: number;
  interestRate: number;
  minimumPayment: number;
  monthlyPayment: number;
}

export interface PayoffSchedule {
  debts: Array<{
    id: string;
    name: string;
    balance: number;
    interestRate: number;
    minimumPayment: number;
    monthlyPayment: number;
    payoffMonth: number;
    totalInterest: number;
  }>;
  monthsToPayoff: number;
  totalPrincipal: number;
  totalInterest: number;
  totalPaid: number;
  interestSaved?: number;
}
```

**Debt Payoff Calculation Utilities:**

```ts
// src/lib/utils/debt-payoff.ts
import type { DebtItem, PayoffStrategy, PayoffSchedule } from '@/types';

export function calculatePayoffSchedule(
  debts: DebtItem[],
  strategy: PayoffStrategy,
  extraPayment: number = 0
): PayoffSchedule {
  // Sort debts based on strategy
  const sortedDebts = [...debts].sort((a, b) => {
    if (strategy === 'snowball') {
      // Smallest balance first
      return a.balance - b.balance;
    } else if (strategy === 'avalanche') {
      // Highest interest rate first
      return b.interestRate - a.interestRate;
    }
    // Custom - keep original order
    return 0;
  });

  const results: PayoffSchedule['debts'] = [];
  let remainingDebts = sortedDebts.map(d => ({
    ...d,
    remainingBalance: d.balance,
  }));

  let currentMonth = 0;
  let totalInterestPaid = 0;

  // Simulate month-by-month payoff
  while (remainingDebts.some(d => d.remainingBalance > 0)) {
    currentMonth++;

    // Calculate interest for this month
    remainingDebts = remainingDebts.map(debt => {
      if (debt.remainingBalance <= 0) return debt;

      const monthlyInterest = (debt.remainingBalance * (debt.interestRate / 100)) / 12;
      return {
        ...debt,
        remainingBalance: debt.remainingBalance + monthlyInterest,
      };
    });

    // Apply payments
    let availablePayment = remainingDebts.reduce((sum, d) =>
      d.remainingBalance > 0 ? sum + d.minimumPayment : sum, 0
    ) + extraPayment;

    // Pay minimum on all debts
    remainingDebts = remainingDebts.map(debt => {
      if (debt.remainingBalance <= 0) return debt;

      const payment = Math.min(debt.minimumPayment, debt.remainingBalance);
      availablePayment -= payment;

      return {
        ...debt,
        remainingBalance: Math.max(0, debt.remainingBalance - payment),
      };
    });

    // Apply extra payment to target debt (first non-zero balance)
    const targetDebt = remainingDebts.find(d => d.remainingBalance > 0);
    if (targetDebt && availablePayment > 0) {
      const extraPaymentAmount = Math.min(availablePayment, targetDebt.remainingBalance);
      targetDebt.remainingBalance = Math.max(0, targetDebt.remainingBalance - extraPaymentAmount);
    }

    // Check for paid-off debts
    remainingDebts.forEach(debt => {
      if (debt.remainingBalance === 0 && !results.find(r => r.id === debt.id)) {
        const totalInterest = (currentMonth * debt.minimumPayment) - debt.balance;
        totalInterestPaid += totalInterest;

        results.push({
          id: debt.id,
          name: debt.name,
          balance: debt.balance,
          interestRate: debt.interestRate,
          minimumPayment: debt.minimumPayment,
          monthlyPayment: debt.monthlyPayment,
          payoffMonth: currentMonth,
          totalInterest: Math.max(0, totalInterest),
        });
      }
    });

    // Safety check to prevent infinite loops
    if (currentMonth > 600) break; // 50 years max
  }

  const totalPrincipal = debts.reduce((sum, d) => sum + d.balance, 0);

  return {
    debts: results,
    monthsToPayoff: currentMonth,
    totalPrincipal,
    totalInterest: totalInterestPaid,
    totalPaid: totalPrincipal + totalInterestPaid,
  };
}

export function calculateMinimumPaymentSchedule(debts: DebtItem[]): PayoffSchedule {
  return calculatePayoffSchedule(debts, 'avalanche', 0);
}
```

### **6\. Settings** {#6.-settings}

#### **6.1 Settings Layout & Navigation** {#6.1-settings-layout-&-navigation}

```
// src/pages/settings/SettingsLayout.tsx
import React from 'react';
import { Outlet, NavLink, useLocation } from 'react-router-dom';
import {
  User,
  Shield,
  Bell,
  Palette,
  Database,
  Settings as SettingsIcon,
} from 'lucide-react';
import { cn } from '@/lib/utils';

export function SettingsLayout() {
  const location = useLocation();

  const navigationItems = [
    {
      name: 'Account',
      href: '/settings/account',
      icon: User,
      description: 'Profile information and email',
    },
    {
      name: 'Security',
      href: '/settings/security',
      icon: Shield,
      description: 'Password and authentication',
    },
    {
      name: 'Notifications',
      href: '/settings/notifications',
      icon: Bell,
      description: 'Email and push preferences',
    },
    {
      name: 'Preferences',
      href: '/settings/preferences',
      icon: Palette,
      description: 'Display and formatting',
    },
    {
      name: 'Data & Privacy',
      href: '/settings/data',
      icon: Database,
      description: 'Export, import, and delete',
    },
  ];

  return (
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {/* Header */}
      <div className="mb-8">
        <div className="flex items-center gap-3 mb-2">
          <SettingsIcon className="h-8 w-8 text-gray-900" />
          <h1 className="text-3xl font-bold text-gray-900">Settings</h1>
        </div>
        <p className="text-gray-600">
          Manage your account settings and preferences
        </p>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-4 gap-8">
        {/* Sidebar Navigation */}
        <aside className="lg:col-span-1">
          <nav className="space-y-1">
            {navigationItems.map((item) => {
              const Icon = item.icon;
              const isActive = location.pathname === item.href;

              return (
                <NavLink
                  key={item.href}
                  to={item.href}
                  className={cn(
                    'flex items-start gap-3 px-4 py-3 rounded-lg transition-colors',
                    isActive
                      ? 'bg-blue-50 text-blue-700'
                      : 'text-gray-700 hover:bg-gray-50'
                  )}
                >
                  <Icon className={cn(
                    'h-5 w-5 mt-0.5 flex-shrink-0',
                    isActive ? 'text-blue-700' : 'text-gray-500'
                  )} />
                  <div>
                    <p className={cn(
                      'font-medium',
                      isActive ? 'text-blue-700' : 'text-gray-900'
                    )}>
                      {item.name}
                    </p>
                    <p className="text-xs text-gray-600 mt-0.5">
                      {item.description}
                    </p>
                  </div>
                </NavLink>
              );
            })}
          </nav>
        </aside>

        {/* Content Area */}
        <main className="lg:col-span-3">
          <Outlet />
        </main>
      </div>
    </div>
  );
}
```

#### **6.2 Account Settings** {#6.2-account-settings}

```
// src/pages/settings/AccountSettings.tsx
import React, { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { Save, Loader2, User, Mail, MapPin, Calendar } from 'lucide-react';
import { useAuth } from '@/hooks/useAuth';
import { useUpdateProfile } from '@/hooks/api/useProfile';
import { accountSettingsSchema, type AccountSettingsFormData } from '@/lib/schemas/settings.schema';
import { Card } from '@/components/common/Card';
import { Button } from '@/components/common/Button';
import { Input } from '@/components/common/Input';
import { Select } from '@/components/common/Select';
import { Avatar } from '@/components/common/Avatar';
import { Alert } from '@/components/common/Alert';
import { timezones } from '@/lib/constants/timezones';

export function AccountSettings() {
  const { user } = useAuth();
  const updateProfileMutation = useUpdateProfile();
  const [successMessage, setSuccessMessage] = useState('');

  const {
    register,
    handleSubmit,
    formState: { errors, isSubmitting },
  } = useForm<AccountSettingsFormData>({
    resolver: zodResolver(accountSettingsSchema),
    defaultValues: {
      fullName: user?.fullName || '',
      email: user?.email || '',
      timezone: user?.timezone || 'America/New_York',
    },
  });

  const onSubmit = async (data: AccountSettingsFormData) => {
    try {
      await updateProfileMutation.mutateAsync(data);
      setSuccessMessage('Profile updated successfully');
      setTimeout(() => setSuccessMessage(''), 3000);
    } catch (error) {
      console.error('Failed to update profile:', error);
    }
  };

  return (
    <div className="space-y-6">
      {/* Header */}
      <div>
        <h2 className="text-2xl font-bold text-gray-900">Account Settings</h2>
        <p className="text-gray-600 mt-1">
          Manage your profile information and account details
        </p>
      </div>

      {/* Success Message */}
      {successMessage && (
        <Alert variant="success">
          <div className="flex items-center gap-2">
            <span className="text-green-600">✓</span>
            <span>{successMessage}</span>
          </div>
        </Alert>
      )}

      {/* Profile Picture */}
      <Card className="p-6">
        <h3 className="text-lg font-semibold text-gray-900 mb-4">
          Profile Picture
        </h3>
        <div className="flex items-center gap-6">
          <Avatar
            name={user?.fullName || user?.email || 'User'}
            size="xl"
            className="ring-4 ring-gray-100"
          />
          <div>
            <Button variant="outline" size="sm">
              Change Photo
            </Button>
            <p className="text-xs text-gray-600 mt-2">
              JPG, GIF or PNG. Max size 2MB.
            </p>
          </div>
        </div>
      </Card>

      {/* Profile Information */}
      <Card className="p-6">
        <h3 className="text-lg font-semibold text-gray-900 mb-4">
          Profile Information
        </h3>

        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          <Input
            {...register('fullName')}
            label="Full Name"
            icon={User}
            error={errors.fullName?.message}
            placeholder="John Doe"
            required
          />

          <Input
            {...register('email')}
            type="email"
            label="Email Address"
            icon={Mail}
            error={errors.email?.message}
            placeholder="john@example.com"
            required
            helpText="Your email is used for account login and notifications"
          />

          <Select
            {...register('timezone')}
            label="Timezone"
            icon={MapPin}
            error={errors.timezone?.message}
            required
          >
            <option value="">Select timezone</option>
            {timezones.map((tz) => (
              <option key={tz.value} value={tz.value}>
                {tz.label}
              </option>
            ))}
          </Select>

          <div className="flex items-center justify-end gap-4 pt-4">
            <Button
              type="submit"
              variant="primary"
              disabled={isSubmitting}
              icon={isSubmitting ? Loader2 : Save}
              iconAnimation={isSubmitting ? 'spin' : undefined}
            >
              {isSubmitting ? 'Saving...' : 'Save Changes'}
            </Button>
          </div>
        </form>
      </Card>

      {/* Account Information */}
      <Card className="p-6">
        <h3 className="text-lg font-semibold text-gray-900 mb-4">
          Account Information
        </h3>
        
        <div className="space-y-4">
          <div className="flex items-center justify-between py-3 border-b border-gray-200">
            <div className="flex items-center gap-3">
              <Calendar className="h-5 w-5 text-gray-500" />
              <div>
                <p className="text-sm font-medium text-gray-900">Member Since</p>
                <p className="text-sm text-gray-600">
                  {user?.createdAt ? new Date(user.createdAt).toLocaleDateString('en-US', {
                    month: 'long',
                    day: 'numeric',
                    year: 'numeric',
                  }) : 'N/A'}
                </p>
              </div>
            </div>
          </div>

          <div className="flex items-center justify-between py-3">
            <div className="flex items-center gap-3">
              <User className="h-5 w-5 text-gray-500" />
              <div>
                <p className="text-sm font-medium text-gray-900">Account ID</p>
                <p className="text-sm text-gray-600 font-mono">
                  {user?.id || 'N/A'}
                </p>
              </div>
            </div>
          </div>
        </div>
      </Card>
    </div>
  );
}
```

#### **6.3 Security Settings** {#6.3-security-settings}

```
// src/pages/settings/SecuritySettings.tsx
import React, { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { Save, Loader2, Lock, Shield, Key, CheckCircle, AlertCircle } from 'lucide-react';
import { useAuth } from '@/hooks/useAuth';
import { useChangePassword, useEnable2FA, useDisable2FA } from '@/hooks/api/useSecurity';
import { passwordChangeSchema, type PasswordChangeFormData } from '@/lib/schemas/settings.schema';
import { Card } from '@/components/common/Card';
import { Button } from '@/components/common/Button';
import { Input } from '@/components/common/Input';
import { Alert } from '@/components/common/Alert';
import { ConfirmDialog } from '@/components/common/ConfirmDialog';
import { Badge } from '@/components/common/Badge';

export function SecuritySettings() {
  const { user } = useAuth();
  const changePasswordMutation = useChangePassword();
  const enable2FAMutation = useEnable2FA();
  const disable2FAMutation = useDisable2FA();

  const [successMessage, setSuccessMessage] = useState('');
  const [show2FADialog, setShow2FADialog] = useState(false);
  const [showDisable2FADialog, setShowDisable2FADialog] = useState(false);
  const [qrCode, setQrCode] = useState<string | null>(null);
  const [verificationCode, setVerificationCode] = useState('');

  const {
    register,
    handleSubmit,
    reset,
    formState: { errors, isSubmitting },
  } = useForm<PasswordChangeFormData>({
    resolver: zodResolver(passwordChangeSchema),
  });

  const onSubmitPassword = async (data: PasswordChangeFormData) => {
    try {
      await changePasswordMutation.mutateAsync({
        currentPassword: data.currentPassword,
        newPassword: data.newPassword,
      });
      setSuccessMessage('Password changed successfully');
      reset();
      setTimeout(() => setSuccessMessage(''), 3000);
    } catch (error) {
      console.error('Failed to change password:', error);
    }
  };

  const handleEnable2FA = async () => {
    try {
      const response = await enable2FAMutation.mutateAsync();
      setQrCode(response.qrCode);
      setShow2FADialog(true);
    } catch (error) {
      console.error('Failed to enable 2FA:', error);
    }
  };

  const handleVerify2FA = async () => {
    try {
      // Verify the code and complete 2FA setup
      await enable2FAMutation.mutateAsync({ verificationCode });
      setSuccessMessage('Two-factor authentication enabled successfully');
      setShow2FADialog(false);
      setQrCode(null);
      setVerificationCode('');
      setTimeout(() => setSuccessMessage(''), 3000);
    } catch (error) {
      console.error('Failed to verify 2FA:', error);
    }
  };

  const handleDisable2FA = async () => {
    try {
      await disable2FAMutation.mutateAsync();
      setSuccessMessage('Two-factor authentication disabled');
      setShowDisable2FADialog(false);
      setTimeout(() => setSuccessMessage(''), 3000);
    } catch (error) {
      console.error('Failed to disable 2FA:', error);
    }
  };

  const is2FAEnabled = user?.twoFactorEnabled || false;

  return (
    <div className="space-y-6">
      {/* Header */}
      <div>
        <h2 className="text-2xl font-bold text-gray-900">Security Settings</h2>
        <p className="text-gray-600 mt-1">
          Manage your password and authentication settings
        </p>
      </div>

      {/* Success Message */}
      {successMessage && (
        <Alert variant="success">
          <div className="flex items-center gap-2">
            <CheckCircle className="h-4 w-4" />
            <span>{successMessage}</span>
          </div>
        </Alert>
      )}

      {/* Change Password */}
      <Card className="p-6">
        <div className="flex items-center gap-3 mb-4">
          <Lock className="h-5 w-5 text-gray-700" />
          <h3 className="text-lg font-semibold text-gray-900">
            Change Password
          </h3>
        </div>

        <form onSubmit={handleSubmit(onSubmitPassword)} className="space-y-4">
          <Input
            {...register('currentPassword')}
            type="password"
            label="Current Password"
            icon={Key}
            error={errors.currentPassword?.message}
            required
          />

          <Input
            {...register('newPassword')}
            type="password"
            label="New Password"
            icon={Lock}
            error={errors.newPassword?.message}
            required
            helpText="Must be at least 8 characters with uppercase, lowercase, and numbers"
          />

          <Input
            {...register('confirmPassword')}
            type="password"
            label="Confirm New Password"
            icon={Lock}
            error={errors.confirmPassword?.message}
            required
          />

          <div className="flex items-center justify-end gap-4 pt-4">
            <Button
              type="button"
              variant="ghost"
              onClick={() => reset()}
            >
              Cancel
            </Button>
            <Button
              type="submit"
              variant="primary"
              disabled={isSubmitting}
              icon={isSubmitting ? Loader2 : Save}
              iconAnimation={isSubmitting ? 'spin' : undefined}
            >
              {isSubmitting ? 'Updating...' : 'Update Password'}
            </Button>
          </div>
        </form>
      </Card>

      {/* Two-Factor Authentication */}
      <Card className="p-6">
        <div className="flex items-start justify-between mb-4">
          <div className="flex items-center gap-3">
            <Shield className="h-5 w-5 text-gray-700" />
            <div>
              <h3 className="text-lg font-semibold text-gray-900">
                Two-Factor Authentication
              </h3>
              <p className="text-sm text-gray-600 mt-1">
                Add an extra layer of security to your account
              </p>
            </div>
          </div>
          <Badge variant={is2FAEnabled ? 'success' : 'secondary'}>
            {is2FAEnabled ? 'Enabled' : 'Disabled'}
          </Badge>
        </div>

        <div className="p-4 bg-gray-50 rounded-lg mb-4">
          <p className="text-sm text-gray-700">
            Two-factor authentication (2FA) adds an extra layer of security by requiring
            a verification code in addition to your password when signing in.
          </p>
        </div>

        {is2FAEnabled ? (
          <div>
            <Alert variant="success" className="mb-4">
              <CheckCircle className="h-4 w-4" />
              <div>
                <p className="font-semibold">2FA is Active</p>
                <p className="text-sm mt-1">
                  Your account is protected with two-factor authentication
                </p>
              </div>
            </Alert>

            <Button
              variant="outline"
              onClick={() => setShowDisable2FADialog(true)}
            >
              Disable 2FA
            </Button>
          </div>
        ) : (
          <div>
            <Alert variant="warning" className="mb-4">
              <AlertCircle className="h-4 w-4" />
              <div>
                <p className="font-semibold">2FA is Not Enabled</p>
                <p className="text-sm mt-1">
                  We recommend enabling 2FA to keep your account secure
                </p>
              </div>
            </Alert>

            <Button
              variant="primary"
              onClick={handleEnable2FA}
            >
              Enable 2FA
            </Button>
          </div>
        )}
      </Card>

      {/* Active Sessions */}
      <Card className="p-6">
        <h3 className="text-lg font-semibold text-gray-900 mb-4">
          Active Sessions
        </h3>
        
        <div className="space-y-3">
          <div className="p-4 bg-gray-50 rounded-lg">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-900">Current Session</p>
                <p className="text-xs text-gray-600 mt-1">
                  Chrome on macOS • Last active: Now
                </p>
              </div>
              <Badge variant="success" size="sm">Active</Badge>
            </div>
          </div>

          <Button variant="outline" size="sm">
            Sign Out All Other Sessions
          </Button>
        </div>
      </Card>

      {/* 2FA Setup Dialog */}
      <ConfirmDialog
        isOpen={show2FADialog}
        onClose={() => {
          setShow2FADialog(false);
          setQrCode(null);
          setVerificationCode('');
        }}
        onConfirm={handleVerify2FA}
        title="Enable Two-Factor Authentication"
        confirmLabel="Verify & Enable"
        cancelLabel="Cancel"
      >
        <div className="space-y-4">
          {qrCode && (
            <>
              <p className="text-sm text-gray-600">
                Scan this QR code with your authenticator app (Google Authenticator, Authy, etc.)
              </p>
              <div className="flex justify-center p-4 bg-gray-50 rounded-lg">
                <img src={qrCode} alt="2FA QR Code" className="w-48 h-48" />
              </div>
            </>
          )}

          <Input
            label="Verification Code"
            value={verificationCode}
            onChange={(e) => setVerificationCode(e.target.value)}
            placeholder="Enter 6-digit code"
            maxLength={6}
            required
          />
        </div>
      </ConfirmDialog>

      {/* Disable 2FA Dialog */}
      <ConfirmDialog
        isOpen={showDisable2FADialog}
        onClose={() => setShowDisable2FADialog(false)}
        onConfirm={handleDisable2FA}
        title="Disable Two-Factor Authentication"
        description="Are you sure you want to disable 2FA? This will make your account less secure."
        confirmLabel="Disable"
        variant="danger"
      />
    </div>
  );
}
```

#### **6.4 Notification Settings** {#6.4-notification-settings}

```
// src/pages/settings/NotificationSettings.tsx
import React, { useState } from 'react';
import { Save, Loader2, Bell, Mail, Smartphone } from 'lucide-react';
import { useNotificationSettings, useUpdateNotificationSettings } from '@/hooks/api/useSettings';
import { Card } from '@/components/common/Card';
import { Button } from '@/components/common/Button';
import { Toggle } from '@/components/common/Toggle';
import { Alert } from '@/components/common/Alert';
import { Skeleton } from '@/components/common/Skeleton';

interface NotificationPreferences {
  email: {
    billReminders: boolean;
    goalMilestones: boolean;
    debtPayoffProgress: boolean;
    weeklyDigest: boolean;
    monthlyReport: boolean;
    securityAlerts: boolean;
  };
  push: {
    billDue: boolean;
    goalAchieved: boolean;
    unusualActivity: boolean;
  };
}

export function NotificationSettings() {
  const { data: settings, isLoading } = useNotificationSettings();
  const updateMutation = useUpdateNotificationSettings();
  const [successMessage, setSuccessMessage] = useState('');

  const [preferences, setPreferences] = useState<NotificationPreferences>({
    email: {
      billReminders: settings?.email?.billReminders ?? true,
      goalMilestones: settings?.email?.goalMilestones ?? true,
      debtPayoffProgress: settings?.email?.debtPayoffProgress ?? true,
      weeklyDigest: settings?.email?.weeklyDigest ?? false,
      monthlyReport: settings?.email?.monthlyReport ?? true,
      securityAlerts: settings?.email?.securityAlerts ?? true,
    },
    push: {
      billDue: settings?.push?.billDue ?? true,
      goalAchieved: settings?.push?.goalAchieved ?? true,
      unusualActivity: settings?.push?.unusualActivity ?? true,
    },
  });

  const handleToggle = (category: 'email' | 'push', key: string) => {
    setPreferences(prev => ({
      ...prev,
      [category]: {
        ...prev[category],
        [key]: !prev[category][key as keyof typeof prev[typeof category]],
      },
    }));
  };

  const handleSave = async () => {
    try {
      await updateMutation.mutateAsync(preferences);
      setSuccessMessage('Notification preferences saved successfully');
      setTimeout(() => setSuccessMessage(''), 3000);
    } catch (error) {
      console.error('Failed to save notification settings:', error);
    }
  };

  if (isLoading) {
    return <SettingsSkeleton />;
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div>
        <h2 className="text-2xl font-bold text-gray-900">Notification Settings</h2>
        <p className="text-gray-600 mt-1">
          Manage how and when you receive notifications
        </p>
      </div>

      {/* Success Message */}
      {successMessage && (
        <Alert variant="success">
          <div className="flex items-center gap-2">
            <span className="text-green-600">✓</span>
            <span>{successMessage}</span>
          </div>
        </Alert>
      )}

      {/* Email Notifications */}
      <Card className="p-6">
        <div className="flex items-center gap-3 mb-6">
          <Mail className="h-5 w-5 text-gray-700" />
          <div>
            <h3 className="text-lg font-semibold text-gray-900">
              Email Notifications
            </h3>
            <p className="text-sm text-gray-600">
              Receive updates via email
            </p>
          </div>
        </div>

        <div className="space-y-4">
          <NotificationToggle
            label="Bill Reminders"
            description="Get notified before bills are due"
            checked={preferences.email.billReminders}
            onChange={() => handleToggle('email', 'billReminders')}
          />

          <NotificationToggle
            label="Goal Milestones"
            description="Celebrate when you reach goal milestones"
            checked={preferences.email.goalMilestones}
            onChange={() => handleToggle('email', 'goalMilestones')}
          />

          <NotificationToggle
            label="Debt Payoff Progress"
            description="Track your progress toward becoming debt-free"
            checked={preferences.email.debtPayoffProgress}
            onChange={() => handleToggle('email', 'debtPayoffProgress')}
          />

          <NotificationToggle
            label="Weekly Digest"
            description="Summary of your financial activity each week"
            checked={preferences.email.weeklyDigest}
            onChange={() => handleToggle('email', 'weeklyDigest')}
          />

          <NotificationToggle
            label="Monthly Report"
            description="Comprehensive monthly financial report"
            checked={preferences.email.monthlyReport}
            onChange={() => handleToggle('email', 'monthlyReport')}
          />

          <NotificationToggle
            label="Security Alerts"
            description="Important account security notifications"
            checked={preferences.email.securityAlerts}
            onChange={() => handleToggle('email', 'securityAlerts')}
            badge="Recommended"
          />
        </div>
      </Card>

      {/* Push Notifications */}
      <Card className="p-6">
        <div className="flex items-center gap-3 mb-6">
          <Smartphone className="h-5 w-5 text-gray-700" />
          <div>
            <h3 className="text-lg font-semibold text-gray-900">
              Push Notifications
            </h3>
            <p className="text-sm text-gray-600">
              Receive instant notifications on your device
            </p>
          </div>
        </div>

        <div className="space-y-4">
          <NotificationToggle
            label="Bill Due Soon"
            description="Reminder when bills are due within 3 days"
            checked={preferences.push.billDue}
            onChange={() => handleToggle('push', 'billDue')}
          />

          <NotificationToggle
            label="Goal Achieved"
            description="Instant notification when you reach a goal"
            checked={preferences.push.goalAchieved}
            onChange={() => handleToggle('push', 'goalAchieved')}
          />

          <NotificationToggle
            label="Unusual Activity"
            description="Alerts about unusual account activity"
            checked={preferences.push.unusualActivity}
            onChange={() => handleToggle('push', 'unusualActivity')}
            badge="Security"
          />
        </div>
      </Card>

      {/* Notification Schedule */}
      <Card className="p-6">
        <div className="flex items-center gap-3 mb-6">
          <Bell className="h-5 w-5 text-gray-700" />
          <div>
            <h3 className="text-lg font-semibold text-gray-900">
              Notification Schedule
            </h3>
            <p className="text-sm text-gray-600">
              Control when you receive notifications
            </p>
          </div>
        </div>

        <div className="p-4 bg-blue-50 rounded-lg">
          <p className="text-sm text-blue-900">
            <strong>Coming Soon:</strong> Set quiet hours and customize delivery times
            for different types of notifications.
          </p>
        </div>
      </Card>

      {/* Save Button */}
      <div className="flex items-center justify-end gap-4">
        <Button
          variant="primary"
          onClick={handleSave}
          disabled={updateMutation.isLoading}
          icon={updateMutation.isLoading ? Loader2 : Save}
          iconAnimation={updateMutation.isLoading ? 'spin' : undefined}
        >
          {updateMutation.isLoading ? 'Saving...' : 'Save Preferences'}
        </Button>
      </div>
    </div>
  );
}

interface NotificationToggleProps {
  label: string;
  description: string;
  checked: boolean;
  onChange: () => void;
  badge?: string;
}

function NotificationToggle({
  label,
  description,
  checked,
  onChange,
  badge,
}: NotificationToggleProps) {
  return (
    <div className="flex items-center justify-between py-3 border-b border-gray-200 last:border-0">
      <div className="flex-1">
        <div className="flex items-center gap-2 mb-1">
          <p className="text-sm font-medium text-gray-900">{label}</p>
          {badge && (
            <span className="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs font-semibold rounded">
              {badge}
            </span>
          )}
        </div>
        <p className="text-sm text-gray-600">{description}</p>
      </div>
      <Toggle
        checked={checked}
        onChange={onChange}
      />
    </div>
  );
}

function SettingsSkeleton() {
  return (
    <div className="space-y-6">
      <Skeleton className="h-12 w-64" />
      <Skeleton className="h-96 rounded-lg" />
      <Skeleton className="h-64 rounded-lg" />
    </div>
  );
}
```

#### **6.5 Preferences Settings** {#6.5-preferences-settings}

```
// src/pages/settings/PreferencesSettings.tsx
import React, { useState } from 'react';
import { Save, Loader2, Globe, Calendar, DollarSign, Palette } from 'lucide-react';
import { usePreferences, useUpdatePreferences } from '@/hooks/api/useSettings';
import { Card } from '@/components/common/Card';
import { Button } from '@/components/common/Button';
import { Select } from '@/components/common/Select';
import { Alert } from '@/components/common/Alert';
import { Skeleton } from '@/components/common/Skeleton';

export function PreferencesSettings() {
  const { data: preferences, isLoading } = usePreferences();
  const updateMutation = useUpdatePreferences();
  const [successMessage, setSuccessMessage] = useState('');

  const [settings, setSettings] = useState({
    currency: preferences?.currency || 'USD',
    dateFormat: preferences?.dateFormat || 'MM/DD/YYYY',
    firstDayOfWeek: preferences?.firstDayOfWeek || 'sunday',
    theme: preferences?.theme || 'light',
    language: preferences?.language || 'en',
  });

  const handleChange = (key: string, value: string) => {
    setSettings(prev => ({ ...prev, [key]: value }));
  };

  const handleSave = async () => {
    try {
      await updateMutation.mutateAsync(settings);
      setSuccessMessage('Preferences saved successfully');
      setTimeout(() => setSuccessMessage(''), 3000);
    } catch (error) {
      console.error('Failed to save preferences:', error);
    }
  };

  if (isLoading) {
    return <SettingsSkeleton />;
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div>
        <h2 className="text-2xl font-bold text-gray-900">Preferences</h2>
        <p className="text-gray-600 mt-1">
          Customize your experience with display and formatting preferences
        </p>
      </div>

      {/* Success Message */}
      {successMessage && (
        <Alert variant="success">
          <div className="flex items-center gap-2">
            <span className="text-green-600">✓</span>
            <span>{successMessage}</span>
          </div>
        </Alert>
      )}

      {/* Currency & Regional */}
      <Card className="p-6">
        <div className="flex items-center gap-3 mb-6">
          <Globe className="h-5 w-5 text-gray-700" />
          <div>
            <h3 className="text-lg font-semibold text-gray-900">
              Currency & Regional
            </h3>
            <p className="text-sm text-gray-600">
              Set your currency and regional preferences
            </p>
          </div>
        </div>

        <div className="space-y-4">
          <Select
            label="Currency"
            icon={DollarSign}
            value={settings.currency}
            onChange={(e) => handleChange('currency', e.target.value)}
          >
            <option value="USD">US Dollar (USD)</option>
            <option value="EUR">Euro (EUR)</option>
            <option value="GBP">British Pound (GBP)</option>
            <option value="CAD">Canadian Dollar (CAD)</option>
            <option value="AUD">Australian Dollar (AUD)</option>
            <option value="JPY">Japanese Yen (JPY)</option>
            <option value="INR">Indian Rupee (INR)</option>
          </Select>

          <Select
            label="Language"
            icon={Globe}
            value={settings.language}
            onChange={(e) => handleChange('language', e.target.value)}
          >
            <option value="en">English</option>
            <option value="es">Español</option>
            <option value="fr">Français</option>
            <option value="de">Deutsch</option>
            <option value="pt">Português</option>
          </Select>
        </div>
      </Card>

      {/* Date & Time */}
      <Card className="p-6">
        <div className="flex items-center gap-3 mb-6">
          <Calendar className="h-5 w-5 text-gray-700" />
          <div>
            <h3 className="text-lg font-semibold text-gray-900">
              Date & Time
            </h3>
            <p className="text-sm text-gray-600">
              Configure how dates and times are displayed
            </p>
          </div>
        </div>

        <div className="space-y-4">
          <Select
            label="Date Format"
            value={settings.dateFormat}
            onChange={(e) => handleChange('dateFormat', e.target.value)}
          >
            <option value="MM/DD/YYYY">MM/DD/YYYY (12/31/2024)</option>
            <option value="DD/MM/YYYY">DD/MM/YYYY (31/12/2024)</option>
            <option value="YYYY-MM-DD">YYYY-MM-DD (2024-12-31)</option>
            <option value="MMM D, YYYY">MMM D, YYYY (Dec 31, 2024)</option>
          </Select>

          <Select
            label="First Day of Week"
            value={settings.firstDayOfWeek}
            onChange={(e) => handleChange('firstDayOfWeek', e.target.value)}
          >
            <option value="sunday">Sunday</option>
            <option value="monday">Monday</option>
            <option value="saturday">Saturday</option>
          </Select>
        </div>
      </Card>

      {/* Appearance */}
      <Card className="p-6">
        <div className="flex items-center gap-3 mb-6">
          <Palette className="h-5 w-5 text-gray-700" />
          <div>
            <h3 className="text-lg font-semibold text-gray-900">
              Appearance
            </h3>
            <p className="text-sm text-gray-600">
              Customize the look and feel of the app
            </p>
          </div>
        </div>

        <div className="space-y-4">
          <Select
            label="Theme"
            value={settings.theme}
            onChange={(e) => handleChange('theme', e.target.value)}
          >
            <option value="light">Light</option>
            <option value="dark">Dark</option>
            <option value="auto">Auto (system)</option>
          </Select>

          <div className="p-4 bg-blue-50 rounded-lg">
            <p className="text-sm text-blue-900">
              <strong>Note:</strong> Dark mode is coming soon! We're working hard to bring
              you a beautiful dark theme experience.
            </p>
          </div>
        </div>
      </Card>

      {/* Save Button */}
      <div className="flex items-center justify-end gap-4">
        <Button
          variant="primary"
          onClick={handleSave}
          disabled={updateMutation.isLoading}
          icon={updateMutation.isLoading ? Loader2 : Save}
          iconAnimation={updateMutation.isLoading ? 'spin' : undefined}
        >
          {updateMutation.isLoading ? 'Saving...' : 'Save Preferences'}
        </Button>
      </div>
    </div>
  );
}

function SettingsSkeleton() {
  return (
    <div className="space-y-6">
      <Skeleton className="h-12 w-64" />
      <Skeleton className="h-64 rounded-lg" />
      <Skeleton className="h-64 rounded-lg" />
      <Skeleton className="h-64 rounded-lg" />
    </div>
  );
}
```

#### **6.6 Data & Privacy Settings** {#6.6-data-&-privacy-settings}

```
// src/pages/settings/DataSettings.tsx
import React, { useState } from 'react';
import { Download, Upload, Trash2, AlertCircle, FileText } from 'lucide-react';
import { useExportData, useDeleteAccount } from '@/hooks/api/useSettings';
import { Card } from '@/components/common/Card';
import { Button } from '@/components/common/Button';
import { Alert } from '@/components/common/Alert';
import { ConfirmDialog } from '@/components/common/ConfirmDialog';
import { formatDate } from '@/lib/utils/formatters';

export function DataSettings() {
  const exportMutation = useExportData();
  const deleteAccountMutation = useDeleteAccount();
  
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);
  const [deleteConfirmation, setDeleteConfirmation] = useState('');

  const handleExportData = async () => {
    try {
      const data = await exportMutation.mutateAsync();
      
      // Create and download JSON file
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `budgetura-export-${formatDate(new Date(), 'yyyy-MM-dd')}.json`;
      a.click();
      window.URL.revokeObjectURL(url);
    } catch (error) {
      console.error('Failed to export data:', error);
    }
  };

  const handleDeleteAccount = async () => {
    if (deleteConfirmation !== 'DELETE') {
      alert('Please type DELETE to confirm');
      return;
    }

    try {
      await deleteAccountMutation.mutateAsync();
      // User will be logged out and redirected
    } catch (error) {
      console.error('Failed to delete account:', error);
    }
  };

  return (
    <div className="space-y-6">
      {/* Header */}
      <div>
        <h2 className="text-2xl font-bold text-gray-900">Data & Privacy</h2>
        <p className="text-gray-600 mt-1">
          Manage your data, exports, and account deletion
        </p>
      </div>

      {/* Export Data */}
      <Card className="p-6">
        <div className="flex items-center gap-3 mb-4">
          <Download className="h-5 w-5 text-gray-700" />
          <h3 className="text-lg font-semibold text-gray-900">
            Export Your Data
          </h3>
        </div>

        <p className="text-sm text-gray-600 mb-4">
          Download a complete copy of your financial data in JSON format. This includes
          all your accounts, transactions, bills, goals, and snapshots.
        </p>

        <div className="p-4 bg-blue-50 rounded-lg mb-4">
          <div className="flex items-start gap-3">
            <FileText className="h-5 w-5 text-blue-600 mt-0.5 flex-shrink-0" />
            <div className="text-sm text-blue-900">
              <p className="font-semibold mb-1">What's included:</p>
              <ul className="space-y-1 ml-4 list-disc">
                <li>Account information</li>
                <li>Credit cards, loans, and mortgages</li>
                <li>Bills and recurring payments</li>
                <li>Financial goals and milestones</li>
                <li>Net worth snapshots</li>
                <li>All settings and preferences</li>
              </ul>
            </div>
          </div>
        </div>

        <Button
          variant="primary"
          icon={Download}
          onClick={handleExportData}
          disabled={exportMutation.isLoading}
        >
          {exportMutation.isLoading ? 'Exporting...' : 'Export Data'}
        </Button>
      </Card>

      {/* Import Data */}
      <Card className="p-6">
        <div className="flex items-center gap-3 mb-4">
          <Upload className="h-5 w-5 text-gray-700" />
          <h3 className="text-lg font-semibold text-gray-900">
            Import Data
          </h3>
        </div>

        <p className="text-sm text-gray-600 mb-4">
          Import financial data from a previous export or from other financial apps.
        </p>

        <div className="p-4 bg-yellow-50 rounded-lg mb-4">
          <p className="text-sm text-yellow-900">
            <strong>Coming Soon:</strong> Data import functionality is currently under
            development. You'll be able to import data from CSV files, JSON exports,
            and popular financial apps.
          </p>
        </div>

        <Button
          variant="outline"
          icon={Upload}
          disabled
        >
          Import Data (Coming Soon)
        </Button>
      </Card>

      {/* Privacy */}
      <Card className="p-6">
        <h3 className="text-lg font-semibold text-gray-900 mb-4">
          Privacy & Security
        </h3>

        <div className="space-y-4">
          <div className="p-4 bg-gray-50 rounded-lg">
            <p className="text-sm text-gray-700 mb-3">
              We take your privacy seriously. Here's how we protect your data:
            </p>
            <ul className="space-y-2 text-sm text-gray-700">
              <li className="flex items-start gap-2">
                <span className="text-green-600 mt-0.5">✓</span>
                <span>All data is encrypted in transit and at rest</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-green-600 mt-0.5">✓</span>
                <span>We never share your data with third parties</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-green-600 mt-0.5">✓</span>
                <span>You can export or delete your data at any time</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-green-600 mt-0.5">✓</span>
                <span>Read our full <a href="/privacy" className="text-blue-600 hover:underline">Privacy Policy</a></span>
              </li>
            </ul>
          </div>
        </div>
      </Card>

      {/* Delete Account */}
      <Card className="p-6 border-2 border-red-200 bg-red-50">
        <div className="flex items-center gap-3 mb-4">
          <Trash2 className="h-5 w-5 text-red-700" />
          <h3 className="text-lg font-semibold text-red-900">
            Delete Account
          </h3>
        </div>

        <Alert variant="danger" className="mb-4">
          <AlertCircle className="h-4 w-4" />
          <div>
            <p className="font-semibold">Warning: This action cannot be undone</p>
            <p className="text-sm mt-1">
              Deleting your account will permanently remove all your data including
              accounts, transactions, bills, goals, and snapshots. This action is
              irreversible.
            </p>
          </div>
        </Alert>

        <Button
          variant="danger"
          icon={Trash2}
          onClick={() => setShowDeleteDialog(true)}
        >
          Delete My Account
        </Button>
      </Card>

      {/* Delete Confirmation Dialog */}
      <ConfirmDialog
        isOpen={showDeleteDialog}
        onClose={() => {
          setShowDeleteDialog(false);
          setDeleteConfirmation('');
        }}
        onConfirm={handleDeleteAccount}
        title="Delete Account"
        confirmLabel="Delete Account"
        variant="danger"
      >
        <div className="space-y-4">
          <Alert variant="danger">
            <AlertCircle className="h-4 w-4" />
            <div>
              <p className="font-semibold">This will permanently delete:</p>
              <ul className="text-sm mt-2 space-y-1 ml-4 list-disc">
                <li>All your financial accounts and data</li>
                <li>All bills, goals, and snapshots</li>
                <li>Your account settings and preferences</li>
                <li>All historical data and exports</li>
              </ul>
            </div>
          </Alert>

          <div>
            <label className="block text-sm font-medium text-gray-900 mb-2">
              Type <strong>DELETE</strong> to confirm
            </label>
            <input
              type="text"
              value={deleteConfirmation}
              onChange={(e) => setDeleteConfirmation(e.target.value)}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
              placeholder="DELETE"
            />
          </div>
        </div>
      </ConfirmDialog>
    </div>
  );
}
```

**Settings Schemas:**

```ts
// src/lib/schemas/settings.schema.ts
import { z } from 'zod';

export const accountSettingsSchema = z.object({
  fullName: z
    .string()
    .min(1, 'Full name is required')
    .max(100, 'Full name must be less than 100 characters'),
  
  email: z
    .string()
    .email('Invalid email address'),
  
  timezone: z
    .string()
    .min(1, 'Timezone is required'),
});

export const passwordChangeSchema = z.object({
  currentPassword: z
    .string()
    .min(1, 'Current password is required'),
  
  newPassword: z
    .string()
    .min(8, 'Password must be at least 8 characters')
    .regex(/[A-Z]/, 'Password must contain at least one uppercase letter')
    .regex(/[a-z]/, 'Password must contain at least one lowercase letter')
    .regex(/[0-9]/, 'Password must contain at least one number'),
  
  confirmPassword: z
    .string()
    .min(1, 'Please confirm your new password'),
}).refine(
  (data) => data.newPassword === data.confirmPassword,
  {
    message: 'Passwords do not match',
    path: ['confirmPassword'],
  }
);

export type AccountSettingsFormData = z.infer<typeof accountSettingsSchema>;
export type PasswordChangeFormData = z.infer<typeof passwordChangeSchema>;
```

**Timezones Constant:**

```ts
// src/lib/constants/timezones.ts
export const timezones = [
  { value: 'America/New_York', label: '(UTC-5:00) Eastern Time' },
  { value: 'America/Chicago', label: '(UTC-6:00) Central Time' },
  { value: 'America/Denver', label: '(UTC-7:00) Mountain Time' },
  { value: 'America/Los_Angeles', label: '(UTC-8:00) Pacific Time' },
  { value: 'America/Anchorage', label: '(UTC-9:00) Alaska Time' },
  { value: 'Pacific/Honolulu', label: '(UTC-10:00) Hawaii Time' },
  { value: 'Europe/London', label: '(UTC+0:00) London' },
  { value: 'Europe/Paris', label: '(UTC+1:00) Paris' },
  { value: 'Europe/Berlin', label: '(UTC+1:00) Berlin' },
  { value: 'Asia/Tokyo', label: '(UTC+9:00) Tokyo' },
  { value: 'Asia/Shanghai', label: '(UTC+8:00) Shanghai' },
  { value: 'Asia/Dubai', label: '(UTC+4:00) Dubai' },
  { value: 'Australia/Sydney', label: '(UTC+10:00) Sydney' },
];
```

### **7\. Reports & Analytics** {#7.-reports-&-analytics}

#### **7.1 Reports Overview Page** {#7.1-reports-overview-page}

```
// src/pages/reports/ReportsPage.tsx
import React from 'react';
import { useNavigate } from 'react-router-dom';
import {
  TrendingUp,
  TrendingDown,
  PieChart,
  BarChart3,
  Target,
  Wallet,
  Calendar,
  ArrowRight,
} from 'lucide-react';
import { Card } from '@/components/common/Card';
import { Button } from '@/components/common/Button';
import { cn } from '@/lib/utils';

export function ReportsPage() {
  const navigate = useNavigate();

  const reports = [
    {
      id: 'income-expenses',
      name: 'Income vs Expenses',
      description: 'Track your income and spending patterns over time',
      icon: TrendingUp,
      color: 'blue',
      path: '/reports/income-expenses',
    },
    {
      id: 'net-worth',
      name: 'Net Worth Trend',
      description: 'Visualize how your net worth changes over time',
      icon: BarChart3,
      color: 'green',
      path: '/reports/net-worth',
    },
    {
      id: 'debt-progress',
      name: 'Debt Payoff Progress',
      description: 'Monitor your progress toward becoming debt-free',
      icon: TrendingDown,
      color: 'red',
      path: '/reports/debt-progress',
    },
    {
      id: 'goal-progress',
      name: 'Goal Progress',
      description: 'Track progress on all your financial goals',
      icon: Target,
      color: 'purple',
      path: '/reports/goal-progress',
    },
    {
      id: 'spending-categories',
      name: 'Spending by Category',
      description: 'Analyze where your money goes each month',
      icon: PieChart,
      color: 'orange',
      path: '/reports/spending-categories',
    },
    {
      id: 'cash-flow',
      name: 'Cash Flow',
      description: 'Understand your monthly cash inflows and outflows',
      icon: Wallet,
      color: 'cyan',
      path: '/reports/cash-flow',
    },
  ];

  return (
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {/* Header */}
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-gray-900">Reports & Analytics</h1>
        <p className="text-gray-600 mt-1">
          Gain insights into your financial health with detailed reports
        </p>
      </div>

      {/* Quick Stats */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <Card className="p-6">
          <div className="flex items-center gap-3 mb-2">
            <div className="p-2 bg-blue-100 rounded-lg">
              <Calendar className="h-5 w-5 text-blue-600" />
            </div>
            <h3 className="text-sm font-medium text-gray-600">Reporting Period</h3>
          </div>
          <p className="text-2xl font-bold text-gray-900">Last 12 Months</p>
          <p className="text-xs text-gray-500 mt-1">Customize in each report</p>
        </Card>

        <Card className="p-6">
          <div className="flex items-center gap-3 mb-2">
            <div className="p-2 bg-green-100 rounded-lg">
              <TrendingUp className="h-5 w-5 text-green-600" />
            </div>
            <h3 className="text-sm font-medium text-gray-600">Available Reports</h3>
          </div>
          <p className="text-2xl font-bold text-gray-900">{reports.length}</p>
          <p className="text-xs text-gray-500 mt-1">Comprehensive analytics</p>
        </Card>

        <Card className="p-6">
          <div className="flex items-center gap-3 mb-2">
            <div className="p-2 bg-purple-100 rounded-lg">
              <BarChart3 className="h-5 w-5 text-purple-600" />
            </div>
            <h3 className="text-sm font-medium text-gray-600">Export Options</h3>
          </div>
          <p className="text-2xl font-bold text-gray-900">PDF & CSV</p>
          <p className="text-xs text-gray-500 mt-1">Download any report</p>
        </Card>
      </div>

      {/* Report Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {reports.map((report) => (
          <ReportCard
            key={report.id}
            report={report}
            onClick={() => navigate(report.path)}
          />
        ))}
      </div>
    </div>
  );
}

interface ReportCardProps {
  report: {
    id: string;
    name: string;
    description: string;
    icon: React.ElementType;
    color: string;
    path: string;
  };
  onClick: () => void;
}

function ReportCard({ report, onClick }: ReportCardProps) {
  const Icon = report.icon;

  const colorClasses = {
    blue: 'from-blue-500 to-blue-600',
    green: 'from-green-500 to-green-600',
    red: 'from-red-500 to-red-600',
    purple: 'from-purple-500 to-purple-600',
    orange: 'from-orange-500 to-orange-600',
    cyan: 'from-cyan-500 to-cyan-600',
  };

  return (
    <Card className="overflow-hidden hover:shadow-lg transition-shadow cursor-pointer group" onClick={onClick}>
      <div className={cn(
        'h-24 bg-gradient-to-br p-6 flex items-center justify-between',
        colorClasses[report.color as keyof typeof colorClasses]
      )}>
        <Icon className="h-12 w-12 text-white" />
        <ArrowRight className="h-6 w-6 text-white opacity-0 group-hover:opacity-100 transition-opacity" />
      </div>
      <div className="p-6">
        <h3 className="text-lg font-semibold text-gray-900 mb-2">
          {report.name}
        </h3>
        <p className="text-sm text-gray-600 mb-4">
          {report.description}
        </p>
        <Button variant="outline" size="sm" className="w-full">
          View Report
        </Button>
      </div>
    </Card>
  );
}
```

#### **7.2 Income vs Expenses Report** {#7.2-income-vs-expenses-report}

```
// src/pages/reports/IncomeExpensesReport.tsx
import React, { useState, useMemo } from 'react';
import { Download, Calendar, TrendingUp, TrendingDown, DollarSign } from 'lucide-react';
import { useTransactions } from '@/hooks/api/useTransactions';
import { Card } from '@/components/common/Card';
import { Button } from '@/components/common/Button';
import { Select } from '@/components/common/Select';
import { DateRangePicker } from '@/components/common/DateRangePicker';
import { IncomeExpensesChart } from '@/components/reports/IncomeExpensesChart';
import { IncomeExpensesTable } from '@/components/reports/IncomeExpensesTable';
import { formatCurrency } from '@/lib/utils/formatters';
import { calculateIncomeExpenses } from '@/lib/utils/report-calculator';
import { Skeleton } from '@/components/common/Skeleton';

export function IncomeExpensesReport() {
  const [dateRange, setDateRange] = useState<'30d' | '90d' | '6m' | '1y' | 'custom'>('1y');
  const [startDate, setStartDate] = useState<Date | null>(null);
  const [endDate, setEndDate] = useState<Date | null>(null);

  const { data: transactions, isLoading } = useTransactions({
    dateRange,
    startDate: startDate?.toISOString(),
    endDate: endDate?.toISOString(),
  });

  const reportData = useMemo(() => {
    if (!transactions) return null;
    return calculateIncomeExpenses(transactions, dateRange);
  }, [transactions, dateRange]);

  const handleExport = () => {
    if (!reportData) return;

    const csv = [
      ['Month', 'Income', 'Expenses', 'Net'],
      ...reportData.monthlyData.map(d => [
        d.month,
        d.income.toFixed(2),
        d.expenses.toFixed(2),
        d.net.toFixed(2),
      ]),
    ].map(row => row.join(',')).join('\n');

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `income-expenses-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
  };

  if (isLoading) {
    return <ReportSkeleton />;
  }

  if (!reportData) {
    return <div>No data available</div>;
  }

  return (
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {/* Header */}
      <div className="flex items-center justify-between mb-8">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">Income vs Expenses</h1>
          <p className="text-gray-600 mt-1">
            Track your income and spending patterns over time
          </p>
        </div>
        <Button
          variant="outline"
          icon={Download}
          onClick={handleExport}
        >
          Export CSV
        </Button>
      </div>

      {/* Filters */}
      <Card className="p-4 mb-8">
        <div className="flex items-center gap-4">
          <Select
            value={dateRange}
            onChange={(e) => setDateRange(e.target.value as any)}
            className="w-48"
          >
            <option value="30d">Last 30 Days</option>
            <option value="90d">Last 90 Days</option>
            <option value="6m">Last 6 Months</option>
            <option value="1y">Last 12 Months</option>
            <option value="custom">Custom Range</option>
          </Select>

          {dateRange === 'custom' && (
            <DateRangePicker
              startDate={startDate}
              endDate={endDate}
              onStartDateChange={setStartDate}
              onEndDateChange={setEndDate}
            />
          )}
        </div>
      </Card>

      {/* Summary Cards */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <Card className="p-6">
          <div className="flex items-center gap-3 mb-2">
            <div className="p-2 bg-green-100 rounded-lg">
              <TrendingUp className="h-5 w-5 text-green-600" />
            </div>
            <h3 className="text-sm font-medium text-gray-600">Total Income</h3>
          </div>
          <p className="text-2xl font-bold text-green-600">
            {formatCurrency(reportData.totalIncome)}
          </p>
          <p className="text-xs text-gray-500 mt-1">
            Avg: {formatCurrency(reportData.avgMonthlyIncome)}/mo
          </p>
        </Card>

        <Card className="p-6">
          <div className="flex items-center gap-3 mb-2">
            <div className="p-2 bg-red-100 rounded-lg">
              <TrendingDown className="h-5 w-5 text-red-600" />
            </div>
            <h3 className="text-sm font-medium text-gray-600">Total Expenses</h3>
          </div>
          <p className="text-2xl font-bold text-red-600">
            {formatCurrency(reportData.totalExpenses)}
          </p>
          <p className="text-xs text-gray-500 mt-1">
            Avg: {formatCurrency(reportData.avgMonthlyExpenses)}/mo
          </p>
        </Card>

        <Card className="p-6">
          <div className="flex items-center gap-3 mb-2">
            <div className={cn(
              'p-2 rounded-lg',
              reportData.netIncome >= 0 ? 'bg-blue-100' : 'bg-orange-100'
            )}>
              <DollarSign className={cn(
                'h-5 w-5',
                reportData.netIncome >= 0 ? 'text-blue-600' : 'text-orange-600'
              )} />
            </div>
            <h3 className="text-sm font-medium text-gray-600">Net Income</h3>
          </div>
          <p className={cn(
            'text-2xl font-bold',
            reportData.netIncome >= 0 ? 'text-blue-600' : 'text-orange-600'
          )}>
            {formatCurrency(reportData.netIncome)}
          </p>
          <p className="text-xs text-gray-500 mt-1">
            Avg: {formatCurrency(reportData.avgMonthlyNet)}/mo
          </p>
        </Card>

        <Card className="p-6">
          <div className="flex items-center gap-3 mb-2">
            <div className="p-2 bg-purple-100 rounded-lg">
              <Calendar className="h-5 w-5 text-purple-600" />
            </div>
            <h3 className="text-sm font-medium text-gray-600">Savings Rate</h3>
          </div>
          <p className="text-2xl font-bold text-purple-600">
            {reportData.savingsRate.toFixed(1)}%
          </p>
          <p className="text-xs text-gray-500 mt-1">
            {reportData.savingsRate >= 20 ? 'Excellent!' : reportData.savingsRate >= 10 ? 'Good' : 'Could improve'}
          </p>
        </Card>
      </div>

      {/* Chart */}
      <IncomeExpensesChart data={reportData.monthlyData} className="mb-8" />

      {/* Table */}
      <IncomeExpensesTable data={reportData.monthlyData} />
    </div>
  );
}

function ReportSkeleton() {
  return (
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <Skeleton className="h-12 w-64 mb-8" />
      <Skeleton className="h-24 rounded-lg mb-8" />
      <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <Skeleton className="h-32 rounded-lg" />
        <Skeleton className="h-32 rounded-lg" />
        <Skeleton className="h-32 rounded-lg" />
        <Skeleton className="h-32 rounded-lg" />
      </div>
      <Skeleton className="h-96 rounded-lg mb-8" />
      <Skeleton className="h-64 rounded-lg" />
    </div>
  );
}
```

**Income Expenses Chart Component:**

```
// src/components/reports/IncomeExpensesChart.tsx
import React from 'react';
import {
  AreaChart,
  Area,
  BarChart,
  Bar,
  LineChart,
  Line,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  Legend,
} from 'recharts';
import { Card } from '@/components/common/Card';
import { formatCurrency } from '@/lib/utils/formatters';
import { cn } from '@/lib/utils';

interface IncomeExpensesChartProps {
  data: Array<{
    month: string;
    income: number;
    expenses: number;
    net: number;
  }>;
  className?: string;
}

export function IncomeExpensesChart({ data, className }: IncomeExpensesChartProps) {
  const CustomTooltip = ({ active, payload }: any) => {
    if (!active || !payload || !payload.length) return null;

    const data = payload[0].payload;

    return (
      <div className="bg-white p-3 rounded-lg shadow-lg border border-gray-200">
        <p className="text-sm font-semibold text-gray-900 mb-2">{data.month}</p>
        <div className="space-y-1 text-xs">
          <div className="flex items-center justify-between gap-4">
            <div className="flex items-center gap-2">
              <div className="w-3 h-3 bg-green-500 rounded-sm" />
              <span className="text-gray-600">Income:</span>
            </div>
            <span className="font-semibold text-green-600">
              {formatCurrency(data.income)}
            </span>
          </div>
          <div className="flex items-center justify-between gap-4">
            <div className="flex items-center gap-2">
              <div className="w-3 h-3 bg-red-500 rounded-sm" />
              <span className="text-gray-600">Expenses:</span>
            </div>
            <span className="font-semibold text-red-600">
              {formatCurrency(data.expenses)}
            </span>
          </div>
          <div className="flex items-center justify-between gap-4 pt-1 border-t border-gray-200">
            <div className="flex items-center gap-2">
              <div className="w-3 h-3 bg-blue-500 rounded-sm" />
              <span className="text-gray-600">Net:</span>
            </div>
            <span className={cn(
              'font-semibold',
              data.net >= 0 ? 'text-blue-600' : 'text-orange-600'
            )}>
              {formatCurrency(data.net)}
            </span>
          </div>
        </div>
      </div>
    );
  };

  return (
    <Card className={cn('p-6', className)}>
      <h3 className="text-lg font-semibold text-gray-900 mb-6">
        Income vs Expenses Trend
      </h3>

      <div className="h-96">
        <ResponsiveContainer width="100%" height="100%">
          <BarChart data={data}>
            <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
            <XAxis
              dataKey="month"
              tick={{ fontSize: 12, fill: '#6b7280' }}
              tickLine={false}
            />
            <YAxis
              tick={{ fontSize: 12, fill: '#6b7280' }}
              tickLine={false}
              tickFormatter={(value) => `$${(value / 1000).toFixed(0)}k`}
            />
            <Tooltip content={<CustomTooltip />} />
            <Legend />
            <Bar dataKey="income" fill="#10b981" name="Income" />
            <Bar dataKey="expenses" fill="#ef4444" name="Expenses" />
          </BarChart>
        </ResponsiveContainer>
      </div>

      {/* Net Line Chart */}
      <div className="h-64 mt-8">
        <h4 className="text-sm font-semibold text-gray-900 mb-4">Net Income Trend</h4>
        <ResponsiveContainer width="100%" height="100%">
          <LineChart data={data}>
            <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
            <XAxis
              dataKey="month"
              tick={{ fontSize: 12, fill: '#6b7280' }}
              tickLine={false}
            />
            <YAxis
              tick={{ fontSize: 12, fill: '#6b7280' }}
              tickLine={false}
              tickFormatter={(value) => `$${(value / 1000).toFixed(0)}k`}
            />
            <Tooltip
              content={({ active, payload }: any) => {
                if (!active || !payload || !payload.length) return null;
                const data = payload[0].payload;
                return (
                  <div className="bg-white p-2 rounded-lg shadow-lg border border-gray-200">
                    <p className="text-xs font-semibold text-gray-900 mb-1">{data.month}</p>
                    <p className={cn(
                      'text-sm font-bold',
                      data.net >= 0 ? 'text-blue-600' : 'text-orange-600'
                    )}>
                      {formatCurrency(data.net)}
                    </p>
                  </div>
                );
              }}
            />
            <Line
              type="monotone"
              dataKey="net"
              stroke="#3b82f6"
              strokeWidth={3}
              dot={{ fill: '#3b82f6', r: 4 }}
              name="Net Income"
            />
          </LineChart>
        </ResponsiveContainer>
      </div>
    </Card>
  );
}
```

**Income Expenses Table Component:**

```
// src/components/reports/IncomeExpensesTable.tsx
import React from 'react';
import { Card } from '@/components/common/Card';
import { formatCurrency } from '@/lib/utils/formatters';
import { cn } from '@/lib/utils';

interface IncomeExpensesTableProps {
  data: Array<{
    month: string;
    income: number;
    expenses: number;
    net: number;
  }>;
}

export function IncomeExpensesTable({ data }: IncomeExpensesTableProps) {
  return (
    <Card className="p-6">
      <h3 className="text-lg font-semibold text-gray-900 mb-4">
        Monthly Breakdown
      </h3>

      <div className="overflow-x-auto">
        <table className="w-full">
          <thead>
            <tr className="border-b border-gray-200">
              <th className="text-left py-3 px-4 text-sm font-semibold text-gray-900">
                Month
              </th>
              <th className="text-right py-3 px-4 text-sm font-semibold text-gray-900">
                Income
              </th>
              <th className="text-right py-3 px-4 text-sm font-semibold text-gray-900">
                Expenses
              </th>
              <th className="text-right py-3 px-4 text-sm font-semibold text-gray-900">
                Net
              </th>
              <th className="text-right py-3 px-4 text-sm font-semibold text-gray-900">
                Savings Rate
              </th>
            </tr>
          </thead>
          <tbody>
            {data.map((row, index) => {
              const savingsRate = row.income > 0 ? (row.net / row.income) * 100 : 0;

              return (
                <tr
                  key={index}
                  className="border-b border-gray-100 hover:bg-gray-50"
                >
                  <td className="py-3 px-4 text-sm text-gray-900">
                    {row.month}
                  </td>
                  <td className="py-3 px-4 text-sm text-right font-semibold text-green-600">
                    {formatCurrency(row.income)}
                  </td>
                  <td className="py-3 px-4 text-sm text-right font-semibold text-red-600">
                    {formatCurrency(row.expenses)}
                  </td>
                  <td className={cn(
                    'py-3 px-4 text-sm text-right font-semibold',
                    row.net >= 0 ? 'text-blue-600' : 'text-orange-600'
                  )}>
                    {formatCurrency(row.net)}
                  </td>
                  <td className={cn(
                    'py-3 px-4 text-sm text-right font-semibold',
                    savingsRate >= 20 ? 'text-green-600' :
                    savingsRate >= 10 ? 'text-blue-600' : 'text-gray-600'
                  )}>
                    {savingsRate.toFixed(1)}%
                  </td>
                </tr>
              );
            })}

            {/* Totals Row */}
            <tr className="bg-gray-50 font-semibold">
              <td className="py-3 px-4 text-sm text-gray-900">
                Total
              </td>
              <td className="py-3 px-4 text-sm text-right text-green-600">
                {formatCurrency(data.reduce((sum, r) => sum + r.income, 0))}
              </td>
              <td className="py-3 px-4 text-sm text-right text-red-600">
                {formatCurrency(data.reduce((sum, r) => sum + r.expenses, 0))}
              </td>
              <td className={cn(
                'py-3 px-4 text-sm text-right',
                data.reduce((sum, r) => sum + r.net, 0) >= 0 ? 'text-blue-600' : 'text-orange-600'
              )}>
                {formatCurrency(data.reduce((sum, r) => sum + r.net, 0))}
              </td>
              <td className="py-3 px-4 text-sm text-right text-gray-600">
                {(() => {
                  const totalIncome = data.reduce((sum, r) => sum + r.income, 0);
                  const totalNet = data.reduce((sum, r) => sum + r.net, 0);
                  const avgRate = totalIncome > 0 ? (totalNet / totalIncome) * 100 : 0;
                  return `${avgRate.toFixed(1)}%`;
                })()}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </Card>
  );
}
```

**Report Calculator Utility:**

```ts
// src/lib/utils/report-calculator.ts
import { addMonths, format, startOfMonth, endOfMonth } from 'date-fns';

export interface Transaction {
  id: string;
  amount: number;
  type: 'income' | 'expense';
  date: string;
  category?: string;
}

export function calculateIncomeExpenses(
  transactions: Transaction[],
  dateRange: '30d' | '90d' | '6m' | '1y'
) {
  const now = new Date();
  const monthsBack = {
    '30d': 1,
    '90d': 3,
    '6m': 6,
    '1y': 12,
  }[dateRange];

  // Generate monthly buckets
  const monthlyData: Array<{
    month: string;
    income: number;
    expenses: number;
    net: number;
  }> = [];

  for (let i = monthsBack - 1; i >= 0; i--) {
    const monthDate = addMonths(now, -i);
    const monthStart = startOfMonth(monthDate);
    const monthEnd = endOfMonth(monthDate);

    const monthTransactions = transactions.filter(t => {
      const txDate = new Date(t.date);
      return txDate >= monthStart && txDate <= monthEnd;
    });

    const income = monthTransactions
      .filter(t => t.type === 'income')
      .reduce((sum, t) => sum + t.amount, 0);

    const expenses = monthTransactions
      .filter(t => t.type === 'expense')
      .reduce((sum, t) => sum + t.amount, 0);

    monthlyData.push({
      month: format(monthDate, 'MMM yyyy'),
      income,
      expenses,
      net: income - expenses,
    });
  }

  // Calculate totals
  const totalIncome = monthlyData.reduce((sum, m) => sum + m.income, 0);
  const totalExpenses = monthlyData.reduce((sum, m) => sum + m.expenses, 0);
  const netIncome = totalIncome - totalExpenses;

  return {
    monthlyData,
    totalIncome,
    totalExpenses,
    netIncome,
    avgMonthlyIncome: totalIncome / monthsBack,
    avgMonthlyExpenses: totalExpenses / monthsBack,
    avgMonthlyNet: netIncome / monthsBack,
    savingsRate: totalIncome > 0 ? (netIncome / totalIncome) * 100 : 0,
  };
}

export function calculateNetWorthTrend(snapshots: any[]) {
  return snapshots.map(snapshot => ({
    date: format(new Date(snapshot.snapshotDate), 'MMM yyyy'),
    netWorth: snapshot.netWorth,
    assets: snapshot.totalAssets,
    liabilities: snapshot.totalLiabilities,
  }));
}

export function calculateDebtProgress(debts: any[]) {
  const totalDebt = debts.reduce((sum, d) => sum + d.currentBalance, 0);
  const totalOriginal = debts.reduce((sum, d) => sum + d.originalAmount, 0);
  const totalPaidOff = totalOriginal - totalDebt;
  const progress = totalOriginal > 0 ? (totalPaidOff / totalOriginal) * 100 : 0;

  return {
    totalDebt,
    totalOriginal,
    totalPaidOff,
    progress,
    debts: debts.map(d => ({
      name: d.name,
      current: d.currentBalance,
      original: d.originalAmount,
      progress: d.originalAmount > 0 ?
        ((d.originalAmount - d.currentBalance) / d.originalAmount) * 100 : 0,
    })),
  };
}

export function calculateGoalProgress(goals: any[]) {
  const totalTarget = goals.reduce((sum, g) => sum + g.targetAmount, 0);
  const totalCurrent = goals.reduce((sum, g) => sum + g.currentAmount, 0);
  const overallProgress = totalTarget > 0 ? (totalCurrent / totalTarget) * 100 : 0;

  return {
    totalTarget,
    totalCurrent,
    overallProgress,
    goalsOnTrack: goals.filter(g => g.progressPercentage >= 75).length,
    goalsAchieved: goals.filter(g => g.status === 'achieved').length,
    goals: goals.map(g => ({
      name: g.goalName,
      target: g.targetAmount,
      current: g.currentAmount,
      progress: g.progressPercentage,
      status: g.status,
    })),
  };
}

export function calculateSpendingByCategory(transactions: Transaction[]) {
  const categoryTotals: Record<string, number> = {};

  transactions
    .filter(t => t.type === 'expense')
    .forEach(t => {
      const category = t.category || 'Uncategorized';
      categoryTotals[category] = (categoryTotals[category] || 0) + t.amount;
    });

  const total = Object.values(categoryTotals).reduce((sum, v) => sum + v, 0);

  return Object.entries(categoryTotals)
    .map(([category, amount]) => ({
      category,
      amount,
      percentage: total > 0 ? (amount / total) * 100 : 0,
    }))
    .sort((a, b) => b.amount - a.amount);
}

export function calculateCashFlow(
  transactions: Transaction[],
  dateRange: '30d' | '90d' | '6m' | '1y'
) {
  const data = calculateIncomeExpenses(transactions, dateRange);

  return {
    ...data,
    cashFlowTrend: data.monthlyData.map((m, i) => ({
      ...m,
      cumulative: data.monthlyData
        .slice(0, i + 1)
        .reduce((sum, month) => sum + month.net, 0),
    })),
  };
}
```

#### **7.3 Net Worth Trend Report** {#7.3-net-worth-trend-report}

```
// src/pages/reports/NetWorthReport.tsx
import React, { useState } from 'react';
import { Download, TrendingUp } from 'lucide-react';
import { useSnapshots } from '@/hooks/api/useSnapshots';
import { Card } from '@/components/common/Card';
import { Button } from '@/components/common/Button';
import { Select } from '@/components/common/Select';
import { NetWorthChart } from '@/components/reports/NetWorthChart';
import { formatCurrency } from '@/lib/utils/formatters';
import { calculateNetWorthTrend } from '@/lib/utils/report-calculator';
import { Skeleton } from '@/components/common/Skeleton';

export function NetWorthReport() {
  const [dateRange, setDateRange] = useState<'6m' | '1y' | '2y' | 'all'>('1y');
  const { data: snapshots, isLoading } = useSnapshots({ dateRange });

  const reportData = snapshots ? calculateNetWorthTrend(snapshots) : null;

  const handleExport = () => {
    if (!reportData) return;

    const csv = [
      ['Date', 'Net Worth', 'Assets', 'Liabilities'],
      ...reportData.map(d => [
        d.date,
        d.netWorth.toFixed(2),
        d.assets.toFixed(2),
        d.liabilities.toFixed(2),
      ]),
    ].map(row => row.join(',')).join('\n');

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `net-worth-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
  };

  if (isLoading) {
    return <Skeleton className="h-screen" />;
  }

  if (!reportData || reportData.length === 0) {
    return <div>No snapshots available</div>;
  }

  const latestSnapshot = reportData[reportData.length - 1];
  const firstSnapshot = reportData[0];
  const netWorthChange = latestSnapshot.netWorth - firstSnapshot.netWorth;
  const percentageChange = firstSnapshot.netWorth !== 0
    ? (netWorthChange / Math.abs(firstSnapshot.netWorth)) * 100
    : 0;

  return (
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {/* Header */}
      <div className="flex items-center justify-between mb-8">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">Net Worth Trend</h1>
          <p className="text-gray-600 mt-1">
            Visualize how your net worth changes over time
          </p>
        </div>
        <Button variant="outline" icon={Download} onClick={handleExport}>
          Export CSV
        </Button>
      </div>

      {/* Filters */}
      <Card className="p-4 mb-8">
        <Select
          value={dateRange}
          onChange={(e) => setDateRange(e.target.value as any)}
          className="w-48"
        >
          <option value="6m">Last 6 Months</option>
          <option value="1y">Last 12 Months</option>
          <option value="2y">Last 2 Years</option>
          <option value="all">All Time</option>
        </Select>
      </Card>

      {/* Summary Cards */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <Card className="p-6">
          <h3 className="text-sm font-medium text-gray-600 mb-2">Current Net Worth</h3>
          <p className="text-3xl font-bold text-blue-600">
            {formatCurrency(latestSnapshot.netWorth)}
          </p>
          <p className="text-xs text-gray-500 mt-1">As of {latestSnapshot.date}</p>
        </Card>

        <Card className="p-6">
          <h3 className="text-sm font-medium text-gray-600 mb-2">Change</h3>
          <p className={`text-3xl font-bold ${netWorthChange >= 0 ? 'text-green-600' : 'text-red-600'}`}>
            {netWorthChange >= 0 ? '+' : ''}{formatCurrency(netWorthChange)}
          </p>
          <p className="text-xs text-gray-500 mt-1">
            {percentageChange >= 0 ? '+' : ''}{percentageChange.toFixed(1)}% since {firstSnapshot.date}
          </p>
        </Card>

        <Card className="p-6">
          <h3 className="text-sm font-medium text-gray-600 mb-2">Total Assets</h3>
          <p className="text-3xl font-bold text-green-600">
            {formatCurrency(latestSnapshot.assets)}
          </p>
          <p className="text-xs text-gray-500 mt-1">
            Liabilities: {formatCurrency(latestSnapshot.liabilities)}
          </p>
        </Card>
      </div>

      {/* Chart */}
      <NetWorthChart data={reportData} />
    </div>
  );
}
```

**Net Worth Chart Component:**

```
// src/components/reports/NetWorthChart.tsx
import React from 'react';
import {
  AreaChart,
  Area,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  Legend,
} from 'recharts';
import { Card } from '@/components/common/Card';
import { formatCurrency } from '@/lib/utils/formatters';

interface NetWorthChartProps {
  data: Array<{
    date: string;
    netWorth: number;
    assets: number;
    liabilities: number;
  }>;
}

export function NetWorthChart({ data }: NetWorthChartProps) {
  const CustomTooltip = ({ active, payload }: any) => {
    if (!active || !payload || !payload.length) return null;

    const data = payload[0].payload;

    return (
      <div className="bg-white p-3 rounded-lg shadow-lg border border-gray-200">
        <p className="text-sm font-semibold text-gray-900 mb-2">{data.date}</p>
        <div className="space-y-1 text-xs">
          <div className="flex items-center justify-between gap-4">
            <span className="text-gray-600">Net Worth:</span>
            <span className="font-semibold text-blue-600">{formatCurrency(data.netWorth)}</span>
          </div>
          <div className="flex items-center justify-between gap-4">
            <span className="text-gray-600">Assets:</span>
            <span className="font-semibold text-green-600">{formatCurrency(data.assets)}</span>
          </div>
          <div className="flex items-center justify-between gap-4">
            <span className="text-gray-600">Liabilities:</span>
            <span className="font-semibold text-red-600">{formatCurrency(data.liabilities)}</span>
          </div>
        </div>
      </div>
    );
  };

  return (
    <Card className="p-6">
      <h3 className="text-lg font-semibold text-gray-900 mb-6">
        Net Worth Over Time
      </h3>

      <div className="h-96">
        <ResponsiveContainer width="100%" height="100%">
          <AreaChart data={data}>
            <defs>
              <linearGradient id="netWorthGradient" x1="0" y1="0" x2="0" y2="1">
                <stop offset="5%" stopColor="#3b82f6" stopOpacity={0.3} />
                <stop offset="95%" stopColor="#3b82f6" stopOpacity={0} />
              </linearGradient>
            </defs>
            <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
            <XAxis
              dataKey="date"
              tick={{ fontSize: 12, fill: '#6b7280' }}
              tickLine={false}
            />
            <YAxis
              tick={{ fontSize: 12, fill: '#6b7280' }}
              tickLine={false}
              tickFormatter={(value) => `$${(value / 1000).toFixed(0)}k`}
            />
            <Tooltip content={<CustomTooltip />} />
            <Legend />
            <Area
              type="monotone"
              dataKey="netWorth"
              stroke="#3b82f6"
              strokeWidth={3}
              fill="url(#netWorthGradient)"
              name="Net Worth"
            />
          </AreaChart>
        </ResponsiveContainer>
      </div>
    </Card>
  );
}
```
